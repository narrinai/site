<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile | Manage AI Companions & Subscription - Narrin AI</title>
  <meta name="description" content="Manage your AI companions, track conversations, and upgrade your subscription. Access unlimited AI companions with personalized coaching and support.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://narrin.ai/profile">
  <meta property="og:title" content="My Profile | Manage AI Companions - Narrin AI">
  <meta property="og:description" content="Manage your Narrin AI profile, subscription, and chat history. Create custom AI companions and track your conversations.">
  <meta property="og:image" content="https://narrin.ai/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://narrin.ai/profile">
  <meta property="twitter:title" content="My Profile - Manage AI Chat History | Narrin AI">
  <meta property="twitter:description" content="Manage your Narrin AI profile, view chat history, upgrade to Pro for unlimited AI character conversations. Personalize your AI chat experience today.">
  <meta property="twitter:image" content="https://narrin.ai/og-image.jpg">
  
  <!-- CRITICAL: Hide page IMMEDIATELY if verification token present -->
  <style id="verification-hide-style">
    /* This style is applied before anything else loads */
  </style>
  <script>
    // This runs BEFORE any other scripts, styles, or content loads
    (function() {
      if (window.location.hash.includes('confirmation_token=') || 
          window.location.hash.includes('recovery_token=') || 
          window.location.hash.includes('invite_token=')) {
        // Inject CSS to hide everything immediately
        document.getElementById('verification-hide-style').textContent = 
          'html, body { display: none !important; visibility: hidden !important; }';
      }
    })();
  </script>
  
<!-- Netlify Identity Widget met configuratie -->
<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Microsoft Clarity Analytics -->
<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "svaxez2fed");
</script>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  // Process email verification token (page already hidden by earlier script)
  (function() {
    const fragment = window.location.hash;
    if (fragment.includes('confirmation_token=') || 
        fragment.includes('recovery_token=') || 
        fragment.includes('invite_token=')) {
      
      console.log('ðŸ“§ Email verification token detected - processing...');
      
      // Mark that we're processing verification
      sessionStorage.setItem('email_verification_processing', 'true');
      
      // Wait for DOM ready before processing
      window.addEventListener('DOMContentLoaded', function() {
        if (window.netlifyIdentity) {
          console.log('ðŸ”„ Initializing Netlify Identity for token processing...');
          
          // Initialize Netlify Identity
          window.netlifyIdentity.init();
          
          // Listen for successful authentication
          window.netlifyIdentity.on('login', function(user) {
            console.log('âœ… User authenticated via token:', user.email);
            
            // Store auth data immediately
            localStorage.setItem('user_email', user.email);
            localStorage.setItem('user_uid', user.id);
            localStorage.setItem('user_token', user.token?.access_token || user.id);
            localStorage.setItem('user_auth_timestamp', Date.now().toString());
            
            // Mark verification complete
            sessionStorage.setItem('email_verified', 'true');
            sessionStorage.setItem('just_verified', 'true');
            sessionStorage.removeItem('email_verification_processing');
            
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Remove hide styles
            const hideStyle = document.getElementById('verification-hide-style');
            if (hideStyle) hideStyle.textContent = '';
            document.documentElement.style.display = '';
            document.documentElement.style.visibility = '';
            document.body.style.display = '';
            document.body.style.visibility = '';
            
            // Reload to show authenticated state
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
          
          // Fallback: check after delay
          setTimeout(() => {
            const user = window.netlifyIdentity.currentUser();
            if (user) {
              console.log('âœ… User found after token processing:', user.email);
              
              // Store auth data
              localStorage.setItem('user_email', user.email);
              localStorage.setItem('user_uid', user.id);
              localStorage.setItem('user_token', user.token?.access_token || user.id);
              localStorage.setItem('user_auth_timestamp', Date.now().toString());
              
              // Clean URL and reload
              window.history.replaceState({}, document.title, window.location.pathname);
              sessionStorage.setItem('just_verified', 'true');
              sessionStorage.removeItem('email_verification_processing');
              
              // Remove hide styles
              const hideStyle = document.getElementById('verification-hide-style');
              if (hideStyle) hideStyle.textContent = '';
              document.documentElement.style.display = '';
              document.documentElement.style.visibility = '';
              document.body.style.display = '';
              document.body.style.visibility = '';
              
              window.location.reload();
            } else {
              console.log('âš ï¸ No user found after token processing');
              
              // Remove processing flag and show page
              sessionStorage.removeItem('email_verification_processing');
              const hideStyle = document.getElementById('verification-hide-style');
              if (hideStyle) hideStyle.textContent = '';
              document.documentElement.style.display = '';
              document.documentElement.style.visibility = '';
              document.body.style.display = '';
              document.body.style.visibility = '';
            }
          }, 3000);
        }
      });
      
      // Ultimate fallback: show page after 5 seconds
      setTimeout(() => {
        const stillProcessing = sessionStorage.getItem('email_verification_processing');
        if (stillProcessing) {
          console.log('âš ï¸ Verification timeout, showing page...');
          sessionStorage.removeItem('email_verification_processing');
          const hideStyle = document.getElementById('verification-hide-style');
          if (hideStyle) hideStyle.textContent = '';
          document.documentElement.style.display = '';
          document.documentElement.style.visibility = '';
          document.body.style.display = '';
          document.body.style.visibility = '';
        }
      }, 5000);
    }
  })();
  
  // Normal init for non-verification flows
  document.addEventListener('DOMContentLoaded', () => {
    if (window.netlifyIdentity && !sessionStorage.getItem('email_verification_processing')) {
      try {
        window.netlifyIdentity.init({
          theme: 'custom',
          colors: {
            primary: '#14b8a6',
            secondary: '#f97316'
          },
          logo: false, // Verberg Netlify logo
          locale: 'en',
          namePlaceholder: false // Verberg name veld in signup
        });
      } catch (e) {
        console.error('Error initializing Netlify Identity:', e);
      }
    }
  });
</script>  
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  
  <!-- Import Modern Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
    
    /* Scroll offset for fixed header */
    #pricing-section,
    #personal-info {
      scroll-margin-top: 100px;
    }
    
    /* ===== NETLIFY IDENTITY CUSTOMIZATION ===== */
    .netlify-identity-widget iframe {
      border-radius: 24px !important;
      border: 2px solid #14b8a6 !important;
    }
    
    /* Verberg name veld in signup form */
    .netlify-identity-widget input[name="name"],
    .netlify-identity-widget input[placeholder*="name" i],
    .netlify-identity-widget input[placeholder*="naam" i] {
      display: none !important;
    }
    
    /* ===== CSS CUSTOM PROPERTIES ===== */
    :root {
      /* Primary Colors */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      
      /* Accent Colors */
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-teal-alt: #10a394;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-coral-dark: #ea580c;
      
      /* Supporting Colors */
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      --gradient-subtle: linear-gradient(135deg, var(--color-teal-light) 0%, var(--color-coral-light) 100%);
      --gradient-tags: linear-gradient(135deg, var(--color-teal-alt) 0%, var(--color-coral) 100%);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-colored: 0 10px 25px -5px rgba(20, 184, 166, 0.2);
      
      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Font Sizes */
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms ease-out;
      --transition-base: 300ms ease-out;
      --transition-slow: 500ms ease-out;
      
      /* Touch Target Size */
      --touch-target: 44px;
      
      /* Z-index Scale - AANGEPAST VOOR NETLIFY MODAL */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-overlay: 300;
      --z-modal: 400;
      --z-menu-overlay: 500;
      --z-netlify-modal: 2147483647; /* Maximum z-index voor Netlify Identity modal */
    }

    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      overflow-x: hidden;
    }

    body {
      font-family: var(--font-primary);
      background: var(--color-off-white);
      color: var(--color-navy);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      width: 100%;
    }

    /* ===== ACCESSIBILITY ===== */
    :focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    /* ===== HEADER NAVIGATION ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: all var(--transition-base);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      width: 100%;
      overflow: hidden;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 72px;
      gap: var(--spacing-lg);
      width: 100%;
    }

    /* Logo */
    .logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 800;
      text-decoration: none;
      letter-spacing: -0.02em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: transform var(--transition-base);
      flex-shrink: 0;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    /* Desktop Navigation Center */
    .nav-center {
      display: none !important;
      align-items: center;
      gap: var(--spacing-lg);
      flex: 1;
      justify-content: flex-start;
    }

    /* USPs Container - Desktop */
    .nav-usps {
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
      height: auto;
      position: relative;
    }

    .usp-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-gray-dark);
      font-size: var(--font-size-xs);
      font-weight: 500;
      white-space: nowrap;
    }

    .usp-icon {
      font-size: var(--font-size-lg);
      color: var(--color-teal);
    }
    /* Mobile USP Carousel adjustments */
    @media (max-width: 768px) {
      .nav-usps {
        height: 32px;
      }
      .usp-item {
        font-size: var(--font-size-xs);
        gap: var(--spacing-xs);
      }
      .usp-icon {
        font-size: var(--font-size-sm);
      }
    }

    .nav-search {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin-left: var(--spacing-xl);
    }

    .nav-search-input {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-lg);
      padding-right: calc(var(--spacing-lg) * 2.5);
      font-size: var(--font-size-sm);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .nav-search-input:hover {
      border-color: var(--color-gray-light);
    }

    .nav-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .nav-search-input::placeholder {
      color: var(--color-gray-light);
    }

    .search-submit {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .search-submit:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .search-submit svg {
      width: 18px;
      height: 18px;
      color: var(--color-white);
    }

    /* Navigation Links - Hide by default, show on desktop */
    .nav-links {
      display: none;
      align-items: center;
      gap: var(--spacing-xl);
    }
    
    @media (min-width: 1024px) {
      .nav-links {
        display: flex;
      }
    }

    .nav-link {
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-sm);
      transition: color var(--transition-base);
      position: relative;
      padding: var(--spacing-xs) 0;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--gradient-primary);
      transition: width var(--transition-base);
    }

    .nav-link:hover {
      color: var(--color-teal);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-sm);
      font-weight: 600;
      text-decoration: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      min-height: var(--touch-target);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      font-weight: 600;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Mobile Navigation Container */
    .mobile-nav-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    /* Mobile Chat Button */
    .mobile-chat-btn {
      display: none !important;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
      text-decoration: none;
    }

    .mobile-chat-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-chat-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Search Button - DISABLED */
    .mobile-search-btn {
      display: none !important;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .mobile-search-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Hamburger Menu */
    .mobile-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      position: relative;
      flex-shrink: 0;
      z-index: var(--z-menu-overlay);
    }

    .mobile-menu-btn:hover {
      background: var(--color-light-gray);
    }

    .hamburger {
      width: 24px;
      height: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: var(--color-navy);
      border-radius: 1px;
      transition: all var(--transition-base);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile Menu Overlay - Full Screen */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: var(--z-overlay);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mobile-menu-content {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl) var(--spacing-xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
    }

    .mobile-menu-overlay.active .mobile-menu-content {
      transform: scale(1) translateY(0);
    }

    .mobile-menu-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .mobile-menu-logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .mobile-menu-subtitle {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
    }

    .mobile-menu-nav {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .mobile-menu-link {
      display: flex;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      background: var(--color-off-white);
    }

    .mobile-menu-link:hover {
      background: var(--color-light-gray);
      color: var(--color-teal);
      transform: translateX(4px);
    }

    .mobile-menu-link.btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      justify-content: center;
      font-weight: 700;
      margin-top: var(--spacing-lg);
    }

    .mobile-menu-link.btn-primary:hover {
      background: var(--gradient-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .mobile-menu-link-icon {
      margin-right: var(--spacing-sm);
      font-size: var(--font-size-lg);
    }

    /* Mobile Search Overlay */
    .mobile-search-overlay {
      position: fixed;
      top: 72px;
      left: 0;
      right: 0;
      background: var(--color-white);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: var(--z-dropdown);
    }

    .mobile-search-overlay.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .mobile-search-form {
      display: flex;
      gap: var(--spacing-sm);
    }

    .mobile-search-input {
      flex: 1;
      padding: var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .mobile-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* Desktop Styles */
    @media (min-width: 769px) {
      .nav-center {
        display: flex;
      }

      .nav-links {
        display: flex;
      }

      .mobile-nav-container {
        display: none;
      }

      .mobile-chat-btn {
        display: none !important;
      }

      .mobile-search-btn {
        display: none !important;
      }

      .mobile-menu-btn {
        display: none !important;
      }

      .mobile-menu-overlay {
        display: none !important;
      }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .header-container {
        padding: 0 var(--spacing-md);
      }

      .header-content {
        min-height: 60px;
        gap: var(--spacing-sm);
        padding: 0;
        display: grid;
        grid-template-columns: auto 1fr auto auto auto;
        align-items: center;
      }

      .logo {
        font-size: var(--font-size-lg);
        flex-shrink: 0;
        min-width: fit-content;
        grid-column: 1;
      }

      .mobile-nav-container {
        flex-shrink: 0;
        min-width: fit-content;
        display: flex !important;
        gap: var(--spacing-xs);
        grid-column: 3 / 6;
        justify-self: end;
      }

      .nav-center {
        display: none !important;
      }

      .nav-links {
        display: none !important;
      }

            .mobile-chat-btn {
        display: flex;
        flex-shrink: 0;
      }

.mobile-search-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-menu-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-search-overlay {
        top: 60px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .header-content {
        gap: var(--spacing-xs);
        grid-template-columns: auto 1fr auto auto auto;
      }
      
      .logo {
        font-size: var(--font-size-base);
      }
    }

    /* ===== NETLIFY IDENTITY MODAL Z-INDEX FIX ===== */
    
    /* EXTREME Z-INDEX FIX - Force ALL Netlify elements to highest possible z-index */
    .netlify-identity-widget,
    .netlify-identity-widget *,
    [data-netlify-identity-widget],
    [data-netlify-identity-widget] *,
    .netlify-identity-widget iframe,
    .netlify-identity-widget > div,
    .netlify-identity-widget .netlify-identity-modal,
    .netlify-identity-widget .netlify-identity-modal *,
    .netlify-identity-widget .netlify-identity-modal > *,
    .netlify-identity-widget .netlify-identity-modal div,
    .netlify-identity-modal,
    .netlify-identity-modal *,
    div[data-netlify-identity-modal],
    div[data-netlify-identity-modal] * {
      z-index: 999999999 !important;
      position: relative !important;
    }

    /* GEFIXTE VERSIE: Alleen z-index verlagen, NIET visibility verbergen */
    body:has(.netlify-identity-widget) .header,
    body:has(.netlify-identity-widget) .mobile-menu-overlay,
    body:has(.netlify-identity-widget) .mobile-search-overlay,
    body:has(.netlify-identity-widget) nav,
    body:has(.netlify-identity-widget) header {
      z-index: 1 !important;
      position: relative !important;
      /* VERWIJDERD: visibility: hidden !important; */
    }

    /* Universal Netlify modal override */
    div[class*="netlify"],
    iframe[src*="netlify"],
    div[id*="netlify"],
    *[class*="identity"],
    *[data-netlify-identity-widget],
    *[data-netlify-identity-modal] {
      z-index: 999999999 !important;
      position: fixed !important;
    }

    /* GEFIXTE mobiele modal behandeling */
    @media (max-width: 768px) {
      /* Zorgt ervoor dat modal OVER de navigatie komt zonder deze te verbergen */
      .netlify-identity-widget {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 999999999 !important;
        background: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* Modal wrapper */
      .netlify-identity-widget > div {
        position: relative !important;
        width: 100% !important;
        max-width: 400px !important;
        height: auto !important;
        max-height: 90vh !important;
        z-index: 999999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px !important;
        box-sizing: border-box !important;
      }

      /* Actual modal */
      .netlify-identity-widget .netlify-identity-modal {
        position: relative !important;
        width: 100% !important;
        max-width: 400px !important;
        max-height: 90vh !important;
        margin: 0 !important;
        border-radius: 16px !important;
        z-index: 999999999 !important;
        overflow-y: auto !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        background: white !important;
      }
    }

    /* Desktop modal positioning */
    @media (min-width: 769px) {
      .netlify-identity-widget {
        z-index: 999999999 !important;
        position: fixed !important;
      }
      
      .netlify-identity-widget .netlify-identity-modal {
        margin-top: 100px !important;
        z-index: 999999999 !important;
      }
    }

    /* AANGEPASTE JavaScript-based fix */
    .modal-open {
      overflow: hidden !important;
    }
    
    .modal-open .header {
      z-index: 1 !important;
      /* VERWIJDERD: visibility: hidden !important; */
    }
    
    .modal-open .mobile-menu-overlay,
    .modal-open .mobile-search-overlay {
      z-index: 1 !important;
      /* VERWIJDERD: display: none !important; */
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-sm);
    }
    
    .page-header h1 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-4xl);
      margin: 0 0 var(--spacing-md) 0;
      color: var(--color-navy);
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    
    .page-header p {
      color: var(--color-gray);
      font-size: var(--font-size-lg);
      margin: 0;
      font-weight: 400;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: var(--spacing-xl);
      gap: var(--spacing-md);
    }

    /* ===== PROFILE CONTENT LAYOUT ===== */
    .profile-content {
      display: block;
      width: 100%;
    }

    /* ===== PROFILE NAVIGATION ===== */
    .profile-nav {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-2xl);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .nav-button {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--color-white);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      text-align: center;
      text-decoration: none;
      color: var(--color-navy);
      font-weight: 600;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
    }

    .nav-button:hover {
      border-color: var(--color-teal);
      background: var(--color-teal-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* ===== WELCOME STORY BLOCK ===== */
    .welcome-story {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl);
      margin: 0 auto var(--spacing-2xl) auto;
      max-width: 800px;
      box-shadow: var(--shadow-md);
      text-align: center;
    }

    .welcome-story h2 {
      font-size: var(--font-size-2xl);
      font-weight: 800;
      margin-bottom: var(--spacing-lg);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-story p {
      font-size: var(--font-size-sm);
      line-height: 1.8;
      margin-bottom: var(--spacing-lg);
      color: var(--color-secondary);
    }

    .welcome-story p:last-of-type {
      margin-bottom: var(--spacing-xl);
    }

    .welcome-story strong {
      color: var(--color-primary);
      font-weight: 700;
    }

    .welcome-cta {
      display: inline-block;
      background: var(--gradient-primary);
      color: var(--color-white);
      padding: var(--spacing-md) var(--spacing-2xl);
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: 700;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      text-align: center;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      display: block;
      white-space: nowrap;
    }

    .welcome-cta:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .welcome-cta.inverted {
      background: transparent;
      color: var(--color-primary);
      border: 2px solid var(--color-primary);
      margin-left: var(--spacing-md);
    }

    .welcome-cta.inverted:hover {
      background: var(--color-primary);
      color: var(--color-white);
    }

    .welcome-cta.secondary {
      background: transparent;
      color: var(--color-primary);
      border: 2px solid var(--color-primary);
      margin-left: var(--spacing-md);
    }

    .welcome-cta.secondary:hover {
      background: var(--color-primary);
      color: var(--color-white);
    }

    .welcome-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .text-link {
      color: var(--color-teal);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
    }

    .text-link:hover {
      color: var(--color-teal-dark);
      text-decoration: underline;
    }

    /* Trial Status Styling */
    .trial-status {
      background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
      border: 2px solid #52c41a;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .trial-badge-large {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: #389e0d;
      margin-bottom: var(--spacing-sm);
    }

    .trial-description {
      font-size: var(--font-size-sm);
      color: #389e0d;
      margin-bottom: var(--spacing-md);
      line-height: 1.5;
    }

    .trial-timer {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: #389e0d;
    }

    .timer-date {
      background: rgba(56, 158, 13, 0.1);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
    }

    @media (max-width: 768px) {
      .welcome-story {
        padding: var(--spacing-xl);
      }
      
      .welcome-story p {
        font-size: var(--font-size-base);
      }
    }

    /* ===== PREMIUM PRICING CARDS ===== */
    .pricing-container {
      width: 100%;
      max-width: 1200px;
      margin: var(--spacing-2xl) auto;
      margin-bottom: var(--spacing-2xl);
    }

    .pricing-title {
      text-align: center;
      font-size: var(--font-size-3xl);
      font-weight: 800;
      margin-bottom: var(--spacing-xl);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .pricing-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-lg);
      max-width: 100%;
      margin: 0 auto;
      align-items: stretch;
    }

    .pricing-card {
      position: relative;
      background: var(--color-white);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl) var(--spacing-xl);
      transition: all var(--transition-base);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .pricing-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--color-teal-light);
    }

    .pricing-card.featured {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.1);
    }

    .pricing-card.featured:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(20, 184, 166, 0.2);
    }
    
    /* Compact Cancellation Notice */
    .compact-cancel-notice {
      background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
      border: 1px solid #fdcb6e;
      border-radius: 6px;
      padding: 8px 12px;
      margin-top: 8px;
      text-align: center;
    }
    
    .cancel-text {
      color: #e17055;
    }
    
    /* Trial Notice */
    .trial-notice {
      background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
      border: 1px solid #52c41a;
      border-radius: 6px;
      padding: 8px 12px;
      margin-top: 8px;
      text-align: center;
    }
    
    .trial-badge {
      font-size: 0.8rem;
      font-weight: 600;
      color: #389e0d;
      margin-bottom: 2px;
    }
    
    .trial-text {
      color: #389e0d;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .benefit-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
      color: var(--color-gray-dark);
      font-weight: 500;
      justify-content: center;
    }
    
    .checkmark {
      color: var(--color-teal);
      font-weight: bold;
      font-size: var(--font-size-sm);
    }
    
    .trial-benefit {
      margin-top: var(--spacing-xs);
      font-size: var(--font-size-xs);
    }
      font-size: 12px;
      font-weight: 500;
    }
    
    .cancel-text strong {
      color: #d63031;
      font-weight: 600;
    }

    .card-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gradient-primary);
      color: white;
      padding: 6px 20px;
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-badge.premium {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .card-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-xl);
      border-bottom: 1px solid var(--color-light-gray);
    }

    .plan-name {
      font-size: var(--font-size-2xl);
      font-weight: 800;
      color: var(--color-navy);
      margin-bottom: var(--spacing-sm);
    }

    .plan-price {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 4px;
      margin-bottom: var(--spacing-sm);
      position: relative;
    }
    
    .price-daily {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-primary);
      margin-top: var(--spacing-xs);
      font-weight: 600;
      text-align: center;
    }

    .price-currency {
      font-size: var(--font-size-lg);
      color: var(--color-gray);
      font-weight: 500;
    }

    .price-amount {
      font-size: var(--font-size-4xl);
      font-weight: 800;
      color: var(--color-navy);
    }

    .pricing-card[data-plan="discover"] .price-amount {
      font-size: var(--font-size-4xl);
    }

    .price-period {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      font-weight: 500;
    }

    .plan-description {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin: 0;
      text-align: center;
    }

    .plan-features {
      list-style: none;
      padding: 0;
      margin: 0 0 var(--spacing-xl) 0;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) 0;
      font-size: var(--font-size-sm);
      color: var(--color-navy);
    }

    .feature-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--color-teal-light);
      color: var(--color-teal-dark);
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .feature-item.premium-feature .feature-icon {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }

    .feature-text strong {
      color: var(--color-teal);
      font-weight: 700;
    }

    /* Limited Time Offer Pricing Styles */
    .early-bird-badge {
      display: inline-block;
      background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-left: 8px;
      vertical-align: middle;
    }

    .price-wrapper {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: var(--spacing-sm);
    }

    .original-price {
      text-decoration: line-through;
      color: var(--color-gray-light);
      font-size: var(--font-size-lg);
      font-weight: 500;
    }

    .card-action {
      margin-top: auto;
      display: flex;
      justify-content: center;
    }

    .plan-button {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-base);
      font-weight: 700;
      font-family: var(--font-primary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      text-transform: none;
      letter-spacing: -0.01em;
    }

    .plan-button.current-plan {
      background: var(--color-light-gray);
      color: var(--color-gray);
      cursor: default;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .plan-button.upgrade-button {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 4px 14px rgba(20, 184, 166, 0.3);
    }

    .plan-button.upgrade-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
    }

    .plan-button.upgrade-button.premium {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 4px 14px rgba(251, 191, 36, 0.3);
    }

    .plan-button.upgrade-button.premium:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .plan-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .plan-active {
      text-align: center;
      width: 100%;
    }

    .active-badge {
      background: var(--color-teal-light);
      color: var(--color-teal-dark);
      font-size: var(--font-size-sm);
      font-weight: 700;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .downgrade-link {
      color: var(--color-gray);
      font-size: var(--font-size-xs);
      text-decoration: none;
      transition: color var(--transition-base);
      font-weight: 500;
    }

    .downgrade-link:hover {
      color: var(--color-coral);
      text-decoration: underline;
    }

    /* ===== INVITE FRIEND SECTION ===== */
    .invite-section {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-base);
      margin-bottom: var(--spacing-lg);
      border: 2px solid var(--color-light-gray);
      width: 100%;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .invite-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .invite-icon {
      font-size: var(--font-size-2xl);
    }

    .invite-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-navy);
      margin: 0;
    }

    .invite-description {
      color: var(--color-gray-dark);
      font-size: var(--font-size-base);
      margin-bottom: var(--spacing-lg);
      line-height: 1.6;
    }

    .invite-form {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .invite-input {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-family: var(--font-primary);
      transition: border-color var(--transition-base);
    }

    .invite-input:focus {
      outline: none;
      border-color: var(--color-teal);
    }

    .invite-button {
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      white-space: nowrap;
      font-family: var(--font-primary);
    }

    .invite-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .invite-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .invite-feedback {
      font-size: var(--font-size-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      display: none !important;
    }

    .invite-feedback.success {
      display: block;
      background: rgba(20, 184, 166, 0.1);
      color: var(--color-teal);
      border: 1px solid var(--color-teal);
    }

    .invite-feedback.info {
      display: block;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid #3b82f6;
    }

    .invite-feedback.error {
      display: block;
      background: rgba(255, 123, 114, 0.1);
      color: var(--color-coral);
      border: 1px solid var(--color-coral);
    }

    .invite-link-container {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .invite-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .invite-action-btn {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--color-white);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      font-family: var(--font-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      text-align: center;
    }

    .invite-action-btn:hover {
      border-color: var(--color-teal);
      background: rgba(20, 184, 166, 0.05);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    @media (max-width: 768px) {
      .invite-section {
        padding: var(--spacing-lg);
      }

      .invite-form {
        flex-direction: column;
      }

      .invite-button {
        width: 100%;
      }

      .invite-link-container {
        flex-direction: column;
      }

      .invite-actions {
        flex-direction: column;
      }

      .invite-action-btn {
        width: 100%;
      }
    }

    /* Subtle gradient overlay for depth */
    .gradient-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        transparent 30%, 
        transparent 70%, 
        rgba(0, 0, 0, 0.1) 100%
      );
      pointer-events: none;
    }
    
    .form-section {
      background: var(--color-white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .form-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }
    
    .form-section h2 {
      margin: 0 0 var(--spacing-lg) 0;
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .profile-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg) 0;
      border-bottom: 1px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }
    
    .profile-item:last-child {
      border-bottom: none;
    }
    
    .profile-item.editing {
      background: var(--color-off-white);
      margin: calc(var(--spacing-lg) * -1) calc(var(--spacing-2xl) * -1);
      padding: var(--spacing-lg) var(--spacing-2xl);
      border-radius: var(--radius-md);
      border-bottom: none;
    }
    
    .label {
      font-weight: 600;
      color: var(--color-navy);
      margin-right: var(--spacing-lg);
      min-width: 100px;
      font-size: var(--font-size-sm);
    }
    
    .value {
      flex: 1;
      color: var(--color-gray);
      margin-right: var(--spacing-lg);
      font-size: var(--font-size-base);
    }
    
    .edit-btn, .save-btn, .cancel-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      display: none !important;
      margin-left: var(--spacing-xs);
      transition: all var(--transition-base);
    }
    
    .edit-btn {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-teal);
      box-shadow: var(--shadow-sm);
    }
    
    .edit-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }
    
    .save-btn {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }
    
    .save-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .cancel-btn {
      background: var(--color-light-gray);
      color: var(--color-gray-dark);
      border: 1px solid var(--color-gray-light);
    }
    
    .cancel-btn:hover {
      background: var(--color-gray-light);
      transform: translateY(-1px);
    }
    
    input.edit-input {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      margin-right: var(--spacing-lg);
      font-family: var(--font-primary);
      transition: all var(--transition-base);
      background: var(--color-white);
      color: var(--color-navy);
    }
    
    input.edit-input:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    #upgrade-btn {
      display: none !important;
      padding: var(--spacing-lg) var(--spacing-2xl);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-lg);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-base);
      width: 100%;
      margin-top: var(--spacing-lg);
      box-shadow: var(--shadow-colored);
    }
    
    #upgrade-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }
    
    .btn-form {
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      font-family: var(--font-primary);
    }
    
    #login-btn {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }
    
    #login-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* FIXED: Remove red background from logout link */
    #logout-btn {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: color var(--transition-base);
      font-weight: 500;
      background: none !important; /* Remove any background */
      border: none !important; /* Remove any border */
      padding: 0 !important; /* Remove any padding */
    }
    
    #logout-btn:hover {
      color: var(--color-teal);
    }
    
    #debug-toggle {
      background: var(--color-light-gray);
      color: var(--color-gray-dark);
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-sm);
      border: 1px solid var(--color-gray-light);
    }
    
    #debug-toggle:hover {
      background: var(--color-gray-light);
      transform: translateY(-1px);
    }
    
    #error {
      color: #c53030;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: #fed7d7;
      border-radius: var(--radius-md);
      border-left: 4px solid #c53030;
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-sm);
    }
    
    #success {
      color: #276749;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: #c6f6d5;
      border-radius: var(--radius-md);
      border-left: 4px solid #38a169;
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-sm);
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .usage-display {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .usage-bar {
      flex: 1;
      height: 8px;
      background: var(--color-light-gray);
      border-radius: var(--radius-full);
      overflow: hidden;
      max-width: 200px;
    }
    
    .usage-fill {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
      transition: width 0.5s ease;
    }
    
    .usage-text {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      font-weight: 500;
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      
      .pricing-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-lg);
      }
      
      .page-header h1 {
        font-size: var(--font-size-3xl);
      }
      
      .pricing-cards {
        grid-template-columns: 1fr;
      }
      
      .pricing-card.featured {
        transform: scale(1);
      }
      
      .form-section {
        padding: var(--spacing-xl);
      }
      
      .header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .profile-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
      }
      
      .profile-item.editing {
        margin: calc(var(--spacing-lg) * -1) calc(var(--spacing-xl) * -1);
        padding: var(--spacing-lg) var(--spacing-xl);
      }
      
      .label {
        min-width: auto;
      }
      
      .value {
        width: 100%;
        margin-right: 0;
      }
      
      .edit-btn, .save-btn, .cancel-btn {
        width: 100%;
        margin: var(--spacing-xs) 0 0 0;
      }
      
      input.edit-input {
        width: 100%;
        margin-right: 0;
        margin-bottom: var(--spacing-xs);
      }
      
      .btn-form {
        width: 100%;
      }
      
      #debug-toggle {
        margin-top: var(--spacing-xs);
      }
      
      .usage-bar {
        max-width: none;
      }

      .premium-card {
        height: auto;
        min-height: 320px;
        padding: 36px 20px;
      }

      .premium-badge {
        font-size: 16px;
        padding: 8px 20px;
      }

      .benefit-item {
        font-size: 13px;
      }

      .upgrade-button {
        font-size: 14px;
        padding: 12px 24px;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ===== FOOTER STYLES ===== */
    .footer {
      background: var(--color-white);
      border-top: 1px solid var(--color-light-gray);
      padding: var(--spacing-xl) 0;
      margin-top: var(--spacing-3xl);
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      text-align: center;
    }

    .footer-links {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .footer-link {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      font-weight: 500;
      transition: color var(--transition-base);
    }

    .footer-link:hover {
      color: var(--color-teal);
    }

    .footer-separator {
      color: var(--color-gray-light);
      font-size: var(--font-size-sm);
    }

    .footer-copyright {
      color: var(--color-gray-light);
      font-size: var(--font-size-xs);
      margin: 0;
    }

    /* Mobile footer adjustments */
    @media (max-width: 768px) {
      .footer {
        padding: var(--spacing-lg) 0;
        margin-top: var(--spacing-2xl);
      }

      .footer-content {
        padding: 0 var(--spacing-md);
      }

      .footer-links {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .footer-separator {
        display: none !important;
      }
    }

    /* ===== LOGIN FORM STYLES ===== */
    .login-form-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      padding: var(--spacing-xl);
    }

    .login-form-section {
      background: var(--color-white);
      padding: var(--spacing-3xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
      text-align: center;
      max-width: 400px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .login-form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .login-form-section:hover {
      border-color: var(--color-teal);
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .login-icon-header {
      margin-bottom: var(--spacing-xl);
    }

    .login-icon-circle {
      width: 64px;
      height: 64px;
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      box-shadow: var(--shadow-colored);
      animation: pulse 2s ease-in-out infinite;
    }

    .login-icon-emoji {
      font-size: var(--font-size-2xl);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .login-form-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--color-navy);
      margin: 0 0 var(--spacing-lg) 0;
      letter-spacing: -0.01em;
    }

    .login-form-text {
      font-size: var(--font-size-base);
      color: var(--color-gray);
      margin: 0 0 var(--spacing-2xl) 0;
      line-height: 1.6;
    }

    .login-form-button {
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg) var(--spacing-2xl);
      font-size: var(--font-size-base);
      font-weight: 600;
      font-family: var(--font-primary);
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-colored);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .login-form-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .login-form-button:hover::before {
      left: 100%;
    }

    .login-form-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .login-form-button:active {
      transform: translateY(0);
    }

    .login-form-button .button-icon {
      font-size: var(--font-size-lg);
    }

    /* Mobile responsive adjustments for login form */
    @media (max-width: 768px) {
      .login-form-container {
        padding: var(--spacing-lg);
        min-height: 50vh;
      }

      .login-form-section {
        padding: var(--spacing-2xl);
        max-width: none;
      }

      .login-icon-circle {
        width: 56px;
        height: 56px;
      }

      .login-icon-emoji {
        font-size: var(--font-size-xl);
      }

      .login-form-title {
        font-size: var(--font-size-xl);
      }

      .login-form-button {
        padding: var(--spacing-md) var(--spacing-xl);
      }
    }

    /* ===== CUSTOM NOTIFICATION SYSTEM ===== */
    .notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999999999;
      display: none !important;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--transition-base);
    }

    .notification-overlay.active {
      display: flex;
      opacity: 1;
    }

    .notification-modal {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
      text-align: center;
    }

    .notification-overlay.active .notification-modal {
      transform: scale(1) translateY(0);
    }

    .notification-icon {
      font-size: var(--font-size-4xl);
      margin-bottom: var(--spacing-lg);
      display: block;
    }

    .notification-icon.success {
      color: var(--color-teal);
    }

    .notification-icon.error {
      color: var(--color-coral);
    }

    .notification-icon.warning {
      color: #f59e0b;
    }

    .notification-icon.info {
      color: #3b82f6;
    }

    .notification-icon.question {
      color: #8b5cf6;
    }

    .notification-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-navy);
      margin-bottom: var(--spacing-md);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification-message {
      color: var(--color-gray-dark);
      font-size: var(--font-size-base);
      line-height: 1.6;
      margin-bottom: var(--spacing-xl);
    }

    .notification-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }

    .notification-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      min-width: 100px;
      font-family: var(--font-primary);
    }

    .notification-btn.primary {
      background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
      color: var(--color-white);
      box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.3);
    }

    .notification-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px -5px rgba(249, 115, 22, 0.4);
      background: linear-gradient(135deg, #fb923c 0%, #dc2626 100%);
    }

    .notification-btn.secondary {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-light-gray);
    }

    .notification-btn.secondary:hover {
      border-color: var(--color-teal);
      color: var(--color-teal);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .notification-modal {
        margin: var(--spacing-lg);
        padding: var(--spacing-xl);
      }

      .notification-buttons {
        flex-direction: column;
      }

      .notification-btn {
        width: 100%;
      }
    }

    /* ===== NETLIFY IDENTITY NAME FIELD VERBERGEN ===== */
    
    /* Verberg name field in Netlify Identity modal */
    .netlify-identity-widget input[name="name"],
    .netlify-identity-widget input[placeholder*="Name"],
    .netlify-identity-widget input[placeholder*="name"],
    .netlify-identity-widget label[for*="name"],
    .netlify-identity-widget .netlify-identity-item:has(input[name="name"]) {
      display: none !important;
    }
    
    /* Verberg ook de label/wrapper van name field */
    .netlify-identity-widget .netlify-identity-item:nth-child(1) {
      display: none !important;
    }
    
    /* Extra fallback selectors voor verschillende Netlify UI versies */
    .netlify-identity-widget [data-netlify-identity-signup] input[name="name"],
    .netlify-identity-widget [data-netlify-identity-signup] input[type="text"]:first-of-type,
    .netlify-identity-widget form input[name="name"],
    .netlify-identity-widget form input[type="text"]:first-child {
      display: none !important;
    }
    
    /* Verberg parent containers van name fields */
    .netlify-identity-widget div:has(input[name="name"]),
    .netlify-identity-widget .form-group:has(input[name="name"]),
    .netlify-identity-widget .field:has(input[name="name"]) {
      display: none !important;
    }

/* ===== NETLIFY IDENTITY MODAL CUSTOM STYLING ===== */

/* Modal overlay/backdrop */
.netlify-identity-widget {
  font-family: var(--font-primary) !important;
  backdrop-filter: blur(20px) !important;
  -webkit-backdrop-filter: blur(20px) !important;
}

/* ===== TERMS & CONDITIONS ACCEPTANCE TEXT ===== */
.netlify-identity-widget .termsAcceptance {
  margin-top: 10px;
  margin-bottom: 15px;
  font-size: 12px;
  color: #666;
  text-align: center;
  line-height: 1.5;
}

.netlify-identity-widget .termsAcceptance a {
  color: #14b8a6;
  text-decoration: underline;
}

.netlify-identity-widget .termsAcceptance a:hover {
  color: #0f766e;
}

/* Modal container iframe */
.netlify-identity-widget iframe {
  border-radius: var(--radius-xl) !important;
  box-shadow: var(--shadow-xl) !important;
  border: none !important;
  overflow: hidden !important;
}

/* Modal content styling */
.netlify-identity-widget .netlify-identity-modal,
.netlify-identity-widget div[data-netlify-identity-modal] {
  background: var(--color-white) !important;
  border-radius: var(--radius-xl) !important;
  font-family: var(--font-primary) !important;
  box-shadow: var(--shadow-xl) !important;
  border: 2px solid var(--color-light-gray) !important;
}

/* Modal headers */
.netlify-identity-widget h1,
.netlify-identity-widget h2,
.netlify-identity-widget h3 {
  color: var(--color-navy) !important;
  font-family: var(--font-secondary) !important;
  font-weight: 700 !important;
  letter-spacing: -0.01em !important;
  margin-bottom: var(--spacing-lg) !important;
}

/* Modal text/paragraphs */
.netlify-identity-widget p,
.netlify-identity-widget span,
.netlify-identity-widget div {
  color: var(--color-gray-dark) !important;
  font-family: var(--font-primary) !important;
  line-height: 1.6 !important;
}

/* Input fields */
.netlify-identity-widget input[type="email"],
.netlify-identity-widget input[type="password"],
.netlify-identity-widget input[type="text"] {
  padding: var(--spacing-md) var(--spacing-lg) !important;
  font-size: var(--font-size-base) !important;
  font-family: var(--font-primary) !important;
  border: 2px solid var(--color-light-gray) !important;
  border-radius: var(--radius-md) !important;
  background: var(--color-white) !important;
  color: var(--color-navy) !important;
  transition: all var(--transition-base) !important;
  margin-bottom: var(--spacing-md) !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.netlify-identity-widget input:focus {
  outline: none !important;
  border-color: var(--color-teal) !important;
  box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1) !important;
  transform: translateY(-2px) !important;
}

.netlify-identity-widget input::placeholder {
  color: var(--color-gray-light) !important;
}

/* Primary buttons (Login, Sign Up, etc.) */
.netlify-identity-widget button[type="submit"],
.netlify-identity-widget .btn,
.netlify-identity-widget button.btn-primary {
  background: var(--gradient-primary) !important;
  color: var(--color-white) !important;
  border: none !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-md) var(--spacing-xl) !important;
  font-size: var(--font-size-base) !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
  width: 100% !important;
  margin-bottom: var(--spacing-md) !important;
  box-shadow: var(--shadow-colored) !important;
  min-height: var(--touch-target) !important;
}

.netlify-identity-widget button[type="submit"]:hover,
.netlify-identity-widget .btn:hover,
.netlify-identity-widget button.btn-primary:hover {
  transform: translateY(-2px) !important;
  box-shadow: var(--shadow-lg) !important;
  opacity: 0.95 !important;
}

/* Secondary buttons */
.netlify-identity-widget button:not([type="submit"]):not(.btn-primary),
.netlify-identity-widget .btn-secondary {
  background: var(--color-white) !important;
  color: var(--color-navy) !important;
  border: 2px solid var(--color-light-gray) !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-lg) !important;
  font-size: var(--font-size-sm) !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
}

.netlify-identity-widget button:not([type="submit"]):hover {
  border-color: var(--color-teal) !important;
  color: var(--color-teal) !important;
  transform: translateY(-1px) !important;
}

/* Links in modal */
.netlify-identity-widget a {
  color: var(--color-teal) !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  font-family: var(--font-primary) !important;
  transition: color var(--transition-base) !important;
}

.netlify-identity-widget a:hover {
  color: var(--color-teal-dark) !important;
  text-decoration: underline !important;
}

/* Error messages */
.netlify-identity-widget .error,
.netlify-identity-widget [data-netlify-identity-error] {
  color: #c53030 !important;
  background: #fed7d7 !important;
  border: 1px solid #feb2b2 !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-md) !important;
  margin: var(--spacing-sm) 0 !important;
  font-size: var(--font-size-sm) !important;
  font-family: var(--font-primary) !important;
}

/* Success messages */
.netlify-identity-widget .success,
.netlify-identity-widget [data-netlify-identity-success] {
  color: #276749 !important;
  background: #c6f6d5 !important;
  border: 1px solid #9ae6b4 !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-md) !important;
  margin: var(--spacing-sm) 0 !important;
  font-size: var(--font-size-sm) !important;
  font-family: var(--font-primary) !important;
}

/* Close button */
.netlify-identity-widget .close,
.netlify-identity-widget button[aria-label="Close"] {
  background: var(--color-light-gray) !important;
  color: var(--color-gray-dark) !important;
  border: none !important;
  border-radius: var(--radius-full) !important;
  width: 32px !important;
  height: 32px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  position: absolute !important;
  top: var(--spacing-md) !important;
  right: var(--spacing-md) !important;
}

.netlify-identity-widget .close:hover {
  background: var(--color-gray-light) !important;
  transform: scale(1.1) !important;
}

/* Modal spacing and layout */
.netlify-identity-widget .netlify-identity-modal {
  padding: var(--spacing-2xl) !important;
  max-width: 400px !important;
  margin: 0 auto !important;
}

/* Form groups/sections */
.netlify-identity-widget .form-group,
.netlify-identity-widget .netlify-identity-item {
  margin-bottom: var(--spacing-lg) !important;
}

/* Tabs/navigation within modal */
.netlify-identity-widget .tabs,
.netlify-identity-widget nav {
  border-bottom: 2px solid var(--color-light-gray) !important;
  margin-bottom: var(--spacing-lg) !important;
}

.netlify-identity-widget .tab {
  color: var(--color-gray) !important;
  padding: var(--spacing-sm) var(--spacing-lg) !important;
  border-bottom: 2px solid transparent !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
  font-weight: 600 !important;
}

.netlify-identity-widget .tab.active,
.netlify-identity-widget .tab:hover {
  color: var(--color-teal) !important;
  border-bottom-color: var(--color-teal) !important;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .netlify-identity-widget .netlify-identity-modal {
    margin: var(--spacing-lg) !important;
    padding: var(--spacing-xl) !important;
    max-width: calc(100vw - 2rem) !important;
    border-radius: var(--radius-lg) !important;
  }
  
  .netlify-identity-widget button {
    min-height: var(--touch-target) !important;
    font-size: var(--font-size-base) !important;
  }
  
  .netlify-identity-widget input {
    min-height: var(--touch-target) !important;
    font-size: var(--font-size-base) !important;
  }

  /* Fix "By signing up..." text positioning on mobile - prevent overlap with Google button */
  /* Since the modal is in an iframe, we need a different approach */
}

/* Loading states */
.netlify-identity-widget .loading {
  opacity: 0.6 !important;
  pointer-events: none !important;
}

/* Social login buttons (if used) */
.netlify-identity-widget .btn-social {
  background: var(--color-white) !important;
  border: 2px solid var(--color-light-gray) !important;
  color: var(--color-navy) !important;
}

.netlify-identity-widget .btn-social:hover {
  border-color: var(--color-teal) !important;
  background: var(--color-off-white) !important;
}

/* Show the name field but make it optional */
.netlify-identity-widget input[name="name"],
.netlify-identity-widget input[placeholder="Nickname"],
.netlify-identity-widget .formGroup:first-child {
  display: block !important;
}

    
    .copy-btn {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      white-space: nowrap;
      box-shadow: var(--shadow-colored);
    }
    
    .copy-btn:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .copy-btn:active {
      transform: translateY(0);
    }
    
    .copy-btn.copied {
      background: var(--gradient-primary);
      color: var(--color-white);
    }
    
    .share-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-2xl);
      padding-top: var(--spacing-2xl);
      border-top: 1px solid var(--color-light-gray);
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .share-btn {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-md);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      justify-content: center;
      box-shadow: var(--shadow-colored);
    }
    
    .share-whatsapp {
      background: #25D366;
      color: white;
    }
    
    .share-whatsapp:hover {
      background: #1DA851;
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .share-twitter {
      background: #1DA1F2;
      color: white;
    }
    
    .share-twitter:hover {
      background: #1a8cd8;
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .share-email {
      background: var(--color-teal);
      color: white;
    }
    
    .share-email:hover {
      background: var(--color-teal-dark);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .copy-btn {
        width: 100%;
        justify-content: center;
      }
      
      .share-buttons {
        gap: var(--spacing-xs);
      }
      
      .share-btn {
        flex: 1;
        min-width: 100px;
        font-size: var(--font-size-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
      }
      
      .share-btn svg {
        width: 16px;
        height: 16px;
      }
    }

  </style>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D6T01M6XTJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D6T01M6XTJ');
  </script>
  <!-- Global Upgrade Popups -->
  <!-- DISABLED: <script src="js/upgrade-popups.js"></script> -->
</head>

<body>
  <!-- Custom Notification System -->
  <div class="notification-overlay" id="notificationOverlay">
    <div class="notification-modal">
      <span class="notification-icon" id="notificationIcon">âœ“</span>
      <h3 class="notification-title" id="notificationTitle">Success</h3>
      <p class="notification-message" id="notificationMessage">Operation completed successfully!</p>
      <div class="notification-buttons" id="notificationButtons">
        <button class="notification-btn primary" id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-container">
      <div class="header-content">
        <!-- Logo -->
        <a href="index.html" class="logo" aria-label="Narrin AI Home">Narrin AI</a>

        <!-- Desktop Navigation Center -->
        <nav class="nav-center" role="navigation" aria-label="Main navigation">
        </nav>

        <!-- Desktop Navigation Links -->
        <nav class="nav-links" role="navigation" aria-label="Secondary navigation">
          <a href="pricing.html" class="nav-link">Plans</a>
          <a href="chat-overview.html" class="nav-link">My Companions</a>
          <a href="profile.html" class="nav-link" id="loginBtn">Login/Register</a>
          <a href="/create-character" class="btn btn-primary">âœ¨ Create Companion</a>
        </nav>

        <!-- Mobile Navigation Container -->
        <div class="mobile-nav-container">
          <!-- Mobile Chat Button -->
          <a 
            href="chat-overview.html" 
            class="mobile-chat-btn"
            aria-label="Go to chats"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </a>

          <button 
            class="mobile-search-btn" 
            id="mobileSearchBtn"
            aria-label="Open search"
            aria-expanded="false"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>

          <!-- Mobile Hamburger Menu -->
          <button
            class="mobile-menu-btn"
            id="mobileMenuBtn"
            aria-label="Open navigation menu"
            aria-expanded="false"
          >
            <div class="hamburger">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
        </div>
      </div>
    </div>

  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-menu-logo">Narrin AI</div>
        <div class="mobile-menu-subtitle">AI Companion Platform</div>
      </div>
      <nav class="mobile-menu-nav" role="navigation" aria-label="Mobile navigation">
        <a href="chat-overview.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">ðŸ’¬</span>
          My Companions
        </a>
        <a href="pricing.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">ðŸ’Ž</span>
          Plans
        </a>
        <a href="profile.html" class="mobile-menu-link" id="mobileLoginBtn">
          <span class="mobile-menu-link-icon">ðŸ‘¤</span>
          Login/Register
        </a>
        <a href="/create-character" class="mobile-menu-link btn-primary">
          <span class="mobile-menu-link-icon">âœ¨</span>
          Create Companion
        </a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>My Profile</h1>
      <p>Manage your account settings and view your usage</p>
    </div>
    
    <div id="not-logged-in" style="display: none;">
      <div class="login-form-container">
        <div class="login-form-section">
          <div class="login-icon-header">
            <div class="login-icon-circle">
              <span class="login-icon-emoji">ðŸ”</span>
            </div>
          </div>
          <h2 class="login-form-title">Login/Register</h2>
          <p class="login-form-text">You must be logged in to view your profile.</p>
          <button class="login-form-button" onclick="openLogin()">
            <span class="button-icon">ðŸ‘¤</span>
            <span>Login/Register</span>
          </button>
        </div>
      </div>
    </div>
    
    <div id="profile" style="display: none;">
      <!-- Navigation Buttons -->
      <div class="profile-nav">
      </div>

      <!-- Welcome Message Section -->
      <div class="welcome-story" id="welcome-story">
        <h2>Welcome to Narrin.ai</h2>
        
        <!-- Trial Status for new users -->
        <div class="trial-status" id="trialStatus" style="display: none;">
          <div class="trial-info">
            <div class="trial-badge-large">ðŸŽ‰ 7-Day Free Trial Activated</div>
            <p class="trial-description">You now have full access to the Engage plan for <strong id="trialDaysRemaining">7</strong> <strong>days</strong>. Enjoy unlimited messaging and premium features!</p>
            <div class="trial-timer">
              <span class="timer-label">Trial ends:</span>
              <span class="timer-date" id="trialEndDate">-</span>
            </div>
          </div>
        </div>
        
        <div class="welcome-actions">
          <a href="/create-character" class="welcome-cta">Create Companion</a>
          <a href="index.html" class="text-link">Start Chatting</a>
        </div>
      </div>

      <!-- Pricing Plans Section -->
      <div class="pricing-container" id="pricing-section">
        <h2 class="pricing-title">Choose Your Plan</h2>
        
        
        <div class="pricing-cards">
          <!-- 7-Day Trial Plan (Free) -->
          <div class="pricing-card featured" data-plan="trial">
            <div class="card-header">
              <h3 class="plan-name">7-Day Free Trial</h3>
              <div class="plan-price">
                <span class="price-currency">$</span>
                <span class="price-amount">0</span>
                <span class="price-period">/7 days</span>
              </div>
              <span class="price-daily">Free for 7 days</span>
              <p class="plan-description">Experience the Engage Plan - no payment required</p>
            </div>
            
            <ul class="plan-features">
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">3 AI companions</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> messages</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">15 voice chats per month</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">15 voice notes per month</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Companion Memory</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Companion Customization</span>
              </li>
            </ul>
            
            <div class="card-action">
              <a href="index.html" class="plan-button upgrade-button" id="discoverButton">
                Active
              </a>
            </div>
            <div class="benefit-item trial-benefit">
              <span class="checkmark">âœ“</span>
              <span>Automatically expires without charging</span>
            </div>
          </div>
          
          <!-- Engage Plan -->
          <div class="pricing-card featured" data-plan="engage">
            <div class="card-badge">Most Popular</div>
            <div class="card-header">
              <h3 class="plan-name">Engage <span class="early-bird-badge">Limited Time Offer</span></h3>
              <div class="price-wrapper">
                <span class="original-price">$8.99</span>
                <div class="plan-price">
                  <span class="price-currency">$</span>
                  <span class="price-amount">6.99</span>
                  <span class="price-period">/month</span>
                </div>
              </div>
              <span class="price-daily">Only $0.23/day</span>
              <p class="plan-description">Unlimited conversations with your AI companion</p>
            </div>
            
            <ul class="plan-features">
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">3 AI companions</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> messages</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">15 voice chats per month</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">15 voice notes per month</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Companion Memory</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Companion Customization</span>
              </li>
            </ul>
            
            <div class="card-action">
              <button class="plan-button upgrade-button" id="engageButton" onclick="handleUpgrade('engage')">
                Upgrade to Engage
              </button>
              <div class="plan-active" id="engageActive" style="display: none;">
                <div class="active-badge">
                  âœ“ Active Plan
                </div>
              </div>
              <!-- Trial Notice for Engage -->
              <div id="engageTrialNotice" class="trial-notice" style="display: none;">
                <div class="trial-badge">ðŸŽ‰ Free Trial</div>
                <div class="benefit-item trial-benefit">
                  <span class="checkmark">âœ“</span>
                  <span>Your 7-day trial ends <strong id="engageTrialDate"></strong>. Automatically returns to free plan after trial.</span>
                </div>
              </div>
              <!-- Compact Cancellation Notice for Engage -->
              <div id="engageCancelNotice" class="compact-cancel-notice" style="display: none;">
                <span class="cancel-text">Access until <strong id="engageCancelDate"></strong> - subscription cancelled</span>
              </div>
            </div>
          </div>
          
          <!-- Immerse Plan -->
          <div class="pricing-card featured" data-plan="immerse">
            <div class="card-badge" style="white-space: nowrap; background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%);">Ultimate Experience</div>
            <div class="card-header">
              <h3 class="plan-name">Immerse <span class="early-bird-badge">Limited Time Offer</span></h3>
              <div class="price-wrapper">
                <span class="original-price">$14.99</span>
                <div class="plan-price">
                  <span class="price-currency">$</span>
                  <span class="price-amount">11.99</span>
                  <span class="price-period">/month</span>
                </div>
              </div>
              <span class="price-daily">Only $0.40/day</span>
              <p class="plan-description">The ultimate AI companion experience</p>
            </div>
            
            <ul class="plan-features">
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> AI companions</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> chat messages</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> voice chats</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text"><strong>Unlimited</strong> voice notes</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Character Memory</span>
              </li>
              <li class="feature-item">
                <span class="feature-icon">âœ“</span>
                <span class="feature-text">Extensive Companion Customization</span>
              </li>
              <li class="feature-item premium-feature">
                <span class="feature-icon">â­</span>
                <span class="feature-text">Early Access to new AI models</span>
              </li>
              <li class="feature-item premium-feature">
                <span class="feature-icon">â­</span>
                <span class="feature-text">Priority Support</span>
              </li>
            </ul>
            
            <div class="card-action">
              <button class="plan-button upgrade-button premium" id="immerseButton" onclick="handleUpgrade('immerse')">
                Upgrade to Immerse
              </button>
              <div class="plan-active" id="immerseActive" style="display: none;">
                <div class="active-badge">
                  âœ“ Active Plan
                </div>
              </div>
              <!-- Compact Cancellation Notice for Immerse -->
              <div id="immerseCancelNotice" class="compact-cancel-notice" style="display: none;">
                <span class="cancel-text">Access until <strong id="immerseCancelDate"></strong> - subscription cancelled</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-content" id="personal-info">
        <!-- Account Information -->
        <div class="form-section">
          <h2>Account Information</h2>
          
          <div class="profile-item" data-field="email">
            <span class="label">Email:</span>
            <span class="value" id="email">...</span>
            <button class="edit-btn" onclick="enableEdit('email')">Edit</button>
          </div>
          
          <div class="profile-item" data-field="nickname">
            <span class="label">Nickname:</span>
            <span class="value" id="nickname">...</span>
            <button class="edit-btn" onclick="enableEdit('nickname')">Edit</button>
          </div>
          
          <div class="profile-item" data-field="plan">
            <span class="label">Plan:</span>
            <span class="value" id="plan">...</span>
            <!-- No edit button for plan - will be replaced with upgrade/manage link later -->
          </div>
          
          <div class="profile-item" data-field="usage">
            <span class="label">Usage:</span>
            <div class="value">
              <div class="usage-display">
                <span class="usage-text">
                  <span id="usage">...</span> / <span id="quota">...</span> messages
                </span>
                <div class="usage-bar">
                  <div class="usage-fill" id="usage-fill" style="width: 0%"></div>
                </div>
              </div>
              <div id="reset-countdown" style="font-size: 12px; color: var(--color-gray); margin-top: 8px; display: none;"></div>
            </div>
          </div>
          
          <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--color-light-gray); text-align: center;">
            <a href="#" id="logout-btn">
              Log out
            </a>
          </div>
        </div>


        <!-- Invite Friends Section -->
        <div class="invite-section">
          <div class="invite-header">
            <span class="invite-icon">ðŸ“§</span>
            <h3 class="invite-title">Invite Friends</h3>
          </div>
          <p class="invite-description">
            Share Narrin AI with your friends! Choose how you'd like to share:
          </p>
          <div class="invite-actions">
            <button class="invite-action-btn" onclick="shareViaEmail()">
              ðŸ“§ Share via Email
            </button>
            <button class="invite-action-btn" onclick="shareViaWhatsApp()">
              ðŸ’¬ Share via WhatsApp
            </button>
            <button class="invite-action-btn" onclick="copyInviteLink()">
              ðŸ”— Copy Invite Link
            </button>
          </div>
          <div class="invite-feedback" id="inviteFeedback"></div>
        </div>
      </div>
      
      
      <div id="error" style="display:none;"></div>
      <div id="success" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ===== UNIVERSAL AUTHENTICATION CHECK FUNCTION =====
    function initializeAuthenticationCheck() {
      console.log('ðŸ” Initializing universal authentication check...');
      
      // Check localStorage first for faster response
      const storedEmail = localStorage.getItem('user_email');
      const storedToken = localStorage.getItem('user_token');
      const storedUid = localStorage.getItem('user_uid');
      const authTimestamp = localStorage.getItem('user_auth_timestamp');
      
      if (storedEmail && storedToken && storedUid && authTimestamp) {
        // Check if token is still valid (24 hours)
        const tokenAge = Date.now() - parseInt(authTimestamp);
        const maxAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        if (tokenAge < maxAge) {
          console.log('âœ… Valid authentication found in localStorage');
          
          // Check trial status for authenticated users
          checkTrialStatus(storedEmail, storedUid);
          
          return true;
        } else {
          console.log('âš ï¸ Stored authentication expired, clearing...');
          clearAuthData();
        }
      }
      
      // Fallback to Netlify Identity current user
      if (window.netlifyIdentity) {
        const currentUser = window.netlifyIdentity.currentUser();
        if (currentUser) {
          console.log('âœ… Valid Netlify Identity user found');
          handleLoginSuccess(currentUser);
          return true;
        }
      }
      
      console.log('âŒ No valid authentication found');
      return false;
    }

    function handleLoginSuccess(user) {
      // Get email from various possible locations (Google login fix)
      console.log('ðŸ“± handleLoginSuccess (first function) - Platform:', {
        isMobile: window.innerWidth <= 768,
        userObject: user,
        userEmail: user?.email
      });
      
      // ENHANCED: For Google SSO, check all possible email locations
      let email = null;
      
      // Try all possible email locations in order of preference
      const emailSources = [
        user.email,
        user.user_metadata?.email,
        user.user_metadata?.email_address,
        user.user_metadata?.full_name, // Sometimes Google puts email in full_name
        user.app_metadata?.email,
        user.app_metadata?.provider_data?.email
      ];
      
      // Find first valid email
      for (const source of emailSources) {
        if (source && source.includes('@')) {
          email = source;
          console.log('âœ… Found email from source:', source);
          break;
        }
      }
      
      // If still no email, try to extract from any field that might contain it
      if (!email) {
        const userString = JSON.stringify(user);
        const emailMatch = userString.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
        if (emailMatch) {
          email = emailMatch[0];
          console.log('âœ… Extracted email from user data:', email);
        }
      }
      
      // Final fallback
      if (!email) {
        email = localStorage.getItem('user_email') || 'unknown@email.com';
      }
                    
      // Netlify Identity user object structure can vary - extract ID properly
      let userId = user.id;
      
      // If user.id is not directly available, extract from JWT token
      if (!userId && user.token?.access_token) {
        try {
          const tokenParts = user.token.access_token.split('.');
          const payload = JSON.parse(atob(tokenParts[1]));
          userId = payload.sub; // 'sub' field contains the user ID
          console.log('âœ… Extracted user ID from JWT:', userId);
          
          // Also get email from JWT if not found earlier
          if ((!email || email === 'unknown@email.com') && payload.email) {
            email = payload.email;
            console.log('âœ… Also found email in JWT:', email);
          }
        } catch (e) {
          console.error('âŒ Failed to parse JWT:', e);
        }
      }
      
      // Another fallback - check for _id property
      if (!userId && user._id) {
        userId = user._id;
      }
      
      if (!userId) {
        console.error('âŒ CRITICAL: Could not extract user ID from Netlify Identity');
        console.error('âŒ User object structure:', Object.keys(user));
        return; // Don't continue without a valid user ID
      }
      
      console.log('âœ… Got Netlify UID:', userId);
      
      console.log('ðŸ’¾ Storing authentication data for:', email);
      console.log('ðŸ” User object structure:', {
        hasEmail: !!user.email,
        hasId: !!user.id,
        hasUserMetadata: !!user.user_metadata,
        email: email,
        userId: userId
      });
      
      // Store authentication data with timestamp
      localStorage.setItem('user_email', email);
      localStorage.setItem('user_token', user.token?.access_token || user.access_token);
      localStorage.setItem('user_uid', userId);
      localStorage.setItem('user_auth_timestamp', Date.now().toString());
      
      // Store additional user data if available
      if (user.user_metadata) {
        localStorage.setItem('user_metadata', JSON.stringify(user.user_metadata));
      }
      
      console.log('âœ… Authentication data stored successfully');
    }

    function clearAuthData() {
      console.log('ðŸ§¹ Clearing authentication data...');
      
      // Clear all auth-related localStorage items
      const authKeys = [
        'user_email',
        'user_token',
        'user_uid',
        'user_auth_timestamp',
        'user_metadata',
        'user_refresh_token',
        'user_netlify_data'
      ];
      
      authKeys.forEach(key => {
        localStorage.removeItem(key);
      });
      
      console.log('âœ… Authentication data cleared');
    }

    // ===== STRIPE CONFIGURATION =====
    const stripe = Stripe('pk_live_jz2dXpzmEDUahXkKkyUe36Zt');
    const PRICE_ID = 'price_1Rx75wDU567HpUYxekUyZ62T'; // Product: prod_SWrbnoc0ywWqOL

    // ===== ENHANCED GLOBAL STATE - VOORKOMT DUBBELE RECORDS =====
    let isEditing = false;
    let currentEditingField = null;
    let originalValue = null;
    let netlifyUser = null;

    // Enhanced global state om dubbele calls te voorkomen
    let isProcessingAuth = false;
    let authProcessTimeout = null;
    let lastProcessedUser = null; // Track laatste geprocesste user
    let authCallLock = false; // Extra lock mechanisme
    let registrationInProgress = false; // NEW: Track if registration is in progress

    // Verbeterde webhook call cache
    const webhookCallCache = new Map();
    const CACHE_DURATION = 30000; // Verhoogd naar 30 seconden om dubbele calls te voorkomen

    // ===== VERBETERDE DEBOUNCING FUNCTIE =====
    function shouldAllowWebhookCall(type, email, userId) {
      const key = `${type}_${email}_${userId}`;
      const lastCall = webhookCallCache.get(key);
      const now = Date.now();
      
      if (lastCall && (now - lastCall) < CACHE_DURATION) {
        console.log(`ðŸš« BLOCKED: Duplicate ${type} call for ${email} (last call: ${now - lastCall}ms ago)`);
        return false;
      }
      
      webhookCallCache.set(key, now);
      console.log(`âœ… ALLOWED: ${type} call for ${email}`);
      return true;
    }

    // ===== NIEUWE FUNCTIE: Check if user was already processed =====
    function wasUserAlreadyProcessed(user) {
      if (!lastProcessedUser) return false;
      
      const sameUser = lastProcessedUser.id === user.id && 
                       lastProcessedUser.email === user.email;
      
      if (sameUser) {
        console.log(`ðŸš« User ${user.email} was already processed recently`);
        return true;
      }
      
      return false;
    }

    // ===== WEBHOOK CALL LOGGING =====
    function logWebhookCall(type, email, payload) {
      const timestamp = new Date().toISOString();
      console.log(`ðŸ“Š WEBHOOK CALL LOG [${timestamp}]:`, {
        type,
        email,
        isProcessingAuth,
        payload: JSON.stringify(payload, null, 2)
      });
    }

    // ===== CUSTOM NOTIFICATION SYSTEM =====
    function showNotification(type, title, message, buttons = null) {
      const overlay = document.getElementById('notificationOverlay');
      const icon = document.getElementById('notificationIcon');
      const titleEl = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');
      const buttonsEl = document.getElementById('notificationButtons');
      
      // Set icon based on type
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸',
        question: 'â“'
      };
      
      icon.textContent = icons[type] || icons.info;
      icon.className = `notification-icon ${type}`;
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // Set up buttons
      if (buttons) {
        buttonsEl.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.className = `notification-btn ${button.type || 'secondary'}`;
          btn.textContent = button.text;
          btn.onclick = () => {
            hideNotification();
            if (button.callback) button.callback();
          };
          buttonsEl.appendChild(btn);
        });
      } else {
        // Default OK button
        buttonsEl.innerHTML = '<button class="notification-btn primary" onclick="hideNotification()">OK</button>';
      }
      
      // Show notification
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function hideNotification() {
      const overlay = document.getElementById('notificationOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Custom confirm replacement
    function customConfirm(message, title = 'Confirm', onConfirm = null, onCancel = null) {
      const buttons = [
        {
          text: 'Cancel',
          type: 'secondary',
          callback: onCancel
        },
        {
          text: 'Confirm',
          type: 'primary',
          callback: onConfirm
        }
      ];
      showNotification('question', title, message, buttons);
    }
    
    // Success notification
    function showSuccess(message, title = 'Success') {
      showNotification('success', title, message);
    }
    
    // Error notification
    function showError(message, title = 'Error') {
      showNotification('error', title, message);
    }

    // ===== NAVIGATION FUNCTIONALITY =====
    
    // Mobile Search Elements
    const mobileSearchBtn = document.getElementById('mobileSearchBtn');
    const mobileSearchOverlay = document.getElementById('mobileSearchOverlay');
    const mobileSearchInput = document.getElementById('mobileSearchInput');
    
    // Mobile Menu Elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    // USP Carousel Elements
    const uspTrack = document.getElementById('uspTrack');
    let currentUspIndex = 0;
    let uspInterval;

    // ===== STRIPE UPGRADE FUNCTIONALITY =====
    window.handleUpgrade = async function(planType = 'engage') {
      console.log('ðŸš€ Upgrade button clicked for plan:', planType);
      
      // Check if plan is available - Immerse is now available
      // if (planType === 'immerse') {
      //   showInfo('The Immerse plan will be available soon!');
      //   return;
      // }
      
      // Check of gebruiker ingelogd is
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      
      if (!email || !uid) {
        showError('You must be logged in to upgrade');
        openLogin();
        return;
      }
      
      try {
        // Get the specific button that was clicked
        const upgradeButton = planType === 'engage' 
          ? document.getElementById('engageButton')
          : document.getElementById('immerseButton');
        
        const originalText = upgradeButton.innerHTML;
        upgradeButton.innerHTML = 'Processing...';
        upgradeButton.disabled = true;
        
        console.log('ðŸ“¡ Creating checkout session...');
        
        // Use different price IDs based on plan
        let priceId = PRICE_ID; // Default to Engage plan
        if (planType === 'immerse') {
          priceId = 'price_1Rx774DU567HpUYxf0mAZInC'; // Immerse plan price ID
        }
        
        // FIRST: Cancel any existing subscriptions to prevent multiple subscriptions
        const stripeCustomerId = localStorage.getItem('stripe_customer_id');
        if (stripeCustomerId) {
          console.log('ðŸš« Cancelling existing subscriptions before upgrade...');
          
          // Store info about what plan is being cancelled
          const currentPlan = localStorage.getItem('user_plan') || 'Unknown';
          
          try {
            const cancelResponse = await fetch('/.netlify/functions/cancel-subscription', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customer_id: stripeCustomerId,
                user_uid: uid
              })
            });
            
            const cancelResult = await cancelResponse.json();
            
            if (cancelResponse.ok) {
              console.log('âœ… Existing subscriptions cancelled:', cancelResult);
              
              // Store info about cancelled plan for showing correct notice
              if (cancelResult.subscriptions_cancelled && cancelResult.subscriptions_cancelled[0]) {
                const cancelData = cancelResult.subscriptions_cancelled[0];
                if (cancelData.cancel_at_date) {
                  localStorage.setItem('subscription_cancel_at', cancelData.cancel_at_date);
                  localStorage.setItem('cancelled_plan_type', currentPlan); // Store which plan was cancelled
                }
              }
            } else {
              console.warn('âš ï¸ Failed to cancel existing subscriptions:', cancelResult);
              // Continue with upgrade anyway - Stripe will handle duplicates
            }
            
          } catch (cancelError) {
            console.warn('âš ï¸ Error cancelling existing subscriptions:', cancelError);
            // Continue with upgrade anyway
          }
        }
        
        // THEN: Redirect to Stripe Checkout for new subscription
        const { error } = await stripe.redirectToCheckout({
          lineItems: [{
            price: priceId,
            quantity: 1,
          }],
          mode: 'subscription',
          successUrl: `${window.location.origin}/profile.html?upgrade=success&plan=${planType}`,
          cancelUrl: `${window.location.origin}/profile.html?upgrade=cancelled`,
          customerEmail: email,
          clientReferenceId: uid // NetlifyUID wordt gebruikt voor identificatie
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
      } catch (error) {
        console.error('âŒ Error creating checkout session:', error);
        showError(`Upgrade error: ${error.message}`);
        
        // Reset button
        const upgradeButton = planType === 'engage' 
          ? document.getElementById('engageButton')
          : document.getElementById('immerseButton');
        upgradeButton.innerHTML = 'Upgrade to ' + (planType === 'engage' ? 'Engage' : 'Immerse');
        upgradeButton.disabled = false;
      }
    }

    // Functie om upgrade status te checken bij page load
    function checkUpgradeStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const upgradeStatus = urlParams.get('upgrade');
      const downgradeStatus = urlParams.get('downgrade');
      
      if (upgradeStatus === 'success') {
        showSuccess('ðŸŽ‰ Upgrade successful! Welcome to your new plan!');
        
        // BELANGRIJKE TOEVOEGING: Automatisch profile data refreshen
        setTimeout(() => {
          console.log('ðŸ”„ Refreshing profile data after upgrade...');
          loadProfile(); // Force refresh van profile data
        }, 2000); // 2 seconde delay zodat webhook verwerkt is
        
        // Clean URL
        window.history.replaceState({}, document.title, 'profile.html');
        
      } else if (upgradeStatus === 'cancelled') {
        showError('Upgrade was cancelled. You can try again anytime.');
        window.history.replaceState({}, document.title, 'profile.html');
      } else if (downgradeStatus === 'success') {
        // Store downgrade flag for loadProfile to use
        sessionStorage.setItem('justDowngraded', 'true');
        
        // Clean URL
        window.history.replaceState({}, document.title, 'profile.html');
      }
    }
    
    // ===== INVITE FUNCTIONALITY =====
    function getInviteLink() {
      return `https://narrin.ai?ref=invite`;
    }
    
    function shareViaEmail() {
      const inviteLink = getInviteLink();
      const currentUser = window.netlifyIdentity?.currentUser();
      const inviterName = currentUser?.email?.split('@')[0] || 'A friend';
      
      const subject = "You're invited to join Narrin AI!";
      const body = `Hi!

${inviterName} thinks you'll love Narrin AI, where you can chat with over 1000+ unique AI characters. Each character has their own personality and can help with everything from creative writing to learning new skills.

Join me here: ${inviteLink}

What you'll get:
- ðŸ¤– 1000+ unique AI characters
- ðŸ’¬ 10 free messages to start
- ðŸ§  Smart memory system
- âœ¨ Personalized conversations

See you there!`;
      
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      showInviteFeedback('success', 'Email client opened with invitation!');
    }
    
    function shareViaWhatsApp() {
      const inviteLink = getInviteLink();
      const message = `Check out Narrin AI! Chat with 1000+ unique AI characters ðŸ¤–âœ¨

Each character has their own personality and expertise. It's like having a team of experts and friends at your fingertips!

Join here: ${inviteLink}`;
      
      // Detect if mobile or desktop
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const whatsappUrl = isMobile 
        ? `whatsapp://send?text=${encodeURIComponent(message)}`
        : `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`;
      
      window.open(whatsappUrl, '_blank');
      showInviteFeedback('success', 'Opening WhatsApp...');
    }
    
    async function copyInviteLink() {
      const inviteLink = getInviteLink();
      
      try {
        await navigator.clipboard.writeText(inviteLink);
        showInviteFeedback('success', 'Invite link copied to clipboard!');
      } catch (error) {
        // Fallback for older browsers
        showInviteFeedback('info', `Copy this link: ${inviteLink}`);
      }
    }
    
    function shareViaWhatsApp() {
      const inviteLink = getInviteLink();
      const message = `Check out Narrin AI! Chat with 1000+ unique AI characters ðŸ¤–âœ¨\n\nJoin here: ${inviteLink}`;
      
      // Detect if mobile or desktop
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const whatsappUrl = isMobile 
        ? `whatsapp://send?text=${encodeURIComponent(message)}`
        : `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`;
      
      window.open(whatsappUrl, '_blank');
    }
    
    function showInviteFeedback(type, message) {
      const feedbackEl = document.getElementById('inviteFeedback');
      feedbackEl.className = `invite-feedback ${type}`;
      feedbackEl.textContent = message;
      feedbackEl.style.display = 'block';
      
      // Hide feedback after 5 seconds
      setTimeout(() => {
        feedbackEl.style.display = 'none';
      }, 5000);
    }
    
    
    
    function copyToClipboard(text, message) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess(message);
        
        // Add visual feedback to button
        const btn = event.target.closest('.copy-btn');
        if (btn) {
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 2000);
        }
      }).catch(err => {
        console.error('Failed to copy:', err);
        showError('Failed to copy to clipboard');
      });
    }
    
    
    

    // ===== MOBILE SEARCH FUNCTIONALITY =====
    function toggleMobileSearch() {
      const isActive = mobileSearchOverlay.classList.contains('active');
      
      if (isActive) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      } else {
        // Close mobile menu if open
        closeMobileMenu();
        
        mobileSearchOverlay.classList.add('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'true');
        mobileSearchInput.focus();
      }
    }

    mobileSearchBtn?.addEventListener('click', toggleMobileSearch);

    // ===== MOBILE MENU FUNCTIONALITY =====
    function toggleMobileMenu() {
      const isActive = mobileMenuOverlay.classList.contains('active');
      
      if (isActive) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    }

    function openMobileMenu() {
      // Close search overlay if open
      if (mobileSearchOverlay && mobileSearchOverlay.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        if (mobileSearchBtn) mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
      
      mobileMenuOverlay.classList.add('active');
      mobileMenuBtn.classList.add('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      mobileMenuOverlay.classList.remove('active');
      mobileMenuBtn.classList.remove('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }

    mobileMenuBtn?.addEventListener('click', toggleMobileMenu);

    // Close menu when clicking on overlay background
    mobileMenuOverlay?.addEventListener('click', (e) => {
      if (e.target === mobileMenuOverlay) {
        closeMobileMenu();
      }
    });

    // Close menu when clicking on a menu item
    document.querySelectorAll('.mobile-menu-link').forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });

    // Close search and menu on outside click
    document.addEventListener('click', (e) => {
      // Close search overlay
      if (!mobileSearchOverlay?.contains(e.target) &&
          !mobileSearchBtn?.contains(e.target) &&
          mobileSearchOverlay?.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (mobileMenuOverlay.classList.contains('active')) {
          closeMobileMenu();
        }
        if (mobileSearchOverlay.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // ===== USP CAROUSEL FUNCTIONALITY =====
    function startUspCarousel() {
      if (window.innerWidth <= 768 && uspTrack) {
        uspInterval = setInterval(() => {
          currentUspIndex = (currentUspIndex + 1) % 3;
          uspTrack.style.transform = `translateY(-${currentUspIndex * 33.333}%)`;
        }, 3000);
      }
    }

    function stopUspCarousel() {
      if (uspInterval) {
        clearInterval(uspInterval);
        uspInterval = null;
      }
    }

    // Handle responsive behavior
    function handleResize() {
      if (window.innerWidth > 768) {
        stopUspCarousel();
        if (uspTrack) {
          uspTrack.style.transform = '';
        }
        if (mobileSearchOverlay?.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn?.setAttribute('aria-expanded', 'false');
        }
        if (mobileMenuOverlay?.classList.contains('active')) {
          closeMobileMenu();
        }
      } else {
        startUspCarousel();
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      handleResize();
    });

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(handleResize, 250);
    });

    // ===== SEARCH FUNCTIONALITY =====
    function handleSearch(searchTerm) {
      if (!searchTerm || !searchTerm.trim()) {
        console.log('Empty search term, ignoring');
        return;
      }
      
      const trimmedTerm = searchTerm.trim();
      console.log('Redirecting to search results for:', trimmedTerm);
      window.location.href = `search-results.html?q=${encodeURIComponent(trimmedTerm)}`;
    }

    // Desktop search
    document.querySelector('.nav-search')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.nav-search-input');
      handleSearch(searchInput.value);
    });

    // Mobile search
    document.querySelector('.mobile-search-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.mobile-search-input');
      handleSearch(searchInput.value);
      toggleMobileSearch();
    });

    // ===== PROFILE FUNCTIONALITY =====

    // Utility function to detect mobile
    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Enhanced redirect handling
    function setupRedirectHandling() {
      // Only store redirect URL if user is not already logged in
      // This prevents storing redirect URLs when users come to register
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      if (!user && document.referrer && document.referrer !== window.location.href) {
        const referrer = new URL(document.referrer);
        // Only store if it's from the same domain and not already the profile page
        if (referrer.hostname === window.location.hostname && 
            !referrer.pathname.includes('profile.html')) {
          // Check if this is likely a signup scenario (coming from homepage)
          if (referrer.pathname === '/' || referrer.pathname === '/index.html') {
            console.log('ðŸš« Not storing homepage as redirect URL (likely signup scenario)');
            return;
          }
          localStorage.setItem('login_redirect_url', document.referrer);
          console.log('ðŸ”„ Stored redirect URL:', document.referrer);
        }
      }
    }

    // ===== GEFIXTE handleAuthEvent functie =====
    function handleAuthEvent(user, eventType) {
      console.log(`ðŸ“¥ Auth event received: ${eventType} for ${user.email}`);
      
      // EERSTE CHECK: Is er al een call bezig?
      if (isProcessingAuth || authCallLock) {
        console.log(`âš ï¸ REJECTED: Auth already being processed (isProcessing: ${isProcessingAuth}, lock: ${authCallLock})`);
        return;
      }

      // TWEEDE CHECK: Was deze user net al geprocessed?
      if (wasUserAlreadyProcessed(user)) {
        console.log(`âš ï¸ REJECTED: User was already processed recently`);
        return;
      }

      // DERDE CHECK: Debouncing check
      if (!shouldAllowWebhookCall('auth', user.email, user.id)) {
        console.log(`âš ï¸ REJECTED: Blocked by debouncing`);
        return;
      }

      // SET LOCKS
      isProcessingAuth = true;
      authCallLock = true;
      lastProcessedUser = user;
      netlifyUser = user;

      console.log(`ðŸ”’ PROCESSING: ${eventType} for user ${user.email}`);

      // Clear eventuele vorige timeout
      if (authProcessTimeout) {
        clearTimeout(authProcessTimeout);
      }

      // Process de auth
      try {
        handleLoginSuccess(user, eventType);
        window.netlifyIdentity.close();
        updateLoginButton();
      } catch (error) {
        console.error('âŒ Error in handleAuthEvent:', error);
      }

      // Reset locks na vertraging
      authProcessTimeout = setTimeout(() => {
        console.log('ðŸ”“ Resetting auth locks after timeout');
        isProcessingAuth = false;
        authCallLock = false;
      }, 15000); // 15 seconden timeout
    }

    // GEFIXTE versie van handleLoginSuccess functie
function handleLoginSuccess(user, eventType = 'unknown') {
  // Remove the terms notice immediately on successful login
  const fixedNotice = document.getElementById('fixed-terms-notice');
  if (fixedNotice) {
    fixedNotice.remove();
    console.log('âœ… Removed terms notice after successful login');
  }
  
  // Debug logging to see what Google provides
  console.log('ðŸ” Full user object:', JSON.stringify(user, null, 2));
  console.log('ðŸ” User email:', user.email);
  console.log('ðŸ” User id:', user.id);
  console.log('ðŸ” User user_metadata:', user.user_metadata);
  
  // Get email from various possible locations
  // Enhanced debugging for mobile vs desktop issue
  console.log('ðŸ“± Platform check:', {
    isMobile: window.innerWidth <= 768,
    screenWidth: window.innerWidth,
    userAgent: navigator.userAgent
  });
  
  // ENHANCED: For Google SSO, check all possible email locations
  let email = null;
  
  // Try all possible email locations in order of preference
  const emailSources = [
    user.email,
    user.user_metadata?.email,
    user.user_metadata?.email_address,
    user.user_metadata?.full_name, // Sometimes Google puts email in full_name
    user.app_metadata?.email,
    user.app_metadata?.provider_data?.email
  ];
  
  // Find first valid email
  for (const source of emailSources) {
    if (source && source.includes('@')) {
      email = source;
      console.log('âœ… Found email from source:', source);
      break;
    }
  }
  
  // If still no email, try to extract from any field that might contain it
  if (!email) {
    const userString = JSON.stringify(user);
    const emailMatch = userString.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
    if (emailMatch) {
      email = emailMatch[0];
      console.log('âœ… Extracted email from user data:', email);
    }
  }
  
  // Final fallback
  if (!email) {
    email = localStorage.getItem('user_email') || 'unknown@email.com';
  }
                
  console.log('ðŸ“§ Email resolution:', {
    finalEmail: email,
    sources: {
      'user.email': user.email,
      'user_metadata.email': user.user_metadata?.email,
      'localStorage': localStorage.getItem('user_email')
    }
  });
  
  // Netlify Identity user object structure can vary - extract ID properly
  let userId = user.id;
  
  // If user.id is not directly available, extract from JWT token
  if (!userId && user.token?.access_token) {
    try {
      const tokenParts = user.token.access_token.split('.');
      const payload = JSON.parse(atob(tokenParts[1]));
      userId = payload.sub; // 'sub' field contains the user ID
      console.log('âœ… Extracted user ID from JWT:', userId);
      
      // Also get email from JWT if not found earlier
      if ((!email || email === 'unknown@email.com') && payload.email) {
        email = payload.email;
        console.log('âœ… Also found email in JWT:', email);
      }
    } catch (e) {
      console.error('âŒ Failed to parse JWT:', e);
    }
  }
  
  // Another fallback - check for _id property
  if (!userId && user._id) {
    userId = user._id;
  }
  
  if (!userId) {
    console.error('âŒ CRITICAL: Could not extract user ID from Netlify Identity');
    console.error('âŒ User object structure:', Object.keys(user));
    return; // Don't continue without a valid user ID
  }
  
  console.log('âœ… Got Netlify UID:', userId);
  
  console.log(`âœ… handleLoginSuccess called for: ${email} (${eventType})`);
  
  // KRITIEKE FIX: Betere token storage
  const accessToken = user.token?.access_token || user.access_token;
  const refreshToken = user.token?.refresh_token || user.refresh_token;
  
  if (!accessToken) {
    console.error('âŒ No access token found in user object');
    return;
  }
  
  // Store ALL noodzakelijke authentication data
  localStorage.setItem('user_email', email);
  localStorage.setItem('user_token', accessToken);
  localStorage.setItem('user_uid', userId);
  localStorage.setItem('user_auth_timestamp', Date.now().toString());
  
  // NIEUW: Store refresh token als beschikbaar
  if (refreshToken) {
    localStorage.setItem('user_refresh_token', refreshToken);
  }
  
  // NIEUW: Store complete user object voor recovery
  try {
    localStorage.setItem('user_netlify_data', JSON.stringify({
      id: user.id,
      email: user.email,
      user_metadata: user.user_metadata || {},
      app_metadata: user.app_metadata || {},
      created_at: user.created_at,
      updated_at: user.updated_at
    }));
  } catch (e) {
    console.warn('Could not store user data:', e);
  }
  
  console.log('ðŸ’¾ Authentication data stored successfully');
  
  // Rest van de functie blijft hetzelfde...
  if (eventType === 'signup') {
    console.log('ðŸ†• NEW SIGNUP: Will create user in Airtable');
    // Clear any redirect URL for signup to prevent redirects
    localStorage.removeItem('login_redirect_url');
    
    // CRITICAL FIX: Add small delay to ensure localStorage is properly set
    setTimeout(() => {
      console.log('â° Delayed createOrUpdateUser call to ensure localStorage is ready');
      createOrUpdateUser(user, true);
    }, 500); // 500ms delay to ensure localStorage operations complete
  } else if (eventType === 'login') {
    console.log('ðŸ”„ EXISTING LOGIN: Loading profile without webhook call');
    showProfileUI();
    loadProfile();
    initializeInviteForm();
    // TEMPORARY: Log redirect check
    console.log('ðŸ” Checking for post-login redirect...');
    handlePostLoginRedirect();
  } else {
    console.log('ðŸ¤” UNKNOWN EVENT TYPE: Defaulting to profile load');
    showProfileUI();
    loadProfile();
    initializeInviteForm();
  }
  
  updateLoginButton();
  
  setTimeout(() => {
    console.log('ðŸ”“ Auth processing completed - resetting flags');
    isProcessingAuth = false;
    authCallLock = false;
  }, 2000);
}

    // New function to handle post-login redirect
    function handlePostLoginRedirect() {
      // Check sessionStorage first for new redirect flow
      const returnTo = sessionStorage.getItem('return_to');
      const returnCharacter = sessionStorage.getItem('return_character');
      const pendingOnboarding = sessionStorage.getItem('pending_onboarding');
      const pendingCharacter = sessionStorage.getItem('pending_character');
      
      console.log('ðŸ” Post-login redirect check:', {
        returnTo: returnTo,
        returnCharacter: returnCharacter,
        hasPendingOnboarding: !!pendingOnboarding,
        pendingCharacter: pendingCharacter
      });
      
      // Handle redirect based on where user came from
      if (returnTo === 'chat' && returnCharacter) {
        // User was trying to access chat
        sessionStorage.removeItem('return_to');
        sessionStorage.removeItem('return_character');
        // Keep pending_onboarding if it exists - chat.html will handle it
        
        showSuccess('Login successful! Redirecting to chat...');
        setTimeout(() => {
          window.location.href = `/chat.html?char=${returnCharacter}`;
        }, 100);
      } else if (returnTo === 'create-character') {
        // User was trying to create a character
        sessionStorage.removeItem('return_to');
        
        showSuccess('Login successful! Redirecting to create character...');
        setTimeout(() => {
          window.location.href = '/create-character';
        }, 100);
      } else {
        // Check legacy localStorage redirect
        const redirectUrl = localStorage.getItem('login_redirect_url');
        
        if (redirectUrl && redirectUrl !== window.location.href) {
          localStorage.removeItem('login_redirect_url');
          showSuccess('Login successful! Redirecting back...');
          
          setTimeout(() => {
            console.log('ðŸ”„ Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
          }, 100);
        } else {
          // No specific redirect, stay on profile page but show success
          showSuccess('Welcome to your profile!');
        }
      }
    }

    // ===== AANGEPASTE createOrUpdateUser functie =====
    async function createOrUpdateUser(user, isNewUser = false) {
      // CRITICAL FIX: Get email and userId from localStorage first, fallback to user object
      let email = localStorage.getItem('user_email') || user.email;
      let userId = localStorage.getItem('user_uid') || user.id;
      
      // If still no email, try to extract from user object in different ways
      if (!email || email === 'unknown@email.com') {
        email = user.email || 
                user.user_metadata?.email || 
                user.user_metadata?.email_address ||
                'unknown@email.com';
                
        // For Google SSO, check if email is in the user object as a string
        if (email === 'unknown@email.com') {
          const userString = JSON.stringify(user);
          const emailMatch = userString.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
          if (emailMatch) {
            email = emailMatch[0];
            console.log('ðŸ“§ Extracted email from user object string:', email);
          }
        }
      }
      
      // If still no userId, this is critical
      if (!userId) {
        console.error('âŒ CRITICAL: No user ID available for createOrUpdateUser');
        return;
      }
      
      console.log('ðŸ” CreateOrUpdateUser data sources:', {
        email: email,
        emailSource: localStorage.getItem('user_email') ? 'localStorage' : 'user object',
        userId: userId,
        userIdSource: localStorage.getItem('user_uid') ? 'localStorage' : 'user object'
      });
      
      // NEW: Check if registration is already in progress
      if (registrationInProgress) {
        console.log('ðŸš« BLOCKED: Registration already in progress');
        return;
      }
      
      // EXTRA CHECK: Nog een keer debouncing controleren
      if (!shouldAllowWebhookCall('register', email, userId)) {
        console.log('ðŸš« FINAL BLOCK: Webhook call blocked by final debouncing check');
        return;
      }
      
      // Set registration flag
      registrationInProgress = true;
      
      console.log(`ðŸ‘¤ ${isNewUser ? 'Creating NEW' : 'Updating EXISTING'} user: ${email}`);
      
      try {
        // Get token from localStorage or user object
        const token = localStorage.getItem('user_token') || 
                     user.token?.access_token || 
                     user.access_token ||
                     'temp-token-' + Date.now();
        
        const payload = {
          user_email: email,
          user_uid: userId,
          user_token: token,
          user_metadata: {
            full_name: user.user_metadata?.full_name || '',
            avatar_url: user.user_metadata?.avatar_url || '',
            provider: user.app_metadata?.provider || 'email',
            nickname: user.user_metadata?.full_name || user.user_metadata?.name || ''
          },
          is_new_user: isNewUser,
          timestamp: new Date().toISOString(),
          source: 'profile_page_auth',
          nickname: user.user_metadata?.full_name || user.user_metadata?.name || ''
        };
        
        // Log webhook call
        logWebhookCall('register', email, payload);
        
        console.log('ðŸ“¤ SINGLE WEBHOOK CALL to Register User:', payload);
        console.log('ðŸ” Referrer ID in payload:', payload.referrer_id);
        console.log('ðŸ” Full payload JSON:', JSON.stringify(payload, null, 2));
        
        const REGISTER_WEBHOOK_URL = 'https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15';
        
        const resp = await fetch(REGISTER_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        console.log('ðŸ“¡ Webhook response status:', resp.status);
        
        if (!resp.ok) {
          throw new Error(`Webhook failed: HTTP ${resp.status}`);
        }
        
        const responseText = await resp.text();
        console.log('âœ… Webhook response:', responseText);
        
        if (isNewUser) {
          showSuccess('Account created successfully! Welcome to Narrin AI!');
          showProfileUI();
          
          // Voor nieuwe users: wacht en laad dan profile
          setTimeout(() => {
            loadProfile();
            // TEMPORARY: Disable redirect for testing
            console.log('ðŸš« Redirect disabled for testing - staying on profile.html');
            // setTimeout(handlePostLoginRedirect, 1000);
          }, 3000);
        }
        
      } catch (error) {
        console.error('âŒ Error in createOrUpdateUser:', error);
        showError(`Account creation failed: ${error.message}`);
      } finally {
        // Always reset the flag
        setTimeout(() => {
          registrationInProgress = false;
          console.log('ðŸ”“ Registration flag reset');
        }, 5000); // Reset after 5 seconds
      }
    }

    // ===== GEFIXTE NETLIFY EVENT LISTENERS =====
    function setupEventListeners() {
      console.log('ðŸ”§ Setting up Netlify Identity event listeners...');
      
      let initHandled = false; // Prevent multiple init handling
      
      window.netlifyIdentity.on('init', user => {
        if (initHandled) {
          console.log('ðŸš« Init already handled, skipping...');
          return;
        }
        initHandled = true;
        
        console.log('ðŸ”„ Netlify Identity initialized, user:', user?.email || 'none');
        updateLoginButton();
        
        // Check if this is from an email confirmation or if we have a verified user
        const fragment = window.location.hash;
        if (user && (fragment.includes('confirmation_token=') || fragment.includes('recovery_token='))) {
          console.log('ðŸ“§ Processing email confirmation/recovery for:', user.email);
          // Store auth data
          localStorage.setItem('user_email', user.email);
          localStorage.setItem('user_uid', user.id);
          localStorage.setItem('user_token', user.token?.access_token || user.id);
          localStorage.setItem('user_auth_timestamp', Date.now().toString());
          
          // Clean URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Show profile
          showProfileUI();
          setTimeout(() => loadProfile(), 500);
          return;
        }
        
        // Also handle case where user is logged in after confirmation (no token in URL anymore)
        if (user && !localStorage.getItem('user_email')) {
          console.log('ðŸ”„ User logged in but no localStorage, storing data:', user.email);
          localStorage.setItem('user_email', user.email);
          localStorage.setItem('user_uid', user.id);
          localStorage.setItem('user_token', user.token?.access_token || user.id);
          localStorage.setItem('user_auth_timestamp', Date.now().toString());
          
          showProfileUI();
          setTimeout(() => loadProfile(), 500);
          return;
        }
        
        if (user && !netlifyUser && !isProcessingAuth) {
          console.log('ðŸ”„ Auto-login for existing user');
          netlifyUser = user;
          handleLoginSuccess(user, 'auto-login');
        }
      });

      window.netlifyIdentity.on('open', () => {
        console.log('ðŸ”“ Modal opened');
        forceModalToTop();
        document.body.classList.add('modal-open');
        
        // Fix mobile positioning for "By signing up..." text
        const fixMobileTermsPosition = () => {
          // Try to access the iframe
          const iframe = document.querySelector('.netlify-identity-widget iframe');
          if (iframe && window.innerWidth <= 768) {
            try {
              // Try to inject styles into the iframe
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              if (iframeDoc) {
                // Check if styles already injected
                if (!iframeDoc.getElementById('mobile-terms-fix')) {
                  const style = iframeDoc.createElement('style');
                  style.id = 'mobile-terms-fix';
                  style.textContent = `
                    @media (max-width: 768px) {
                      /* Fix terms text positioning on mobile */
                      p:has(> small),
                      div:has(> small),
                      small:has(a[href*="terms"]),
                      .formFooter,
                      .signupTerms,
                      [class*="terms"] {
                        position: relative !important;
                        display: block !important;
                        margin-top: 20px !important;
                        margin-bottom: 10px !important;
                        padding: 10px !important;
                        background: rgba(255,255,255,0.95) !important;
                        border-radius: 8px !important;
                        font-size: 12px !important;
                        text-align: center !important;
                        order: 999 !important;
                      }
                      
                      /* Make form a flex container on mobile */
                      form {
                        display: flex !important;
                        flex-direction: column !important;
                        padding-bottom: 20px !important;
                      }
                      
                      /* Google/Provider buttons */
                      button[class*="provider"],
                      .providerBtn,
                      button:has(svg),
                      button:contains("Google"),
                      button:contains("Continue with") {
                        order: 1 !important;
                        margin-bottom: 15px !important;
                      }
                      
                      /* Email/password fields */
                      .formGroup,
                      [class*="field"],
                      div:has(> input) {
                        order: 2 !important;
                      }
                      
                      /* Submit button */
                      button[type="submit"] {
                        order: 3 !important;
                        margin-bottom: 10px !important;
                      }
                      
                      /* Modal content */
                      .modalContent,
                      [class*="modal"] > div {
                        max-height: 90vh !important;
                        overflow-y: auto !important;
                        padding-bottom: 20px !important;
                      }
                    }
                  `;
                  iframeDoc.head.appendChild(style);
                  console.log('âœ… Injected mobile terms fix styles');
                }
              }
            } catch (e) {
              // Cross-origin restriction, try alternative approach
              console.log('âš ï¸ Cannot access iframe content, using alternative approach');
              
              // Alternative: Add styles to the parent document that might cascade
              if (!document.getElementById('mobile-terms-fix-parent')) {
                const style = document.createElement('style');
                style.id = 'mobile-terms-fix-parent';
                style.textContent = `
                  @media (max-width: 768px) {
                    /* Make the iframe scrollable and full height */
                    .netlify-identity-widget iframe {
                      height: 100vh !important;
                      max-height: 100vh !important;
                      overflow-y: auto !important;
                    }
                  }
                `;
                document.head.appendChild(style);
              }
            }
          }
        };
        
        // Try to fix mobile positioning
        fixMobileTermsPosition();
        setTimeout(fixMobileTermsPosition, 300);
        setTimeout(fixMobileTermsPosition, 600);
        setTimeout(fixMobileTermsPosition, 1000);
        
        // Update Optional field to Name (optional)
        const updateOptionalField = () => {
          const optionalInput = document.querySelector('.netlify-identity-widget input[placeholder="Optional"], .netlify-identity-widget input[placeholder="Nickname"]');
          if (optionalInput) {
            optionalInput.placeholder = 'Nickname';
            optionalInput.removeAttribute('required');
            console.log('âœ… Updated Optional field to Nickname');
          }
          
          const labels = document.querySelectorAll('.netlify-identity-widget label');
          labels.forEach(label => {
            if (label.textContent.trim() === 'Optional' || label.textContent.includes('Optional')) {
              label.textContent = 'Nickname';
            }
          });
        };
        
        // Try immediately and after delays
        updateOptionalField();
        setTimeout(updateOptionalField, 100);
        setTimeout(updateOptionalField, 300);
        setTimeout(updateOptionalField, 500);
        
        // Add terms notice at bottom of screen for mobile
        setTimeout(() => {
          addFixedTermsNotice();
        }, 500);
      });

      window.netlifyIdentity.on('close', () => {
        console.log('ðŸ”’ Modal closed');
        document.body.classList.remove('modal-open');
        
        // Remove any terms notices
        const floatingNotice = document.getElementById('floating-terms-notice');
        if (floatingNotice) {
          floatingNotice.remove();
        }
        
        const fixedNotice = document.getElementById('fixed-terms-notice');
        if (fixedNotice) {
          fixedNotice.remove();
        }
        
        if (window.innerWidth <= 768) {
          const header = document.querySelector('.header');
          if (header) {
            header.style.visibility = 'visible';
          }
        }
      });

      // ===== BELANGRIJKSTE FIX: Gescheiden event handling =====
      window.netlifyIdentity.on('login', user => {
        console.log('ðŸ”‘ LOGIN event fired for:', user.email);
        // Only call handleAuthEvent - it will call handleLoginSuccess internally
        handleAuthEvent(user, 'login');
      });

      window.netlifyIdentity.on('signup', async user => {
        console.log('ðŸŽ‰ SIGNUP event fired for:', user.email);
        
        // IMPORTANT: Clear any stored redirect URL immediately to prevent redirects
        localStorage.removeItem('login_redirect_url');
        console.log('ðŸš« Cleared redirect URL to prevent signup redirect');
        
        // CRITICAL: Manually ensure localStorage is set immediately
        if (user) {
          // Extract email
          let email = user.email || 
                      user.user_metadata?.email || 
                      user.user_metadata?.email_address ||
                      'unknown@email.com';
          
          // For Google SSO, check more locations
          if (email === 'unknown@email.com') {
            const userString = JSON.stringify(user);
            const emailMatch = userString.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            if (emailMatch) {
              email = emailMatch[0];
            }
          }
          
          // Extract user ID - might need to parse from JWT
          let userId = user.id;
          if (!userId && user.token?.access_token) {
            try {
              const tokenParts = user.token.access_token.split('.');
              const payload = JSON.parse(atob(tokenParts[1]));
              userId = payload.sub;
              // Also try to get email from JWT
              if (email === 'unknown@email.com' && payload.email) {
                email = payload.email;
              }
            } catch (e) {
              console.error('âŒ Failed to parse JWT in signup:', e);
            }
          }
          
          const accessToken = user.token?.access_token || user.access_token || 'temp-token';
          
          console.log('ðŸ’¾ Manually storing auth data for signup:', {
            email: email,
            userId: userId,
            hasToken: !!accessToken
          });
          
          // Manually store auth data to ensure it's available after refresh
          localStorage.setItem('user_email', email);
          localStorage.setItem('user_token', accessToken);
          localStorage.setItem('user_uid', userId);
          localStorage.setItem('user_auth_timestamp', Date.now().toString());
        }
        
        // Only call handleAuthEvent - it will call handleLoginSuccess internally
        handleAuthEvent(user, 'signup');
        
        // Setup 7-day Engage trial for new users
        try {
          console.log('ðŸŽ Setting up 7-day Engage trial...');
          const trialResponse = await fetch('/.netlify/functions/setup-trial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_email: email,
              user_uid: userId
            })
          });
          
          if (trialResponse.ok) {
            const trialData = await trialResponse.json();
            console.log('âœ… Trial setup successful:', trialData);
            
            // Store trial info in localStorage
            localStorage.setItem('user_plan', 'Engage');
            localStorage.setItem('subscription_status', 'trial');
            localStorage.setItem('trial_end_date', trialData['grace_period_end']);
            
            showSuccess('ðŸŽ‰ Welcome! You have 7 days of Engage plan access with unlimited messaging!');
          } else {
            console.error('âŒ Failed to setup trial');
            showSuccess('Welcome! Your account has been created successfully.');
          }
        } catch (error) {
          console.error('âŒ Error setting up trial:', error);
          showSuccess('Welcome! Your account has been created successfully.');
        }
        
        // Update the UI to show logged-in state
        showProfileUI();
        
        // Wait a bit for all data to be saved, then load profile
        setTimeout(() => {
          console.log('ðŸ“Š Loading profile after signup...');
          loadProfile(); // Use correct function name
        }, 1500);
        
        // Prevent default redirect behavior
        return false;
      });

      window.netlifyIdentity.on('logout', () => {
        console.log('ðŸ‘‹ Logout event');
        clearAuthData(); // Clear auth data first
        resetAuthState();
        localStorage.clear();
        showLoginUI();
        updateLoginButton();
        setTimeout(() => window.location.href = 'index.html', 1000);
      });

      window.netlifyIdentity.on('error', err => {
        console.error('âŒ Netlify Identity error:', err);
        
        // Prevent null reference error
        if (!err) {
          console.log('âš ï¸ Error object is null, skipping error handling');
          resetAuthState();
          return;
        }
        
        const errorMessage = err?.message || err?.toString() || 'Unknown error';
        
        // Only show error if it's not a null error
        if (errorMessage && errorMessage !== 'null') {
          resetAuthState();
          
          // Custom error messages for common issues
          if (errorMessage.includes('invalid_grant')) {
            showError('Invalid email or password. Please try again.');
          } else if (errorMessage.includes('No user found')) {
            showError('No account found with that email. Please sign up first.');
          } else {
            showError('Authentication error: ' + errorMessage);
          }
        } else {
          // Silent reset for null errors
          resetAuthState();
        }
      });
    }

    // ===== RESET FUNCTIE =====
    function resetAuthState() {
      isProcessingAuth = false;
      authCallLock = false;
      netlifyUser = null;
      lastProcessedUser = null;
      
      if (authProcessTimeout) {
        clearTimeout(authProcessTimeout);
        authProcessTimeout = null;
      }
      
      console.log('ðŸ”„ Auth state completely reset');
    }

    // Add terms acceptance text to signup form
    function addTermsAcceptanceText() {
      try {
        // Try multiple times to ensure the modal is fully loaded
        let attempts = 0;
        const maxAttempts = 10;
        
        const checkAndAdd = () => {
          attempts++;
          
          // Try to find the signup form within the iframe
          const iframes = document.querySelectorAll('.netlify-identity-widget iframe');
          
          iframes.forEach(iframe => {
            try {
              // Try to access iframe content (may be blocked by same-origin policy)
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              
              // Look for signup form
              const signupForms = iframeDoc.querySelectorAll('form[name="signup"], form[data-netlify-identity-signup], .signup-form');
              
              signupForms.forEach(form => {
                // Check if we already added the terms
                if (!form.querySelector('.termsAcceptance')) {
                  // Find the password field or submit button
                  const passwordField = form.querySelector('input[type="password"]');
                  const submitButton = form.querySelector('button[type="submit"], .btn-primary');
                  
                  if (passwordField || submitButton) {
                    // Create terms div
                    const termsDiv = iframeDoc.createElement('div');
                    termsDiv.className = 'termsAcceptance';
                    termsDiv.innerHTML = 'By signing up, you agree to our <a href="/terms-and-conditions.html" target="_blank">Terms & Conditions</a> and <a href="/privacy-policy.html" target="_blank">Privacy Policy</a>';
                    
                    // Insert after password field or before submit button
                    if (passwordField && passwordField.parentElement) {
                      passwordField.parentElement.parentElement.insertBefore(termsDiv, submitButton ? submitButton.parentElement : null);
                    } else if (submitButton && submitButton.parentElement) {
                      submitButton.parentElement.insertBefore(termsDiv, submitButton);
                    }
                    
                    console.log('âœ… Terms acceptance text added to signup form');
                  }
                }
              });
            } catch (e) {
              // If we can't access iframe, try direct DOM manipulation
              console.log('âš ï¸ Cannot access iframe content, trying alternative method');
              
              // Alternative: Add terms text using CSS pseudo-element (already in styles)
              // Or try to inject via MutationObserver
              addTermsViaObserver();
            }
          });
          
          // If not found and we haven't exceeded attempts, try again
          if (attempts < maxAttempts && !document.querySelector('.termsAcceptance')) {
            setTimeout(checkAndAdd, 200);
          }
        };
        
        checkAndAdd();
      } catch (error) {
        console.error('âŒ Error adding terms acceptance text:', error);
      }
    }
    
    // Alternative method using MutationObserver
    function addTermsViaObserver() {
      const observer = new MutationObserver((mutations) => {
        // Look for password fields in the mutations
        const passwordFields = document.querySelectorAll('.netlify-identity-widget input[type="password"]');
        
        passwordFields.forEach(field => {
          const form = field.closest('form');
          if (form && !form.querySelector('.termsAcceptance')) {
            const termsDiv = document.createElement('div');
            termsDiv.className = 'termsAcceptance';
            termsDiv.style.cssText = 'margin-top: 10px; margin-bottom: 15px; font-size: 12px; color: #666; text-align: center; line-height: 1.5;';
            termsDiv.innerHTML = 'By signing up, you agree to our <a href="/terms-and-conditions.html" target="_blank" style="color: #14b8a6; text-decoration: underline;">Terms & Conditions</a> and <a href="/privacy-policy.html" target="_blank" style="color: #14b8a6; text-decoration: underline;">Privacy Policy</a>';
            
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton && submitButton.parentElement) {
              submitButton.parentElement.insertBefore(termsDiv, submitButton);
              observer.disconnect(); // Stop observing once we've added the text
              console.log('âœ… Terms acceptance text added via observer');
            }
          }
        });
      });
      
      // Start observing the entire document for changes
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // Stop observing after 5 seconds to prevent memory leaks
      setTimeout(() => observer.disconnect(), 5000);
    }

    // Function to add fixed terms notice at bottom of screen
    function addFixedTermsNotice() {
      // Remove any existing notice
      const existingNotice = document.getElementById('fixed-terms-notice');
      if (existingNotice) {
        existingNotice.remove();
      }
      
      // Create the terms notice
      const termsNotice = document.createElement('div');
      termsNotice.id = 'fixed-terms-notice';
      
      // Check if mobile
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // Mobile: Fixed at very bottom of viewport with full width and larger text
        termsNotice.style.cssText = `
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          background: linear-gradient(to top, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.98));
          border-top: 1px solid rgba(20, 184, 166, 0.3);
          padding: 20px 15px 25px 15px;
          font-size: 15px;
          color: #64748b;
          text-align: center;
          z-index: 999999998;
          box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
          font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
          line-height: 1.5;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100px;
        `;
      } else {
        // Desktop: Positioned below modal
        termsNotice.style.cssText = `
          position: fixed;
          bottom: 50px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.98);
          border: 1px solid rgba(20, 184, 166, 0.4);
          border-radius: 8px;
          padding: 10px 20px;
          font-size: 12px;
          color: #64748b;
          text-align: center;
          z-index: 999999998;
          max-width: 400px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
          line-height: 1.4;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;
      }
      
      termsNotice.innerHTML = `
        By signing up, you agree to our 
        <a href="/terms-and-conditions.html" target="_blank" style="color: #14b8a6; text-decoration: none; font-weight: 500; border-bottom: 1px solid rgba(20, 184, 166, 0.3);">Terms & Conditions</a>
        and 
        <a href="/privacy-policy.html" target="_blank" style="color: #14b8a6; text-decoration: none; font-weight: 500; border-bottom: 1px solid rgba(20, 184, 166, 0.3);">Privacy Policy</a>
      `;
      
      document.body.appendChild(termsNotice);
      console.log('âœ… Fixed terms notice added at bottom');
    }
    
    // Keep the old function for compatibility (not used anymore)
    function addTermsToModalForm() {
      // Use MutationObserver to watch for form changes
      const observer = new MutationObserver(() => {
        // Look for the signup form within the modal
        const signupForms = document.querySelectorAll('.netlify-identity-widget form');
        
        signupForms.forEach(form => {
          // Check if we already added terms to this form
          if (form.querySelector('.inline-terms-notice')) return;
          
          // Look for the submit button or Google login button
          const submitButton = form.querySelector('button[type="submit"]');
          const googleButton = form.querySelector('button[class*="provider"], button:has(svg)');
          
          if (submitButton || googleButton) {
            // Create terms div that fits inside the modal
            const termsDiv = document.createElement('div');
            termsDiv.className = 'inline-terms-notice';
            termsDiv.style.cssText = `
              margin: 15px 0;
              padding: 10px;
              font-size: 11px;
              color: #64748b;
              text-align: center;
              line-height: 1.4;
              background: rgba(248, 250, 252, 0.8);
              border-radius: 6px;
              border: 1px solid rgba(20, 184, 166, 0.2);
            `;
            
            termsDiv.innerHTML = `
              <span style="display: block; margin-bottom: 5px;">By signing up, you agree to our</span>
              <a href="/terms-and-conditions.html" target="_blank" style="color: #14b8a6; text-decoration: none; font-weight: 500;">Terms & Conditions</a>
              <span> and </span>
              <a href="/privacy-policy.html" target="_blank" style="color: #14b8a6; text-decoration: none; font-weight: 500;">Privacy Policy</a>
            `;
            
            // Insert before the submit button
            if (submitButton) {
              submitButton.parentElement.insertBefore(termsDiv, submitButton);
            } else if (googleButton) {
              // If only Google button, add after it
              googleButton.parentElement.appendChild(termsDiv);
            }
            
            console.log('âœ… Added inline terms notice to modal form');
          }
        });
      });
      
      // Start observing
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // Stop observing after 5 seconds to prevent memory leaks
      setTimeout(() => observer.disconnect(), 5000);
    }
    
    // Keep old function for compatibility but make it do nothing
    function addFloatingTermsNotice() {
      // Deprecated - now using addTermsToModalForm instead
      // Remove any existing floating notices
      const existingNotice = document.getElementById('floating-terms-notice');
      if (existingNotice) {
        existingNotice.remove();
      }
    }

    // GEFIXTE versie van forceModalToTop met minder agressieve hiding
    function forceModalToTop() {
      setTimeout(() => {
        // Find all Netlify modal elements
        const modalElements = [
          ...document.querySelectorAll('.netlify-identity-widget'),
          ...document.querySelectorAll('[data-netlify-identity-widget]'),
          ...document.querySelectorAll('.netlify-identity-modal'),
          ...document.querySelectorAll('iframe[src*="netlify"]'),
          ...document.querySelectorAll('div[class*="netlify"]')
        ];

        modalElements.forEach(element => {
          if (element) {
            element.style.zIndex = '999999999';
            element.style.position = 'fixed';
            console.log('ðŸ”§ Forced z-index on:', element.className || element.tagName);
          }
        });

        // GEFIXTE versie: Alleen z-index aanpassen, NIET visibility verbergen
        if (window.innerWidth <= 768) {
          const header = document.querySelector('.header');
          const mobileMenu = document.querySelector('.mobile-menu-overlay');
          const mobileSearch = document.querySelector('.mobile-search-overlay');
          
          // Sluit eventueel geopende menu's, maar verberg header NIET
          if (mobileMenu && mobileMenu.classList.contains('active')) {
            closeMobileMenu();
          }
          if (mobileSearch && mobileSearch.classList.contains('active')) {
            mobileSearchOverlay.classList.remove('active');
            mobileSearchBtn.setAttribute('aria-expanded', 'false');
          }
          
          // Verlaag alleen z-index van header, verberg het NIET
          if (header) {
            header.style.zIndex = '1';
          }
          
          console.log('ðŸ“± Adjusted mobile navigation z-index (without hiding)');
        }
      }, 100);

      // Keep checking and forcing for 3 seconds
      let forceCounter = 0;
      const forceInterval = setInterval(() => {
        forceCounter++;
        
        const widget = document.querySelector('.netlify-identity-widget');
        if (widget) {
          widget.style.zIndex = '999999999';
          widget.style.position = 'fixed';
        }

        if (forceCounter > 30) { // Stop after 3 seconds
          clearInterval(forceInterval);
        }
      }, 100);
    }

    // Debug function to clear stuck localStorage
    window.debugClearPlan = function() {
      console.log('ðŸ§¹ Clearing all plan-related localStorage...');
      localStorage.removeItem('user_plan');
      localStorage.removeItem('subscription_cancel_at');
      localStorage.removeItem('cancelled_plan_type');
      localStorage.removeItem('justDowngraded');
      console.log('âœ… Cleared! Refreshing...');
      window.location.reload();
    }

    // Initialize Netlify Identity and check login status
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸš€ Page loaded, initializing...');
      
      // Check if this is an active anonymous user (from featured character chat) and redirect to pricing
      const userEmail = localStorage.getItem('user_email');
      const isAnonymousUser = localStorage.getItem('is_anonymous_user') === 'true';
      const hasAnonymousCredentials = userEmail === 'anonymous@narrin.ai';
      
      // Only redirect if BOTH anonymous flags are true AND email is anonymous
      if (isAnonymousUser && hasAnonymousCredentials && userEmail === 'anonymous@narrin.ai') {
        console.log('ðŸ’° Active anonymous user detected, redirecting to pricing page');
        window.location.href = 'pricing.html';
        return;
      }
      
      // Clean up anonymous flags for registered users
      if (userEmail && userEmail !== 'anonymous@narrin.ai') {
        localStorage.removeItem('is_anonymous_user');
      }
      
      // Check if we're processing verification (should skip if handled by early script)
      if (sessionStorage.getItem('email_verification_processing') === 'true') {
        console.log('â³ Email verification in progress, waiting...');
        return;
      }
      
      // Check if email was just verified
      const emailJustVerified = sessionStorage.getItem('email_verified') === 'true';
      if (emailJustVerified) {
        console.log('âœ… Email was just verified, showing login prompt');
        sessionStorage.removeItem('email_verified');
        
        // Show login UI
        showLoginUI();
        
        // Add success banner
        setTimeout(() => {
          const loginSection = document.querySelector('.login-section');
          if (loginSection) {
            const successBanner = document.createElement('div');
            successBanner.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; margin: 0 auto 24px; max-width: 500px; text-align: center;';
            successBanner.innerHTML = `
              <h3 style="margin: 0 0 8px 0; font-size: 20px;">âœ… Email Verified Successfully!</h3>
              <p style="margin: 0; opacity: 0.95;">Your email has been confirmed. Please log in to access your account.</p>
            `;
            loginSection.insertBefore(successBanner, loginSection.firstChild);
            
            // Auto-open login modal
            setTimeout(() => {
              if (window.netlifyIdentity) {
                window.netlifyIdentity.open('login');
              }
            }, 500);
          }
        }, 100);
        
        return;
      }
      
      // Check for email verification token in URL (fallback if early script didn't catch it)
      const urlParams = new URLSearchParams(window.location.search);
      const fragment = window.location.hash;
      const hasConfirmationToken = fragment.includes('confirmation_token=') || 
                                   fragment.includes('recovery_token=') ||
                                   fragment.includes('invite_token=');
      
      if (hasConfirmationToken) {
        console.log('ðŸ“§ Email verification/recovery token detected in URL');
        console.log('ðŸ”‘ Token fragment:', fragment);
        
        // Store that we're processing a verification
        sessionStorage.setItem('email_verification_in_progress', 'true');
        
        // Let Netlify Identity handle the token first
        if (window.netlifyIdentity) {
          // Initialize Netlify Identity
          window.netlifyIdentity.init();
          
          // DISABLED: Duplicate login listener removed to prevent double webhook calls
          
          // Also listen for the init event with user
          window.netlifyIdentity.on('init', (user) => {
            if (user) {
              console.log('âœ… User found on init after verification:', user.email);
              
              // Store auth data
              localStorage.setItem('user_email', user.email);
              localStorage.setItem('user_uid', user.id);
              localStorage.setItem('user_token', user.token?.access_token || user.id);
              localStorage.setItem('user_auth_timestamp', Date.now().toString());
              
              // Clean URL
              window.history.replaceState({}, document.title, window.location.pathname);
              
              // Clear verification flag
              sessionStorage.removeItem('email_verification_in_progress');
              
              // Show profile
              showProfileUI();
              setTimeout(() => loadProfile(), 500);
            }
          });
          
          // Also check after a delay in case the event doesn't fire
          let checkAttempts = 0;
          const checkInterval = setInterval(() => {
            checkAttempts++;
            const user = window.netlifyIdentity.currentUser();
            
            console.log(`ðŸ” Checking for user (attempt ${checkAttempts}/10):`, user?.email || 'none');
            
            if (user) {
              console.log('âœ… User found after verification:', user.email);
              clearInterval(checkInterval);
              
              // Store auth data
              localStorage.setItem('user_email', user.email);
              localStorage.setItem('user_uid', user.id);
              localStorage.setItem('user_token', user.token?.access_token || user.id);
              localStorage.setItem('user_auth_timestamp', Date.now().toString());
              
              // Clean URL
              window.history.replaceState({}, document.title, window.location.pathname);
              
              // Show profile
              showProfileUI();
              loadProfile();
            } else if (checkAttempts >= 10) {
              console.log('âš ï¸ User not found after 10 attempts');
              clearInterval(checkInterval);
              
              // Clean URL since token was processed
              window.history.replaceState({}, document.title, window.location.pathname);
              
              // Mark that we just verified
              sessionStorage.setItem('just_verified', 'true');
              
              // Clear verification flag
              sessionStorage.removeItem('email_verification_in_progress');
              
              // Show login UI immediately with message
              showLoginUI();
              
              // Show prominent success message
              const loginSection = document.querySelector('.login-section');
              if (loginSection) {
                const successBanner = document.createElement('div');
                successBanner.className = 'verification-success-banner';
                successBanner.innerHTML = `
                  <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                    <h3 style="margin: 0 0 8px 0; font-size: 20px;">âœ… Email Verified Successfully!</h3>
                    <p style="margin: 0; opacity: 0.95;">Your email has been confirmed. Please log in to access your account.</p>
                  </div>
                `;
                loginSection.insertBefore(successBanner, loginSection.firstChild);
              }
              
              // Auto-open login modal after a short delay
              setTimeout(() => {
                if (window.netlifyIdentity) {
                  window.netlifyIdentity.open('login');
                }
              }, 1000);
            }
          }, 1000);
        }
        return; // Exit early to let Netlify handle the token
      }
      
      
      // Debug localStorage state
      console.log('ðŸ“¦ LocalStorage state:', {
        email: localStorage.getItem('user_email'),
        token: localStorage.getItem('user_token')?.substring(0, 20) + '...',
        uid: localStorage.getItem('user_uid'),
        timestamp: localStorage.getItem('user_auth_timestamp')
      });
      
      // Check if we just completed email verification
      const justVerified = sessionStorage.getItem('just_verified') === 'true';
      if (justVerified) {
        console.log('âœ¨ Just completed email verification, showing success...');
        sessionStorage.removeItem('just_verified');
      }
      
      // FIRST: Run universal authentication check
      const isAuthenticated = initializeAuthenticationCheck();
      
      // Set up redirect handling
      setupRedirectHandling();
      
      // Check upgrade status
      checkUpgradeStatus();
      
      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        // CRITICAL: Always show profile UI if we have auth data in localStorage
        if (isAuthenticated) {
          console.log('âœ… User authenticated via localStorage');
          showProfileUI();
          
          // If just verified, give extra time for Netlify to sync
          const delay = justVerified ? 2000 : 500;
          
          // Give Netlify Identity time to init, then load profile
          setTimeout(() => {
            loadProfile();
          }, delay);
        } else {
          // FALLBACK: Check if we just signed up (within last 10 seconds)
          const authTimestamp = localStorage.getItem('user_auth_timestamp');
          if (authTimestamp) {
            const timeSinceAuth = Date.now() - parseInt(authTimestamp);
            if (timeSinceAuth < 10000) { // 10 seconds
              console.log('ðŸ†• Recent signup detected, showing profile UI');
              showProfileUI();
              setTimeout(() => {
                loadProfile();
              }, 1000);
            }
          }
        }
        
        window.netlifyIdentity.init({
          namePlaceholder: 'Nickname'
        });
        
        // Check if user is already logged in (might be null right after signup)
        netlifyUser = window.netlifyIdentity.currentUser();
        
        if (netlifyUser && !isAuthenticated) {
          console.log('âœ… User authenticated via Netlify Identity:', netlifyUser?.email);
          // For existing logged-in users, just load profile (don't redirect)
          showProfileUI();
          loadProfile();
        } else if (!netlifyUser && !isAuthenticated) {
          console.log('âŒ No user logged in');
          checkLocalStorage();
        }
        
        // Set up event listeners
        setupEventListeners();
      } else {
        console.error('âŒ Netlify Identity not loaded');
        if (isAuthenticated) {
          // If we have auth data but no Netlify Identity, still show profile
          showProfileUI();
          setTimeout(() => {
            loadProfile();
          }, 500);
        }
      }
    });

    function checkLocalStorage() {
      // Check if we have stored auth data
      const token = localStorage.getItem('user_token');
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      
      if (token && email && uid) {
        console.log('âœ… Found stored auth data for:', email);
        showProfileUI();
        loadProfile();
      } else {
        console.log('âŒ No stored auth data found');
        showLoginUI();
      }
    }

    let logoutInProgress = false;
    
    function handleLogout() {
      console.log('ðŸ” handleLogout called');
      
      // Prevent double execution
      if (logoutInProgress) {
        console.log('âš ï¸ Logout already in progress, ignoring');
        return;
      }
      
      logoutInProgress = true;
      
      // Use custom styled confirm modal
      showLogoutConfirm(() => {
        console.log('ðŸšª Logout confirmed...');
        
        // Try Netlify Identity logout first
        if (window.netlifyIdentity) {
          try {
            const currentUser = window.netlifyIdentity.currentUser();
            if (currentUser) {
              console.log('ðŸ‘¤ Logging out Netlify user:', currentUser.email);
              window.netlifyIdentity.logout();
              // clearAllAuthData will be called by the logout event listener
            } else {
              console.log('âš ï¸ No Netlify user found, clearing local storage');
              clearAllAuthData();
            }
          } catch (error) {
            console.error('âŒ Error during Netlify logout:', error);
            clearAllAuthData();
          }
        } else {
          console.log('âš ï¸ Netlify Identity not available, clearing local storage');
          clearAllAuthData();
        }
      }, () => {
        logoutInProgress = false;
        console.log('âŒ Logout cancelled');
      });
    }
    
    function showLogoutConfirm(onConfirm, onCancel) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.className = 'logout-modal-overlay';
      overlay.innerHTML = `
        <div class="logout-modal">
          <div class="logout-modal-header">
            <h3>Confirm Logout</h3>
          </div>
          <div class="logout-modal-body">
            <p>Are you sure you want to log out?</p>
          </div>
          <div class="logout-modal-actions">
            <button class="logout-btn cancel">Cancel</button>
            <button class="logout-btn confirm">Log Out</button>
          </div>
        </div>
      `;
      
      // Add styling
      const style = document.createElement('style');
      style.textContent = `
        .logout-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(30, 41, 59, 0.95);
          backdrop-filter: blur(20px);
          z-index: 999999999;
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0;
          transition: all 0.3s ease;
        }
        .logout-modal-overlay.active {
          opacity: 1;
        }
        .logout-modal {
          background: var(--color-white);
          border-radius: var(--radius-xl);
          padding: var(--spacing-2xl);
          box-shadow: var(--shadow-xl);
          max-width: 400px;
          width: 90%;
          transform: scale(0.9);
          transition: all 0.3s ease;
        }
        .logout-modal-overlay.active .logout-modal {
          transform: scale(1);
        }
        .logout-modal-header h3 {
          margin: 0 0 var(--spacing-md) 0;
          color: var(--color-navy);
          font-family: var(--font-secondary);
          font-weight: 700;
          text-align: center;
        }
        .logout-modal-body p {
          margin: 0 0 var(--spacing-lg) 0;
          color: var(--color-gray-dark);
          text-align: center;
          line-height: 1.6;
        }
        .logout-modal-actions {
          display: flex;
          gap: var(--spacing-md);
          justify-content: center;
        }
        .logout-btn {
          padding: var(--spacing-md) var(--spacing-xl);
          border-radius: var(--radius-md);
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          border: none;
          font-size: var(--font-size-sm);
          min-width: 100px;
        }
        .logout-btn.cancel {
          background: var(--color-light-gray);
          color: var(--color-gray-dark);
        }
        .logout-btn.cancel:hover {
          background: var(--color-gray-light);
        }
        .logout-btn.confirm {
          background: var(--gradient-primary);
          color: var(--color-white);
        }
        .logout-btn.confirm:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
        }
      `;
      
      document.head.appendChild(style);
      document.body.appendChild(overlay);
      
      // Show modal
      setTimeout(() => overlay.classList.add('active'), 10);
      
      // Event handlers
      overlay.querySelector('.logout-btn.cancel').addEventListener('click', () => {
        overlay.classList.remove('active');
        setTimeout(() => {
          document.body.removeChild(overlay);
          document.head.removeChild(style);
        }, 300);
        if (onCancel) onCancel();
      });
      
      overlay.querySelector('.logout-btn.confirm').addEventListener('click', () => {
        overlay.classList.remove('active');
        setTimeout(() => {
          document.body.removeChild(overlay);
          document.head.removeChild(style);
        }, 300);
        if (onConfirm) onConfirm();
      });
      
      // Close on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.querySelector('.logout-btn.cancel').click();
        }
      });
    }

    function clearAllAuthData() {
      console.log('ðŸ§¹ Clearing all auth data...');
      
      // Clear all auth-related localStorage items
      localStorage.removeItem('user_email');
      localStorage.removeItem('user_token');
      localStorage.removeItem('user_uid');
      localStorage.removeItem('user_auth_timestamp');
      localStorage.removeItem('user_metadata');
      localStorage.removeItem('user_netlify_data');
      localStorage.removeItem('user_refresh_token');
      localStorage.removeItem('user_id');
      localStorage.removeItem('login_redirect_url');
      localStorage.removeItem('subscription_status');
      localStorage.removeItem('trial_end_date');
      
      // Clear session storage too
      sessionStorage.clear();
      
      // Reset logout flag
      logoutInProgress = false;
      
      // Show login UI briefly then redirect
      showLoginUI();
      
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 500);
    }

    function showLoginUI() {
      document.getElementById('not-logged-in').style.display = 'block';
      document.getElementById('profile').style.display = 'none';
      hideMessages();
    }

    function showProfileUI() {
      document.getElementById('not-logged-in').style.display = 'none';
      document.getElementById('profile').style.display = 'block';
      
      // Check if we just verified email and show success message
      const justVerified = sessionStorage.getItem('just_verified') === 'true';
      if (justVerified) {
        sessionStorage.removeItem('just_verified');
        
        // Show success message
        const profileContent = document.querySelector('.profile-content');
        if (profileContent) {
          const successBanner = document.createElement('div');
          successBanner.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; margin: 0 0 24px; text-align: center; animation: slideIn 0.5s ease-out;';
          successBanner.innerHTML = `
            <h3 style="margin: 0 0 8px 0; font-size: 20px;">âœ… Email Verified Successfully!</h3>
            <p style="margin: 0; opacity: 0.95;">Your account is now fully activated. Welcome to Narrin AI!</p>
          `;
          
          // Add animation
          const style = document.createElement('style');
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateY(-20px); opacity: 0; }
              to { transform: translateY(0); opacity: 1; }
            }
          `;
          document.head.appendChild(style);
          
          // Insert at the beginning of profile content
          profileContent.insertBefore(successBanner, profileContent.firstChild);
          
          // Remove after 10 seconds
          setTimeout(() => {
            successBanner.style.transition = 'opacity 0.5s ease-out';
            successBanner.style.opacity = '0';
            setTimeout(() => successBanner.remove(), 500);
          }, 10000);
        }
      }
      
      // Show edit buttons for editable fields only (exclude plan)
      document.querySelectorAll('.edit-btn').forEach(btn => {
        const profileItem = btn.closest('.profile-item');
        const field = profileItem.getAttribute('data-field');
        
        // Only show edit button for email field, not for plan
        if (field !== 'plan') {
          btn.style.display = 'inline-block';
        }
      });
    }

    // GEFIXTE versie van loadProfile() functie
async function loadProfile() {
  const token = localStorage.getItem('user_token');
  let email = localStorage.getItem('user_email');
  const uid = localStorage.getItem('user_uid');
  
  // Extra fallback for email if it's 'unknown@email.com'
  if (email === 'unknown@email.com' || !email) {
    // Try to get from Netlify Identity current user
    const netlifyUser = window.netlifyIdentity?.currentUser();
    if (netlifyUser?.email) {
      email = netlifyUser.email;
      localStorage.setItem('user_email', email);
      console.log('ðŸ“§ Retrieved email from Netlify Identity:', email);
    }
  }
  
  if (!token || !email || !uid) {
    console.log('âš ï¸ No auth data - showing login UI');
    showLoginUI();
    return;
  }

  console.log('ðŸ“¡ Loading profile for:', email);
  console.log('ðŸ“± Device context:', {
    isMobile: window.innerWidth <= 768,
    storedEmail: localStorage.getItem('user_email'),
    netlifyEmail: window.netlifyIdentity?.currentUser()?.email
  });
  showLoading();
  
  try {
    const payload = { 
      user_email: email, 
      user_uid: uid, 
      user_token: token,
      action: 'get_profile' // Explicit action for profile loading
    };
    
    console.log('ðŸ“¤ Request payload:', payload);
    
    const resp = await fetch('https://hook.eu2.make.com/lya166veex7oo2wwo8mx4fuhlkssxlog', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    console.log('ðŸ“¡ Response status:', resp.status);
    
    if (!resp.ok) {
      // KRITIEKE FIX: Als gebruiker niet gevonden wordt, probeer opnieuw aan te maken
      if (resp.status === 400 || resp.status === 404) {
        console.log('ðŸ”„ User data not found in Airtable, attempting to create...');
        
        // Probeer de gebruiker opnieuw aan te maken in Airtable
        const createPayload = {
          user_email: email,
          user_uid: uid,
          user_token: token,
          user_metadata: {
            full_name: '',
            avatar_url: '',
            provider: 'email'
          },
          is_new_user: false, // Bestaande user, maar niet in Airtable
          timestamp: new Date().toISOString(),
          source: 'profile_page_recovery'
        };
        
        console.log('ðŸ“¤ Creating missing user in Airtable...');
        const createResp = await fetch('https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(createPayload)
        });
        
        if (createResp.ok) {
          console.log('âœ… User created in Airtable, retrying profile load...');
          // Wacht 3 seconden en probeer opnieuw
          setTimeout(() => {
            loadProfile();
          }, 3000);
          return;
        }
      }
      
      throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
    }
    
    const responseText = await resp.text();
    console.log('ðŸ“‹ Raw response (first 500 chars):', responseText.substring(0, 500));
    
    // KRITIEKE FIX: Betere response parsing met fallbacks
    let data;
    
    try {
      data = JSON.parse(responseText);
      console.log('ðŸ“‹ Parsed JSON data:', data);
    } catch (parseError) {
      console.error('âŒ JSON Parse Error:', parseError);
      console.log('âŒ Failed to parse response, using default values');
      
      // Gebruik standaard waarden als JSON parsing faalt
      data = {
        email: email,
        plan: 'Free',
        usage: 0,
        quota: 10
      };
    }
    
    // VEILIGE data processing met null checks
    setField('email', data?.email || email);
    setField('nickname', data?.nickname || data?.Name || data?.name || data?.user_metadata?.nickname || '');
    
    // Check URL parameters for recent actions
    const urlParams = new URLSearchParams(window.location.search);
    const upgradeSuccess = urlParams.get('upgrade');
    const downgradeSuccess = urlParams.get('downgrade');
    const urlPlan = urlParams.get('plan');
    
    // Use localStorage as fallback if more recent than Airtable data (for immediate UI updates)
    const localPlan = localStorage.getItem('user_plan');
    let userPlan = data?.plan || 'Free';
    
    if (upgradeSuccess === 'success' && urlPlan) {
      // User just completed Stripe checkout - use URL plan as most recent
      const capitalizedUrlPlan = urlPlan.charAt(0).toUpperCase() + urlPlan.slice(1);
      console.log(`ðŸŽ‰ Stripe checkout success - using URL plan "${capitalizedUrlPlan}" instead of Airtable plan "${userPlan}"`);
      
      // FORCE clear ALL plan-related localStorage first
      localStorage.removeItem('user_plan');
      localStorage.removeItem('subscription_cancel_at');
      localStorage.removeItem('cancelled_plan_type');
      localStorage.removeItem('justDowngraded');
      
      // Set the new plan fresh
      userPlan = capitalizedUrlPlan;
      localStorage.setItem('user_plan', capitalizedUrlPlan);
      
      console.log('ðŸ§¹ Cleared ALL old plan data');
      console.log('âœ… Force set plan to:', capitalizedUrlPlan);
      
      // IMPORTANT: Ignore any conflicting data from Airtable/localStorage
      // URL parameter is the source of truth after Stripe checkout
      
    } else if (downgradeSuccess === 'success') {
      // User just completed downgrade - force plan to Free
      console.log(`â¬‡ï¸ Downgrade success - forcing plan to "Free" instead of Airtable plan "${userPlan}"`);
      userPlan = 'Free';
      
      // Update localStorage to match
      localStorage.setItem('user_plan', 'Free');
      console.log('ðŸ“± Updated localStorage to Free after downgrade');
      
    } else if (localPlan && localPlan !== userPlan) {
      // ALWAYS clear conflicting localStorage when it doesn't match Airtable
      console.log(`âš ï¸ Conflict: localStorage="${localPlan}" vs Airtable="${userPlan}"`);
      
      // If URL has no special parameters, trust Airtable over localStorage
      if (!upgradeSuccess && !downgradeSuccess) {
        console.log(`ðŸ”„ No URL params - using Airtable plan "${userPlan}" and clearing localStorage`);
        localStorage.removeItem('user_plan');
        localStorage.removeItem('subscription_cancel_at');
        localStorage.removeItem('cancelled_plan_type');
        // Use Airtable plan
      } else {
        // Only during active upgrade/downgrade, use localStorage
        console.log(`ðŸ“± Active operation - keeping localStorage plan "${localPlan}"`);
        userPlan = localPlan;
      }
    }
    
    // Check if subscription has expired
    if (data?.cancel_at && data.cancel_at !== '1970-01-01') {
      const expiresDate = new Date(data.cancel_at);
      const now = new Date();
      
      if (now > expiresDate) {
        console.log('â° Subscription expired, defaulting to Free plan');
        userPlan = 'Free';
      } else {
        console.log('âœ… Subscription still active until:', expiresDate);
      }
    }
    
    setField('plan', userPlan);
    
    // Store current plan in localStorage for cancellation logic
    localStorage.setItem('user_plan', userPlan);
    
    // Store trial data from Airtable profile response
    if (data?.subscription_status) {
      localStorage.setItem('subscription_status', data.subscription_status);
      console.log('ðŸ“… Subscription status saved:', data.subscription_status);
    }
    
    console.log('ðŸ” Looking for grace_period_end in data:', { 
      grace_period_end: data?.grace_period_end,
      all_fields: Object.keys(data || {}),
      field_values: Object.keys(data || {}).map(key => ({ [key]: data[key] }))
    });
    
    // Try multiple possible field names for trial end date
    const possibleEndDateFields = [
      'grace_period_end',
      'Grace_Period_End', 
      'GracePeriodEnd',
      'grace-period-end',
      'trial_end_date',
      'trial_expires',
      'trialEndDate'
    ];
    
    let trialEndDate = null;
    for (const fieldName of possibleEndDateFields) {
      if (data?.[fieldName]) {
        trialEndDate = data[fieldName];
        console.log('ðŸ“… Found trial end date in field:', fieldName, '=', trialEndDate);
        break;
      }
    }
    
    if (trialEndDate) {
      localStorage.setItem('trial_end_date', trialEndDate);
      console.log('ðŸ“… Trial end date saved:', trialEndDate);
    } else {
      console.log('âš ï¸ No trial end date found in any field:', possibleEndDateFields);
      
      // If user has trial status but no end date, create a default one (7 days from now)
      if (data?.subscription_status === 'trial') {
        const defaultEndDate = new Date();
        defaultEndDate.setDate(defaultEndDate.getDate() + 7);
        const defaultEndDateString = defaultEndDate.toISOString();
        
        localStorage.setItem('trial_end_date', defaultEndDateString);
        console.log('ðŸ“… Created default trial end date (7 days):', defaultEndDateString);
      }
    }
    
    // Save stripe_customer_id to localStorage if available
    if (data?.stripe_customer_id) {
      localStorage.setItem('stripe_customer_id', data.stripe_customer_id);
      console.log('ðŸ’³ Stripe customer ID saved:', data.stripe_customer_id);
    }
    
    // Debug: Log all relevant data for cancellation notice
    console.log('ðŸ” Checking for cancellation notice:', {
      subscription_status: data?.subscription_status,
      cancel_at: data?.cancel_at,
      localStorage_cancel_at: localStorage.getItem('subscription_cancel_at'),
      userPlan: userPlan
    });

    // Check for subscription cancellation (show notice even if not expired yet)
    if (data?.subscription_status === 'cancelled' && data?.cancel_at && data.cancel_at !== '1970-01-01') {
      console.log('âœ… Showing notice from Airtable data');
      showCancellationNotice(data.cancel_at, userPlan);
    } else {
      // Fallback: Check localStorage for cancel_at if webhook data is missing
      const localCancelAt = localStorage.getItem('subscription_cancel_at');
      const cancelledPlanType = localStorage.getItem('cancelled_plan_type');
      
      if (localCancelAt) {
        console.log('ðŸ“± Using localStorage cancel_at as fallback:', localCancelAt);
        console.log('ðŸ“± Cancelled plan type:', cancelledPlanType);
        console.log('ðŸ“± Current plan type:', userPlan);
        
        // Show notice on the plan that was cancelled, not the current plan
        if (cancelledPlanType && cancelledPlanType !== 'Unknown') {
          showCancellationNotice(localCancelAt, cancelledPlanType);
        } else {
          // If no cancelled plan info, show on current plan as fallback
          showCancellationNotice(localCancelAt, userPlan);
        }
      } else {
        console.log('âŒ No cancellation data found in either Airtable or localStorage');
      }
    }
    
    // Update pricing card
    updatePricingCard(userPlan);
    
    // Debug: Log final plan decision
    console.log('ðŸŽ¯ FINAL PLAN DECISION:', {
      airtablePlan: data?.plan,
      localStoragePlan: localStorage.getItem('user_plan'),
      urlParams: {
        upgrade: urlParams.get('upgrade'),
        downgrade: urlParams.get('downgrade'),
        plan: urlParams.get('plan')
      },
      finalPlan: userPlan,
      currentURL: window.location.href
    });
    
    // Show welcome story and trial status for Free plan users
    const welcomeStory = document.getElementById('welcome-story');
    const trialStatus = document.getElementById('trialStatus');
    
    if (welcomeStory) {
      const planLower = userPlan.toLowerCase();
      const subscriptionStatus = localStorage.getItem('subscription_status');
      const trialEndDate = localStorage.getItem('trial_end_date');
      
      if (planLower === 'engage' || planLower === 'immerse') {
        welcomeStory.style.display = 'none';
      } else {
        welcomeStory.style.display = 'block';
        
        // Show trial status if user is on trial
        console.log('ðŸ” Trial check:', { subscriptionStatus, trialEndDate, hasTrialStatus: !!trialStatus });
        
        if (subscriptionStatus === 'trial' && trialStatus) {
          console.log('ðŸ“… Showing trial status in welcome section');
          
          // Update trial information
          const trialDaysEl = document.getElementById('trialDaysRemaining');
          const trialEndEl = document.getElementById('trialEndDate');
          
          if (trialEndDate) {
            // Calculate days remaining if we have an end date
            const endDate = new Date(trialEndDate);
            const now = new Date();
            const daysRemaining = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
            
            if (trialDaysEl) trialDaysEl.textContent = daysRemaining;
            if (trialEndEl) {
              const formattedDate = endDate.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
              });
              trialEndEl.textContent = formattedDate;
            }
          } else {
            // Default trial messaging when no end date is available
            if (trialDaysEl) trialDaysEl.textContent = '7';
            if (trialEndEl) trialEndEl.textContent = 'Contact support for details';
          }
          
          trialStatus.style.display = 'block';
        }
      }
    }
    
    // VEILIGE usage/quota verwerking
    let usage = 0;
    let quota = 10;
    
    if (data && typeof data.usage !== 'undefined' && data.usage !== null) {
      usage = parseInt(String(data.usage).replace(/[^0-9]/g, ''), 10) || 0;
    }
    
    if (data && typeof data.quota !== 'undefined' && data.quota !== null) {
      quota = parseInt(String(data.quota).replace(/[^0-9]/g, ''), 10) || 50;
    }
    
    // If subscription expired, enforce Free tier limits
    if (userPlan === 'Free' && data?.cancel_at && data.cancel_at !== '1970-01-01') {
      const expiresDate = new Date(data.cancel_at);
      const now = new Date();
      
      if (now > expiresDate) {
        quota = 50; // Force Free tier quota
        console.log('â° Subscription expired - enforcing Free tier quota of 50');
      }
    }
    
    console.log('ðŸ“Š Final processed values - Usage:', usage, 'Quota:', quota);
    
    // Check if user just downgraded
    const justDowngraded = sessionStorage.getItem('justDowngraded');
    if (justDowngraded === 'true') {
      // Clear the flag
      sessionStorage.removeItem('justDowngraded');
      // Force usage to 0 for downgraded users
      usage = 0;
      console.log('ðŸ”„ User just downgraded - resetting usage to 0/10');
    }
    
    // Update UI veilig
    const planLower = userPlan.toLowerCase();
    if (planLower === 'engage' || planLower === 'immerse' || planLower === 'premium' || planLower === 'pro') {
      setField('usage', usage.toString());
      const quotaElement = document.getElementById('quota');
      if (quotaElement) quotaElement.textContent = 'Unlimited';
      
      const usageFill = document.getElementById('usage-fill');
      if (usageFill) usageFill.style.width = '0%';
    } else {
      setField('usage', usage.toString());
      const quotaElement = document.getElementById('quota');
      if (quotaElement) quotaElement.textContent = quota.toString();
      
      const percentage = quota > 0 ? (usage / quota) * 100 : 0;
      const usageFill = document.getElementById('usage-fill');
      if (usageFill) usageFill.style.width = `${Math.min(percentage, 100)}%`;
    }
    
    console.log('âœ… Profile loaded successfully');
    updateUsageCountdown(userPlan, usage, quota);
    
    // Update trial status display after profile data is loaded
    updateTrialStatus();
    

  } catch (error) {
    console.error('âŒ Error loading profile:', error);
    
    // FALLBACK: Toon basis info ook bij fout
    setField('email', email);
    setField('nickname', '');
    setField('plan', 'Free');
    setField('usage', '0');
    
    const quotaElement = document.getElementById('quota');
    if (quotaElement) quotaElement.textContent = '10';
    
    const usageFill = document.getElementById('usage-fill');
    if (usageFill) usageFill.style.width = '0%';
    
    updatePricingCard('Free');
    
    // Toon gebruiksvriendelijke foutmelding
    showError('Profile loaded with default settings. Some data may not be current.');
  } finally {
    hideLoading();
  }
}

    // Edit functionality
    function enableEdit(field) {
      // Prevent editing of plan field
      if (field === 'plan') {
        showError('Plan cannot be edited directly. Use the upgrade/manage options instead.');
        return;
      }
      
      if (isEditing) {
        showError('A field is already being edited. Save or cancel first.');
        return;
      }
      
      console.log(`âœï¸ Start editing field: ${field}`);
      
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const valueSpan = profileItem.querySelector('.value');
      const editBtn = profileItem.querySelector('.edit-btn');
      
      // Store original value
      originalValue = valueSpan.textContent;
      currentEditingField = field;
      isEditing = true;
      
      // Add editing class
      profileItem.classList.add('editing');
      
      // Create input field
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalValue;
      input.className = 'edit-input';
      input.setAttribute('data-field', field);
      
      // Create save and cancel buttons
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'save-btn';
      saveBtn.style.display = 'inline-block';
      saveBtn.onclick = () => saveField(field);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'cancel-btn';
      cancelBtn.style.display = 'inline-block';
      cancelBtn.onclick = () => cancelEdit(field);
      
      // Replace value span with input
      valueSpan.style.display = 'none';
      profileItem.insertBefore(input, editBtn);
      
      // Hide edit button, show save/cancel
      editBtn.style.display = 'none';
      profileItem.appendChild(saveBtn);
      profileItem.appendChild(cancelBtn);
      
      // Focus input
      input.focus();
      input.select();
      
      // Enter key saves, Escape cancels
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveField(field);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit(field);
        }
      });
    }

    async function saveField(field) {
      if (!isEditing || currentEditingField !== field) return;
      
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const input = profileItem.querySelector('.edit-input');
      const newValue = input.value.trim();
      
      if (!newValue) {
        showError('Value cannot be empty');
        return;
      }
      
      if (newValue === originalValue) {
        cancelEdit(field);
        return;
      }
      
      console.log(`ðŸ’¾ Saving field ${field}: "${originalValue}" â†’ "${newValue}"`);
      showLoading();
      
      try {
        const token = localStorage.getItem('user_token');
        const email = localStorage.getItem('user_email');
        const uid = localStorage.getItem('user_uid');
        
        const payload = {
          user_email: email,
          user_uid: uid,
          user_token: token,
          action: 'update',
          field: field,
          value: newValue
        };
        
        console.log('ðŸ“¤ Sending payload:', payload);
        
        const resp = await fetch('https://hook.eu2.make.com/lya166veex7oo2wwo8mx4fuhlkssxlog', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('ðŸ“¡ Response status:', resp.status);
        
        // Handle response more carefully like in loadProfile
        const responseText = await resp.text();
        console.log('ðŸ“‹ Raw response:', responseText);
        
        let result;
        
        // Check if response is just "Accepted" or similar non-JSON
        if (responseText.trim() === 'Accepted' || responseText.trim() === 'OK' || responseText.trim() === 'Success') {
          console.log('âœ… Simple status response - assuming success');
          result = { success: true, message: 'Updated successfully' };
        } else {
          try {
            result = JSON.parse(responseText);
            console.log('âœ… Parsed JSON response:', result);
          } catch (parseError) {
            // If not JSON and response was OK, assume success
            if (resp.ok) {
              console.log('âœ… Non-JSON response but HTTP OK - assuming success');
              result = { success: true, message: responseText };
            } else {
              throw new Error('Invalid response format');
            }
          }
        }
        
        // CRITICAL: Update localStorage if email was changed successfully
        if (field === 'email' && resp.ok) {
          console.log(`ðŸ”„ Updating localStorage email: "${email}" â†’ "${newValue}"`);
          localStorage.setItem('user_email', newValue);
        }
        
        finishEdit(field, newValue);
        showSuccess(`${field} updated successfully!`);
        
      } catch (error) {
        console.error(`âŒ Error saving ${field}:`, error);
        showError(`Save error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    function cancelEdit(field) {
      console.log(`âŒ Cancel editing field: ${field}`);
      finishEdit(field, originalValue);
    }

    function finishEdit(field, finalValue) {
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const valueSpan = profileItem.querySelector('.value');
      const editBtn = profileItem.querySelector('.edit-btn');
      const input = profileItem.querySelector('.edit-input');
      const saveBtn = profileItem.querySelector('.save-btn');
      const cancelBtn = profileItem.querySelector('.cancel-btn');
      
      // Update value
      valueSpan.textContent = finalValue;
      valueSpan.style.display = 'flex';
      
      // Remove input and buttons
      if (input) input.remove();
      if (saveBtn) saveBtn.remove();
      if (cancelBtn) cancelBtn.remove();
      
      // Show edit button
      editBtn.style.display = 'inline-block';
      
      // Remove editing class
      profileItem.classList.remove('editing');
      
      // Reset state
      isEditing = false;
      currentEditingField = null;
      originalValue = null;
    }

    // VEILIGERE versie van setField functie
function setField(field, text) {
  const element = document.getElementById(field);
  if (element) {
    element.textContent = String(text || '');
  } else {
    console.warn(`âš ï¸ Element with id '${field}' not found`);
  }
}

    function showError(msg) {
      hideMessages();
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
      setTimeout(hideMessages, 5000);
    }

    function showSuccess(msg) {
      hideMessages();
      const successDiv = document.getElementById('success');
      successDiv.textContent = msg;
      successDiv.style.display = 'block';
      setTimeout(hideMessages, 3000);
    }

    function showInfo(msg) {
      hideMessages();
      const infoDiv = document.getElementById('success'); // Use success div for info messages
      infoDiv.textContent = msg;
      infoDiv.style.display = 'block';
      setTimeout(hideMessages, 4000);
    }

    function hideMessages() {
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
    }

    function showLoading() {
      document.body.classList.add('loading');
    }

    function hideLoading() {
      document.body.classList.remove('loading');
    }

    // ===== NETLIFY IDENTITY BUTTON UPDATES =====
    function updateLoginButton() {
      const loginBtn = document.getElementById('loginBtn');
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      
      // Check both Netlify Identity and local storage for user info
      const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      const localEmail = localStorage.getItem("user_email");
      const localToken = localStorage.getItem("user_token");
      
      const isLoggedIn = netlifyUser || (localEmail && localToken);
      
      if (isLoggedIn) {
        // Always show "Profile" for logged in users instead of their name
        
        // Update desktop button
        if (loginBtn) {
          loginBtn.textContent = 'Profile';
          loginBtn.href = 'profile.html';
        }
        
        // Update mobile button
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">ðŸ‘¤</span>'}Profile`;
          mobileLoginBtn.href = 'profile.html';
        }
      } else {
        // User is not logged in
        if (loginBtn) {
          loginBtn.textContent = 'Login/Register';
          loginBtn.href = 'profile.html';
        }
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">ðŸ‘¤</span>'}Login/Register`;
          mobileLoginBtn.href = 'profile.html';
        }
      }
    }

    // Enhanced click handler for navigation links
    function setupNavigationClickHandlers() {
      const loginBtn = document.getElementById('loginBtn');
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      
      // Desktop login button click handler
      if (loginBtn) {
        loginBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
          const localEmail = localStorage.getItem("user_email");
          const localToken = localStorage.getItem("user_token");
          const isLoggedIn = netlifyUser || (localEmail && localToken);
          
          if (isLoggedIn) {
            // User is logged in, go directly to profile page
            window.location.href = 'profile.html';
          } else {
            // User not logged in, store current page for redirect and open login
            localStorage.setItem('login_redirect_url', window.location.href);
            openLogin();
          }
        });
      }
      
      // Mobile login button click handler
      if (mobileLoginBtn) {
        mobileLoginBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
          const localEmail = localStorage.getItem("user_email");
          const localToken = localStorage.getItem("user_token");
          const isLoggedIn = netlifyUser || (localEmail && localToken);
          
          if (isLoggedIn) {
            // User is logged in, go directly to profile page
            window.location.href = 'profile.html';
          } else {
            // User not logged in, store current page for redirect and open login
            localStorage.setItem('login_redirect_url', window.location.href);
            openLogin();
          }
          
          // Close mobile menu after click
          closeMobileMenu();
        });
      }
    }

    // Function to open login modal
    function openLogin() {
      if (window.netlifyIdentity) {
        console.log('ðŸ”“ Opening Netlify Identity modal...');
        
        // Close mobile menu first if open
        closeMobileMenu();
        
        // Add modal-open class preemptively
        document.body.classList.add('modal-open');
        
        // Force modal styling before opening
        setTimeout(() => {
          forceModalToTop();
        }, 50);
        
        window.netlifyIdentity.open('login');
        
        // Additional force after opening
        setTimeout(() => {
          forceModalToTop();
        }, 200);
        
      } else {
        // Fallback if Netlify Identity is not available
        console.log('âŒ Netlify Identity not available, redirecting to profile page');
        window.location.href = 'profile.html';
      }
    }

    // Initialize login button on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Update immediately on page load
      updateLoginButton();
      
      // Set up click handlers
      setupNavigationClickHandlers();
      
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          updateLoginButton();
        });

        // DISABLED: Duplicate login listener removed to prevent double webhook calls

        window.netlifyIdentity.on('logout', () => {
          updateLoginButton();
        });
      }
      
      // Add logout button event listener
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ðŸšª Logout button clicked');
          handleLogout();
        });
      }
    });

    // ===== PRICING CARD STATE MANAGEMENT =====
   // ===== PRICING CARD STATE MANAGEMENT =====
function updatePricingCard(plan) {
  // Hide all active states and show all upgrade buttons first
  const discoverButton = document.getElementById('discoverButton');
  const engageButton = document.getElementById('engageButton');
  const engageActive = document.getElementById('engageActive');
  const immerseButton = document.getElementById('immerseButton');
  const immerseActive = document.getElementById('immerseActive');
  
  console.log('ðŸŽ¯ Updating pricing cards for plan:', plan);
  
  // Reset all cards to default state
  if (discoverButton) {
    discoverButton.textContent = 'Active';
    discoverButton.disabled = true;
    discoverButton.classList.add('current-plan');
    discoverButton.classList.remove('upgrade-button');
  }
  
  if (engageButton) {
    engageButton.style.display = 'block';
    engageButton.disabled = false;
  }
  if (engageActive) engageActive.style.display = 'none';
  
  // Reset trial notices
  const engageTrialNotice = document.getElementById('engageTrialNotice');
  if (engageTrialNotice) engageTrialNotice.style.display = 'none';
  
  if (immerseButton) {
    immerseButton.style.display = 'block';
    immerseButton.disabled = false;
  }
  if (immerseActive) immerseActive.style.display = 'none';
  
  // Update based on user's actual plan
  if (plan) {
    const planLower = plan.toLowerCase();
    
    if (planLower === 'engage' || planLower === 'premium' || planLower === 'pro' || planLower === 'paid') {
      // User has Engage plan
      if (discoverButton) {
        discoverButton.textContent = 'Downgrade to Free';
        discoverButton.disabled = false;
        discoverButton.classList.remove('current-plan');
        discoverButton.classList.add('upgrade-button', 'downgrade');
        discoverButton.onclick = () => handleDowngrade();
      }
      
      // Hide Engage button, show active badge
      if (engageButton) engageButton.style.display = 'none';
      if (engageActive) engageActive.style.display = 'block';
      
      // Check if user is on trial
      const subscriptionStatus = localStorage.getItem('subscription_status');
      const trialEndDate = localStorage.getItem('trial_end_date');
      
      if (subscriptionStatus === 'trial' && trialEndDate) {
        console.log('ðŸ“… Showing trial information for Engage plan');
        const engageTrialNotice = document.getElementById('engageTrialNotice');
        const engageTrialDateEl = document.getElementById('engageTrialDate');
        
        if (engageTrialNotice && engageTrialDateEl) {
          // Format the trial end date
          const endDate = new Date(trialEndDate);
          const formattedDate = endDate.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });
          
          engageTrialDateEl.textContent = formattedDate;
          engageTrialNotice.style.display = 'block';
        }
      }
      
      // Show Immerse button as upgrade option
      if (immerseButton) {
        immerseButton.textContent = 'Upgrade to Immerse';
        immerseButton.onclick = () => handleUpgrade('immerse');
      }
      
      console.log('âœ… Showing Engage plan as active');
      
    } else if (planLower === 'immerse') {
      // User has Immerse plan
      if (discoverButton) {
        discoverButton.textContent = 'Downgrade to Free';
        discoverButton.disabled = false;
        discoverButton.classList.remove('current-plan');
        discoverButton.classList.add('upgrade-button', 'downgrade');
        discoverButton.onclick = () => handleDowngrade();
      }
      
      // Show Engage button as downgrade option
      if (engageButton) {
        engageButton.textContent = 'Downgrade to Engage';
        engageButton.classList.add('downgrade');
        engageButton.onclick = () => handlePlanChange('engage');
      }
      
      // Hide Immerse button, show active badge
      if (immerseButton) immerseButton.style.display = 'none';
      if (immerseActive) immerseActive.style.display = 'block';
      
      console.log('âœ… Showing Immerse plan as active');
      
    } else {
      // User has Free/Discover plan
      // Reset button texts to default upgrade options
      if (engageButton) {
        engageButton.textContent = 'Upgrade to Engage';
        engageButton.onclick = () => handleUpgrade('engage');
      }
      if (immerseButton) {
        immerseButton.textContent = 'Upgrade to Immerse';
        immerseButton.onclick = () => handleUpgrade('immerse');
      }
      console.log('ðŸ“¦ Showing upgrade options for free plan');
    }
  }
}

    // Show compact cancellation notice for specific plan
    function showCancellationNotice(cancelAtDate, planType) {
      if (!cancelAtDate) return;
      
      console.log('ðŸ“… showCancellationNotice called with:', { cancelAtDate, planType });
      
      // Convert timestamp to date if needed
      let date;
      if (typeof cancelAtDate === 'number' || /^\d+$/.test(cancelAtDate)) {
        date = new Date(parseInt(cancelAtDate) * 1000);
      } else {
        date = new Date(cancelAtDate);
      }
      
      // Format the date (shorter format)
      const options = { month: 'short', day: 'numeric' };
      const formattedDate = date.toLocaleDateString('en-US', options);
      
      console.log('ðŸ“… Formatted date:', formattedDate);
      
      // Hide any existing notices first
      const engageNotice = document.getElementById('engageCancelNotice');
      const immerseCancelNotice = document.getElementById('immerseCancelNotice');
      if (engageNotice) engageNotice.style.display = 'none';
      if (immerseCancelNotice) immerseCancelNotice.style.display = 'none';
      
      // Show notice based on current plan (where the user is now)
      let noticeShown = false;
      
      if (planType === 'Engage') {
        // User is on Engage plan with cancellation notice
        const engageDateEl = document.getElementById('engageCancelDate');
        if (engageNotice && engageDateEl) {
          engageDateEl.textContent = formattedDate;
          engageNotice.style.display = 'block';
          noticeShown = true;
          console.log('âœ… Engage cancellation notice shown');
        }
      } else if (planType === 'Immerse') {
        // User is on Immerse plan with cancellation notice  
        const immerseDateEl = document.getElementById('immerseCancelDate');
        if (immerseCancelNotice && immerseDateEl) {
          immerseDateEl.textContent = formattedDate;
          immerseCancelNotice.style.display = 'block';
          noticeShown = true;
          console.log('âœ… Immerse cancellation notice shown');
        }
      } else {
        // For Free users, try to show appropriate notice (fallback to Engage)
        const engageDateEl = document.getElementById('engageCancelDate');
        if (engageNotice && engageDateEl) {
          engageDateEl.textContent = formattedDate;
          engageNotice.style.display = 'block';
          noticeShown = true;
          console.log('âœ… Engage cancellation notice shown (fallback for Free user)');
        }
      }
      
      if (!noticeShown) {
        console.log('âŒ No cancellation notice elements found in DOM');
      }
    }

    // ===== PLAN CHANGE FUNCTIONALITY =====
    window.handlePlanChange = async function(targetPlan) {
      console.log('ðŸ”„ Plan change requested to:', targetPlan);
      
      const currentPlan = document.getElementById('plan')?.textContent?.toLowerCase();
      const stripeCustomerId = localStorage.getItem('stripe_customer_id');
      const uid = localStorage.getItem('user_uid');
      
      if (!stripeCustomerId || !uid) {
        showError('Unable to change plan. Please contact support.');
        return;
      }
      
      // Determine if this is a downgrade to free or a plan change
      if (targetPlan === 'free') {
        // Use existing downgrade flow
        handleDowngrade();
        return;
      }
      
      // For Engage <-> Immerse changes - use direct Stripe checkout instead of update-subscription
      customConfirm(
        `Are you sure you want to change to the ${targetPlan} plan? This will create a new subscription and cancel your current one.`,
        'Confirm Plan Change',
        async () => {
          // Use the upgrade flow instead which works better
          handleUpgrade(targetPlan);
        }
      );
    };

    // ===== DOWNGRADE FUNCTIONALITY =====
    window.handleDowngrade = async function() {
      console.log('â¬‡ï¸ Downgrade button clicked');
      
      customConfirm("Are you sure you want to cancel your subscription? You won't lose your character memories, we will store them for you safely. But you will lose access to your paid features.", 'Confirm Cancellation', () => {
        // Continue with downgrade logic
        performDowngrade();
      });
      return;
    }
    
    async function performDowngrade() {
      
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      const token = localStorage.getItem('user_token');
      const stripeCustomerId = localStorage.getItem('stripe_customer_id');
      
      if (!email || !uid || !token) {
        showError('You must be logged in to manage your subscription');
        return;
      }
      
      try {
        showLoading();
        
        // First: Cancel the Stripe subscription if customer ID exists
        console.log('ðŸ” Checking for Stripe customer ID:', stripeCustomerId);
        
        if (stripeCustomerId) {
          console.log('ðŸš« Cancelling Stripe subscription first...');
          
          try {
            const cancelResponse = await fetch('/.netlify/functions/cancel-subscription', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customer_id: stripeCustomerId,
                user_uid: uid
              })
            });
            
            const cancelResult = await cancelResponse.json();
            
            if (!cancelResponse.ok) {
              console.error('âŒ Failed to cancel Stripe subscription:', cancelResult);
              // Continue with downgrade even if Stripe cancellation fails
              // The user can always cancel manually via Stripe
            } else {
              console.log('âœ… Stripe subscription cancelled:', cancelResult);
              
              // Save cancel date if available
              if (cancelResult.subscriptions_cancelled && cancelResult.subscriptions_cancelled[0]) {
                const cancelData = cancelResult.subscriptions_cancelled[0];
                if (cancelData.cancel_at_date) {
                  localStorage.setItem('subscription_cancel_at', cancelData.cancel_at_date);
                }
              }
            }
          } catch (stripeError) {
            console.error('âŒ Stripe cancellation error:', stripeError);
            // Continue with downgrade anyway
          }
        } else {
          console.warn('âš ï¸ No Stripe customer ID found in localStorage');
          console.log('ðŸ“‹ localStorage contents:', {
            user_email: localStorage.getItem('user_email'),
            user_uid: localStorage.getItem('user_uid'),
            stripe_customer_id: localStorage.getItem('stripe_customer_id')
          });
        }
        
        // Then: Call webhook to handle downgrade in database
        let cancelAt = localStorage.getItem('subscription_cancel_at');
        
        // If no cancel_at from Stripe, set to end of current month for manual downgrade
        if (!cancelAt && !stripeCustomerId) {
          const endOfMonth = new Date();
          endOfMonth.setMonth(endOfMonth.getMonth() + 1, 0); // Last day of current month
          endOfMonth.setHours(23, 59, 59, 999); // End of day
          cancelAt = endOfMonth.toISOString();
          console.log('â° Setting manual downgrade expiry to end of month:', cancelAt);
          
          // Save to localStorage so UI can show notice immediately
          localStorage.setItem('subscription_cancel_at', cancelAt);
        }
        
        const payload = {
  netlifyuid: uid,
  user_email: email,
  action: 'manual_downgrade',
  subscription_status: 'cancelled',
  cancel_at: cancelAt,
  plan: 'Free',
  quota: 50
};
        
        console.log('ðŸ“¡ Sending downgrade request with payload:', JSON.stringify(payload, null, 2));
        
        const resp = await fetch('https://hook.eu2.make.com/p4qk5bzmdq987erwlo0g0bjv2xvgb5mt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        // Handle response more carefully like in saveField
        const responseText = await resp.text();
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          if (resp.ok) {
            result = { success: true, message: responseText };
          } else {
            throw new Error('Invalid response format');
          }
        }
        
        console.log('âœ… Downgrade response:', result);
        
        showSuccess('Successfully cancelled your subscription. Your access will remain active until the end of your billing period.');
        
        // Reload profile to update UI with downgrade flag
        setTimeout(() => {
          window.location.href = 'profile.html?downgrade=success';
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Error downgrading plan:', error);
        showError(`Downgrade error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    // ===== USAGE RESET COUNTDOWN =====
function updateUsageCountdown(plan, usage, quota) {
  const countdownEl = document.getElementById('reset-countdown');
  
  // Hide countdown - we now use subscription-based system instead of 30-day resets
  if (countdownEl) {
    countdownEl.style.display = 'none';
  }
}

// ===== ENHANCED FORCE NETLIFY MODAL STYLING =====
function applyNetlifyModalStyling() {
  console.log('ðŸŽ¨ Attempting to apply modal styling...');
  
  // Wacht tot modal volledig geladen is
  setTimeout(() => {
    try {
      // METHODE 1: Style de widget container zelf
      const widget = document.querySelector('.netlify-identity-widget');
      if (widget) {
        widget.style.fontFamily = 'Plus Jakarta Sans, sans-serif !important';
        widget.style.backdropFilter = 'blur(20px)';
        widget.style.background = 'rgba(30, 41, 59, 0.8)';
        console.log('âœ… Widget container styled');
      }

      // METHODE 2: Style iframe container
      const iframe = document.querySelector('.netlify-identity-widget iframe');
      if (iframe) {
        iframe.style.borderRadius = '24px';
        iframe.style.border = '2px solid #14b8a6';
        iframe.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1)';
        iframe.style.overflow = 'hidden';
        console.log('âœ… Iframe styled');
      }

      // METHODE 3: Force styling op alle netlify elementen
      const allNetlifyElements = document.querySelectorAll('[class*="netlify"]');
      allNetlifyElements.forEach(el => {
        el.style.fontFamily = 'Plus Jakarta Sans, sans-serif';
        el.style.color = '#1e293b';
      });

      // METHODE 4: Inject custom CSS direct in document
      const customStyles = `
        <style id="netlify-custom-styling">
          .netlify-identity-widget * {
            font-family: 'Plus Jakarta Sans', sans-serif !important;
          }
          .netlify-identity-widget iframe {
            border-radius: 24px !important;
            border: 2px solid #14b8a6 !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
          }
        </style>
      `;
      
      if (!document.getElementById('netlify-custom-styling')) {
        document.head.insertAdjacentHTML('beforeend', customStyles);
        console.log('âœ… Custom CSS injected');
      }

    } catch (error) {
      console.log('âš ï¸ Styling attempt blocked:', error);
    }
  }, 100);

  // Herhaal styling om er zeker van te zijn
  setTimeout(() => applyForcedStyling(), 300);
  setTimeout(() => applyForcedStyling(), 600);
  setTimeout(() => applyForcedStyling(), 1000);
}

function applyForcedStyling() {
  try {
    // Probeer styling opnieuw toe te passen
    const iframe = document.querySelector('.netlify-identity-widget iframe');
    if (iframe) {
      iframe.style.setProperty('border-radius', '24px', 'important');
      iframe.style.setProperty('border', '2px solid #14b8a6', 'important');
      iframe.style.setProperty('font-family', 'Plus Jakarta Sans, sans-serif', 'important');
    }
    
    const widget = document.querySelector('.netlify-identity-widget');
    if (widget) {
      widget.style.setProperty('font-family', 'Plus Jakarta Sans, sans-serif', 'important');
    }
  } catch (error) {
    console.log('âš ï¸ Forced styling blocked:', error);
  }
}

// Pas styling toe bij elke modal open
function setupModalStyling() {
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('open', () => {
      console.log('ðŸŽ¨ Modal opened - applying styling...');
      applyNetlifyModalStyling();
      
      // Update Optional field
      const updateOptionalField = () => {
        const optionalInput = document.querySelector('.netlify-identity-widget input[placeholder="Optional"], .netlify-identity-widget input[placeholder="Nickname"]');
        if (optionalInput) {
          optionalInput.placeholder = 'Name (optional)';
          optionalInput.removeAttribute('required');
        }
      };
      updateOptionalField();
      
      // Extra agressieve herhaling
      const stylingInterval = setInterval(() => {
        applyForcedStyling();
        updateOptionalField(); // Also update field during styling
      }, 200);
      
      // Stop na 5 seconden
      setTimeout(() => {
        clearInterval(stylingInterval);
      }, 5000);
    });

    // Ook proberen bij init
    window.netlifyIdentity.on('init', () => {
      console.log('ðŸŽ¨ Identity initialized - preparing styling...');
      applyNetlifyModalStyling();
    });
  }
}

// Initialize styling setup
document.addEventListener('DOMContentLoaded', () => {
  setupModalStyling();
});

// Pas styling toe bij elke modal open
function setupModalStyling() {
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('open', () => {
      console.log('ðŸŽ¨ Applying modal styling...');
      applyNetlifyModalStyling();
      
      // Herhaal styling meerdere keren voor zekerheid
      setTimeout(applyNetlifyModalStyling, 500);
      setTimeout(applyNetlifyModalStyling, 1000);
    });
  }
}

// Initialize styling setup
document.addEventListener('DOMContentLoaded', () => {
  setupModalStyling();
  
  // Show random USP
  const uspItems = document.querySelectorAll('.usp-item');
  if (uspItems.length > 0) {
    // Hide all USPs first
    uspItems.forEach(item => item.style.display = 'none');
    
    // Show a random one
    const randomIndex = Math.floor(Math.random() * uspItems.length);
    uspItems[randomIndex].style.display = 'flex';
  }
});

// Check trial status and handle expiration
async function checkTrialStatus(email, uid) {
  try {
    const response = await fetch('/.netlify/functions/check-trial', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_email: email, user_uid: uid })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.trial_expired) {
        console.log('â° Trial has expired, updating localStorage');
        localStorage.setItem('user_plan', 'Free');
        localStorage.setItem('subscription_status', 'expired_trial');
        localStorage.removeItem('trial_end_date');
        
        // Show notification about trial expiration
        showNotification('â° Your 7-day Engage trial has ended. Upgrade to continue with unlimited messaging!');
      } else if (data.current_plan === 'Engage' && data.subscription_status === 'trial') {
        // Update localStorage with current trial info
        localStorage.setItem('user_plan', 'Engage');
        localStorage.setItem('subscription_status', 'trial');
        if (data['grace_period_end']) {
          localStorage.setItem('trial_end_date', data['grace_period_end']);
          console.log('ðŸ“… Trial end date from check-trial:', data['grace_period_end']);
        }
        
        // Update trial status display after data is loaded
        updateTrialStatus();
      }
    }
  } catch (error) {
    console.error('âŒ Error checking trial status:', error);
  }
}

// Function to update trial status display
function updateTrialStatus() {
  const trialStatus = document.getElementById('trialStatus');
  const subscriptionStatus = localStorage.getItem('subscription_status');
  const trialEndDate = localStorage.getItem('trial_end_date');
  
  console.log('ðŸ” updateTrialStatus called:', { subscriptionStatus, trialEndDate, hasTrialStatus: !!trialStatus });
  
  if (subscriptionStatus === 'trial' && trialEndDate && trialStatus) {
    console.log('ðŸ“… Updating trial status display');
    
    // Calculate days remaining
    const endDate = new Date(trialEndDate);
    const now = new Date();
    const daysRemaining = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
    
    // Update trial information
    const trialDaysEl = document.getElementById('trialDaysRemaining');
    const trialEndEl = document.getElementById('trialEndDate');
    
    if (trialDaysEl) trialDaysEl.textContent = daysRemaining;
    if (trialEndEl) {
      const formattedDate = endDate.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
      trialEndEl.textContent = formattedDate;
    }
    
    trialStatus.style.display = 'block';
    console.log('âœ… Trial status display updated');
  }
}

  </script>
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="index.html" class="footer-link">Home</a>
        <span class="footer-separator">â€¢</span>
        <a href="chat-overview.html" class="footer-link">My Companions</a>
        <span class="footer-separator">â€¢</span>
        <a href="/create-character" class="footer-link">Create Character</a>
        <span class="footer-separator">â€¢</span>
        <a href="contact.html" class="footer-link">Contact</a>
        <span class="footer-separator">â€¢</span>
        <a href="profile.html" class="footer-link">Profile</a>
        <span class="footer-separator">â€¢</span>
        <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
        <span class="footer-separator">â€¢</span>
        <a href="terms-and-conditions.html" class="footer-link">Terms and Conditions</a>
      </div>
      <div class="footer-copyright">
        Â© 2025 Narrin AI. All rights reserved.
      </div>
    </div>
  </footer>
</body>
</html> 