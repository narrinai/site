<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile - Narrin AI</title>
<!-- Netlify Identity Widget met configuratie -->
<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  // Configureer widget styling
  if (window.netlifyIdentity) {
    window.netlifyIdentity.init({
      theme: 'custom',
      colors: {
        primary: '#14b8a6',
        secondary: '#f97316'
      },
      logo: false, // Verberg Netlify logo
      locale: 'en'
    });
  }
</script>  
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  
  <!-- Import Modern Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS CUSTOM PROPERTIES ===== */
    :root {
      /* Primary Colors */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      
      /* Accent Colors */
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-teal-alt: #10a394;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-coral-dark: #ea580c;
      
      /* Supporting Colors */
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      --gradient-subtle: linear-gradient(135deg, var(--color-teal-light) 0%, var(--color-coral-light) 100%);
      --gradient-tags: linear-gradient(135deg, var(--color-teal-alt) 0%, var(--color-coral) 100%);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-colored: 0 10px 25px -5px rgba(20, 184, 166, 0.2);
      
      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Font Sizes */
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms ease-out;
      --transition-base: 300ms ease-out;
      --transition-slow: 500ms ease-out;
      
      /* Touch Target Size */
      --touch-target: 44px;
      
      /* Z-index Scale - AANGEPAST VOOR NETLIFY MODAL */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-overlay: 300;
      --z-modal: 400;
      --z-menu-overlay: 500;
      --z-netlify-modal: 2147483647; /* Maximum z-index voor Netlify Identity modal */
    }

    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      overflow-x: hidden;
    }

    body {
      font-family: var(--font-primary);
      background: var(--color-off-white);
      color: var(--color-navy);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      width: 100%;
    }

    /* ===== ACCESSIBILITY ===== */
    :focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    /* ===== HEADER NAVIGATION ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: all var(--transition-base);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      width: 100%;
      overflow: hidden;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 72px;
      gap: var(--spacing-lg);
      width: 100%;
    }

    /* Logo */
    .logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 800;
      text-decoration: none;
      letter-spacing: -0.02em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: transform var(--transition-base);
      flex-shrink: 0;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    /* Desktop Navigation Center */
    .nav-center {
      display: none;
      align-items: center;
      gap: var(--spacing-2xl);
      flex: 1;
      justify-content: center;
    }

    /* USPs Container - Desktop */
    .nav-usps {
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
    }

    .usp-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-gray-dark);
      font-size: var(--font-size-xs);
      font-weight: 500;
      white-space: nowrap;
    }

    .usp-icon {
      font-size: var(--font-size-lg);
      color: var(--color-teal);
    }

    /* Search Bar - Desktop */
    .nav-search {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .nav-search-input {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-lg);
      padding-right: calc(var(--spacing-lg) * 2.5);
      font-size: var(--font-size-sm);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .nav-search-input:hover {
      border-color: var(--color-gray-light);
    }

    .nav-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .nav-search-input::placeholder {
      color: var(--color-gray-light);
    }

    .search-submit {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .search-submit:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .search-submit svg {
      width: 18px;
      height: 18px;
      color: var(--color-white);
    }

    /* Navigation Links - Desktop */
    .nav-links {
      display: none;
      align-items: center;
      gap: var(--spacing-xl);
    }

    .nav-link {
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-sm);
      transition: color var(--transition-base);
      position: relative;
      padding: var(--spacing-xs) 0;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--gradient-primary);
      transition: width var(--transition-base);
    }

    .nav-link:hover {
      color: var(--color-teal);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-sm);
      font-weight: 600;
      text-decoration: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      min-height: var(--touch-target);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Mobile Navigation Container */
    .mobile-nav-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    /* Mobile Chat Button */
    .mobile-chat-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-teal);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
      text-decoration: none;
    }

    .mobile-chat-btn:hover {
      background: var(--color-light-gray);
      color: var(--color-teal-dark);
    }

    .mobile-chat-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Search Button */
    .mobile-search-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .mobile-search-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Hamburger Menu */
    .mobile-menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      position: relative;
      flex-shrink: 0;
      z-index: var(--z-menu-overlay);
    }

    .mobile-menu-btn:hover {
      background: var(--color-light-gray);
    }

    .hamburger {
      width: 24px;
      height: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: var(--color-navy);
      border-radius: 1px;
      transition: all var(--transition-base);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile Menu Overlay - Full Screen */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: var(--z-overlay);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mobile-menu-content {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl) var(--spacing-xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
    }

    .mobile-menu-overlay.active .mobile-menu-content {
      transform: scale(1) translateY(0);
    }

    .mobile-menu-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .mobile-menu-logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .mobile-menu-subtitle {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
    }

    .mobile-menu-nav {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .mobile-menu-link {
      display: flex;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      background: var(--color-off-white);
    }

    .mobile-menu-link:hover {
      background: var(--color-light-gray);
      color: var(--color-teal);
      transform: translateX(4px);
    }

    .mobile-menu-link.btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      justify-content: center;
      font-weight: 700;
      margin-top: var(--spacing-lg);
    }

    .mobile-menu-link.btn-primary:hover {
      background: var(--gradient-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .mobile-menu-link-icon {
      margin-right: var(--spacing-sm);
      font-size: var(--font-size-lg);
    }

    /* Mobile Search Overlay */
    .mobile-search-overlay {
      position: fixed;
      top: 72px;
      left: 0;
      right: 0;
      background: var(--color-white);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: var(--z-dropdown);
    }

    .mobile-search-overlay.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .mobile-search-form {
      display: flex;
      gap: var(--spacing-sm);
    }

    .mobile-search-input {
      flex: 1;
      padding: var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .mobile-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* Desktop Styles */
    @media (min-width: 769px) {
      .nav-center {
        display: flex;
      }

      .nav-links {
        display: flex;
      }

      .mobile-nav-container {
        display: none;
      }

      .mobile-chat-btn {
        display: none !important;
      }

      .mobile-search-btn {
        display: none !important;
      }

      .mobile-menu-btn {
        display: none !important;
      }

      .mobile-menu-overlay {
        display: none !important;
      }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .header-container {
        padding: 0 var(--spacing-md);
      }

      .header-content {
        min-height: 60px;
        gap: var(--spacing-sm);
        padding: 0;
        display: grid;
        grid-template-columns: auto 1fr auto auto auto;
        align-items: center;
      }

      .logo {
        font-size: var(--font-size-lg);
        flex-shrink: 0;
        min-width: fit-content;
        grid-column: 1;
      }

      .mobile-nav-container {
        flex-shrink: 0;
        min-width: fit-content;
        display: flex !important;
        gap: var(--spacing-xs);
        grid-column: 3 / 6;
        justify-self: end;
      }

      .nav-center {
        display: none !important;
      }

      .nav-links {
        display: none !important;
      }

            .mobile-chat-btn {
        display: flex;
        flex-shrink: 0;
      }

.mobile-search-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-menu-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-search-overlay {
        top: 60px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .header-content {
        gap: var(--spacing-xs);
        grid-template-columns: auto 1fr auto auto auto;
      }
      
      .logo {
        font-size: var(--font-size-base);
      }
    }

    /* ===== NETLIFY IDENTITY MODAL Z-INDEX FIX ===== */
    
    /* EXTREME Z-INDEX FIX - Force ALL Netlify elements to highest possible z-index */
    .netlify-identity-widget,
    .netlify-identity-widget *,
    [data-netlify-identity-widget],
    [data-netlify-identity-widget] *,
    .netlify-identity-widget iframe,
    .netlify-identity-widget > div,
    .netlify-identity-widget .netlify-identity-modal,
    .netlify-identity-widget .netlify-identity-modal *,
    .netlify-identity-widget .netlify-identity-modal > *,
    .netlify-identity-widget .netlify-identity-modal div,
    .netlify-identity-modal,
    .netlify-identity-modal *,
    div[data-netlify-identity-modal],
    div[data-netlify-identity-modal] * {
      z-index: 999999999 !important;
      position: relative !important;
    }

    /* GEFIXTE VERSIE: Alleen z-index verlagen, NIET visibility verbergen */
    body:has(.netlify-identity-widget) .header,
    body:has(.netlify-identity-widget) .mobile-menu-overlay,
    body:has(.netlify-identity-widget) .mobile-search-overlay,
    body:has(.netlify-identity-widget) nav,
    body:has(.netlify-identity-widget) header {
      z-index: 1 !important;
      position: relative !important;
      /* VERWIJDERD: visibility: hidden !important; */
    }

    /* Universal Netlify modal override */
    div[class*="netlify"],
    iframe[src*="netlify"],
    div[id*="netlify"],
    *[class*="identity"],
    *[data-netlify-identity-widget],
    *[data-netlify-identity-modal] {
      z-index: 999999999 !important;
      position: fixed !important;
    }

    /* GEFIXTE mobiele modal behandeling */
    @media (max-width: 768px) {
      /* Zorgt ervoor dat modal OVER de navigatie komt zonder deze te verbergen */
      .netlify-identity-widget {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 999999999 !important;
        background: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* Modal wrapper */
      .netlify-identity-widget > div {
        position: relative !important;
        width: 100% !important;
        max-width: 400px !important;
        height: auto !important;
        max-height: 90vh !important;
        z-index: 999999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px !important;
        box-sizing: border-box !important;
      }

      /* Actual modal */
      .netlify-identity-widget .netlify-identity-modal {
        position: relative !important;
        width: 100% !important;
        max-width: 400px !important;
        max-height: 90vh !important;
        margin: 0 !important;
        border-radius: 16px !important;
        z-index: 999999999 !important;
        overflow-y: auto !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        background: white !important;
      }
    }

    /* Desktop modal positioning */
    @media (min-width: 769px) {
      .netlify-identity-widget {
        z-index: 999999999 !important;
        position: fixed !important;
      }
      
      .netlify-identity-widget .netlify-identity-modal {
        margin-top: 100px !important;
        z-index: 999999999 !important;
      }
    }

    /* AANGEPASTE JavaScript-based fix */
    .modal-open {
      overflow: hidden !important;
    }
    
    .modal-open .header {
      z-index: 1 !important;
      /* VERWIJDERD: visibility: hidden !important; */
    }
    
    .modal-open .mobile-menu-overlay,
    .modal-open .mobile-search-overlay {
      z-index: 1 !important;
      /* VERWIJDERD: display: none !important; */
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }
    
    .page-header h1 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-4xl);
      margin: 0 0 var(--spacing-md) 0;
      color: var(--color-navy);
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    
    .page-header p {
      color: var(--color-gray);
      font-size: var(--font-size-lg);
      margin: 0;
      font-weight: 400;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: var(--spacing-xl);
      gap: var(--spacing-md);
    }

    /* ===== PROFILE CONTENT LAYOUT ===== */
    .profile-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: var(--spacing-xl);
      align-items: start;
    }

    /* ===== PREMIUM UPGRADE CARD ===== */
    .premium-card {
      width: 100%;
      height: 360px;
      background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 32px 32px;
      box-sizing: border-box;
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
      margin-bottom: var(--spacing-lg);
    }

    /* Background decorative elements */
    .premium-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
    }

    /* Premium crown icon */
    .crown-icon {
      position: absolute;
      top: 16px;
      right: 24px;
      font-size: 28px;
      opacity: 0.3;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    }

    /* Main content */
    .premium-content {
      position: relative;
      z-index: 2;
      text-align: center;
      color: white;
      width: 100%;
    }

    .premium-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 24px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-shadow: none;
      font-family: 'Plus Jakarta Sans', sans-serif;
      letter-spacing: 0.5px;
    }

    .benefits-list {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      text-align: left;
      max-width: 320px;
    }

    .benefit-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .benefit-item:last-child {
      margin-bottom: 0;
    }

    .checkmark {
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .checkmark::after {
      content: '✓';
      color: #14b8a6;
      font-weight: 800;
      font-size: 12px;
    }

    .benefit-text {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Upgrade Button */
    .upgrade-button {
      background: white;
      color: #14b8a6;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      letter-spacing: -0.01em;
      width: 100%;
    }

    .upgrade-button:hover {
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .upgrade-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .upgrade-button::after {
      content: '✨';
      font-size: 14px;
    }

    /* Premium Active State */
    .premium-active {
      text-align: center;
      width: 100%;
    }

    .premium-status-button {
      background: rgba(255, 255, 255, 0.9);
      color: #22c55e;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      padding: 14px 28px;
      border-radius: 14px;
      margin-bottom: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      letter-spacing: -0.01em;
      width: 100%;
      border: 2px solid rgba(34, 197, 94, 0.3);
    }

    .downgrade-link {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: color var(--transition-base);
      font-weight: 500;
    }

    .downgrade-link:hover {
      color: var(--color-teal);
      text-decoration: underline;
    }

    /* Subtle sparkle animation */
    .sparkle {
      position: absolute;
      color: rgba(255, 255, 255, 0.6);
      font-size: 10px;
      animation: sparkle 3s ease-in-out infinite;
    }

    .sparkle:nth-child(1) { top: 12%; left: 12%; animation-delay: 0s; }
    .sparkle:nth-child(2) { top: 20%; right: 15%; animation-delay: 1s; }
    .sparkle:nth-child(3) { bottom: 15%; left: 15%; animation-delay: 2s; }
    .sparkle:nth-child(4) { bottom: 25%; right: 12%; animation-delay: 0.5s; }

    @keyframes sparkle {
      0%, 100% { 
        opacity: 0.3; 
        transform: scale(1) rotate(0deg); 
      }
      50% { 
        opacity: 1; 
        transform: scale(1.2) rotate(180deg); 
      }
    }

    /* Subtle gradient overlay for depth */
    .gradient-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        transparent 30%, 
        transparent 70%, 
        rgba(0, 0, 0, 0.1) 100%
      );
      pointer-events: none;
    }
    
    .form-section {
      background: var(--color-white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }
    
    .form-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }
    
    .form-section h2 {
      margin: 0 0 var(--spacing-lg) 0;
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .profile-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg) 0;
      border-bottom: 1px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }
    
    .profile-item:last-child {
      border-bottom: none;
    }
    
    .profile-item.editing {
      background: var(--color-off-white);
      margin: calc(var(--spacing-lg) * -1) calc(var(--spacing-2xl) * -1);
      padding: var(--spacing-lg) var(--spacing-2xl);
      border-radius: var(--radius-md);
      border-bottom: none;
    }
    
    .label {
      font-weight: 600;
      color: var(--color-navy);
      margin-right: var(--spacing-lg);
      min-width: 100px;
      font-size: var(--font-size-sm);
    }
    
    .value {
      flex: 1;
      color: var(--color-gray);
      margin-right: var(--spacing-lg);
      font-size: var(--font-size-base);
    }
    
    .edit-btn, .save-btn, .cancel-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      display: none;
      margin-left: var(--spacing-xs);
      transition: all var(--transition-base);
    }
    
    .edit-btn {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-teal);
      box-shadow: var(--shadow-sm);
    }
    
    .edit-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }
    
    .save-btn {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }
    
    .save-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .cancel-btn {
      background: var(--color-light-gray);
      color: var(--color-gray-dark);
      border: 1px solid var(--color-gray-light);
    }
    
    .cancel-btn:hover {
      background: var(--color-gray-light);
      transform: translateY(-1px);
    }
    
    input.edit-input {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      margin-right: var(--spacing-lg);
      font-family: var(--font-primary);
      transition: all var(--transition-base);
      background: var(--color-white);
      color: var(--color-navy);
    }
    
    input.edit-input:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    #upgrade-btn {
      display: none;
      padding: var(--spacing-lg) var(--spacing-2xl);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-lg);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-base);
      width: 100%;
      margin-top: var(--spacing-lg);
      box-shadow: var(--shadow-colored);
    }
    
    #upgrade-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }
    
    .btn-form {
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      font-family: var(--font-primary);
    }
    
    #login-btn {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }
    
    #login-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* FIXED: Remove red background from logout link */
    #logout-btn {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: color var(--transition-base);
      font-weight: 500;
      background: none !important; /* Remove any background */
      border: none !important; /* Remove any border */
      padding: 0 !important; /* Remove any padding */
    }
    
    #logout-btn:hover {
      color: var(--color-teal);
    }
    
    #debug-toggle {
      background: var(--color-light-gray);
      color: var(--color-gray-dark);
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-sm);
      border: 1px solid var(--color-gray-light);
    }
    
    #debug-toggle:hover {
      background: var(--color-gray-light);
      transform: translateY(-1px);
    }
    
    #error {
      color: #c53030;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: #fed7d7;
      border-radius: var(--radius-md);
      border-left: 4px solid #c53030;
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-sm);
    }
    
    #success {
      color: #276749;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: #c6f6d5;
      border-radius: var(--radius-md);
      border-left: 4px solid #38a169;
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-sm);
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .usage-display {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .usage-bar {
      flex: 1;
      height: 8px;
      background: var(--color-light-gray);
      border-radius: var(--radius-full);
      overflow: hidden;
      max-width: 200px;
    }
    
    .usage-fill {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
      transition: width 0.5s ease;
    }
    
    .usage-text {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      font-weight: 500;
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .profile-content {
        grid-template-columns: 1fr;
        gap: var(--spacing-lg);
      }
      
      .premium-card {
        width: 100%;
        max-width: 600px;
        height: auto;
        min-height: 360px;
        margin: 0 auto var(--spacing-lg);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-lg);
      }
      
      .page-header h1 {
        font-size: var(--font-size-3xl);
      }
      
      .form-section {
        padding: var(--spacing-xl);
      }
      
      .header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .profile-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
      }
      
      .profile-item.editing {
        margin: calc(var(--spacing-lg) * -1) calc(var(--spacing-xl) * -1);
        padding: var(--spacing-lg) var(--spacing-xl);
      }
      
      .label {
        min-width: auto;
      }
      
      .value {
        width: 100%;
        margin-right: 0;
      }
      
      .edit-btn, .save-btn, .cancel-btn {
        width: 100%;
        margin: var(--spacing-xs) 0 0 0;
      }
      
      input.edit-input {
        width: 100%;
        margin-right: 0;
        margin-bottom: var(--spacing-xs);
      }
      
      .btn-form {
        width: 100%;
      }
      
      #debug-toggle {
        margin-top: var(--spacing-xs);
      }
      
      .usage-bar {
        max-width: none;
      }

      .premium-card {
        height: auto;
        min-height: 320px;
        padding: 24px 20px;
      }

      .premium-badge {
        font-size: 16px;
        padding: 8px 20px;
      }

      .benefit-item {
        font-size: 13px;
      }

      .upgrade-button {
        font-size: 14px;
        padding: 12px 24px;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ===== FOOTER STYLES ===== */
    .footer {
      background: var(--color-white);
      border-top: 1px solid var(--color-light-gray);
      padding: var(--spacing-xl) 0;
      margin-top: var(--spacing-3xl);
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      text-align: center;
    }

    .footer-links {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .footer-link {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      font-weight: 500;
      transition: color var(--transition-base);
    }

    .footer-link:hover {
      color: var(--color-teal);
    }

    .footer-separator {
      color: var(--color-gray-light);
      font-size: var(--font-size-sm);
    }

    .footer-copyright {
      color: var(--color-gray-light);
      font-size: var(--font-size-xs);
      margin: 0;
    }

    /* Mobile footer adjustments */
    @media (max-width: 768px) {
      .footer {
        padding: var(--spacing-lg) 0;
        margin-top: var(--spacing-2xl);
      }

      .footer-content {
        padding: 0 var(--spacing-md);
      }

      .footer-links {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .footer-separator {
        display: none;
      }
    }

    /* ===== LOGIN FORM STYLES ===== */
    .login-form-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      padding: var(--spacing-xl);
    }

    .login-form-section {
      background: var(--color-white);
      padding: var(--spacing-3xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
      text-align: center;
      max-width: 400px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .login-form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .login-form-section:hover {
      border-color: var(--color-teal);
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .login-icon-header {
      margin-bottom: var(--spacing-xl);
    }

    .login-icon-circle {
      width: 64px;
      height: 64px;
      background: var(--gradient-primary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      box-shadow: var(--shadow-colored);
      animation: pulse 2s ease-in-out infinite;
    }

    .login-icon-emoji {
      font-size: var(--font-size-2xl);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .login-form-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--color-navy);
      margin: 0 0 var(--spacing-lg) 0;
      letter-spacing: -0.01em;
    }

    .login-form-text {
      font-size: var(--font-size-base);
      color: var(--color-gray);
      margin: 0 0 var(--spacing-2xl) 0;
      line-height: 1.6;
    }

    .login-form-button {
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg) var(--spacing-2xl);
      font-size: var(--font-size-base);
      font-weight: 600;
      font-family: var(--font-primary);
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-colored);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .login-form-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .login-form-button:hover::before {
      left: 100%;
    }

    .login-form-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .login-form-button:active {
      transform: translateY(0);
    }

    .login-form-button .button-icon {
      font-size: var(--font-size-lg);
    }

    /* Mobile responsive adjustments for login form */
    @media (max-width: 768px) {
      .login-form-container {
        padding: var(--spacing-lg);
        min-height: 50vh;
      }

      .login-form-section {
        padding: var(--spacing-2xl);
        max-width: none;
      }

      .login-icon-circle {
        width: 56px;
        height: 56px;
      }

      .login-icon-emoji {
        font-size: var(--font-size-xl);
      }

      .login-form-title {
        font-size: var(--font-size-xl);
      }

      .login-form-button {
        padding: var(--spacing-md) var(--spacing-xl);
      }
    }

    /* ===== CUSTOM NOTIFICATION SYSTEM ===== */
    .notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999999999;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--transition-base);
    }

    .notification-overlay.active {
      display: flex;
      opacity: 1;
    }

    .notification-modal {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
      text-align: center;
    }

    .notification-overlay.active .notification-modal {
      transform: scale(1) translateY(0);
    }

    .notification-icon {
      font-size: var(--font-size-4xl);
      margin-bottom: var(--spacing-lg);
      display: block;
    }

    .notification-icon.success {
      color: var(--color-teal);
    }

    .notification-icon.error {
      color: var(--color-coral);
    }

    .notification-icon.warning {
      color: #f59e0b;
    }

    .notification-icon.info {
      color: #3b82f6;
    }

    .notification-icon.question {
      color: #8b5cf6;
    }

    .notification-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-navy);
      margin-bottom: var(--spacing-md);
    }

    .notification-message {
      color: var(--color-gray-dark);
      font-size: var(--font-size-base);
      line-height: 1.6;
      margin-bottom: var(--spacing-xl);
    }

    .notification-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }

    .notification-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      min-width: 100px;
      font-family: var(--font-primary);
    }

    .notification-btn.primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .notification-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .notification-btn.secondary {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-light-gray);
    }

    .notification-btn.secondary:hover {
      border-color: var(--color-teal);
      color: var(--color-teal);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .notification-modal {
        margin: var(--spacing-lg);
        padding: var(--spacing-xl);
      }

      .notification-buttons {
        flex-direction: column;
      }

      .notification-btn {
        width: 100%;
      }
    }

    /* ===== NETLIFY IDENTITY NAME FIELD VERBERGEN ===== */
    
    /* Verberg name field in Netlify Identity modal */
    .netlify-identity-widget input[name="name"],
    .netlify-identity-widget input[placeholder*="Name"],
    .netlify-identity-widget input[placeholder*="name"],
    .netlify-identity-widget label[for*="name"],
    .netlify-identity-widget .netlify-identity-item:has(input[name="name"]) {
      display: none !important;
    }
    
    /* Verberg ook de label/wrapper van name field */
    .netlify-identity-widget .netlify-identity-item:nth-child(1) {
      display: none !important;
    }
    
    /* Extra fallback selectors voor verschillende Netlify UI versies */
    .netlify-identity-widget [data-netlify-identity-signup] input[name="name"],
    .netlify-identity-widget [data-netlify-identity-signup] input[type="text"]:first-of-type,
    .netlify-identity-widget form input[name="name"],
    .netlify-identity-widget form input[type="text"]:first-child {
      display: none !important;
    }
    
    /* Verberg parent containers van name fields */
    .netlify-identity-widget div:has(input[name="name"]),
    .netlify-identity-widget .form-group:has(input[name="name"]),
    .netlify-identity-widget .field:has(input[name="name"]) {
      display: none !important;
    }

/* ===== NETLIFY IDENTITY MODAL CUSTOM STYLING ===== */

/* Modal overlay/backdrop */
.netlify-identity-widget {
  font-family: var(--font-primary) !important;
  backdrop-filter: blur(20px) !important;
  -webkit-backdrop-filter: blur(20px) !important;
}

/* Modal container iframe */
.netlify-identity-widget iframe {
  border-radius: var(--radius-xl) !important;
  box-shadow: var(--shadow-xl) !important;
  border: none !important;
  overflow: hidden !important;
}

/* Modal content styling */
.netlify-identity-widget .netlify-identity-modal,
.netlify-identity-widget div[data-netlify-identity-modal] {
  background: var(--color-white) !important;
  border-radius: var(--radius-xl) !important;
  font-family: var(--font-primary) !important;
  box-shadow: var(--shadow-xl) !important;
  border: 2px solid var(--color-light-gray) !important;
}

/* Modal headers */
.netlify-identity-widget h1,
.netlify-identity-widget h2,
.netlify-identity-widget h3 {
  color: var(--color-navy) !important;
  font-family: var(--font-secondary) !important;
  font-weight: 700 !important;
  letter-spacing: -0.01em !important;
  margin-bottom: var(--spacing-lg) !important;
}

/* Modal text/paragraphs */
.netlify-identity-widget p,
.netlify-identity-widget span,
.netlify-identity-widget div {
  color: var(--color-gray-dark) !important;
  font-family: var(--font-primary) !important;
  line-height: 1.6 !important;
}

/* Input fields */
.netlify-identity-widget input[type="email"],
.netlify-identity-widget input[type="password"],
.netlify-identity-widget input[type="text"] {
  padding: var(--spacing-md) var(--spacing-lg) !important;
  font-size: var(--font-size-base) !important;
  font-family: var(--font-primary) !important;
  border: 2px solid var(--color-light-gray) !important;
  border-radius: var(--radius-md) !important;
  background: var(--color-white) !important;
  color: var(--color-navy) !important;
  transition: all var(--transition-base) !important;
  margin-bottom: var(--spacing-md) !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.netlify-identity-widget input:focus {
  outline: none !important;
  border-color: var(--color-teal) !important;
  box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1) !important;
  transform: translateY(-2px) !important;
}

.netlify-identity-widget input::placeholder {
  color: var(--color-gray-light) !important;
}

/* Primary buttons (Login, Sign Up, etc.) */
.netlify-identity-widget button[type="submit"],
.netlify-identity-widget .btn,
.netlify-identity-widget button.btn-primary {
  background: var(--gradient-primary) !important;
  color: var(--color-white) !important;
  border: none !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-md) var(--spacing-xl) !important;
  font-size: var(--font-size-base) !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
  width: 100% !important;
  margin-bottom: var(--spacing-md) !important;
  box-shadow: var(--shadow-colored) !important;
  min-height: var(--touch-target) !important;
}

.netlify-identity-widget button[type="submit"]:hover,
.netlify-identity-widget .btn:hover,
.netlify-identity-widget button.btn-primary:hover {
  transform: translateY(-2px) !important;
  box-shadow: var(--shadow-lg) !important;
  opacity: 0.95 !important;
}

/* Secondary buttons */
.netlify-identity-widget button:not([type="submit"]):not(.btn-primary),
.netlify-identity-widget .btn-secondary {
  background: var(--color-white) !important;
  color: var(--color-navy) !important;
  border: 2px solid var(--color-light-gray) !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-lg) !important;
  font-size: var(--font-size-sm) !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
}

.netlify-identity-widget button:not([type="submit"]):hover {
  border-color: var(--color-teal) !important;
  color: var(--color-teal) !important;
  transform: translateY(-1px) !important;
}

/* Links in modal */
.netlify-identity-widget a {
  color: var(--color-teal) !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  font-family: var(--font-primary) !important;
  transition: color var(--transition-base) !important;
}

.netlify-identity-widget a:hover {
  color: var(--color-teal-dark) !important;
  text-decoration: underline !important;
}

/* Error messages */
.netlify-identity-widget .error,
.netlify-identity-widget [data-netlify-identity-error] {
  color: #c53030 !important;
  background: #fed7d7 !important;
  border: 1px solid #feb2b2 !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-md) !important;
  margin: var(--spacing-sm) 0 !important;
  font-size: var(--font-size-sm) !important;
  font-family: var(--font-primary) !important;
}

/* Success messages */
.netlify-identity-widget .success,
.netlify-identity-widget [data-netlify-identity-success] {
  color: #276749 !important;
  background: #c6f6d5 !important;
  border: 1px solid #9ae6b4 !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-sm) var(--spacing-md) !important;
  margin: var(--spacing-sm) 0 !important;
  font-size: var(--font-size-sm) !important;
  font-family: var(--font-primary) !important;
}

/* Close button */
.netlify-identity-widget .close,
.netlify-identity-widget button[aria-label="Close"] {
  background: var(--color-light-gray) !important;
  color: var(--color-gray-dark) !important;
  border: none !important;
  border-radius: var(--radius-full) !important;
  width: 32px !important;
  height: 32px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
  transition: all var(--transition-base) !important;
  position: absolute !important;
  top: var(--spacing-md) !important;
  right: var(--spacing-md) !important;
}

.netlify-identity-widget .close:hover {
  background: var(--color-gray-light) !important;
  transform: scale(1.1) !important;
}

/* Modal spacing and layout */
.netlify-identity-widget .netlify-identity-modal {
  padding: var(--spacing-2xl) !important;
  max-width: 400px !important;
  margin: 0 auto !important;
}

/* Form groups/sections */
.netlify-identity-widget .form-group,
.netlify-identity-widget .netlify-identity-item {
  margin-bottom: var(--spacing-lg) !important;
}

/* Tabs/navigation within modal */
.netlify-identity-widget .tabs,
.netlify-identity-widget nav {
  border-bottom: 2px solid var(--color-light-gray) !important;
  margin-bottom: var(--spacing-lg) !important;
}

.netlify-identity-widget .tab {
  color: var(--color-gray) !important;
  padding: var(--spacing-sm) var(--spacing-lg) !important;
  border-bottom: 2px solid transparent !important;
  transition: all var(--transition-base) !important;
  font-family: var(--font-primary) !important;
  font-weight: 600 !important;
}

.netlify-identity-widget .tab.active,
.netlify-identity-widget .tab:hover {
  color: var(--color-teal) !important;
  border-bottom-color: var(--color-teal) !important;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .netlify-identity-widget .netlify-identity-modal {
    margin: var(--spacing-lg) !important;
    padding: var(--spacing-xl) !important;
    max-width: calc(100vw - 2rem) !important;
    border-radius: var(--radius-lg) !important;
  }
  
  .netlify-identity-widget button {
    min-height: var(--touch-target) !important;
    font-size: var(--font-size-base) !important;
  }
  
  .netlify-identity-widget input {
    min-height: var(--touch-target) !important;
    font-size: var(--font-size-base) !important;
  }
}

/* Loading states */
.netlify-identity-widget .loading {
  opacity: 0.6 !important;
  pointer-events: none !important;
}

/* Social login buttons (if used) */
.netlify-identity-widget .btn-social {
  background: var(--color-white) !important;
  border: 2px solid var(--color-light-gray) !important;
  color: var(--color-navy) !important;
}

.netlify-identity-widget .btn-social:hover {
  border-color: var(--color-teal) !important;
  background: var(--color-off-white) !important;
}

  </style>
</head>

<body>
  <!-- Custom Notification System -->
  <div class="notification-overlay" id="notificationOverlay">
    <div class="notification-modal">
      <span class="notification-icon" id="notificationIcon">✓</span>
      <h3 class="notification-title" id="notificationTitle">Success</h3>
      <p class="notification-message" id="notificationMessage">Operation completed successfully!</p>
      <div class="notification-buttons" id="notificationButtons">
        <button class="notification-btn primary" id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-container">
      <div class="header-content">
        <!-- Logo -->
        <a href="index.html" class="logo" aria-label="Narrin AI Home">Narrin AI</a>

        <!-- Desktop Navigation Center -->
        <nav class="nav-center" role="navigation" aria-label="Main navigation">
          <!-- USPs - All visible on desktop -->
          <div class="nav-usps" aria-label="Key features">
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🔒</span>
              <span>100% Safe</span>
            </div>
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🧠</span>
              <span>Character Memory</span>
            </div>
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🔐</span>
              <span>Private Data</span>
            </div>
          </div>

          <!-- Search Bar - Always visible on desktop -->
          <form class="nav-search" role="search">
            <input 
              type="search" 
              class="nav-search-input" 
              placeholder="Search characters..." 
              aria-label="Search characters"
            />
            <button type="submit" class="search-submit" aria-label="Submit search">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </button>
          </form>
        </nav>

        <!-- Desktop Navigation Links -->
        <nav class="nav-links" role="navigation" aria-label="Secondary navigation">
          <a href="index.html" class="nav-link">Characters</a>
          <a href="chat-overview.html" class="nav-link">Chats</a>
          <a href="profile.html" class="nav-link" id="loginBtn">Login/Register</a>
          <a href="create-character.html" class="btn btn-primary">✨ Create Character</a>
        </nav>

        <!-- Mobile Navigation Container -->
        <div class="mobile-nav-container">
          <!-- Mobile Chat Button -->
          <a 
            href="chat-overview.html" 
            class="mobile-chat-btn"
            aria-label="Go to chats"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </a>

            </div>
          </div>

          <!-- Mobile Search Button -->
          <button 
            class="mobile-search-btn" 
            id="mobileSearchBtn"
            aria-label="Open search"
            aria-expanded="false"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>

          <!-- Mobile Hamburger Menu -->
          <button
            class="mobile-menu-btn"
            id="mobileMenuBtn"
            aria-label="Open navigation menu"
            aria-expanded="false"
          >
            <div class="hamburger">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Search Overlay -->
    <div class="mobile-search-overlay" id="mobileSearchOverlay">
      <form class="mobile-search-form" role="search">
        <input 
          type="search" 
          class="mobile-search-input" 
          placeholder="Search characters..." 
          aria-label="Search characters"
          id="mobileSearchInput"
        />
        <button type="submit" class="btn btn-primary" aria-label="Submit search">
          Search
        </button>
      </form>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-menu-logo">Narrin AI</div>
        <div class="mobile-menu-subtitle">AI Character Chat</div>
      </div>
      <nav class="mobile-menu-nav" role="navigation" aria-label="Mobile navigation">
        <a href="index.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">🏠</span>
          Characters
        </a>
        <a href="chat-overview.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">💬</span>
          Chats
        </a>
        <a href="profile.html" class="mobile-menu-link" id="mobileLoginBtn">
          <span class="mobile-menu-link-icon">👤</span>
          Login/Register
        </a>
        <a href="create-character.html" class="mobile-menu-link btn-primary">
          <span class="mobile-menu-link-icon">✨</span>
          Create Character
        </a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>My Profile</h1>
      <p>Manage your account settings and view your usage</p>
    </div>
    
    <div id="not-logged-in" style="display: none;">
      <div class="login-form-container">
        <div class="login-form-section">
          <div class="login-icon-header">
            <div class="login-icon-circle">
              <span class="login-icon-emoji">🔐</span>
            </div>
          </div>
          <h2 class="login-form-title">Login/Register</h2>
          <p class="login-form-text">You must be logged in to view your profile.</p>
          <button class="login-form-button" onclick="openLogin()">
            <span class="button-icon">👤</span>
            <span>Login/Register</span>
          </button>
        </div>
      </div>
    </div>
    
    <div id="profile" style="display: none;">
      <div class="profile-content">
        <!-- Account Information -->
        <div class="form-section">
          <h2>Account Information</h2>
          
          <div class="profile-item" data-field="email">
            <span class="label">Email:</span>
            <span class="value" id="email">...</span>
            <button class="edit-btn" onclick="enableEdit('email')">Edit</button>
          </div>
          
          <div class="profile-item" data-field="plan">
            <span class="label">Plan:</span>
            <span class="value" id="plan">...</span>
            <!-- No edit button for plan - will be replaced with upgrade/manage link later -->
          </div>
          
          <div class="profile-item" data-field="usage">
            <span class="label">Usage:</span>
            <div class="value">
              <div class="usage-display">
                <span class="usage-text">
                  <span id="usage">...</span> / <span id="quota">...</span> messages
                </span>
                <div class="usage-bar">
                  <div class="usage-fill" id="usage-fill" style="width: 0%"></div>
                </div>
              </div>
              <div id="reset-countdown" style="font-size: 12px; color: var(--color-gray); margin-top: 8px; display: none;"></div>
            </div>
          </div>
          
          <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--color-light-gray); text-align: center;">
            <a href="#" id="logout-btn" onclick="handleLogout(); return false;">
              Log out
            </a>
          </div>
        </div>

        <!-- Premium Upgrade Card -->
        <div class="premium-card">
          <!-- Background sparkles -->
          <div class="sparkle">✨</div>
          <div class="sparkle">⭐</div>
          <div class="sparkle">✨</div>
          <div class="sparkle">⭐</div>
          
          <!-- Crown icon -->
          <div class="crown-icon">👑</div>
          
          <!-- Gradient overlay -->
          <div class="gradient-overlay"></div>
          
          <!-- Main content -->
          <div class="premium-content">
            <div class="premium-badge">PREMIUM €7.99/month</div>
            
            <ul class="benefits-list">
              <li class="benefit-item">
                <div class="checkmark"></div>
                <div class="benefit-text">Unlimited Chat Messages</div>
              </li>
              <li class="benefit-item">
                <div class="checkmark"></div>
                <div class="benefit-text">Extensive Character Memory</div>
              </li>
              <li class="benefit-item">
                <div class="checkmark"></div>
                <div class="benefit-text">Early Access to New Features</div>
              </li>
              <li class="benefit-item">
                <div class="checkmark"></div>
                <div class="benefit-text">Early Access to New Characters</div>
              </li>
            </ul>
            
            <button class="upgrade-button" id="upgradeButton" onclick="handleUpgrade()">
              Upgrade to Narrin AI Premium
            </button>
            <div class="premium-active" id="premiumActive" style="display: none;">
              <div class="premium-status-button">
                ✓ Narrin AI Premium
              </div>
              <a href="#" class="downgrade-link" onclick="handleDowngrade(); return false;">
                Downgrade to Free plan and 100 messages/month.
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div id="error" style="display:none;"></div>
      <div id="success" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ===== UNIVERSAL AUTHENTICATION CHECK FUNCTION =====
    function initializeAuthenticationCheck() {
      console.log('🔐 Initializing universal authentication check...');
      
      // Check localStorage first for faster response
      const storedEmail = localStorage.getItem('user_email');
      const storedToken = localStorage.getItem('user_token');
      const storedUid = localStorage.getItem('user_uid');
      const authTimestamp = localStorage.getItem('user_auth_timestamp');
      
      if (storedEmail && storedToken && storedUid && authTimestamp) {
        // Check if token is still valid (24 hours)
        const tokenAge = Date.now() - parseInt(authTimestamp);
        const maxAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        if (tokenAge < maxAge) {
          console.log('✅ Valid authentication found in localStorage');
          return true;
        } else {
          console.log('⚠️ Stored authentication expired, clearing...');
          clearAuthData();
        }
      }
      
      // Fallback to Netlify Identity current user
      if (window.netlifyIdentity) {
        const currentUser = window.netlifyIdentity.currentUser();
        if (currentUser) {
          console.log('✅ Valid Netlify Identity user found');
          handleLoginSuccess(currentUser);
          return true;
        }
      }
      
      console.log('❌ No valid authentication found');
      return false;
    }

    function handleLoginSuccess(user) {
      console.log('💾 Storing authentication data for:', user.email);
      
      // Store authentication data with timestamp
      localStorage.setItem('user_email', user.email);
      localStorage.setItem('user_token', user.token?.access_token || user.access_token);
      localStorage.setItem('user_uid', user.id);
      localStorage.setItem('user_auth_timestamp', Date.now().toString());
      
      // Store additional user data if available
      if (user.user_metadata) {
        localStorage.setItem('user_metadata', JSON.stringify(user.user_metadata));
      }
      
      console.log('✅ Authentication data stored successfully');
    }

    function clearAuthData() {
      console.log('🧹 Clearing authentication data...');
      
      // Clear all auth-related localStorage items
      const authKeys = [
        'user_email',
        'user_token',
        'user_uid',
        'user_auth_timestamp',
        'user_metadata',
        'user_refresh_token',
        'user_netlify_data'
      ];
      
      authKeys.forEach(key => {
        localStorage.removeItem(key);
      });
      
      console.log('✅ Authentication data cleared');
    }

    // ===== STRIPE CONFIGURATION =====
    const stripe = Stripe('pk_live_jz2dXpzmEDUahXkKkyUe36Zt');
    const PRICE_ID = 'price_1RbnsKDU567HpUYxA9y9dnLc'; // Product: prod_SWrbnoc0ywWqOL

    // ===== ENHANCED GLOBAL STATE - VOORKOMT DUBBELE RECORDS =====
    let isEditing = false;
    let currentEditingField = null;
    let originalValue = null;
    let netlifyUser = null;

    // Enhanced global state om dubbele calls te voorkomen
    let isProcessingAuth = false;
    let authProcessTimeout = null;
    let lastProcessedUser = null; // Track laatste geprocesste user
    let authCallLock = false; // Extra lock mechanisme

    // Verbeterde webhook call cache
    const webhookCallCache = new Map();
    const CACHE_DURATION = 10000; // Verhoogd naar 10 seconden

    // ===== VERBETERDE DEBOUNCING FUNCTIE =====
    function shouldAllowWebhookCall(type, email, userId) {
      const key = `${type}_${email}_${userId}`;
      const lastCall = webhookCallCache.get(key);
      const now = Date.now();
      
      if (lastCall && (now - lastCall) < CACHE_DURATION) {
        console.log(`🚫 BLOCKED: Duplicate ${type} call for ${email} (last call: ${now - lastCall}ms ago)`);
        return false;
      }
      
      webhookCallCache.set(key, now);
      console.log(`✅ ALLOWED: ${type} call for ${email}`);
      return true;
    }

    // ===== NIEUWE FUNCTIE: Check if user was already processed =====
    function wasUserAlreadyProcessed(user) {
      if (!lastProcessedUser) return false;
      
      const sameUser = lastProcessedUser.id === user.id && 
                       lastProcessedUser.email === user.email;
      
      if (sameUser) {
        console.log(`🚫 User ${user.email} was already processed recently`);
        return true;
      }
      
      return false;
    }

    // ===== WEBHOOK CALL LOGGING =====
    function logWebhookCall(type, email, payload) {
      const timestamp = new Date().toISOString();
      console.log(`📊 WEBHOOK CALL LOG [${timestamp}]:`, {
        type,
        email,
        isProcessingAuth,
        payload: JSON.stringify(payload, null, 2)
      });
    }

    // ===== CUSTOM NOTIFICATION SYSTEM =====
    function showNotification(type, title, message, buttons = null) {
      const overlay = document.getElementById('notificationOverlay');
      const icon = document.getElementById('notificationIcon');
      const titleEl = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');
      const buttonsEl = document.getElementById('notificationButtons');
      
      // Set icon based on type
      const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️',
        question: '❓'
      };
      
      icon.textContent = icons[type] || icons.info;
      icon.className = `notification-icon ${type}`;
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // Set up buttons
      if (buttons) {
        buttonsEl.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.className = `notification-btn ${button.type || 'secondary'}`;
          btn.textContent = button.text;
          btn.onclick = () => {
            hideNotification();
            if (button.callback) button.callback();
          };
          buttonsEl.appendChild(btn);
        });
      } else {
        // Default OK button
        buttonsEl.innerHTML = '<button class="notification-btn primary" onclick="hideNotification()">OK</button>';
      }
      
      // Show notification
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function hideNotification() {
      const overlay = document.getElementById('notificationOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Custom confirm replacement
    function customConfirm(message, title = 'Confirm', onConfirm = null, onCancel = null) {
      const buttons = [
        {
          text: 'Cancel',
          type: 'secondary',
          callback: onCancel
        },
        {
          text: 'Confirm',
          type: 'primary',
          callback: onConfirm
        }
      ];
      showNotification('question', title, message, buttons);
    }
    
    // Success notification
    function showSuccess(message, title = 'Success') {
      showNotification('success', title, message);
    }
    
    // Error notification
    function showError(message, title = 'Error') {
      showNotification('error', title, message);
    }

    // ===== NAVIGATION FUNCTIONALITY =====
    
    // Mobile Search Elements
    const mobileSearchBtn = document.getElementById('mobileSearchBtn');
    const mobileSearchOverlay = document.getElementById('mobileSearchOverlay');
    const mobileSearchInput = document.getElementById('mobileSearchInput');
    
    // Mobile Menu Elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    // USP Carousel Elements
    const uspTrack = document.getElementById('uspTrack');
    let currentUspIndex = 0;
    let uspInterval;

    // ===== STRIPE UPGRADE FUNCTIONALITY =====
    async function handleUpgrade() {
      console.log('🚀 Upgrade button clicked');
      
      // Check of gebruiker ingelogd is
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      
      if (!email || !uid) {
        showError('Je moet ingelogd zijn om te upgraden');
        openLogin();
        return;
      }
      
      try {
        // Toon loading state
        const upgradeButton = document.querySelector('.upgrade-button');
        const originalText = upgradeButton.innerHTML;
        upgradeButton.innerHTML = 'Processing...';
        upgradeButton.disabled = true;
        
        console.log('📡 Creating checkout session...');
        
        // Redirect direct naar Stripe Checkout
        const { error } = await stripe.redirectToCheckout({
          lineItems: [{
            price: PRICE_ID,
            quantity: 1,
          }],
          mode: 'subscription',
          successUrl: `${window.location.origin}/profile.html?upgrade=success`,
          cancelUrl: `${window.location.origin}/profile.html?upgrade=cancelled`,
          customerEmail: email,
          clientReferenceId: uid, // Om later de user te kunnen identificeren
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
      } catch (error) {
        console.error('❌ Error creating checkout session:', error);
        showError(`Upgrade error: ${error.message}`);
        
        // Reset button
        const upgradeButton = document.querySelector('.upgrade-button');
        upgradeButton.innerHTML = originalText;
        upgradeButton.disabled = false;
      }
    }

    // Functie om upgrade status te checken bij page load
    function checkUpgradeStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const upgradeStatus = urlParams.get('upgrade');
      
      if (upgradeStatus === 'success') {
        showSuccess('🎉 Upgrade successful! Welcome to Narrin AI Premium!');
        
        // BELANGRIJKE TOEVOEGING: Automatisch profile data refreshen
        setTimeout(() => {
          console.log('🔄 Refreshing profile data after upgrade...');
          loadProfile(); // Force refresh van profile data
        }, 2000); // 2 seconde delay zodat webhook verwerkt is
        
        // Clean URL
        window.history.replaceState({}, document.title, 'profile.html');
        
      } else if (upgradeStatus === 'cancelled') {
        showError('Upgrade was cancelled. You can try again anytime.');
        window.history.replaceState({}, document.title, 'profile.html');
      }
    }

    // ===== MOBILE SEARCH FUNCTIONALITY =====
    function toggleMobileSearch() {
      const isActive = mobileSearchOverlay.classList.contains('active');
      
      if (isActive) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      } else {
        // Close mobile menu if open
        closeMobileMenu();
        
        mobileSearchOverlay.classList.add('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'true');
        mobileSearchInput.focus();
      }
    }

    mobileSearchBtn?.addEventListener('click', toggleMobileSearch);

    // ===== MOBILE MENU FUNCTIONALITY =====
    function toggleMobileMenu() {
      const isActive = mobileMenuOverlay.classList.contains('active');
      
      if (isActive) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    }

    function openMobileMenu() {
      // Close search overlay if open
      if (mobileSearchOverlay.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
      
      mobileMenuOverlay.classList.add('active');
      mobileMenuBtn.classList.add('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      mobileMenuOverlay.classList.remove('active');
      mobileMenuBtn.classList.remove('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }

    mobileMenuBtn?.addEventListener('click', toggleMobileMenu);

    // Close menu when clicking on overlay background
    mobileMenuOverlay?.addEventListener('click', (e) => {
      if (e.target === mobileMenuOverlay) {
        closeMobileMenu();
      }
    });

    // Close menu when clicking on a menu item
    document.querySelectorAll('.mobile-menu-link').forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });

    // Close search and menu on outside click
    document.addEventListener('click', (e) => {
      // Close search overlay
      if (!mobileSearchOverlay?.contains(e.target) &&
          !mobileSearchBtn?.contains(e.target) &&
          mobileSearchOverlay?.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (mobileMenuOverlay.classList.contains('active')) {
          closeMobileMenu();
        }
        if (mobileSearchOverlay.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // ===== USP CAROUSEL FUNCTIONALITY =====
    function startUspCarousel() {
      if (window.innerWidth <= 768 && uspTrack) {
        uspInterval = setInterval(() => {
          currentUspIndex = (currentUspIndex + 1) % 3;
          uspTrack.style.transform = `translateY(-${currentUspIndex * 33.333}%)`;
        }, 3000);
      }
    }

    function stopUspCarousel() {
      if (uspInterval) {
        clearInterval(uspInterval);
        uspInterval = null;
      }
    }

    // Handle responsive behavior
    function handleResize() {
      if (window.innerWidth > 768) {
        stopUspCarousel();
        if (uspTrack) {
          uspTrack.style.transform = '';
        }
        if (mobileSearchOverlay?.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn?.setAttribute('aria-expanded', 'false');
        }
        if (mobileMenuOverlay?.classList.contains('active')) {
          closeMobileMenu();
        }
      } else {
        startUspCarousel();
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      handleResize();
    });

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(handleResize, 250);
    });

    // ===== SEARCH FUNCTIONALITY =====
    function handleSearch(searchTerm) {
      if (!searchTerm || !searchTerm.trim()) {
        console.log('Empty search term, ignoring');
        return;
      }
      
      const trimmedTerm = searchTerm.trim();
      console.log('Redirecting to search results for:', trimmedTerm);
      window.location.href = `search-results.html?q=${encodeURIComponent(trimmedTerm)}`;
    }

    // Desktop search
    document.querySelector('.nav-search')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.nav-search-input');
      handleSearch(searchInput.value);
    });

    // Mobile search
    document.querySelector('.mobile-search-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.mobile-search-input');
      handleSearch(searchInput.value);
      toggleMobileSearch();
    });

    // ===== PROFILE FUNCTIONALITY =====

    // Utility function to detect mobile
    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Enhanced redirect handling
    function setupRedirectHandling() {
      // Store the referring page when coming to profile
      if (document.referrer && document.referrer !== window.location.href) {
        const referrer = new URL(document.referrer);
        // Only store if it's from the same domain and not already the profile page
        if (referrer.hostname === window.location.hostname && 
            !referrer.pathname.includes('profile.html')) {
          localStorage.setItem('login_redirect_url', document.referrer);
          console.log('🔄 Stored redirect URL:', document.referrer);
        }
      }
    }

    // ===== GEFIXTE handleAuthEvent functie =====
    function handleAuthEvent(user, eventType) {
      console.log(`📥 Auth event received: ${eventType} for ${user.email}`);
      
      // EERSTE CHECK: Is er al een call bezig?
      if (isProcessingAuth || authCallLock) {
        console.log(`⚠️ REJECTED: Auth already being processed (isProcessing: ${isProcessingAuth}, lock: ${authCallLock})`);
        return;
      }

      // TWEEDE CHECK: Was deze user net al geprocessed?
      if (wasUserAlreadyProcessed(user)) {
        console.log(`⚠️ REJECTED: User was already processed recently`);
        return;
      }

      // DERDE CHECK: Debouncing check
      if (!shouldAllowWebhookCall('auth', user.email, user.id)) {
        console.log(`⚠️ REJECTED: Blocked by debouncing`);
        return;
      }

      // SET LOCKS
      isProcessingAuth = true;
      authCallLock = true;
      lastProcessedUser = user;
      netlifyUser = user;

      console.log(`🔒 PROCESSING: ${eventType} for user ${user.email}`);

      // Clear eventuele vorige timeout
      if (authProcessTimeout) {
        clearTimeout(authProcessTimeout);
      }

      // Process de auth
      try {
        handleLoginSuccess(user, eventType);
        window.netlifyIdentity.close();
        updateLoginButton();
      } catch (error) {
        console.error('❌ Error in handleAuthEvent:', error);
      }

      // Reset locks na vertraging
      authProcessTimeout = setTimeout(() => {
        console.log('🔓 Resetting auth locks after timeout');
        isProcessingAuth = false;
        authCallLock = false;
      }, 15000); // 15 seconden timeout
    }

    // GEFIXTE versie van handleLoginSuccess functie
function handleLoginSuccess(user, eventType = 'unknown') {
  console.log(`✅ handleLoginSuccess called for: ${user.email} (${eventType})`);
  
  // KRITIEKE FIX: Betere token storage
  const accessToken = user.token?.access_token || user.access_token;
  const refreshToken = user.token?.refresh_token || user.refresh_token;
  
  if (!accessToken) {
    console.error('❌ No access token found in user object');
    return;
  }
  
  // Store ALL noodzakelijke authentication data
  localStorage.setItem('user_email', user.email);
  localStorage.setItem('user_token', accessToken);
  localStorage.setItem('user_uid', user.id);
  localStorage.setItem('user_auth_timestamp', Date.now().toString());
  
  // NIEUW: Store refresh token als beschikbaar
  if (refreshToken) {
    localStorage.setItem('user_refresh_token', refreshToken);
  }
  
  // NIEUW: Store complete user object voor recovery
  try {
    localStorage.setItem('user_netlify_data', JSON.stringify({
      id: user.id,
      email: user.email,
      user_metadata: user.user_metadata || {},
      app_metadata: user.app_metadata || {},
      created_at: user.created_at,
      updated_at: user.updated_at
    }));
  } catch (e) {
    console.warn('Could not store user data:', e);
  }
  
  console.log('💾 Authentication data stored successfully');
  
  // Rest van de functie blijft hetzelfde...
  if (eventType === 'signup') {
    console.log('🆕 NEW SIGNUP: Will create user in Airtable');
    createOrUpdateUser(user, true);
  } else if (eventType === 'login') {
    console.log('🔄 EXISTING LOGIN: Loading profile without webhook call');
    showProfileUI();
    loadProfile();
    handlePostLoginRedirect();
  } else {
    console.log('🤔 UNKNOWN EVENT TYPE: Defaulting to profile load');
    showProfileUI();
    loadProfile();
  }
  
  updateLoginButton();
  
  setTimeout(() => {
    console.log('🔓 Auth processing completed - resetting flags');
    isProcessingAuth = false;
    authCallLock = false;
  }, 2000);
}

    // New function to handle post-login redirect
    function handlePostLoginRedirect() {
      const redirectUrl = localStorage.getItem('login_redirect_url');
      
      if (redirectUrl && redirectUrl !== window.location.href) {
        localStorage.removeItem('login_redirect_url');
        showSuccess('Login successful! Redirecting back...');
        
        setTimeout(() => {
          console.log('🔄 Redirecting to:', redirectUrl);
          window.location.href = redirectUrl;
        }, 100); // Very short delay to ensure login is fully processed
      } else {
        // No specific redirect, stay on profile page but show success
        showSuccess('Welcome to your profile!');
      }
    }

    // ===== AANGEPASTE createOrUpdateUser functie =====
    async function createOrUpdateUser(user, isNewUser = false) {
      const email = user.email;
      const userId = user.id;
      
      // EXTRA CHECK: Nog een keer debouncing controleren
      if (!shouldAllowWebhookCall('register', email, userId)) {
        console.log('🚫 FINAL BLOCK: Webhook call blocked by final debouncing check');
        return;
      }
      
      console.log(`👤 ${isNewUser ? 'Creating NEW' : 'Updating EXISTING'} user: ${email}`);
      
      try {
        const payload = {
          user_email: email,
          user_uid: userId,
          user_token: user.token.access_token,
          user_metadata: {
            full_name: user.user_metadata?.full_name || '',
            avatar_url: user.user_metadata?.avatar_url || '',
            provider: user.app_metadata?.provider || 'email'
          },
          is_new_user: isNewUser,
          timestamp: new Date().toISOString(),
          source: 'profile_page_auth'
        };
        
        // Log webhook call
        logWebhookCall('register', email, payload);
        
        console.log('📤 SINGLE WEBHOOK CALL to Register User:', payload);
        
        const REGISTER_WEBHOOK_URL = 'https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15';
        
        const resp = await fetch(REGISTER_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        console.log('📡 Webhook response status:', resp.status);
        
        if (!resp.ok) {
          throw new Error(`Webhook failed: HTTP ${resp.status}`);
        }
        
        const responseText = await resp.text();
        console.log('✅ Webhook response:', responseText);
        
        if (isNewUser) {
          showSuccess('Account created successfully! Welcome to Narrin AI!');
          showProfileUI();
          
          // Voor nieuwe users: wacht en laad dan profile
          setTimeout(() => {
            loadProfile();
            setTimeout(handlePostLoginRedirect, 1000);
          }, 3000);
        }
        
      } catch (error) {
        console.error('❌ Error in createOrUpdateUser:', error);
        showError(`Account creation failed: ${error.message}`);
      }
    }

    // ===== GEFIXTE NETLIFY EVENT LISTENERS =====
    function setupEventListeners() {
      console.log('🔧 Setting up Netlify Identity event listeners...');
      
      let initHandled = false; // Prevent multiple init handling
      
      window.netlifyIdentity.on('init', user => {
        if (initHandled) {
          console.log('🚫 Init already handled, skipping...');
          return;
        }
        initHandled = true;
        
        console.log('🔄 Netlify Identity initialized, user:', user?.email || 'none');
        updateLoginButton();
        
        if (user && !netlifyUser && !isProcessingAuth) {
          console.log('🔄 Auto-login for existing user');
          netlifyUser = user;
          handleLoginSuccess(user, 'auto-login');
        }
      });

      window.netlifyIdentity.on('open', () => {
        console.log('🔓 Modal opened');
        forceModalToTop();
        document.body.classList.add('modal-open');
      });

      window.netlifyIdentity.on('close', () => {
        console.log('🔒 Modal closed');
        document.body.classList.remove('modal-open');
        
        if (window.innerWidth <= 768) {
          const header = document.querySelector('.header');
          if (header) {
            header.style.visibility = 'visible';
          }
        }
      });

      // ===== BELANGRIJKSTE FIX: Gescheiden event handling =====
      window.netlifyIdentity.on('login', user => {
        console.log('🔑 LOGIN event fired for:', user.email);
        handleLoginSuccess(user); // Store auth data first
        handleAuthEvent(user, 'login'); // Then handle auth event
      });

      window.netlifyIdentity.on('signup', user => {
        console.log('🎉 SIGNUP event fired for:', user.email);
        handleLoginSuccess(user); // Store auth data first
        handleAuthEvent(user, 'signup'); // Then handle auth event
      });

      window.netlifyIdentity.on('logout', () => {
        console.log('👋 Logout event');
        clearAuthData(); // Clear auth data first
        resetAuthState();
        localStorage.clear();
        showLoginUI();
        updateLoginButton();
        setTimeout(() => window.location.href = 'index.html', 1000);
      });

      window.netlifyIdentity.on('error', err => {
        console.error('❌ Netlify Identity error:', err);
        resetAuthState();
        showError('Authentication error: ' + err.message);
      });
    }

    // ===== RESET FUNCTIE =====
    function resetAuthState() {
      isProcessingAuth = false;
      authCallLock = false;
      netlifyUser = null;
      lastProcessedUser = null;
      
      if (authProcessTimeout) {
        clearTimeout(authProcessTimeout);
        authProcessTimeout = null;
      }
      
      console.log('🔄 Auth state completely reset');
    }

    // GEFIXTE versie van forceModalToTop met minder agressieve hiding
    function forceModalToTop() {
      setTimeout(() => {
        // Find all Netlify modal elements
        const modalElements = [
          ...document.querySelectorAll('.netlify-identity-widget'),
          ...document.querySelectorAll('[data-netlify-identity-widget]'),
          ...document.querySelectorAll('.netlify-identity-modal'),
          ...document.querySelectorAll('iframe[src*="netlify"]'),
          ...document.querySelectorAll('div[class*="netlify"]')
        ];

        modalElements.forEach(element => {
          if (element) {
            element.style.zIndex = '999999999';
            element.style.position = 'fixed';
            console.log('🔧 Forced z-index on:', element.className || element.tagName);
          }
        });

        // GEFIXTE versie: Alleen z-index aanpassen, NIET visibility verbergen
        if (window.innerWidth <= 768) {
          const header = document.querySelector('.header');
          const mobileMenu = document.querySelector('.mobile-menu-overlay');
          const mobileSearch = document.querySelector('.mobile-search-overlay');
          
          // Sluit eventueel geopende menu's, maar verberg header NIET
          if (mobileMenu && mobileMenu.classList.contains('active')) {
            closeMobileMenu();
          }
          if (mobileSearch && mobileSearch.classList.contains('active')) {
            mobileSearchOverlay.classList.remove('active');
            mobileSearchBtn.setAttribute('aria-expanded', 'false');
          }
          
          // Verlaag alleen z-index van header, verberg het NIET
          if (header) {
            header.style.zIndex = '1';
          }
          
          console.log('📱 Adjusted mobile navigation z-index (without hiding)');
        }
      }, 100);

      // Keep checking and forcing for 3 seconds
      let forceCounter = 0;
      const forceInterval = setInterval(() => {
        forceCounter++;
        
        const widget = document.querySelector('.netlify-identity-widget');
        if (widget) {
          widget.style.zIndex = '999999999';
          widget.style.position = 'fixed';
        }

        if (forceCounter > 30) { // Stop after 3 seconds
          clearInterval(forceInterval);
        }
      }, 100);
    }

    // Initialize Netlify Identity and check login status
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 Page loaded, initializing...');
      
      // FIRST: Run universal authentication check
      const isAuthenticated = initializeAuthenticationCheck();
      
      // Set up redirect handling
      setupRedirectHandling();
      
      // Check upgrade status
      checkUpgradeStatus();
      
      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        window.netlifyIdentity.init();
        
        // Check if user is already logged in
        netlifyUser = window.netlifyIdentity.currentUser();
        
        if (netlifyUser || isAuthenticated) {
          console.log('✅ User authenticated:', netlifyUser?.email || localStorage.getItem('user_email'));
          // For existing logged-in users, just load profile (don't redirect)
          showProfileUI();
          loadProfile();
        } else {
          console.log('❌ No user logged in');
          checkLocalStorage();
        }
        
        // Set up event listeners
        setupEventListeners();
      } else {
        console.error('❌ Netlify Identity not loaded');
      }
    });

    function checkLocalStorage() {
      // Check if we have stored auth data
      const token = localStorage.getItem('user_token');
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      
      if (token && email && uid) {
        console.log('✅ Found stored auth data for:', email);
        showProfileUI();
        loadProfile();
      } else {
        console.log('❌ No stored auth data found');
        showLoginUI();
      }
    }

    function handleLogout() {
      customConfirm('Are you sure you want to log out?', 'Confirm Logout', () => {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.logout();
        } else {
          // Fallback if Netlify Identity is not available
          localStorage.clear();
          showLoginUI();
          window.location.href = 'index.html';
        }
      });
    }

    function showLoginUI() {
      document.getElementById('not-logged-in').style.display = 'block';
      document.getElementById('profile').style.display = 'none';
      hideMessages();
    }

    function showProfileUI() {
      document.getElementById('not-logged-in').style.display = 'none';
      document.getElementById('profile').style.display = 'block';
      
      // Show edit buttons for editable fields only (exclude plan)
      document.querySelectorAll('.edit-btn').forEach(btn => {
        const profileItem = btn.closest('.profile-item');
        const field = profileItem.getAttribute('data-field');
        
        // Only show edit button for email field, not for plan
        if (field !== 'plan') {
          btn.style.display = 'inline-block';
        }
      });
    }

    // GEFIXTE versie van loadProfile() functie
async function loadProfile() {
  const token = localStorage.getItem('user_token');
  const email = localStorage.getItem('user_email');
  const uid = localStorage.getItem('user_uid');
  
  if (!token || !email || !uid) {
    console.log('⚠️ No auth data - showing login UI');
    showLoginUI();
    return;
  }

  console.log('📡 Loading profile for:', email);
  showLoading();
  
  try {
    const payload = { 
      user_email: email, 
      user_uid: uid, 
      user_token: token,
      action: 'get_profile' // Explicit action for profile loading
    };
    
    console.log('📤 Request payload:', payload);
    
    const resp = await fetch('https://hook.eu2.make.com/lya166veex7oo2wwo8mx4fuhlkssxlog', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    console.log('📡 Response status:', resp.status);
    
    if (!resp.ok) {
      // KRITIEKE FIX: Als gebruiker niet gevonden wordt, probeer opnieuw aan te maken
      if (resp.status === 400 || resp.status === 404) {
        console.log('🔄 User data not found in Airtable, attempting to create...');
        
        // Probeer de gebruiker opnieuw aan te maken in Airtable
        const createPayload = {
          user_email: email,
          user_uid: uid,
          user_token: token,
          user_metadata: {
            full_name: '',
            avatar_url: '',
            provider: 'email'
          },
          is_new_user: false, // Bestaande user, maar niet in Airtable
          timestamp: new Date().toISOString(),
          source: 'profile_page_recovery'
        };
        
        console.log('📤 Creating missing user in Airtable...');
        const createResp = await fetch('https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(createPayload)
        });
        
        if (createResp.ok) {
          console.log('✅ User created in Airtable, retrying profile load...');
          // Wacht 3 seconden en probeer opnieuw
          setTimeout(() => {
            loadProfile();
          }, 3000);
          return;
        }
      }
      
      throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
    }
    
    const responseText = await resp.text();
    console.log('📋 Raw response (first 500 chars):', responseText.substring(0, 500));
    
    // KRITIEKE FIX: Betere response parsing met fallbacks
    let data;
    
    try {
      data = JSON.parse(responseText);
      console.log('📋 Parsed JSON data:', data);
    } catch (parseError) {
      console.error('❌ JSON Parse Error:', parseError);
      console.log('❌ Failed to parse response, using default values');
      
      // Gebruik standaard waarden als JSON parsing faalt
      data = {
        email: email,
        plan: 'Free',
        usage: 0,
        quota: 100
      };
    }
    
    // VEILIGE data processing met null checks
    setField('email', data?.email || email);
    const userPlan = data?.plan || 'Free';
    setField('plan', userPlan);
    
    // Update premium card
    updatePremiumCard(userPlan);
    
    // VEILIGE usage/quota verwerking
    let usage = 0;
    let quota = 100;
    
    if (data && typeof data.usage !== 'undefined' && data.usage !== null) {
      usage = parseInt(String(data.usage).replace(/[^0-9]/g, ''), 10) || 0;
    }
    
    if (data && typeof data.quota !== 'undefined' && data.quota !== null) {
      quota = parseInt(String(data.quota).replace(/[^0-9]/g, ''), 10) || 100;
    }
    
    console.log('📊 Final processed values - Usage:', usage, 'Quota:', quota);
    
    // Update UI veilig
    if (userPlan.toLowerCase() === 'premium' || userPlan.toLowerCase() === 'pro') {
      setField('usage', usage.toString());
      const quotaElement = document.getElementById('quota');
      if (quotaElement) quotaElement.textContent = 'Unlimited';
      
      const usageFill = document.getElementById('usage-fill');
      if (usageFill) usageFill.style.width = '0%';
    } else {
      setField('usage', usage.toString());
      const quotaElement = document.getElementById('quota');
      if (quotaElement) quotaElement.textContent = quota.toString();
      
      const percentage = quota > 0 ? (usage / quota) * 100 : 0;
      const usageFill = document.getElementById('usage-fill');
      if (usageFill) usageFill.style.width = `${Math.min(percentage, 100)}%`;
    }
    
    console.log('✅ Profile loaded successfully');
    updateUsageCountdown(userPlan, usage, quota);

  } catch (error) {
    console.error('❌ Error loading profile:', error);
    
    // FALLBACK: Toon basis info ook bij fout
    setField('email', email);
    setField('plan', 'Free');
    setField('usage', '0');
    
    const quotaElement = document.getElementById('quota');
    if (quotaElement) quotaElement.textContent = '100';
    
    const usageFill = document.getElementById('usage-fill');
    if (usageFill) usageFill.style.width = '0%';
    
    updatePremiumCard('Free');
    
    // Toon gebruiksvriendelijke foutmelding
    showError('Profile loaded with default settings. Some data may not be current.');
  } finally {
    hideLoading();
  }
}

    // Edit functionality
    function enableEdit(field) {
      // Prevent editing of plan field
      if (field === 'plan') {
        showError('Plan cannot be edited directly. Use the upgrade/manage options instead.');
        return;
      }
      
      if (isEditing) {
        showError('A field is already being edited. Save or cancel first.');
        return;
      }
      
      console.log(`✏️ Start editing field: ${field}`);
      
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const valueSpan = profileItem.querySelector('.value');
      const editBtn = profileItem.querySelector('.edit-btn');
      
      // Store original value
      originalValue = valueSpan.textContent;
      currentEditingField = field;
      isEditing = true;
      
      // Add editing class
      profileItem.classList.add('editing');
      
      // Create input field
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalValue;
      input.className = 'edit-input';
      input.setAttribute('data-field', field);
      
      // Create save and cancel buttons
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'save-btn';
      saveBtn.style.display = 'inline-block';
      saveBtn.onclick = () => saveField(field);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'cancel-btn';
      cancelBtn.style.display = 'inline-block';
      cancelBtn.onclick = () => cancelEdit(field);
      
      // Replace value span with input
      valueSpan.style.display = 'none';
      profileItem.insertBefore(input, editBtn);
      
      // Hide edit button, show save/cancel
      editBtn.style.display = 'none';
      profileItem.appendChild(saveBtn);
      profileItem.appendChild(cancelBtn);
      
      // Focus input
      input.focus();
      input.select();
      
      // Enter key saves, Escape cancels
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveField(field);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit(field);
        }
      });
    }

    async function saveField(field) {
      if (!isEditing || currentEditingField !== field) return;
      
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const input = profileItem.querySelector('.edit-input');
      const newValue = input.value.trim();
      
      if (!newValue) {
        showError('Value cannot be empty');
        return;
      }
      
      if (newValue === originalValue) {
        cancelEdit(field);
        return;
      }
      
      console.log(`💾 Saving field ${field}: "${originalValue}" → "${newValue}"`);
      showLoading();
      
      try {
        const token = localStorage.getItem('user_token');
        const email = localStorage.getItem('user_email');
        const uid = localStorage.getItem('user_uid');
        
        const payload = {
          user_email: email,
          user_uid: uid,
          user_token: token,
          action: 'update',
          field: field,
          value: newValue
        };
        
        console.log('📤 Sending payload:', payload);
        
        const resp = await fetch('https://hook.eu2.make.com/lya166veex7oo2wwo8mx4fuhlkssxlog', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('📡 Response status:', resp.status);
        
        // Handle response more carefully like in loadProfile
        const responseText = await resp.text();
        console.log('📋 Raw response:', responseText);
        
        let result;
        
        // Check if response is just "Accepted" or similar non-JSON
        if (responseText.trim() === 'Accepted' || responseText.trim() === 'OK' || responseText.trim() === 'Success') {
          console.log('✅ Simple status response - assuming success');
          result = { success: true, message: 'Updated successfully' };
        } else {
          try {
            result = JSON.parse(responseText);
            console.log('✅ Parsed JSON response:', result);
          } catch (parseError) {
            // If not JSON and response was OK, assume success
            if (resp.ok) {
              console.log('✅ Non-JSON response but HTTP OK - assuming success');
              result = { success: true, message: responseText };
            } else {
              throw new Error('Invalid response format');
            }
          }
        }
        
        // CRITICAL: Update localStorage if email was changed successfully
        if (field === 'email' && resp.ok) {
          console.log(`🔄 Updating localStorage email: "${email}" → "${newValue}"`);
          localStorage.setItem('user_email', newValue);
        }
        
        finishEdit(field, newValue);
        showSuccess(`${field} updated successfully!`);
        
      } catch (error) {
        console.error(`❌ Error saving ${field}:`, error);
        showError(`Save error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    function cancelEdit(field) {
      console.log(`❌ Cancel editing field: ${field}`);
      finishEdit(field, originalValue);
    }

    function finishEdit(field, finalValue) {
      const profileItem = document.querySelector(`.profile-item[data-field="${field}"]`);
      const valueSpan = profileItem.querySelector('.value');
      const editBtn = profileItem.querySelector('.edit-btn');
      const input = profileItem.querySelector('.edit-input');
      const saveBtn = profileItem.querySelector('.save-btn');
      const cancelBtn = profileItem.querySelector('.cancel-btn');
      
      // Update value
      valueSpan.textContent = finalValue;
      valueSpan.style.display = 'flex';
      
      // Remove input and buttons
      if (input) input.remove();
      if (saveBtn) saveBtn.remove();
      if (cancelBtn) cancelBtn.remove();
      
      // Show edit button
      editBtn.style.display = 'inline-block';
      
      // Remove editing class
      profileItem.classList.remove('editing');
      
      // Reset state
      isEditing = false;
      currentEditingField = null;
      originalValue = null;
    }

    // VEILIGERE versie van setField functie
function setField(field, text) {
  const element = document.getElementById(field);
  if (element) {
    element.textContent = String(text || '');
  } else {
    console.warn(`⚠️ Element with id '${field}' not found`);
  }
}

    function showError(msg) {
      hideMessages();
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
      setTimeout(hideMessages, 5000);
    }

    function showSuccess(msg) {
      hideMessages();
      const successDiv = document.getElementById('success');
      successDiv.textContent = msg;
      successDiv.style.display = 'block';
      setTimeout(hideMessages, 3000);
    }

    function hideMessages() {
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
    }

    function showLoading() {
      document.body.classList.add('loading');
    }

    function hideLoading() {
      document.body.classList.remove('loading');
    }

    // ===== NETLIFY IDENTITY BUTTON UPDATES =====
    function updateLoginButton() {
      const loginBtn = document.getElementById('loginBtn');
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      
      // Check both Netlify Identity and local storage for user info
      const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      const localEmail = localStorage.getItem("user_email");
      const localToken = localStorage.getItem("user_token");
      
      const isLoggedIn = netlifyUser || (localEmail && localToken);
      
      if (isLoggedIn) {
        // Always show "Profile" for logged in users instead of their name
        
        // Update desktop button
        if (loginBtn) {
          loginBtn.textContent = 'Profile';
          loginBtn.href = 'profile.html';
        }
        
        // Update mobile button
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">👤</span>'}Profile`;
          mobileLoginBtn.href = 'profile.html';
        }
      } else {
        // User is not logged in
        if (loginBtn) {
          loginBtn.textContent = 'Login/Register';
          loginBtn.href = 'profile.html';
        }
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">👤</span>'}Login/Register`;
          mobileLoginBtn.href = 'profile.html';
        }
      }
    }

    // Enhanced click handler for navigation links
    function setupNavigationClickHandlers() {
      const loginBtn = document.getElementById('loginBtn');
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      
      // Desktop login button click handler
      if (loginBtn) {
        loginBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
          const localEmail = localStorage.getItem("user_email");
          const localToken = localStorage.getItem("user_token");
          const isLoggedIn = netlifyUser || (localEmail && localToken);
          
          if (isLoggedIn) {
            // User is logged in, go directly to profile page
            window.location.href = 'profile.html';
          } else {
            // User not logged in, store current page for redirect and open login
            localStorage.setItem('login_redirect_url', window.location.href);
            openLogin();
          }
        });
      }
      
      // Mobile login button click handler
      if (mobileLoginBtn) {
        mobileLoginBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
          const localEmail = localStorage.getItem("user_email");
          const localToken = localStorage.getItem("user_token");
          const isLoggedIn = netlifyUser || (localEmail && localToken);
          
          if (isLoggedIn) {
            // User is logged in, go directly to profile page
            window.location.href = 'profile.html';
          } else {
            // User not logged in, store current page for redirect and open login
            localStorage.setItem('login_redirect_url', window.location.href);
            openLogin();
          }
          
          // Close mobile menu after click
          closeMobileMenu();
        });
      }
    }

    // Function to open login modal
    function openLogin() {
      if (window.netlifyIdentity) {
        console.log('🔓 Opening Netlify Identity modal...');
        
        // Close mobile menu first if open
        closeMobileMenu();
        
        // Add modal-open class preemptively
        document.body.classList.add('modal-open');
        
        // Force modal styling before opening
        setTimeout(() => {
          forceModalToTop();
        }, 50);
        
        window.netlifyIdentity.open('login');
        
        // Additional force after opening
        setTimeout(() => {
          forceModalToTop();
        }, 200);
        
      } else {
        // Fallback if Netlify Identity is not available
        console.log('❌ Netlify Identity not available, redirecting to profile page');
        window.location.href = 'profile.html';
      }
    }

    // Initialize login button on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Update immediately on page load
      updateLoginButton();
      
      // Set up click handlers
      setupNavigationClickHandlers();
      
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          updateLoginButton();
        });

        window.netlifyIdentity.on('login', user => {
          updateLoginButton();
          window.netlifyIdentity.close();
          
          // Handle redirect back to create-character if needed
          setTimeout(() => {
            handlePostLoginRedirect();
          }, 500);
        });

        window.netlifyIdentity.on('logout', () => {
          updateLoginButton();
        });
      }
    });

    // ===== PREMIUM CARD STATE MANAGEMENT =====
   // ===== PREMIUM CARD STATE MANAGEMENT =====
function updatePremiumCard(plan) {
  const upgradeButton = document.getElementById('upgradeButton');
  const premiumActive = document.getElementById('premiumActive');
  
  console.log('🎯 Updating premium card for plan:', plan);
  
  if (plan && (plan.toLowerCase() === 'premium' || plan.toLowerCase() === 'pro' || plan.toLowerCase() === 'paid')) {
    // User has premium - show premium status
    if (upgradeButton) upgradeButton.style.display = 'none';
    if (premiumActive) premiumActive.style.display = 'block';
    console.log('✅ Showing premium active state');
  } else {
    // User has free plan - show upgrade button and hide downgrade link
    if (upgradeButton) {
      upgradeButton.style.display = 'block';
      upgradeButton.disabled = false; // Make sure button is clickable
    }
    if (premiumActive) premiumActive.style.display = 'none';
    console.log('📦 Showing upgrade button for free plan');
  }
}

    // ===== DOWNGRADE FUNCTIONALITY =====
    async function handleDowngrade() {
      console.log('⬇️ Downgrade button clicked');
      
      customConfirm('Are you sure you want to downgrade to the free plan? You will lose access to premium features and be limited to 100 messages per month.', 'Confirm Downgrade', () => {
        // Continue with downgrade logic
        performDowngrade();
      });
      return;
    }
    
    async function performDowngrade() {
      
      const email = localStorage.getItem('user_email');
      const uid = localStorage.getItem('user_uid');
      const token = localStorage.getItem('user_token');
      
      if (!email || !uid || !token) {
        showError('You must be logged in to manage your subscription');
        return;
      }
      
      try {
        showLoading();
        
        // Call webhook to handle downgrade
        const payload = {
  type: 'customer.subscription.deleted',
   user_email: email,       
  user_uid: uid,           
  data: {
    object: {
      customer_email: email,
      customer: uid,
      status: 'canceled'
    }
  },
  action: 'manual_downgrade',
  source: 'profile_page'
};
        
        console.log('📡 Sending downgrade request...');
        
        const resp = await fetch('https://hook.eu2.make.com/p4qk5bzmdq987erwlo0g0bjv2xvgb5mt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        // Handle response more carefully like in saveField
        const responseText = await resp.text();
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          if (resp.ok) {
            result = { success: true, message: responseText };
          } else {
            throw new Error('Invalid response format');
          }
        }
        
        console.log('✅ Downgrade response:', result);
        
        showSuccess('Successfully downgraded to free plan. You now have a limit of 100 messages per month.');
        
        // Reload profile to update UI
        setTimeout(() => {
          loadProfile();
        }, 1000);
        
      } catch (error) {
        console.error('❌ Error downgrading plan:', error);
        showError(`Downgrade error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    // ===== USAGE RESET COUNTDOWN =====
function updateUsageCountdown(plan, usage, quota) {
  const countdownEl = document.getElementById('reset-countdown');
  
  if (plan.toLowerCase() === 'free' && usage >= quota) {
    // User is over limit - show countdown
    const resetDate = new Date();
    resetDate.setDate(resetDate.getDate() + 30); // 30 days from now
    
    countdownEl.style.display = 'block';
    
    function updateTimer() {
      const now = new Date().getTime();
      const resetTime = resetDate.getTime();
      const distance = resetTime - now;
      
      if (distance < 0) {
        countdownEl.innerHTML = "Messages reset! Refresh page to see updated quota.";
        return;
      }
      
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      
      countdownEl.innerHTML = `Messages reset in: ${days}d ${hours}h ${minutes}m`;
    }
    
    updateTimer();
    setInterval(updateTimer, 60000); // Update every minute
  } else {
    countdownEl.style.display = 'none';
  }
}

// ===== ENHANCED FORCE NETLIFY MODAL STYLING =====
function applyNetlifyModalStyling() {
  console.log('🎨 Attempting to apply modal styling...');
  
  // Wacht tot modal volledig geladen is
  setTimeout(() => {
    try {
      // METHODE 1: Style de widget container zelf
      const widget = document.querySelector('.netlify-identity-widget');
      if (widget) {
        widget.style.fontFamily = 'Plus Jakarta Sans, sans-serif !important';
        widget.style.backdropFilter = 'blur(20px)';
        widget.style.background = 'rgba(30, 41, 59, 0.8)';
        console.log('✅ Widget container styled');
      }

      // METHODE 2: Style iframe container
      const iframe = document.querySelector('.netlify-identity-widget iframe');
      if (iframe) {
        iframe.style.borderRadius = '24px';
        iframe.style.border = '2px solid #14b8a6';
        iframe.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1)';
        iframe.style.overflow = 'hidden';
        console.log('✅ Iframe styled');
      }

      // METHODE 3: Force styling op alle netlify elementen
      const allNetlifyElements = document.querySelectorAll('[class*="netlify"]');
      allNetlifyElements.forEach(el => {
        el.style.fontFamily = 'Plus Jakarta Sans, sans-serif';
        el.style.color = '#1e293b';
      });

      // METHODE 4: Inject custom CSS direct in document
      const customStyles = `
        <style id="netlify-custom-styling">
          .netlify-identity-widget * {
            font-family: 'Plus Jakarta Sans', sans-serif !important;
          }
          .netlify-identity-widget iframe {
            border-radius: 24px !important;
            border: 2px solid #14b8a6 !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
          }
        </style>
      `;
      
      if (!document.getElementById('netlify-custom-styling')) {
        document.head.insertAdjacentHTML('beforeend', customStyles);
        console.log('✅ Custom CSS injected');
      }

    } catch (error) {
      console.log('⚠️ Styling attempt blocked:', error);
    }
  }, 100);

  // Herhaal styling om er zeker van te zijn
  setTimeout(() => applyForcedStyling(), 300);
  setTimeout(() => applyForcedStyling(), 600);
  setTimeout(() => applyForcedStyling(), 1000);
}

function applyForcedStyling() {
  try {
    // Probeer styling opnieuw toe te passen
    const iframe = document.querySelector('.netlify-identity-widget iframe');
    if (iframe) {
      iframe.style.setProperty('border-radius', '24px', 'important');
      iframe.style.setProperty('border', '2px solid #14b8a6', 'important');
      iframe.style.setProperty('font-family', 'Plus Jakarta Sans, sans-serif', 'important');
    }
    
    const widget = document.querySelector('.netlify-identity-widget');
    if (widget) {
      widget.style.setProperty('font-family', 'Plus Jakarta Sans, sans-serif', 'important');
    }
  } catch (error) {
    console.log('⚠️ Forced styling blocked:', error);
  }
}

// Pas styling toe bij elke modal open
function setupModalStyling() {
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('open', () => {
      console.log('🎨 Modal opened - applying styling...');
      applyNetlifyModalStyling();
      
      // Extra agressieve herhaling
      const stylingInterval = setInterval(() => {
        applyForcedStyling();
      }, 200);
      
      // Stop na 5 seconden
      setTimeout(() => {
        clearInterval(stylingInterval);
      }, 5000);
    });

    // Ook proberen bij init
    window.netlifyIdentity.on('init', () => {
      console.log('🎨 Identity initialized - preparing styling...');
      applyNetlifyModalStyling();
    });
  }
}

// Initialize styling setup
document.addEventListener('DOMContentLoaded', () => {
  setupModalStyling();
});

// Pas styling toe bij elke modal open
function setupModalStyling() {
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('open', () => {
      console.log('🎨 Applying modal styling...');
      applyNetlifyModalStyling();
      
      // Herhaal styling meerdere keren voor zekerheid
      setTimeout(applyNetlifyModalStyling, 500);
      setTimeout(applyNetlifyModalStyling, 1000);
    });
  }
}

// Initialize styling setup
document.addEventListener('DOMContentLoaded', () => {
  setupModalStyling();
});

  </script>
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="index.html" class="footer-link">Characters</a>
        <span class="footer-separator">•</span>
        <a href="chat-overview.html" class="footer-link">Chats</a>
        <span class="footer-separator">•</span>
        <a href="create-character.html" class="footer-link">Create Character</a>
        <span class="footer-separator">•</span>
        <a href="profile.html" class="footer-link">Profile</a>
        <span class="footer-separator">•</span>
        <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
        <span class="footer-separator">•</span>
        <a href="terms-and-conditions.html" class="footer-link">Terms and Conditions</a>
      </div>
      <div class="footer-copyright">
        © 2025 Narrin AI. All rights reserved.
      </div> 