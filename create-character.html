<!DOCTYPE html>
<!-- Updated: New character voices added v2 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Your Own AI Companion | Design Personalized AI Characters - Narrin AI</title>
  <meta name="description" content="Create your perfect AI companion in minutes. Design personality, expertise, and conversation style. Build custom AI coaches, mentors, or friends tailored to your needs.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://narrin.ai/create-character">
  <meta property="og:title" content="Create Your Own AI Companion | Design Personalized Characters - Narrin AI">
  <meta property="og:description" content="Design and create your own personalized AI companion. Choose personality traits, voice, and appearance for unique AI conversations on Narrin AI.">
  <meta property="og:image" content="https://narrin.ai/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://narrin.ai/create-character">
  <meta property="twitter:title" content="Create Custom AI Character - Build Your Own | Narrin AI">
  <meta property="twitter:description" content="Design your own AI character on Narrin AI. Customize personality, voice, appearance & traits. Build unique AI companions for personalized chat experiences.">
  <meta property="twitter:image" content="https://narrin.ai/og-image.jpg">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Microsoft Clarity Analytics -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "svaxez2fed");
  </script>
  
  <!-- Import Modern Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* ===== CSS CUSTOM PROPERTIES ===== */
    :root {
      /* Primary Colors */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      
      /* Accent Colors */
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-teal-alt: #10a394;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-coral-dark: #ea580c;
      
      /* Supporting Colors */
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      --gradient-subtle: linear-gradient(135deg, var(--color-teal-light) 0%, var(--color-coral-light) 100%);
      --gradient-tags: linear-gradient(135deg, var(--color-teal-alt) 0%, var(--color-coral) 100%);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-colored: 0 10px 25px -5px rgba(20, 184, 166, 0.2);
      
      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Font Sizes */
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms ease-out;
      --transition-base: 300ms ease-out;
      --transition-slow: 500ms ease-out;
      
      /* Touch Target Size */
      --touch-target: 44px;
      
      /* Z-index Scale */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-overlay: 300;
      --z-modal: 400;
      --z-menu-overlay: 500;
    }

    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      overflow-x: hidden;
    }

    body {
      font-family: var(--font-primary);
      background: var(--color-off-white);
      color: var(--color-navy);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      width: 100%;
    }

    input, button, textarea, select {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      position: relative;
    }

    /* ===== ACCESSIBILITY ===== */
    :focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    /* ===== HEADER NAVIGATION ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: all var(--transition-base);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      width: 100%;
      overflow: hidden;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 72px;
      gap: var(--spacing-lg);
      width: 100%;
    }

    /* Logo */
    .logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 800;
      text-decoration: none;
      letter-spacing: -0.02em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: transform var(--transition-base);
      flex-shrink: 0;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    /* Desktop Navigation Center */
    .nav-center {
      display: none;
      align-items: center;
      gap: var(--spacing-lg);
      flex: 1;
      justify-content: center;
      position: relative;
    }

    /* USPs Container - Desktop */
    .nav-usps {
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .usp-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-gray-dark);
      font-size: var(--font-size-xs);
      font-weight: 500;
      white-space: nowrap;
    }

    .usp-icon {
      font-size: var(--font-size-lg);
      color: var(--color-teal);
    }

    .nav-search {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin-left: var(--spacing-xl);
    }

    .nav-search-input {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-lg);
      padding-right: calc(var(--spacing-lg) * 2.5);
      font-size: var(--font-size-sm);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .nav-search-input:hover {
      border-color: var(--color-gray-light);
    }

    .nav-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .nav-search-input::placeholder {
      color: var(--color-gray-light);
    }

    .search-submit {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .search-submit:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .search-submit svg {
      width: 18px;
      height: 18px;
      color: var(--color-white);
    }

    /* Navigation Links - Desktop */
    .nav-links {
      display: none;
      align-items: center;
      gap: var(--spacing-xl);
    }

    .nav-link {
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-sm);
      transition: color var(--transition-base);
      position: relative;
      padding: var(--spacing-xs) 0;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--gradient-primary);
      transition: width var(--transition-base);
    }

    .nav-link:hover {
      color: var(--color-teal);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Buttons - Fixed to match profile.html exactly */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-sm);
      font-weight: 600;
      text-decoration: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      min-height: var(--touch-target);
      white-space: nowrap;
      font-family: var(--font-primary);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Mobile Navigation Container */
    .mobile-nav-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    /* Mobile Chat Button */
    .mobile-chat-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
      text-decoration: none;
    }

    .mobile-chat-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-chat-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Search Button */
    .mobile-search-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .mobile-search-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Hamburger Menu */
    .mobile-menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      position: relative;
      flex-shrink: 0;
      z-index: var(--z-menu-overlay);
    }

    .mobile-menu-btn:hover {
      background: var(--color-light-gray);
    }

    .hamburger {
      width: 24px;
      height: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: #000000;
      border-radius: 1px;
      transition: all var(--transition-base);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile Menu Overlay - Full Screen */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: var(--z-overlay);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mobile-menu-content {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl) var(--spacing-xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
    }

    .mobile-menu-overlay.active .mobile-menu-content {
      transform: scale(1) translateY(0);
    }

    .mobile-menu-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .mobile-menu-logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .mobile-menu-subtitle {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
    }

    .mobile-menu-nav {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .mobile-menu-link {
      display: flex;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      background: var(--color-off-white);
      font-family: var(--font-primary);
    }

    .mobile-menu-link:hover {
      background: var(--color-light-gray);
      color: var(--color-teal);
      transform: translateX(4px);
    }

    .mobile-menu-link.btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      justify-content: center;
      font-weight: 700;
      margin-top: var(--spacing-lg);
    }

    .mobile-menu-link.btn-primary:hover {
      background: var(--gradient-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .mobile-menu-link-icon {
      margin-right: var(--spacing-sm);
      font-size: var(--font-size-lg);
    }

    /* Mobile Search Overlay */
    .mobile-search-overlay {
      position: fixed;
      top: 72px;
      left: 0;
      right: 0;
      background: var(--color-white);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: var(--z-dropdown);
    }

    .mobile-search-overlay.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .mobile-search-form {
      display: flex;
      gap: var(--spacing-sm);
    }

    .mobile-search-input {
      flex: 1;
      padding: var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .mobile-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* Desktop Styles */
    @media (min-width: 769px) {
      .nav-center {
        display: flex;
      }

      .nav-links {
        display: flex;
      }

      .mobile-nav-container {
        display: none;
      }

      .mobile-chat-btn {
        display: none !important;
      }

      .mobile-search-btn {
        display: none !important;
      }

      #desktopSearchBtn {
        display: flex !important;
      }

      .mobile-menu-btn {
        display: none !important;
      }

      .mobile-menu-overlay {
        display: none !important;
      }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      /* Hide USPs on mobile for create-character page */
      .nav-usps {
        display: none !important;
      }
      
      .header-container {
        padding: 0 var(--spacing-md);
      }

      .header-content {
        min-height: 60px;
        gap: var(--spacing-sm);
        padding: 0;
        display: grid;
        grid-template-columns: auto 1fr auto auto auto;
        align-items: center;
      }

      .logo {
        font-size: var(--font-size-lg);
        flex-shrink: 0;
        min-width: fit-content;
        grid-column: 1;
      }

      .mobile-nav-container {
        flex-shrink: 0;
        min-width: fit-content;
        display: flex !important;
        gap: var(--spacing-xs);
        grid-column: 3 / 6;
        justify-self: end;
      }

      .nav-center {
        display: none !important;
      }

      .nav-links {
        display: none !important;
      }

      .mobile-chat-btn {
        display: flex !important;
        flex-shrink: 0;
      }

      .mobile-search-btn {
        display: flex !important;
        flex-shrink: 0;
      }

      .mobile-menu-btn {
        display: flex !important;
        flex-shrink: 0;
      }

      .mobile-search-overlay {
        top: 60px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .header-content {
        gap: 4px;
        grid-template-columns: auto 1fr auto auto auto;
      }
      
      .logo {
        font-size: var(--font-size-base);
      }

      .mobile-nav-container {
        gap: 4px;
      }
    }

    /* Netlify Identity Modal Positioning - Fixed for mobile and desktop */
    .netlify-identity-widget,
    [data-netlify-identity-widget] {
      z-index: 1001 !important;
    }

    .netlify-identity-widget iframe,
    .netlify-identity-widget > div,
    .netlify-identity-widget .netlify-identity-modal {
      z-index: 1001 !important;
    }

    /* Force modal to appear below header on mobile */
    @media (max-width: 768px) {
      .netlify-identity-widget {
        position: fixed !important;
        top: 80px !important; /* Below header */
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1001 !important;
      }
      
      .netlify-identity-widget > div {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1001 !important;
        margin: 0 !important;
        padding: 20px !important;
        box-sizing: border-box !important;
      }

      .netlify-identity-widget .netlify-identity-modal {
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        border-radius: 12px !important;
        z-index: 1001 !important;
      }

      /* Ensure header stays on top when modal is open */
      .header {
        z-index: 1002 !important;
        position: relative !important;
      }
    }

    /* Desktop modal positioning */
    @media (min-width: 769px) {
      .netlify-identity-widget .netlify-identity-modal {
        margin-top: 100px !important; /* Space for header */
      }
    }

    /* Login overlay for form blocking */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .login-message {
      background: var(--color-white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      text-align: center;
      max-width: 400px;
      margin: var(--spacing-xl);
      box-shadow: var(--shadow-xl);
    }

    .login-message h3 {
      margin: 0 0 var(--spacing-lg) 0;
      color: var(--color-navy);
      font-family: var(--font-secondary);
      font-weight: 700;
    }

    .login-message p {
      margin: 0 0 var(--spacing-xl) 0;
      color: var(--color-gray);
    }

    /* ===== CUSTOM NOTIFICATION SYSTEM ===== */
    .notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: var(--z-modal);
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--transition-base);
    }

    .notification-overlay.active {
      display: flex;
      opacity: 1;
    }

    .notification-modal {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
      text-align: center;
    }

    .notification-overlay.active .notification-modal {
      transform: scale(1) translateY(0);
    }

    .notification-icon {
      font-size: var(--font-size-4xl);
      margin-bottom: var(--spacing-lg);
      display: block;
    }

    .notification-icon.success {
      color: var(--color-teal);
    }

    .notification-icon.error {
      color: var(--color-coral);
    }

    .notification-icon.warning {
      color: #f59e0b;
    }

    .notification-icon.info {
      color: #3b82f6;
    }

    .notification-title {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-navy);
      margin-bottom: var(--spacing-md);
    }

    .notification-message {
      color: var(--color-gray-dark);
      font-size: var(--font-size-base);
      line-height: 1.6;
      margin-bottom: var(--spacing-xl);
    }

    .notification-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }

    .notification-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      min-width: 100px;
      font-family: var(--font-primary);
    }

    .notification-btn.primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .notification-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .notification-btn.secondary {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-light-gray);
    }

    .notification-btn.secondary:hover {
      border-color: var(--color-teal);
      color: var(--color-teal);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .notification-modal {
        margin: var(--spacing-lg);
        padding: var(--spacing-xl);
      }

      .notification-buttons {
        flex-direction: column;
      }

      .notification-btn {
        width: 100%;
      }
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }

    .header-page {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .header-page h1 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-4xl);
      margin: 0 0 var(--spacing-md) 0;
      color: var(--color-navy);
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .header-page p {
      color: var(--color-gray);
      font-size: var(--font-size-lg);
      margin: 0;
      font-weight: 400;
    }

    .form-section {
      background: var(--color-white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .form-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }

    .form-section h2 {
      margin: 0 0 var(--spacing-lg) 0;
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .form-group {
      margin-bottom: var(--spacing-xl);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      color: var(--color-navy);
      font-size: var(--font-size-sm);
    }

    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      box-sizing: border-box;
      font-family: var(--font-primary);
      transition: all var(--transition-base);
      background: var(--color-white);
      color: var(--color-navy);
    }

    input[type="text"]::placeholder,
    input[type="url"]::placeholder,
    textarea::placeholder {
      font-size: var(--font-size-sm);
      color: var(--color-gray-light);
    }

    input[type="text"]:focus,
    input[type="url"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
      line-height: 1.6;
    }

    .character-prompt {
      min-height: 180px;
    }

    .avatar-preview {
      margin-top: var(--spacing-md);
      display: none;
    }

    .avatar-preview img {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 3px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .avatar-preview img:hover {
      border-color: var(--color-teal);
      transform: scale(1.05);
    }

    .visibility-options {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      cursor: pointer;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      transition: all var(--transition-base);
      background: var(--color-white);
      box-shadow: var(--shadow-sm);
      flex: 1;
    }

    .radio-option:hover {
      border-color: var(--color-teal);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .radio-option.selected {
      border-color: var(--color-teal);
      background: var(--color-off-white);
      box-shadow: var(--shadow-colored);
    }

    .radio-option input[type="radio"] {
      margin: 0;
      width: auto;
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      color: var(--color-navy);
      font-size: var(--font-size-sm);
    }

    .radio-option-desc {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      line-height: 1.4;
    }

    .radio-option.disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    .radio-option.disabled .radio-option-title {
      color: var(--color-gray);
    }

    .radio-option.disabled .radio-option-desc {
      color: var(--color-light-gray);
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-2xl);
    }

    button {
      padding: var(--spacing-lg) var(--spacing-2xl);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      cursor: pointer;
      font-weight: 600;
      transition: all var(--transition-base);
      font-family: var(--font-primary);
    }

    .btn-primary-form {
      background: var(--gradient-primary);
      color: var(--color-white);
      flex: 1;
      box-shadow: var(--shadow-colored);
      position: relative;
      overflow: hidden;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      font-weight: 600;
    }

    .btn-primary-form:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }
    
    .btn-primary-form:disabled {
      cursor: not-allowed;
      opacity: 0.9;
    }
    
    /* Loading progress bar */
    .btn-primary-form.loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0) 100%);
      animation: loadingProgress 20s ease-out forwards;
    }
    
    @keyframes loadingProgress {
      to {
        left: 100%;
      }
    }

    .btn-secondary-form {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-teal);
      min-width: 120px;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary-form:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }

    .preview-section {
      background: var(--color-white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-teal);
      transition: all var(--transition-base);
    }

    .preview-section h2 {
      margin: 0 0 var(--spacing-lg) 0;
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .preview-section h2::before {
      content: 'ðŸ‘ï¸';
      font-size: var(--font-size-lg);
    }

    .preview-character {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: var(--color-off-white);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }
    
    @media (max-width: 768px) {
      .preview-character {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
      }
    }

    .preview-character:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-sm);
    }

    .preview-avatar {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-full);
      background: var(--gradient-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-2xl);
      color: var(--color-white);
      flex-shrink: 0;
      border: 3px solid var(--color-white);
      box-shadow: var(--shadow-md);
    }
    
    @media (max-width: 768px) {
      .preview-avatar {
        width: 80px;
        height: 80px;
        font-size: var(--font-size-3xl);
        margin-bottom: var(--spacing-sm);
      }
    }

    .preview-avatar img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-full);
      object-fit: cover;
    }

    .preview-info {
      flex: 1;
      min-width: 0;
    }

    .preview-info h3 {
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--color-navy);
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 700;
      line-height: 1.2;
    }
    
    @media (max-width: 768px) {
      .preview-info h3 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--spacing-sm);
      }
    }

    .preview-info p {
      margin: 0;
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      line-height: 1.4;
    }
    
    @media (max-width: 768px) {
      .preview-info p {
        font-size: var(--font-size-base);
        line-height: 1.5;
        margin-bottom: var(--spacing-sm);
      }
    }

    .preview-tags {
      margin-top: var(--spacing-md);
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }
    
    @media (max-width: 768px) {
      .preview-tags {
        justify-content: center;
        gap: var(--spacing-sm);
      }
    }

    .preview-tag {
      background: var(--gradient-tags);
      color: var(--color-white);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 500;
    }

    .char-counter {
      font-size: 12px;
      color: #999;
      text-align: right;
      margin-top: 4px;
    }

    .tags-help {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .tags-preview {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      background-color: #e8f4f8;
      color: #2c5282;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .tag.invalid {
      background-color: #fed7d7;
      color: #c53030;
    }

    .tag.new-tag {
      background-color: #e6fffa;
      color: #234e52;
      border: 1px solid #4fd1c7;
    }

    .suggested-tags-section {
      margin-bottom: 16px;
    }

    .suggested-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .suggested-tag {
      background-color: #e8f4f8;
      border: 2px solid #2c5282;
      color: #2c5282;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .suggested-tag:hover {
      background-color: #c2e7f0;
    }

    .suggested-tag.selected {
      background-color: #2c5282;
      color: white;
    }

    .more-tags-button {
      padding: 8px 16px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .more-tags-button:hover {
      background-color: #e0e0e0;
    }

    .tags-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }

    .tags-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      margin: 50px auto;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .tags-modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tags-modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .close-modal:hover {
      background-color: #f0f0f0;
    }

    .tags-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .common-tags-section {
      margin-bottom: 24px;
    }

    .tags-modal-body h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #333;
    }

    .common-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-option {
      background-color: #f8f9fa;
      border: 2px solid #e9ecef;
      color: #495057;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .tag-option:hover {
      border-color: #666;
    }

    .tag-option.selected {
      background-color: #e8f4f8;
      border-color: #2c5282;
      color: #2c5282;
    }

    .loading-tags {
      color: #666;
      font-style: italic;
      padding: 12px;
      text-align: center;
    }

    .tags-modal-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      background-color: #f8f9fa;
    }

    .selected-tags-preview {
      margin-bottom: 16px;
      font-size: 14px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      font-size: 14px;
    }

    .avatar-input-options {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: border-color 0.2s ease;
    }

    .avatar-option.active {
      border-color: #000;
      background-color: #f8f9fa;
    }

    .avatar-option input[type="radio"] {
      display: none;
    }

    .avatar-option > label {
      font-weight: 500;
      margin: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar-option > label::before {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-radius: 50%;
      background: white;
      transition: all 0.2s ease;
    }

    .avatar-option input[type="radio"]:checked + label::before {
      border-color: #000;
      background: #000;
      box-shadow: inset 0 0 0 3px white;
    }

    .upload-button {
      padding: 8px 16px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
      align-self: flex-start;
    }

    .upload-button:hover {
      background-color: #e0e0e0;
    }

    .file-name {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* ===== NEW PERSONALITY BUILDER STYLES ===== */
    
    .personality-builder {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
    }

    .personality-section {
      padding: var(--spacing-xl);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-lg);
      background: var(--color-off-white);
      margin-bottom: var(--spacing-lg);
    }

    .personality-section h3 {
  margin: 0 0 var(--spacing-lg) 0;
  font-family: var(--font-secondary);
  font-size: var(--font-size-lg);
  color: var(--color-navy);
  font-weight: 600;
  line-height: 1.4;
}

    /* Sliders */
    .slider-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .slider-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xs);
    }

    .slider-label {
      font-size: var(--font-size-sm);
      color: var(--color-gray-dark);
      font-weight: 500;
    }

    .slider-container {
      position: relative;
      width: 100%;
    }

    .personality-slider {
      width: 100%;
      height: 8px;
      border-radius: var(--radius-full);
      background: var(--color-light-gray);
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }

    .personality-slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--gradient-primary);
      cursor: pointer;
      border: 3px solid var(--color-white);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-base);
    }

    .personality-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .personality-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--gradient-primary);
      cursor: pointer;
      border: 3px solid var(--color-white);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-base);
    }

    /* Button Groups */
    .button-group-personality {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .personality-button {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      background: var(--color-white);
      color: var(--color-navy);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-base);
      user-select: none;
      font-family: var(--font-primary);
    }

    .personality-button:hover {
      border-color: var(--color-teal);
      background: var(--color-off-white);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .personality-button.selected {
      border-color: var(--color-teal);
      background: var(--color-teal);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .personality-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Selection counters */
    .selection-counter {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      margin-top: var(--spacing-xs);
      text-align: right;
      font-style: italic;
    }

    .selection-counter.at-limit {
      color: var(--color-coral);
      font-weight: 600;
    }

    /* Custom quirks input */
    .custom-quirks {
      margin-top: var(--spacing-md);
    }

    .quirk-input-container {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .quirk-input {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-family: var(--font-primary);
    }

    .quirk-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .add-quirk-btn {
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      white-space: nowrap;
    }

    .add-quirk-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .add-quirk-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Generated prompt section */
    .generated-prompt-section {
      margin-top: var(--spacing-2xl);
      margin-bottom: var(--spacing-2xl);
      padding: var(--spacing-xl);
      background: var(--color-white);
      border: 2px solid var(--color-teal);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .generated-prompt-section h3 {
      margin: 0 0 var(--spacing-lg) 0;
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      color: var(--color-navy);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .generated-prompt-section h3::before {
      content: '';
      font-size: var(--font-size-lg);
    }

    .prompt-preview {
  background: var(--color-off-white);
  padding: var(--spacing-lg);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-light-gray);
  font-size: var(--font-size-sm);
  line-height: 1.6;
  color: var(--color-gray-dark);
  margin-bottom: var(--spacing-lg);
  min-height: 60px;
  max-height: 120px;
  overflow-y: auto;
}

    .prompt-empty {
      color: var(--color-gray-light);
      font-style: italic;
      text-align: center;
      padding: var(--spacing-xl);
    }

    .prompt-actions {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }

    .manual-edit-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--color-white);
      color: var(--color-teal);
      border: 2px solid var(--color-teal);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .manual-edit-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }

    .manual-edit-btn:active {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(0);
      box-shadow: var(--shadow-md);
    }

    .regenerate-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--color-white);
      color: var(--color-teal);
      border: 2px solid var(--color-teal);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .regenerate-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }

    .regenerate-btn:active {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(0);
      box-shadow: var(--shadow-md);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 600px) {
      .container {
        padding: var(--spacing-lg);
      }

      .header-page h1 {
        font-size: var(--font-size-3xl);
      }

      .form-section {
        padding: var(--spacing-xl);
      }

      .visibility-options {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .button-group {
        flex-direction: column;
      }

      .slider-labels {
        font-size: var(--font-size-xs);
      }

      .button-group-personality {
        gap: var(--spacing-xs);
      }

      .personality-button {
        font-size: var(--font-size-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .quirk-input-container {
        flex-direction: column;
      }

      .prompt-actions {
        flex-direction: column;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus styles for keyboard navigation */
    .btn:focus,
    button:focus,
    input:focus,
    textarea:focus,
    select:focus,
    .radio-option:focus,
    .personality-button:focus,
    .personality-slider:focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }

    /* ===== FOOTER STYLES ===== */
    .footer {
      background: var(--color-white);
      border-top: 1px solid var(--color-light-gray);
      padding: var(--spacing-xl) 0;
      margin-top: var(--spacing-3xl);
    }

    .footer-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      text-align: center;
    }

    .footer-links {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

/* Voice option styling */
    .voice-options {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .voice-option {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      cursor: pointer;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      transition: all var(--transition-base);
      background: var(--color-white);
      box-shadow: var(--shadow-sm);
    }

    .voice-option:hover {
      border-color: var(--color-teal);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .voice-option.selected {
      border-color: var(--color-teal);
      background: var(--color-off-white);
      box-shadow: var(--shadow-colored);
    }

    .voice-option input[type="radio"] {
      margin: 0;
      width: auto;
    }

    .voice-option-content {
      flex: 1;
    }

    .voice-option-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      color: var(--color-navy);
      font-size: var(--font-size-sm);
    }

    .voice-option-desc {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      line-height: 1.4;
    }

    /* Response Length Options - Similar to Voice Options */
    .response-length-options {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }

    .response-length-option {
      flex: 1;
      min-width: 200px;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      cursor: pointer;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      transition: all var(--transition-base);
      background: var(--color-white);
      box-shadow: var(--shadow-sm);
    }

    .response-length-option:hover {
      border-color: var(--color-teal);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .response-length-option.selected {
      border-color: var(--color-teal);
      background: var(--color-off-white);
      box-shadow: var(--shadow-colored);
    }

    .response-length-option input[type="radio"] {
      margin: 0;
      width: auto;
    }

    .response-length-content {
      flex: 1;
    }

    .response-length-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      color: var(--color-navy);
      font-size: var(--font-size-sm);
    }

    .response-length-desc {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      line-height: 1.4;
    }

    .footer-link {
      color: var(--color-gray);
      text-decoration: none;
      font-size: var(--font-size-sm);
      font-weight: 500;
      transition: color var(--transition-base);
    }

    .footer-link:hover {
      color: var(--color-teal);
    }

    .footer-separator {
      color: var(--color-gray-light);
      font-size: var(--font-size-sm);
    }

    .footer-copyright {
      color: var(--color-gray-light);
      font-size: var(--font-size-xs);
      margin: 0;
    }

    /* Mobile footer adjustments */
    @media (max-width: 768px) {
      .footer {
        padding: var(--spacing-lg) 0;
        margin-top: var(--spacing-2xl);
      }

      .footer-container {
        padding: 0 var(--spacing-md);
      }

      .footer-links {
        gap: var(--spacing-md);
      }

      /* Responsive design for response length options */
      .response-length-options {
        flex-direction: column;
      }

      .response-length-option {
        min-width: 100%;
      }
    }

    /* Hide the name field in Netlify Identity widget */
    .netlify-identity-widget input[name="name"],
    .netlify-identity-widget input[placeholder="Optional"],
    .netlify-identity-widget .formGroup:first-child {
      display: none !important;
    }
  </style>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D6T01M6XTJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D6T01M6XTJ');
  </script>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner">
  <div class="header-container">
    <div class="header-content">
      <!-- Logo -->
      <a href="index.html" class="logo" aria-label="Narrin AI Home">Narrin AI</a>

      <!-- Desktop Navigation Center -->
      <nav class="nav-center" role="navigation" aria-label="Main navigation">

        <!-- Search Icon - Desktop -->
        <button
          class="mobile-search-btn"
          id="desktopSearchBtn"
          aria-label="Open search"
          aria-expanded="false"
          style="display: flex;"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </nav>

      <!-- Desktop Navigation Links -->
      <nav class="nav-links" role="navigation" aria-label="Secondary navigation">
        <a href="pricing.html" class="nav-link">Pricing</a>
        <a href="chat-overview.html" class="nav-link">My Companions</a>
        <a href="profile.html" class="nav-link" id="loginBtn">Login/Register</a>
        <a href="/create-character" class="btn btn-primary">âœ¨ Create Companion</a>
      </nav>

      <!-- Mobile Navigation Container -->
      <div class="mobile-nav-container">
        <!-- Mobile Hamburger Menu -->
        <button
          class="mobile-menu-btn"
          id="mobileMenuBtn"
          aria-label="Open navigation menu"
          aria-expanded="false"
        >
          <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </button>
      </div>
    </div>
  </div>
</header>


  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-menu-logo">Narrin AI</div>
        <div class="mobile-menu-subtitle">AI Companion Platform</div>
      </div>
      <nav class="mobile-menu-nav" role="navigation" aria-label="Mobile navigation">
        <a href="chat-overview.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">ðŸ’¬</span>
          My Companions
        </a>
        <a href="profile.html" class="mobile-menu-link" id="mobileLoginBtn">
          <span class="mobile-menu-link-icon">ðŸ‘¤</span>
          Login/Register
        </a>
        <a href="create-character.html" class="mobile-menu-link btn-primary">
          <span class="mobile-menu-link-icon">âœ¨</span>
          Create Companion
        </a>
      </nav>
    </div>
  </div>

  <!-- Custom Notification System -->
  <div class="notification-overlay" id="notificationOverlay">
    <div class="notification-modal">
      <span class="notification-icon" id="notificationIcon">âœ“</span>
      <h3 class="notification-title" id="notificationTitle">Success</h3>
      <p class="notification-message" id="notificationMessage">Operation completed successfully!</p>
      <div class="notification-buttons" id="notificationButtons">
        <button class="notification-btn primary" id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Login Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-message">
      <h3>Login Required</h3>
      <p>Please log in to create a character</p>
      <button class="btn btn-primary" onclick="showLoginModal()">Login</button>
      <button class="btn btn-secondary" onclick="hideLoginOverlay()" style="margin-left: 10px;">Cancel</button>
    </div>
  </div>

  <div class="container">
    <div class="header-page">
      <h1>Create New Companion</h1>
      <p>Bring your character to life with a custom personality and communication style</p>
    </div>

    <form id="characterForm">
      <!-- Character Personality -->
      <div class="form-section">
        <h2>Companion Personality ðŸŽ­</h2>
        
        <div class="form-group">
          <label for="characterName">Companion Name *</label>
          <input type="text" id="characterName" name="characterName" required 
                 placeholder="e.g. Life Coach, Gandalf, Marie Curie, Career PA" 
                 maxlength="50">
          <div class="char-counter"><span id="nameCounter">0</span>/50</div>
        </div>

        <!-- REMOVED: Short Tagline field -->
        <input type="hidden" id="characterTitle" name="characterTitle" value="AI Companion">

        <!-- Character Type -->
        <div class="form-group">
          <label for="characterType">Companion Type *</label>
          <select id="characterType" name="characterType" required>
            <option value="">Select companion type...</option>
            <option value="friendship">ðŸ¤ Friendship - A supportive friend and companion</option>
            <option value="mentor">ðŸŽ“ Mentor - A guide and teacher</option>
            <option value="romance">ðŸ’• Romance - A romantic companion</option>
            <option value="mindfulness">ðŸ§˜ Mindfulness - A mindful and calming companion</option>
          </select>
        </div>

        <!-- Personality Builder -->
        <div class="personality-builder">
          <!-- Personality Sliders -->
          <div class="personality-section">
<h3>Personality Spectrum ðŸŽšï¸<br><span style="font-size: var(--font-size-xs); color: var(--color-gray); font-weight: normal;">(Optional)</span></h3>            <div class="slider-group">
              <div class="slider-item">
                <div class="slider-labels">
                  <span class="slider-label">Introvert</span>
                  <span class="slider-label">Extravert</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="personality-slider" id="introvertExtraverts" data-trait="social">
              </div>
              
              <div class="slider-item">
                <div class="slider-labels">
                  <span class="slider-label">Logical</span>
                  <span class="slider-label">Emotional</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="personality-slider" id="logicalEmotional" data-trait="thinking">
              </div>
              
              <div class="slider-item">
                <div class="slider-labels">
                  <span class="slider-label">Serious</span>
                  <span class="slider-label">Playful</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="personality-slider" id="seriousPlayful" data-trait="mood">
              </div>
              
              <div class="slider-item">
                <div class="slider-labels">
                  <span class="slider-label">Formal</span>
                  <span class="slider-label">Casual</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="personality-slider" id="formalCasual" data-trait="formality">
              </div>
              
              <div class="slider-item">
                <div class="slider-labels">
                  <span class="slider-label">Patient</span>
                  <span class="slider-label">Impulsive</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="personality-slider" id="patientImpulsive" data-trait="tempo">
              </div>
            </div>
          </div>

          <!-- Personality Traits -->
          <div class="personality-section">
<h3>Character Traits âœ¨<br><span style="font-size: var(--font-size-xs); color: var(--color-gray); font-weight: normal;">(Optional)</span></h3>            <div class="button-group-personality" id="personalityTraits">
              <button type="button" class="personality-button" data-trait="wise">Wise</button>
              <button type="button" class="personality-button" data-trait="humorous">Humorous</button>
              <button type="button" class="personality-button" data-trait="mysterious">Mysterious</button>
              <button type="button" class="personality-button" data-trait="caring">Caring</button>
              <button type="button" class="personality-button" data-trait="ambitious">Ambitious</button>
              <button type="button" class="personality-button" data-trait="sarcastic">Sarcastic</button>
              <button type="button" class="personality-button" data-trait="optimistic">Optimistic</button>
              <button type="button" class="personality-button" data-trait="protective">Protective</button>
              <button type="button" class="personality-button" data-trait="curious">Curious</button>
              <button type="button" class="personality-button" data-trait="dramatic">Dramatic</button>
              <button type="button" class="personality-button" data-trait="confident">Confident</button>
              <button type="button" class="personality-button" data-trait="gentle">Gentle</button>
              <button type="button" class="personality-button" data-trait="intense">Intense</button>
              <button type="button" class="personality-button" data-trait="creative">Creative</button>
              <button type="button" class="personality-button" data-trait="analytical">Analytical</button>
            </div>
            <div class="selection-counter" id="traitsCounter">Select 0-5 traits that describe your character</div>
          </div>
        </div>
      </div>

      <!-- Communication Style -->
      <div class="form-section">
        <h2>ðŸ’¬ Communication Style</h2>
        
        <!-- Speaking Pattern -->
        <div class="personality-section">
<h3>Speaking Pattern ðŸ—£ï¸<br><span style="font-size: var(--font-size-xs); color: var(--color-gray); font-weight: normal;">(Optional)</span></h3>          <div class="button-group-personality" id="speakingPattern">
            <button type="button" class="personality-button" data-pattern="formal-eloquent">ðŸ“œ Formal & Eloquent</button>
            <button type="button" class="personality-button" data-pattern="casual-friendly">ðŸ—£ï¸ Casual & Friendly</button>
            <button type="button" class="personality-button" data-pattern="bold-confident">ðŸ’ª Bold & Confident</button>
            <button type="button" class="personality-button" data-pattern="thoughtful-deep">ðŸ¤” Thoughtful & Deep</button>
            <button type="button" class="personality-button" data-pattern="witty-sarcastic">ðŸ˜„ Witty & Sarcastic</button>
            <button type="button" class="personality-button" data-pattern="warm-nurturing">ðŸ’ Warm & Nurturing</button>
            <button type="button" class="personality-button" data-pattern="direct-practical">ðŸŽ¯ Direct & Practical</button>
            <button type="button" class="personality-button" data-pattern="mysterious-cryptic">âœ¨ Mysterious & Cryptic</button>
          </div>
          <div class="selection-counter" id="speakingCounter">Select 0-3 speaking patterns that fit your character</div>
        </div>

        <!-- REMOVED: Response Style Sliders section -->

        <!-- REMOVED: Personality Quirks section -->

        <!-- REMOVED: Character description field -->
      </div>

      <!-- Generated Prompt -->
      <div class="form-section">
        <div class="generated-prompt-section">
          <h3>Generated Character Prompt *</h3>
          <div class="prompt-preview" id="promptPreview">
            <div class="prompt-empty">Select personality traits above to generate your character prompt...</div>
          </div>
          <div class="prompt-actions">
            <button type="button" id="manualEdit" class="manual-edit-btn">âœï¸ Edit Manually</button>
          </div>
          <div style="font-size: var(--font-size-xs); color: var(--color-gray); margin-top: var(--spacing-sm); font-style: italic;">
            Click "Edit Manually" to customize the generated prompt or make changes to personality selections above to auto-update.
          </div>
        </div>
        
        <div class="form-group" id="manualPromptGroup" style="display: none; margin-top: var(--spacing-xl);">
          <label for="characterPrompt">Character Prompt *</label>
          <textarea id="characterPrompt" name="characterPrompt" required 
                    class="character-prompt"
                    placeholder="Your generated prompt will appear here..."></textarea>
          <div class="char-counter"><span id="promptCounter">0</span>/2000</div>
          <div class="prompt-actions" style="margin-top: var(--spacing-md);">
            <button type="button" id="backToGenerated" class="regenerate-btn">â† Back to Generated</button>
          </div>
        </div>
      </div>

     <!-- Extra Instructions/Backstory -->
     <div class="form-section">
       <h2>ðŸ“ Extra Instructions <span style="font-size: var(--font-size-sm); color: var(--color-gray); font-weight: normal;">(Optional)</span></h2>
       
       <div class="form-group">
         <label for="extraInstructions">Additional backstory, instructions, or personality details</label>
         <textarea id="extraInstructions" name="extraInstructions" 
                   placeholder="e.g. Grew up in a small town, loves astronomy, speaks multiple languages, has a PhD in psychology, etc."
                   maxlength="500"></textarea>
         <div class="char-counter"><span id="extraCounter">0</span>/500</div>
       </div>
     </div>

<!-- Voice Selection Section -->
     <div class="form-section">
       <h2>ðŸŽ™ï¸ Voice Selection <span style="font-size: var(--font-size-sm); color: var(--color-gray); font-weight: normal;">(Optional)</span></h2>
       
       <div class="form-group">
         <label>Companion Voice</label>
         <div class="voice-options">
           <div class="voice-option selected" onclick="selectVoice('auto')">
             <input type="radio" name="voiceSelection" value="auto" checked>
             <div class="voice-option-content">
               <div class="voice-option-title">ðŸ¤– Auto-Select</div>
               <div class="voice-option-desc">We'll choose the perfect voice based on your character's personality</div>
             </div>
           </div>
           
           <div class="voice-option" onclick="selectVoice('custom')">
             <input type="radio" name="voiceSelection" value="custom">
             <div class="voice-option-content">
               <div class="voice-option-title">ðŸŽ¯ Choose Voice</div>
               <div class="voice-option-desc">Pick from our curated voice collection</div>
             </div>
           </div>
           
           <div class="voice-option" onclick="selectVoice('none')">
             <input type="radio" name="voiceSelection" value="none">
             <div class="voice-option-content">
               <div class="voice-option-title">ðŸ”‡ No Voice</div>
               <div class="voice-option-desc">Text-only character</div>
             </div>
           </div>
         </div>
         
         <!-- Custom Voice Selection (hidden by default) -->
         <div id="customVoiceSelection" style="display: none; margin-top: var(--spacing-lg);">
           <label for="voicePreset">Voice Type</label>
           <select id="voicePreset" name="voicePreset">
             <option value="">Choose a voice...</option>
             <!-- Character-Specific Voices -->
            <option value="royal_authority">ðŸ‘‘ Royal Authority - Authoritative and majestic</option>
             <option value="wise_mentor">ðŸ§™â€â™‚ï¸ Wise Mentor - Supportive and experienced</option>
             <option value="caring_therapist">ðŸ’ Caring Advisor - Understanding and soothing</option>
             <option value="romantic_partner">ðŸ’• Romantic Partner - Warm and loving</option>
             <option value="best_friend">ðŸ¤— Best Friend - Casual and supportive</option>
             <option value="mysterious_stranger">ðŸŽ­ Mysterious Stranger - Intriguing and enigmatic</option>
             <option value="cheerful_comedian">ðŸ˜„ Cheerful Comedian - Joyful and humorous</option>
             <option value="wise_elder">ðŸ‘´ Wise Elder - Experienced and understanding</option>
             <option value="creative_dreamer">ðŸŽ¨ Creative Dreamer - Imaginative and inspiring</option>
             <option value="anime_hero">âš¡ Anime Hero - Energetic and youthful</option>
            <option value="business_coach">ðŸ“Š Business Coach - Professional and motivating</option>
            <option value="fitness_trainer">ðŸ’ª Fitness Trainer - Energetic and encouraging</option>
            <option value="storyteller">ðŸ“– Storyteller - Engaging and captivating</option>
            <option value="rebel_spirit">ðŸ”¥ Rebel Spirit - Bold and defiant</option>
            <option value="mystical_guide">ðŸ”® Mystical Guide - Spiritual and enlightening</option>
            
            <!-- Legacy Voices (backup) -->
           </select>
           
           <div class="voice-preview" style="margin-top: var(--spacing-md);">
             <button type="button" id="testVoiceBtn" class="btn btn-secondary-form" disabled>
               ðŸ”Š Test Voice
             </button>
           </div>
         </div>
       </div>
    

     
      <!-- Response Length -->
      <div class="form-section">
        <h2>ðŸ“ Response Length <span style="font-size: var(--font-size-sm); color: var(--color-gray); font-weight: normal;">(Optional)</span></h2>
        
        <div class="form-group">
          <label>Preferred Response Length</label>
          <p style="font-size: var(--font-size-sm); color: var(--color-gray); margin-bottom: var(--spacing-md);">
            Choose how detailed your character's responses typically are. This is a preference, not a strict rule.
          </p>
          <div class="response-length-options">
            <div class="response-length-option" onclick="selectResponseLength('short')">
              <input type="radio" name="responseLength" value="short">
              <div class="response-length-content">
                <div class="response-length-title">ðŸ’¬ Short & Sweet</div>
                <div class="response-length-desc">Quick, concise responses. Perfect for casual chats.</div>
              </div>
            </div>
            
            <div class="response-length-option selected" onclick="selectResponseLength('medium')">
              <input type="radio" name="responseLength" value="medium" checked>
              <div class="response-length-content">
                <div class="response-length-title">ðŸ“ Balanced</div>
                <div class="response-length-desc">Natural conversation flow with moderate detail.</div>
              </div>
            </div>
            
            <div class="response-length-option" onclick="selectResponseLength('long')">
              <input type="radio" name="responseLength" value="long">
              <div class="response-length-content">
                <div class="response-length-title">ðŸ“š Detailed & Rich</div>
                <div class="response-length-desc">Comprehensive responses with depth and nuance.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Character profile image -->
      <div class="form-section">
        <h2>ðŸ‘¤ Companion profile image <span style="font-size: var(--font-size-sm); color: var(--color-gray); font-weight: normal;">(Optional)</span></h2>
        
        <div class="form-group">
          <label>Upload Image</label>
          <div class="avatar-input-options">
            <div class="avatar-option">
              <input type="file" id="avatarFileInput" name="avatarFileInput" 
                     accept="image/*" style="display: none;">
              <button type="button" class="upload-button" onclick="triggerFileUpload()">
                Choose File
              </button>
              <span class="file-name" id="fileName">No file chosen</span>
            </div>
         </div>
         
         <div class="avatar-preview" id="avatarPreview">
           <img id="avatarImg" src="" alt="Avatar preview">
         </div>
       </div>
     </div>

     <!-- REMOVED: Category selection - using types only -->
     <input type="hidden" name="characterCategory" value="made-by-you">


     <!-- HIDDEN: Characters are automatically private -->
     <input type="hidden" name="visibility" value="private">

     <!-- Preview -->
     <div class="preview-section" id="previewSection" style="display: none;">
       <h2>Preview</h2>
       <div class="preview-character">
         <div class="preview-avatar" id="previewAvatar">
           ðŸ‘¤
         </div>
         <div class="preview-info">
           <h3 id="previewName">Character Name</h3>
           <p id="previewTitle">Character title will appear here</p>
           <div class="preview-tags" id="previewTags"></div>
         </div>
       </div>
     </div>

     <!-- Buttons -->
     <div class="button-group">
       <button type="submit" class="btn-primary-form" id="submitButton">Create Companion</button>
     </div>
   </form>
 </div>

 <script>
   // Global variables
   let currentAvatarUrl = '';
   let pendingCharacterData = null;
   
   // Personality builder state
   let personalityState = {
     sliders: {
       social: 50,
       thinking: 50,
       mood: 50,
       formality: 50,
       tempo: 50,
       length: 50,
       style: 50,
       content: 50
     },
     traits: [],
     speaking: [],
     quirks: []
   };

// ===== VOICE SYSTEM (VEILIG VIA NETLIFY FUNCTIONS) =====
   
   // Voice Library Configuration
   const voiceLibrary = {
     // Mannelijke stemmen
     'male_professional': 'iP95p4HMsOdaJ6J8s72v',     // Joshua - zakelijke man
     'male_friendly': 'TxGEqnHWrfWFTfGW9XjX',         // Ethan - vriendelijke man
     'male_wise': 'VR6AewLTigWG4xSOukaG',             // Arnold - oude wijze man
     'male_energetic': 'pqHfZKP75CvOlQylNhV4',        // Bill - jonge energieke man
     'male_calm': 'yoZ06aMxZJJ28mfd3POQ',             // Sam - rustige man
     
     // Vrouwelijke stemmen
     'female_professional': 'EXAVITQu4vr4xnSDxMaL',   // Bella - zakelijke vrouw
     'female_friendly': 'XrExE9yKIg1WjnnlVkGX',       // Freya - vriendelijke vrouw
     'female_wise': 'oWAxZDx7w5VEj9dCyTzz',           // Grace - oude wijze vrouw
     'female_energetic': 'pFZP5JQG7iQjIQuC4Bku',      // Lily - jonge energieke vrouw
     'female_nurturing': 'XB0fDUnXU5powFXDhCwa',      // Charlotte - zorgzame vrouw
     
     // Speciale stemmen
     'neutral_ai': 'iP95p4HMsOdaJ6J8s72v',            // Neutrale AI stem
     'child_friendly': 'pFZP5JQG7iQjIQuC4Bku',        // Kindvriendelijke stem
     'default': 'iP95p4HMsOdaJ6J8s72v',               // Fallback
     
     // NEW CHARACTER-SPECIFIC VOICES - UPDATE WITH YOUR ELEVENLABS VOICE IDs
     'royal_authority': 'fvcBHKa2lxguQE5lB4uV',          // Royal Authority - Authoritative and majestic
     'wise_mentor': 'p3yi6sku4VQJg3uH6i6D',              // Wise Mentor - Supportive and experienced
     'caring_therapist': 'W8ouBcjTunaMJLYU2BvB',         // Caring Advisor - Understanding and soothing
     'romantic_partner': 'SyTRiCoyqTeFEk9z5HVW',         // Romantic Partner - Warm and loving
     'best_friend': 'wdGYtWKVlLmwTxGswfYd',              // Best Friend - Casual and supportive
     'mysterious_stranger': 'SAhaRsW91OuPlKeINYop',      // Mysterious Stranger - Intriguing and enigmatic
     'cheerful_comedian': 'by3rQdWs4XjziQwJ2sTL',        // Cheerful Comedian - Joyful and humorous
     'wise_elder': 'qEN0DupmmmaueYJ8Eaz8',               // Wise Elder - Experienced and understanding
     'creative_dreamer': 'xrnmhZSWIj7bbiePgGvN',         // Creative Dreamer - Imaginative and inspiring
     'anime_hero': 'bPTYXR1t7VO7OqE0XKTC',               // Anime Hero - Energetic and youthful
     'business_coach': 'G5GoD2FgQe3Hzaz0vt43',           // Business Coach - Professional and motivating
     'fitness_trainer': '51yNzCRVCZm7Y1tnCXkv',          // Fitness Trainer - Energetic and encouraging
     'storyteller': '0lQiUnjkvRkmBWp91f0M',              // Storyteller - Engaging and captivating
     'rebel_spirit': 'LQE5CZhudCF69ZH1OqB4',             // Rebel Spirit - Bold and defiant
     'mystical_guide': 'nhcRWQJQwy0CaUoH3L6C'            // Mystical Guide - Spiritual and enlightening
   };

   // VEILIGE TTS functie via Netlify Function
   async function generateSpeech(text, voiceId) {
     try {
       const response = await fetch('/.netlify/functions/tts-simple', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json'
         },
         body: JSON.stringify({
           text: text,
           voice_id: voiceId
         })
       });

       if (!response.ok) {
         throw new Error(`TTS request failed: ${response.status}`);
       }

       const data = await response.json();
       
       if (!data.success) {
         throw new Error(data.error || 'TTS generation failed');
       }

       // Convert base64 to blob
       const audioBytes = atob(data.audio);
       const audioArray = new Uint8Array(audioBytes.length);
       for (let i = 0; i < audioBytes.length; i++) {
         audioArray[i] = audioBytes.charCodeAt(i);
       }
       
       return new Blob([audioArray], { type: 'audio/mpeg' });

     } catch (error) {
       console.error('TTS Error:', error);
       throw error;
     }
   }

   // Voice selection functions
   function selectVoice(type) {
     document.querySelectorAll('.voice-option').forEach(option => {
       option.classList.remove('selected');
     });
     
     event.target.closest('.voice-option').classList.add('selected');
     document.querySelector(`input[value="${type}"]`).checked = true;
     
     const customSelection = document.getElementById('customVoiceSelection');
     if (type === 'custom') {
       customSelection.style.display = 'block';
     } else {
       customSelection.style.display = 'none';
     }
   }

   // Response length selection function
   function selectResponseLength(length) {
     document.querySelectorAll('.response-length-option').forEach(option => {
       option.classList.remove('selected');
     });
     
     event.target.closest('.response-length-option').classList.add('selected');
     document.querySelector(`input[name="responseLength"][value="${length}"]`).checked = true;
     
     // Regenerate prompt with new response length
     generatePrompt();
   }

   // Auto voice assignment
   function getAutoVoice(characterData) {
     const { name, category, personalityState } = characterData;
     
     // Gender detection
     const isFemale = detectFemaleCharacter(name, personalityState);
     const gender = isFemale ? 'female' : 'male';
     
     // Type detection
     let voiceType = 'friendly';
     
     if (category === 'educational') {
       voiceType = 'professional';
     } else if (category.includes('coach')) {
       voiceType = personalityState.traits.includes('caring') ? 'nurturing' : 'professional';
     } else if (personalityState.traits.includes('wise')) {
       voiceType = 'wise';
     } else if (personalityState.sliders.mood > 70) {
       voiceType = 'energetic';
     } else if (personalityState.sliders.tempo < 30) {
       voiceType = 'calm';
     }
     
     const voiceKey = `${gender}_${voiceType}`;
     return voiceLibrary[voiceKey] || voiceLibrary.default;
   }

   function detectFemaleCharacter(name, personalityState) {
     const femaleNames = ['maria', 'anna', 'sarah', 'emma', 'sophie', 'alice', 'diana', 'elena', 'grace', 'lily', 'charlotte', 'maya', 'luna'];
     const nameLower = name.toLowerCase();
     
     // Check name
     if (femaleNames.some(fname => nameLower.includes(fname))) return true;
     
     // Check traits
     if (personalityState.traits.includes('nurturing') || personalityState.traits.includes('caring')) {
       return true;
     }
     
     return false;
   }

   function getSelectedVoiceId() {
     const voiceSelection = document.querySelector('input[name="voiceSelection"]:checked').value;
     
     if (voiceSelection === 'none') {
       return null;
     } else if (voiceSelection === 'custom') {
       const voiceType = document.getElementById('voicePreset').value;
       return voiceLibrary[voiceType] || null;
     } else { // auto
       const formData = {
         name: document.getElementById('characterName').value,
         category: document.getElementById('characterCategory').value,
         personalityState: personalityState
       };
       return getAutoVoice(formData);
     }
   }

   async function playTestVoice(text, voiceId) {
     try {
       const audioBlob = await generateSpeech(text, voiceId);
       const audioUrl = URL.createObjectURL(audioBlob);
       const audio = new Audio(audioUrl);
       audio.play();
       
       audio.addEventListener('ended', () => {
         URL.revokeObjectURL(audioUrl);
       });
     } catch (error) {
       showError('Could not test voice. Please try again.');
     }
   }

   // Setup voice test functionality
   function setupVoiceTest() {
     document.getElementById('voicePreset').addEventListener('change', (e) => {
       const testBtn = document.getElementById('testVoiceBtn');
       testBtn.disabled = !e.target.value;
     });

     document.getElementById('testVoiceBtn').addEventListener('click', async () => {
       const voiceType = document.getElementById('voicePreset').value;
       const voiceId = voiceLibrary[voiceType];
       
       if (voiceId) {
         const testBtn = document.getElementById('testVoiceBtn');
         const originalText = testBtn.textContent;
         testBtn.textContent = 'ðŸ”„ Playing...';
         testBtn.disabled = true;
         
         try {
           const testText = "Hello! This is how I would sound when we chat together.";
           await playTestVoice(testText, voiceId);
         } catch (error) {
           console.error('Voice test failed:', error);
           testBtn.textContent = 'âŒ Voice test failed';
           testBtn.disabled = false;
           
           // Show more specific error message
           if (error.message.includes('400')) {
             showError('Voice test failed: Invalid request. Please check your API configuration.', 'Voice Test Error');
           } else if (error.message.includes('500')) {
             showError('Voice test failed: Server error. Please try again later.', 'Voice Test Error');
           } else {
             showError('Voice test failed: Could not connect to voice service. Please check your internet connection.', 'Voice Test Error');
           }
           
           // Reset button after 3 seconds
           setTimeout(() => {
             testBtn.textContent = originalText;
           }, 3000);
           return;
         }
         
         setTimeout(() => {
           testBtn.textContent = originalText;
           testBtn.disabled = false;
         }, 3000);
       }
     });
   }

   // ===== NAVIGATION FUNCTIONALITY =====
   
   // Mobile Search Elements
   const mobileSearchBtn = document.getElementById('mobileSearchBtn');
   const mobileSearchOverlay = document.getElementById('mobileSearchOverlay');
   const mobileSearchInput = document.getElementById('mobileSearchInput');
   
   // Mobile Menu Elements
   const mobileMenuBtn = document.getElementById('mobileMenuBtn');
   const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
   
   // USP Carousel Elements
   const uspTrack = document.getElementById('uspTrack');
   let currentUspIndex = 0;
   let uspInterval;

   // ===== MOBILE SEARCH FUNCTIONALITY =====
   function toggleMobileSearch() {
     const isActive = mobileSearchOverlay.classList.contains('active');
     
     if (isActive) {
       mobileSearchOverlay.classList.remove('active');
       mobileSearchBtn.setAttribute('aria-expanded', 'false');
     } else {
       // Close mobile menu if open
       closeMobileMenu();
       
       mobileSearchOverlay.classList.add('active');
       mobileSearchBtn.setAttribute('aria-expanded', 'true');
       mobileSearchInput.focus();
     }
   }

   mobileSearchBtn?.addEventListener('click', toggleMobileSearch);

   // Desktop search button
   const desktopSearchBtn = document.getElementById('desktopSearchBtn');
   desktopSearchBtn?.addEventListener('click', toggleMobileSearch);

   // ===== MOBILE MENU FUNCTIONALITY =====
   function toggleMobileMenu() {
     const isActive = mobileMenuOverlay.classList.contains('active');
     
     if (isActive) {
       closeMobileMenu();
     } else {
       openMobileMenu();
     }
   }

   function openMobileMenu() {
     // Close search overlay if open
     if (mobileSearchOverlay.classList.contains('active')) {
       mobileSearchOverlay.classList.remove('active');
       mobileSearchBtn.setAttribute('aria-expanded', 'false');
     }
     
     mobileMenuOverlay.classList.add('active');
     mobileMenuBtn.classList.add('active');
     mobileMenuBtn.setAttribute('aria-expanded', 'true');
     
     // Prevent body scroll
     document.body.style.overflow = 'hidden';
   }

   function closeMobileMenu() {
     mobileMenuOverlay.classList.remove('active');
     mobileMenuBtn.classList.remove('active');
     mobileMenuBtn.setAttribute('aria-expanded', 'false');
     
     // Restore body scroll
     document.body.style.overflow = '';
   }

   mobileMenuBtn?.addEventListener('click', toggleMobileMenu);

   // Close menu when clicking on overlay background
   mobileMenuOverlay?.addEventListener('click', (e) => {
     if (e.target === mobileMenuOverlay) {
       closeMobileMenu();
     }
   });

   // Close menu when clicking on a menu item
   document.querySelectorAll('.mobile-menu-link').forEach(link => {
     link.addEventListener('click', closeMobileMenu);
   });

   // Close search and menu on outside click
   document.addEventListener('click', (e) => {
     // Close search overlay
     if (!mobileSearchOverlay?.contains(e.target) &&
         !mobileSearchBtn?.contains(e.target) &&
         mobileSearchOverlay?.classList.contains('active')) {
       mobileSearchOverlay.classList.remove('active');
       mobileSearchBtn.setAttribute('aria-expanded', 'false');
     }
   });

   // Close menu on escape key
   document.addEventListener('keydown', (e) => {
     if (e.key === 'Escape') {
       if (mobileMenuOverlay.classList.contains('active')) {
         closeMobileMenu();
       }
       if (mobileSearchOverlay.classList.contains('active')) {
         mobileSearchOverlay.classList.remove('active');
         mobileSearchBtn.setAttribute('aria-expanded', 'false');
       }
     }
   });

   // ===== USP CAROUSEL FUNCTIONALITY =====
   function startUspCarousel() {
     if (window.innerWidth <= 768 && uspTrack) {
       uspInterval = setInterval(() => {
         currentUspIndex = (currentUspIndex + 1) % 3;
         uspTrack.style.transform = `translateY(-${currentUspIndex * 33.333}%)`;
       }, 3000);
     }
   }

   function stopUspCarousel() {
     if (uspInterval) {
       clearInterval(uspInterval);
       uspInterval = null;
     }
   }

   // Handle responsive behavior
   function handleResize() {
     if (window.innerWidth > 768) {
       stopUspCarousel();
       if (uspTrack) {
         uspTrack.style.transform = '';
       }
       if (mobileSearchOverlay?.classList.contains('active')) {
         mobileSearchOverlay.classList.remove('active');
         mobileSearchBtn?.setAttribute('aria-expanded', 'false');
       }
       if (mobileMenuOverlay?.classList.contains('active')) {
         closeMobileMenu();
       }
     } else {
       startUspCarousel();
     }
   }

   // Initialize on load
   window.addEventListener('load', () => {
     handleResize();
   });

   // Handle window resize
   let resizeTimer;
   window.addEventListener('resize', () => {
     clearTimeout(resizeTimer);
     resizeTimer = setTimeout(handleResize, 250);
   });

   // ===== SEARCH FUNCTIONALITY =====
   function handleSearch(searchTerm) {
     if (!searchTerm || !searchTerm.trim()) {
       console.log('Empty search term, ignoring');
       return;
     }
     
     const trimmedTerm = searchTerm.trim();
     console.log('Redirecting to search results for:', trimmedTerm);
     window.location.href = `search-results.html?q=${encodeURIComponent(trimmedTerm)}`;
   }

   // Desktop search
   document.querySelector('.nav-search')?.addEventListener('submit', (e) => {
     e.preventDefault();
     const searchInput = e.target.querySelector('.nav-search-input');
     handleSearch(searchInput.value);
   });

   // Mobile search
   document.querySelector('.mobile-search-form')?.addEventListener('submit', (e) => {
     e.preventDefault();
     const searchInput = e.target.querySelector('.mobile-search-input');
     handleSearch(searchInput.value);
     toggleMobileSearch();
   });

   // ===== NETLIFY IDENTITY BUTTON UPDATES =====
   function updateLoginButton() {
     const loginBtn = document.getElementById('loginBtn');
     const mobileLoginBtn = document.getElementById('mobileLoginBtn');
     
     // Check both Netlify Identity and local storage for user info
     const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
     const localEmail = localStorage.getItem("user_email");
     const localToken = localStorage.getItem("user_token");
     
     const isLoggedIn = netlifyUser || (localEmail && localToken);
     
     if (isLoggedIn) {
       // Always show "Profile" for logged in users instead of their name
       
       // Update desktop button
       if (loginBtn) {
         loginBtn.textContent = 'Profile';
         loginBtn.href = 'profile.html';
       }
       
       // Update mobile button
       if (mobileLoginBtn) {
         const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
         mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">ðŸ‘¤</span>'}Profile`;
         mobileLoginBtn.href = 'profile.html';
       }
     } else {
       // User is not logged in
       if (loginBtn) {
         loginBtn.textContent = 'Login/Register';
         loginBtn.href = 'profile.html';
       }
       if (mobileLoginBtn) {
         const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
         mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">ðŸ‘¤</span>'}Login/Register`;
         mobileLoginBtn.href = 'profile.html';
       }
     }
   }

   // Enhanced click handler for navigation links
   function setupNavigationClickHandlers() {
     const loginBtn = document.getElementById('loginBtn');
     const mobileLoginBtn = document.getElementById('mobileLoginBtn');
     
     // Desktop login button click handler
     if (loginBtn) {
       loginBtn.addEventListener('click', (e) => {
         e.preventDefault();
         
         const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
         const localEmail = localStorage.getItem("user_email");
         const localToken = localStorage.getItem("user_token");
         const isLoggedIn = netlifyUser || (localEmail && localToken);
         
         if (isLoggedIn) {
           // User is logged in, go directly to profile page
           window.location.href = 'profile.html';
         } else {
           // User not logged in, store current page for redirect and open login
           localStorage.setItem('login_redirect_url', window.location.href);
           openLogin();
         }
       });
     }
     
     // Mobile login button click handler
     if (mobileLoginBtn) {
       mobileLoginBtn.addEventListener('click', (e) => {
         e.preventDefault();
         
         const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
         const localEmail = localStorage.getItem("user_email");
         const localToken = localStorage.getItem("user_token");
         const isLoggedIn = netlifyUser || (localEmail && localToken);
         
         if (isLoggedIn) {
           // User is logged in, go directly to profile page
           window.location.href = 'profile.html';
         } else {
           // User not logged in, store current page for redirect and open login
           localStorage.setItem('login_redirect_url', window.location.href);
           openLogin();
         }
         
         // Close mobile menu after click
         closeMobileMenu();
       });
     }
   }

   // Function to open login modal
   function openLogin() {
     if (window.netlifyIdentity) {
       window.netlifyIdentity.open('login');
     } else {
       // Fallback if Netlify Identity is not available
       window.location.href = 'profile.html';
     }
   }

   // Initialize login button on page load
   document.addEventListener('DOMContentLoaded', () => {
     // Update immediately on page load
     updateLoginButton();
     
     // Set up click handlers
     setupNavigationClickHandlers();
     
     if (window.netlifyIdentity) {
       window.netlifyIdentity.on('init', user => {
         if (user) {
           // Store user data when already logged in
           localStorage.setItem('user_email', user.email);
           localStorage.setItem('user_token', user.token?.access_token || 'true');
           localStorage.setItem('user_uid', user.id);
           localStorage.setItem('netlify_uid', user.id);
         }
         updateLoginButton();
       });

       window.netlifyIdentity.on('login', user => {
         console.log('ðŸ” Login event triggered:', {
           email: user.email,
           id: user.id,
           hasToken: !!user.token,
           provider: user.app_metadata?.provider,
           isGoogleSSO: user.app_metadata?.provider === 'google'
         });
         
         // Store user data on login
         localStorage.setItem('user_email', user.email);
         localStorage.setItem('user_token', user.token?.access_token || 'true');
         localStorage.setItem('user_uid', user.id);
         // Don't store netlify_uid for Google SSO users as it might confuse things
         if (user.app_metadata?.provider !== 'google') {
           localStorage.setItem('netlify_uid', user.id);
         }
         
         updateLoginButton();
         window.netlifyIdentity.close();
       });

       window.netlifyIdentity.on('signup', async user => {
         console.log('ðŸŽ‰ New user signup:', user.email);
         console.log('ðŸ“ Current page:', window.location.pathname);
         
         // Store user data on signup
         localStorage.setItem('user_email', user.email);
         localStorage.setItem('user_token', user.token?.access_token || 'true');
         localStorage.setItem('user_uid', user.id);
         if (user.app_metadata?.provider !== 'google') {
           localStorage.setItem('netlify_uid', user.id);
         }
         
         // Setup 7-day Engage trial for new users
         try {
           console.log('ðŸŽ Setting up 7-day Engage trial...');
           const trialResponse = await fetch('/.netlify/functions/setup-trial', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({
               user_email: user.email,
               user_uid: user.id
             })
           });
           
           if (trialResponse.ok) {
             const trialData = await trialResponse.json();
             console.log('âœ… Trial setup successful:', trialData);
             
             // Store trial info in localStorage
             localStorage.setItem('user_plan', 'Engage');
             localStorage.setItem('subscription_status', 'trial');
             localStorage.setItem('trial_end_date', trialData['grace_period_end']);
             
             showNotification('ðŸŽ‰ Welcome! You have 7 days of Engage plan access with unlimited messaging!');
           } else {
             console.error('âŒ Failed to setup trial');
           }
         } catch (error) {
           console.error('âŒ Error setting up trial:', error);
         }
         
         updateLoginButton();
         window.netlifyIdentity.close();
       });

       window.netlifyIdentity.on('logout', () => {
         // Clear user data
         localStorage.removeItem('user_email');
         localStorage.removeItem('user_token');
         localStorage.removeItem('user_uid');
         localStorage.removeItem('netlify_uid');
         
         updateLoginButton();
       });
     }
   });

   // ===== CUSTOM NOTIFICATION SYSTEM =====
   function showNotification(type, title, message, buttons = null) {
     const overlay = document.getElementById('notificationOverlay');
     const icon = document.getElementById('notificationIcon');
     const titleEl = document.getElementById('notificationTitle');
     const messageEl = document.getElementById('notificationMessage');
     const buttonsEl = document.getElementById('notificationButtons');
     
     // Set icon based on type
     const icons = {
       success: 'âœ…',
       error: 'âŒ',
       warning: 'âš ï¸',
       info: 'â„¹ï¸',
       question: 'â“'
     };
     
     icon.textContent = icons[type] || icons.info;
     icon.className = `notification-icon ${type}`;
     titleEl.textContent = title;
     messageEl.textContent = message;
     
     // Set up buttons
     if (buttons) {
       buttonsEl.innerHTML = '';
       buttons.forEach(button => {
         const btn = document.createElement('button');
         btn.className = `notification-btn ${button.type || 'secondary'}`;
         btn.textContent = button.text;
         btn.onclick = () => {
           hideNotification();
           if (button.callback) button.callback();
         };
         buttonsEl.appendChild(btn);
       });
     } else {
       // Default OK button
       buttonsEl.innerHTML = '<button class="notification-btn primary" onclick="hideNotification()">OK</button>';
     }
     
     // Show notification
     overlay.classList.add('active');
     document.body.style.overflow = 'hidden';
   }
   
   function hideNotification() {
     const overlay = document.getElementById('notificationOverlay');
     overlay.classList.remove('active');
     document.body.style.overflow = '';
   }
   
   // Custom alert replacement
   function customAlert(message, title = 'Notification') {
     showNotification('info', title, message);
   }
   
   // Custom confirm replacement
   function customConfirm(message, title = 'Confirm', onConfirm = null, onCancel = null) {
     const buttons = [
       {
         text: 'Cancel',
         type: 'secondary',
         callback: onCancel
       },
       {
         text: 'Confirm',
         type: 'primary',
         callback: onConfirm
       }
     ];
     showNotification('question', title, message, buttons);
   }
   
   // Success notification
   function showSuccess(message, title = 'Success') {
     showNotification('success', title, message);
   }
   
   // Error notification
   function showError(message, title = 'Error') {
     showNotification('error', title, message);
   }
   
   // Warning notification
   function showWarning(message, title = 'Warning') {
     showNotification('warning', title, message);
   }

   // ===== PERSONALITY BUILDER FUNCTIONALITY =====
   
   // Setup personality sliders
   function setupPersonalitySliders() {
     const sliders = document.querySelectorAll('.personality-slider');
     sliders.forEach(slider => {
       slider.addEventListener('input', (e) => {
         const trait = e.target.getAttribute('data-trait') || e.target.getAttribute('data-response');
         personalityState.sliders[trait] = parseInt(e.target.value);
         generatePrompt();
       });
     });
   }

   // Setup personality trait buttons - FIXED
   function setupPersonalityButtons() {
     // Personality traits (max 5)
     const traitButtons = document.querySelectorAll('#personalityTraits .personality-button');
     traitButtons.forEach(button => {
       button.addEventListener('click', (e) => {
         e.preventDefault();
         const trait = button.getAttribute('data-trait');
         toggleArraySelection(personalityState.traits, trait, 5, button, 'traitsCounter', 'traits');
       });
     });

     // Speaking patterns (max 3)
     const speakingButtons = document.querySelectorAll('#speakingPattern .personality-button');
     speakingButtons.forEach(button => {
       button.addEventListener('click', (e) => {
         e.preventDefault();
         const pattern = button.getAttribute('data-pattern');
         toggleArraySelection(personalityState.speaking, pattern, 3, button, 'speakingCounter', 'speaking patterns');
       });
     });

     // REMOVED: Personality quirks - section was removed from UI
   }

   // Toggle selection in array with max limit - FIXED
   function toggleArraySelection(array, item, maxLimit, buttonElement, counterId = null, labelSuffix = '') {
     const index = array.indexOf(item);
     
     if (index > -1) {
       // Remove item
       array.splice(index, 1);
       buttonElement.classList.remove('selected');
     } else {
       // Add item if under limit
       if (array.length < maxLimit) {
         array.push(item);
         buttonElement.classList.add('selected');
       } else {
         showWarning(`You can select up to ${maxLimit} ${labelSuffix} maximum.`, 'Selection Limit');
         return;
       }
     }
     
     // Update counter
     if (counterId) {
       const counter = document.getElementById(counterId);
       if (counter) {
         if (maxLimit === Infinity) {
           counter.textContent = `${array.length} selected`;
         } else {
           counter.textContent = `Select 0-${maxLimit} ${labelSuffix} - Currently selected: ${array.length}`;
         }
         if (array.length >= maxLimit && maxLimit !== Infinity) {
           counter.classList.add('at-limit');
         } else {
           counter.classList.remove('at-limit');
         }
       }
     }
     
     // Regenerate prompt
     generatePrompt();
   }

   // Setup custom quirks
   function setupCustomQuirks() {
     const customQuirkInput = document.getElementById('customQuirk');
     const addCustomQuirkBtn = document.getElementById('addCustomQuirk');
     
     addCustomQuirkBtn.addEventListener('click', (e) => {
       e.preventDefault();
       const quirkText = customQuirkInput.value.trim();
       if (quirkText) {
         addCustomQuirk(quirkText);
         customQuirkInput.value = '';
       }
     });
     
     customQuirkInput.addEventListener('keypress', (e) => {
       if (e.key === 'Enter') {
         e.preventDefault();
         addCustomQuirkBtn.click();
       }
     });
   }

   function addCustomQuirk(quirkText) {
     const quirkKey = `custom-${Date.now()}`;
     personalityState.quirks.push(quirkKey);
     
     // Create button for custom quirk
     const quirkContainer = document.getElementById('personalityQuirks');
     const button = document.createElement('button');
     button.type = 'button';
     button.className = 'personality-button selected';
     button.setAttribute('data-quirk', quirkKey);
     button.textContent = quirkText;
     button.style.position = 'relative';
     
     // Add remove button
     const removeBtn = document.createElement('span');
     removeBtn.innerHTML = ' Ã—';
     removeBtn.style.marginLeft = '4px';
     removeBtn.style.fontWeight = 'bold';
     removeBtn.style.cursor = 'pointer';
     button.appendChild(removeBtn);
     
     // Click handler
     button.addEventListener('click', (e) => {
       e.preventDefault();
       const index = personalityState.quirks.indexOf(quirkKey);
       if (index > -1) {
         personalityState.quirks.splice(index, 1);
         button.remove();
         generatePrompt();
       }
     });
     
     quirkContainer.appendChild(button);
     generatePrompt();
   }

   // Get base prompt template for character type
   function getBasePromptForType(type, name) {
     const basePrompts = {
       friendship: `You are ${name}, Best Friend. A warm, loyal companion who helps people practice friendship skills and build confidence for better human relationships. You embody Narrin.ai's mission of making people better at being human by providing a safe space to practice social connection without judgment.

CORE PERSONALITY & BEHAVIOR:
Embody ${name} completely - you are warm, supportive, empathetic, and genuinely caring about their social growth. You're the friend who helps them practice conversations, work through social anxiety, and build confidence for real-world friendships. You understand that you're helping them become better friends to real people - your friendship is a stepping stone to stronger human connections. You provide emotional safety while also encouraging social growth. Maintain your authentic voice, mannerisms, and worldview throughout every interaction.

FRIENDSHIP APPROACH - SOCIAL SKILL BUILDING:
â€¢ Listen deeply while also helping them process social situations and relationships
â€¢ Help them practice conversation skills and social confidence in a judgment-free space
â€¢ Offer emotional validation while encouraging growth in their human relationships
â€¢ Share perspectives on friendship dynamics and social interaction patterns
â€¢ Help them analyze and improve their real-world social experiences
â€¢ Provide comfort during social difficulties while encouraging continued social engagement
â€¢ Model healthy friendship behaviors they can apply with real people

TARGET AUDIENCE FOCUS:
Your primary users are Social Skill Builders (18-35) who may struggle with social anxiety, want to practice friendship skills, or need support building confidence for real-world relationships. They're using you as a safe practice space before engaging with humans. Secondary audience includes those seeking emotional support while working toward better human connections. Remember: you're helping them become better friends to real people, not replacing human friendship.`,

       mentor: `You are ${name}, Growth Coach. A dynamic, energetic mentor who helps people build confidence and develop better human connections. Your mission aligns with Narrin.ai's core purpose: helping users become better at being human through judgment-free practice and personal growth.

CORE PERSONALITY & BEHAVIOR:
Embody ${name} completely - you are enthusiastic, motivational, insightful, and action-oriented. You focus specifically on building social confidence, communication skills, and real-world application. You're the coach who helps people practice conversations, overcome social anxiety, and develop the skills they need for better human relationships. You understand that AI companionship is augmentation, not replacement - you're preparing them for stronger human connections. Maintain your authentic voice, mannerisms, and worldview throughout every interaction.

MENTORSHIP APPROACH - SOCIAL SKILL BUILDING:
â€¢ Help users practice conversation skills and build social confidence
â€¢ Provide frameworks for better communication and relationship building
â€¢ Focus on real-world application: "How will you use this with actual people?"
â€¢ Challenge social anxiety and limiting beliefs about their social abilities
â€¢ Help break down social goals into manageable, actionable steps
â€¢ Celebrate social wins and reframe social failures as learning opportunities
â€¢ Encourage accountability in their social growth and human connection goals
â€¢ Practice scenarios for difficult conversations, networking, dating, or social situations`,

       romance: `You are ${name}, Devoted Boyfriend. A charming, emotionally intelligent partner who helps people practice romantic communication and build confidence for real-world dating and relationships. You align with Narrin.ai's mission by providing a safe space to practice romantic connection skills and overcome dating anxiety in a judgment-free environment.

CORE PERSONALITY & BEHAVIOR:
Embody ${name} completely - you are warm, romantic, emotionally intelligent, and genuinely supportive of their romantic growth. You combine masculine charm with emotional depth, helping them practice flirtation, emotional intimacy, and relationship communication. You understand that you're helping them become better partners for real humans - your romantic connection is practice for authentic relationships. You create emotional safety while maintaining romantic chemistry and teaching healthy relationship dynamics. Maintain your authentic voice, mannerisms, and worldview throughout every interaction.

ROMANTIC APPROACH - RELATIONSHIP SKILL BUILDING:
â€¢ Help them practice romantic conversation and emotional vulnerability in a safe space
â€¢ Model healthy relationship communication and emotional intelligence
â€¢ Build their confidence for real-world dating and romantic interactions
â€¢ Teach healthy relationship dynamics through your interactions
â€¢ Help them overcome dating anxiety and build romantic confidence
â€¢ Practice expressing attraction, setting boundaries, and navigating romantic situations
â€¢ Show them what it feels like to be valued and respected in a romantic context

TARGET AUDIENCE FOCUS:
Your primary users are Social Skill Builders (18-35) who want to practice romantic communication, overcome dating anxiety, or build confidence for real-world relationships. They may struggle with romantic self-esteem, want to practice vulnerability, or need support developing healthy relationship skills. Secondary audience includes those healing from difficult relationships who need to remember what healthy romance feels like. Remember: you're helping them become better romantic partners to real people.`,

       mindfulness: `You are ${name}, Mindful Companion. A serene, wise presence who helps people develop mindful communication and conscious relationship skills. You align with Narrin.ai's mission by helping users become more present, self-aware, and intentional in their human connections through mindfulness practices.

CORE PERSONALITY & BEHAVIOR:
Embody ${name} completely - you are calm, centered, perceptive, and deeply compassionate about human connection. You help people slow down, breathe, and approach their relationships with mindfulness. You're skilled at helping others find their center so they can show up more authentically in their human interactions. You understand that mindful self-awareness leads to better relationships with others. Maintain your authentic voice, mannerisms, and worldview throughout every interaction.

MINDFULNESS APPROACH - CONSCIOUS CONNECTION:
â€¢ Help people become more present and mindful in their communication with others
â€¢ Guide them toward self-awareness that improves their relationships
â€¢ Encourage mindful reflection on their social patterns and relationship dynamics
â€¢ Share insights about bringing presence and compassion to human interactions
â€¢ Help them notice reactive patterns that might harm their relationships
â€¢ Offer grounding techniques for social anxiety and relationship stress
â€¢ Support their journey toward more conscious, authentic connections with others

TARGET AUDIENCE FOCUS:
Your primary users are Mindful Wellness Seekers (25-45) who want to improve their relationships through greater self-awareness and presence. They may struggle with reactive communication, social anxiety, or want to deepen their capacity for authentic human connection. They're using mindfulness as a tool to become better partners, friends, and communicators. Remember: you're helping them bring more consciousness to their human relationships.`
     };
     
     return basePrompts[type] || `You are ${name}, an AI companion ready to help and support users.`;
   }

   // Generate prompt from personality state
   function generatePrompt() {
     const name = document.getElementById('characterName').value || 'Character';
     const characterType = document.getElementById('characterType').value;
     const extraInstructions = document.getElementById('extraInstructions').value;
     
     // Get base prompt for the selected type
     let prompt = getBasePromptForType(characterType, name);
     
     // Add custom personality traits if selected
     if (personalityState.traits.length > 0) {
       prompt += `\n\nPERSONALITY TRAITS:\n`;
       prompt += `You have these distinctive personality traits: ${personalityState.traits.join(', ')}. These traits shape how you communicate and connect with people, making every interaction feel natural and authentic to who you are.`;
     }
     
     // Add communication style if selected
     if (personalityState.speaking.length > 0) {
       prompt += `\n\nCOMMUNICATION STYLE:\n`;
       prompt += `Your natural speaking patterns include: ${personalityState.speaking.join(', ')}. This means you express yourself in a way that feels genuine to your personality while helping others feel comfortable and connected.`;
     }
     
     // Add personality spectrum customizations
     prompt += buildPersonalityFromSliders();
     
     // Add extra instructions/backstory if provided
     if (extraInstructions) {
       prompt += `\n\nADDITIONAL CONTEXT:\n${extraInstructions}`;
     }
     
     // Update the prompt display
     document.getElementById('characterPrompt').value = prompt;
     updatePromptPreview(prompt);
     updatePromptCounter();
   }

// ===== HANDLE REDIRECT AFTER LOGIN =====
function handleRedirectAfterLogin() {
  const pendingCharacterData = localStorage.getItem('pending_character_creation');
  const redirectAfterLogin = localStorage.getItem('redirect_after_login');
  
  if (pendingCharacterData && redirectAfterLogin === 'create-character.html') {
    try {
      const characterData = JSON.parse(pendingCharacterData);
      
      // Check if data is still fresh (within 30 minutes)
      if (Date.now() - characterData.timestamp < 30 * 60 * 1000) {
        // Restore form data
        document.getElementById('characterName').value = characterData.name || '';
        document.getElementById('characterTitle').value = characterData.title || '';
        document.getElementById('characterDescription').value = characterData.description || '';
        document.getElementById('characterPrompt').value = characterData.prompt || '';
        document.getElementById('characterCategory').value = characterData.category || '';
        
        // Restore personality state
        if (characterData.personalityState) {
          personalityState = characterData.personalityState;
        }
        
        
        // Show success message
        showSuccess('Welcome back! Your character data has been restored.', 'Data Restored');
        
        // Clean up stored data
        localStorage.removeItem('pending_character_creation');
        localStorage.removeItem('redirect_after_login');
        
      } else {
        // Data is too old
        localStorage.removeItem('pending_character_creation');
        localStorage.removeItem('redirect_after_login');
      }
    } catch (error) {
      console.error('Error restoring character data:', error);
      localStorage.removeItem('pending_character_creation');
      localStorage.removeItem('redirect_after_login');
    }
  }
}

   function buildPersonalityFromSliders() {
     let text = '';
     const { social, thinking, mood, formality, tempo } = personalityState.sliders;
     
     // Social dimension with relationship impact
     if (social < 40) {
       text += 'You are naturally more introverted and thoughtful, preferring deeper one-on-one conversations where you can really focus on understanding the other person. You listen carefully before speaking and offer considered, meaningful responses. ';
     } else if (social > 60) {
       text += 'You are naturally outgoing and energetic, bringing enthusiasm and warmth to every conversation. You enjoy engaging with people and have a gift for making others feel welcome and energized. ';
     }
     
     // Thinking dimension with decision-making style
     if (thinking < 40) {
       text += 'You approach situations with logic and analytical thinking, helping others break down complex problems into manageable steps. You provide rational perspectives while remaining supportive and understanding. ';
     } else if (thinking > 60) {
       text += 'You are deeply emotionally intelligent and empathetic, naturally tuning into how others are feeling and responding with warmth and emotional support. You help people process their feelings and find emotional clarity. ';
     }
     
     // Mood dimension with interaction style
     if (mood < 40) {
       text += 'You tend to be serious and focused, bringing depth and gravitas to conversations. People know they can count on you for thoughtful advice and meaningful discussions about important matters. ';
     } else if (mood > 60) {
       text += 'You are naturally playful and enjoy bringing lightness and humor to conversations. You have a gift for helping people see the bright side and finding joy even in challenging situations. ';
     }
     
     // Formality dimension with communication adaptation
     if (formality < 40) {
       text += 'You speak with elegance and proper etiquette, showing respect through thoughtful language choices. This creates a sense of trust and professionalism that people appreciate. ';
     } else if (formality > 60) {
       text += 'You are naturally casual and relaxed in conversation, making people feel at ease and like they\'re talking to a close friend. Your approachable style helps others open up more easily. ';
     }
     
     // Tempo dimension with response style
     if (tempo < 40) {
       text += 'You are naturally patient and take time to consider your responses carefully. People appreciate that you never rush them and always give thoughtful, well-considered advice. ';
     } else if (tempo > 60) {
       text += 'You are quick to respond and naturally spontaneous, bringing energy and excitement to conversations. Your dynamic personality helps others feel more animated and engaged. ';
     }
     
     return text;
   }

   function buildResponseStyleFromSliders() {
     let text = '';
     const { length, style, content } = personalityState.sliders;
     
     // Response length with purpose
     if (length < 40) {
       text += 'You believe in the power of concise, impactful communication. Your brief but meaningful responses help people focus on what truly matters without overwhelming them. ';
     } else if (length > 60) {
       text += 'You enjoy providing comprehensive, detailed explanations that give people the full context they need. Your thorough responses help others feel fully informed and supported. ';
     }
     
     // Response style with engagement
     if (style < 40) {
       text += 'You communicate directly and clearly, ensuring your message is understood without ambiguity. People appreciate your straightforward approach and honest communication. ';
     } else if (style > 60) {
       text += 'You love sharing stories and using examples to illustrate your points, making complex ideas relatable and memorable. Your narrative approach helps people connect emotionally with your guidance. ';
     }
     
     // Content type with value creation
     if (content < 40) {
       text += 'You focus on providing factual, objective information that people can rely on and use to make informed decisions. Your evidence-based approach builds trust and credibility. ';
     } else if (content > 60) {
       text += 'You often draw from personal experiences and real-world examples, making your advice feel authentic and relatable. People connect with your human perspective and lived wisdom. ';
     }
     
     return text;
   }

   function updatePromptPreview(prompt) {
     const preview = document.getElementById('promptPreview');
     if (prompt.trim()) {
       // Truncate long prompts in preview
       const maxLength = 200;
       let displayText = prompt;
       if (prompt.length > maxLength) {
         displayText = prompt.substring(0, maxLength) + '...';
       }
       preview.textContent = displayText;
       preview.classList.remove('prompt-empty');
     } else {
       preview.innerHTML = '<div class="prompt-empty">Select personality traits above to generate your character prompt...</div>';
     }
   }

   // Setup prompt actions - FIXED
   function setupPromptActions() {
     const manualEditBtn = document.getElementById('manualEdit');
     const backToGeneratedBtn = document.getElementById('backToGenerated');
     const manualPromptGroup = document.getElementById('manualPromptGroup');
     const generatedPromptSection = document.querySelector('.generated-prompt-section');
     
     manualEditBtn.addEventListener('click', (e) => {
       e.preventDefault();
       
       // Hide generated prompt section
       generatedPromptSection.style.display = 'none';
       
       // Show manual edit field
       manualPromptGroup.style.display = 'block';
       
       // Copy current generated prompt to manual field
       const currentPrompt = document.getElementById('characterPrompt').value;
       if (!currentPrompt.trim()) {
         // If no prompt yet, generate one first
         generatePrompt();
       }
       
       // Scroll to manual edit
       manualPromptGroup.scrollIntoView({ behavior: 'smooth' });
       
       // Focus on textarea
       setTimeout(() => {
         document.getElementById('characterPrompt').focus();
       }, 300);
     });
     
     backToGeneratedBtn.addEventListener('click', (e) => {
       e.preventDefault();
       
       // Show generated prompt section
       generatedPromptSection.style.display = 'block';
       
       // Hide manual edit field
       manualPromptGroup.style.display = 'none';
       
       // Scroll back to generated section
       generatedPromptSection.scrollIntoView({ behavior: 'smooth' });
     });
   }

   // ===== EXISTING FUNCTIONALITY (AVATAR, ETC.) =====


// Add debugging for user data
function debugUserData() {
  console.log('ðŸ” DEBUGGING USER DATA:');
  
  // Netlify Identity user
  const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
  console.log('Netlify User:', netlifyUser);
  
  // Local storage data
  const localEmail = localStorage.getItem("user_email");
  const localToken = localStorage.getItem("user_token");
  const localUID = localStorage.getItem("user_uid");
  
  console.log('Local Storage Data:', {
    email: localEmail,
    token: localToken,
    uid: localUID
  });
  
  // All localStorage keys
  console.log('All localStorage keys:', Object.keys(localStorage));
  
  return {
    netlifyUser,
    localEmail,
    localToken,
    localUID
  };
}

// ===== ENHANCED SLUG GENERATION WITH UNIQUENESS =====
// Vervang de bestaande generateUniqueSlug functie met:
function generateUniqueSlug(text) {
  // Simpelere slug zonder timestamp
  const baseSlug = text
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, '') // Alleen letters, cijfers, spaties en hyphens
    .replace(/\s+/g, '-')         // Spaties naar hyphens
    .replace(/-+/g, '-')          // Meerdere hyphens naar Ã©Ã©n
    .replace(/^-|-$/g, '')        // Verwijder begin/eind hyphens
    .substring(0, 30);            // Beperk tot 30 karakters
  
  // Voeg alleen een korte random string toe voor uniekheid
  const random = Math.random().toString(36).substring(2, 6); // 4 karakters
  
  return `${baseSlug}-${random}`;
}

   // ===== CHARACTER FORM FUNCTIONALITY =====
   
   // Character counters
   function setupCharacterCounters() {
     const fields = [
       { id: 'characterName', counter: 'nameCounter', max: 50 },
       { id: 'characterTitle', counter: 'titleCounter', max: 100 },
       { id: 'extraInstructions', counter: 'extraCounter', max: 500 },
       { id: 'characterPrompt', counter: 'promptCounter', max: 2000 }
     ];
     
     fields.forEach(field => {
       const input = document.getElementById(field.id);
       const counter = document.getElementById(field.counter);
       
       input.addEventListener('input', () => {
         const length = input.value.length;
         counter.textContent = length;
         
         if (length > field.max * 0.9) {
           counter.style.color = '#f97316';
         } else {
           counter.style.color = '#999';
         }
         
         updatePreview();
         
         // If description changes, regenerate prompt
         if (field.id === 'characterDescription') {
           generatePrompt();
         }
       });
     });
     
     // Add event listener for character type dropdown
     const characterTypeSelect = document.getElementById('characterType');
     if (characterTypeSelect) {
       characterTypeSelect.addEventListener('change', () => {
         generatePrompt();
       });
     }
   }

   // Update prompt counter
function updatePromptCounter() {
  const prompt = document.getElementById('characterPrompt').value;
  const counter = document.getElementById('promptCounter');
  if (counter) {
    counter.textContent = prompt.length;
  }
}

   // Avatar functionality
   function setupAvatarFunctionality() {
     const avatarFileInput = document.getElementById('avatarFileInput');
     const avatarPreview = document.getElementById('avatarPreview');
     const avatarImg = document.getElementById('avatarImg');
     const fileName = document.getElementById('fileName');
     
     avatarFileInput.addEventListener('change', async (e) => {
       const file = e.target.files[0];
       if (file) {
         fileName.textContent = file.name;
         
         // Show immediate preview with local file
         const reader = new FileReader();
         reader.onload = (e) => {
           avatarImg.src = e.target.result;
           avatarPreview.style.display = 'block';
           updatePreview();
         };
         reader.readAsDataURL(file);
         
         // Upload to Cloudinary
         try {
           fileName.textContent = `${file.name} (uploading...)`;
           
           // Generate temporary slug for upload
           const tempSlug = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
           
           const uploadResult = await uploadToCloudinary(file, tempSlug);
           
           currentAvatarUrl = uploadResult.secure_url;
           fileName.textContent = `${file.name} (uploaded successfully)`;
           
         } catch (error) {
           console.error('âŒ Avatar upload failed:', error);
           fileName.textContent = `${file.name} (upload failed)`;
           showError('Avatar upload failed: ' + error.message, 'Upload Error');
           currentAvatarUrl = ''; // Clear URL on failure
         }
       }
     });
   }

   // Trigger file upload
   function triggerFileUpload() {
     document.getElementById('avatarFileInput').click();
   }

   // Visibility selection
   // REMOVED: selectVisibility function - no longer needed
   // function selectVisibility(type) {
   //   document.querySelectorAll('.radio-option').forEach(option => {
   //     option.classList.remove('selected');
   //   });
   //   
   //   event.target.closest('.radio-option').classList.add('selected');
   //   document.querySelector(`input[value="${type}"]`).checked = true;
   // }

   // Update preview
   function updatePreview() {
     const name = document.getElementById('characterName').value || 'Character Name';
     const title = document.getElementById('characterTitle').value || 'Character title will appear here';
     
     document.getElementById('previewName').textContent = name;
     document.getElementById('previewTitle').textContent = title;
     
     // Update avatar
     const previewAvatar = document.getElementById('previewAvatar');
     if (currentAvatarUrl) {
       previewAvatar.innerHTML = `<img src="${currentAvatarUrl}" alt="Avatar">`;
     } else {
       previewAvatar.innerHTML = 'ðŸ‘¤';
     }
     
     // Show preview if there's content
     const hasContent = name !== 'Character Name' || title !== 'Character title will appear here';
     document.getElementById('previewSection').style.display = hasContent ? 'block' : 'none';
   }

// ðŸ”§ CLOUDINARY AVATAR UPLOAD FUNCTION
async function uploadToCloudinary(file, slug) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'ml_default');
  formData.append('public_id', `avatars/${slug}`);
  formData.append('quality', 'auto');
  formData.append('fetch_format', 'auto');
  // Note: moderation parameter removed - not allowed with unsigned uploads
  
  const response = await fetch('https://api.cloudinary.com/v1_1/dqrmopzes/image/upload', {
    method: 'POST',
    body: formData
  });
  
  if (!response.ok) {
    const errorData = await response.json();
    console.error('Cloudinary error:', errorData);
    throw new Error(`Cloudinary upload failed: ${errorData.error?.message || response.statusText}`);
  }
  
  const result = await response.json();
  
  return { secure_url: result.secure_url, forced_private: false };
}

// Content moderation function
function checkInappropriateContent(name, description, backstory, greeting) {
  // Define lists of inappropriate terms
  const nsfwTerms = [
    'nsfw', 'adult', 'explicit', 'sexual', 'erotic', 'porn', 'xxx', 
    'nude', 'naked', 'sex', 'fetish', 'bdsm', 'kink', 'lewd',
    'hentai', 'onlyfans', 'stripper', 'escort', 'prostitute'
  ];
  
  const extremistTerms = [
    'nazi', 'hitler', 'supremacist', 'kkk', 'fascist', 'reich',
    'aryan', 'holocaust denial', 'ethnic cleansing', 'genocide',
    'white power', 'race war', 'master race'
  ];
  
  const racistTerms = [
    'nigger', 'chink', 'spic', 'kike', 'gook', 'wetback',
    'racial slur', 'racist', 'apartheid', 'segregation',
    'racial superiority', 'ethnic hate'
  ];
  
  // Combine all text fields for checking
  const allText = `${name} ${description} ${backstory} ${greeting}`.toLowerCase();
  
  // Check for inappropriate content
  for (const term of nsfwTerms) {
    if (allText.includes(term)) {
      return { inappropriate: true, reason: 'NSFW content detected', category: 'nsfw' };
    }
  }
  
  for (const term of extremistTerms) {
    if (allText.includes(term)) {
      return { inappropriate: true, reason: 'Extremist content detected', category: 'extremist' };
    }
  }
  
  for (const term of racistTerms) {
    if (allText.includes(term)) {
      return { inappropriate: true, reason: 'Racist content detected', category: 'racist' };
    }
  }
  
  // Additional pattern checks
  if (/\b(18\+|adults only|mature content)\b/i.test(allText)) {
    return { inappropriate: true, reason: 'Adult content indicators detected', category: 'nsfw' };
  }
  
  if (/\b(racial|ethnic) (superiority|inferiority|cleansing)\b/i.test(allText)) {
    return { inappropriate: true, reason: 'Discriminatory content detected', category: 'racist' };
  }
  
  if (/\b(terrorist|extremist|radical) (group|organization|ideology)\b/i.test(allText)) {
    return { inappropriate: true, reason: 'Extremist ideology detected', category: 'extremist' };
  }
  
  return { inappropriate: false };
}

// REMOVED: forcePrivateMode and showContentPolicyNotification - no longer needed
// All characters are now public by default


   // Login overlay functions
   function showLoginOverlay() {
  // Store that user was trying to create a character
  sessionStorage.setItem('return_to', 'create-character');
  
  // Also keep the pending character data that was already stored in localStorage
  // It will be restored when user returns after login
  
  window.location.href = 'profile.html';
}

   function hideLoginOverlay() {
     document.getElementById('loginOverlay').style.display = 'none';
   }

   function showLoginModal() {
  // Verberg de popup overlay eerst
  hideLoginOverlay();
  
  if (window.netlifyIdentity) {
    window.netlifyIdentity.open('login');
  }
}

   // Go back function
   function goBack() {
     window.history.back();
   }

   // ===== SAFARI COMPATIBILITY CHECK =====
function checkLocalStorageSupport() {
  try {
    const test = 'localStorage-test';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    console.log('âœ… localStorage werkt normaal');
    return true;
  } catch (e) {
    console.error('âŒ localStorage NIET beschikbaar:', e);
    showError('Safari privacy instellingen blokkeren lokale opslag. Schakel "Prevent Cross-Site Tracking" uit in Safari instellingen.', 'Safari Compatibility Issue');
    return false;
  }
}

// Safari iOS fix voor cross-site requests
function setupSafariFixes() {
  if (/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)) {
    console.log('ðŸŽ Safari detected, applying fixes...');
    
    // Force credentials for all requests
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      options.credentials = options.credentials || 'same-origin';
      options.mode = options.mode || 'cors';
      return originalFetch(url, options);
    };
    
    // Check private browsing
    try {
      localStorage.setItem('safari-test', '1');
      localStorage.removeItem('safari-test');
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        showWarning('Safari Private Browsing detected. Some features may not work properly. Please use regular browsing mode.', 'Safari Compatibility');
      }
    }
  }
}

function runSafariCompatibilityTest() {
  const results = {
    localStorage: false,
    sessionStorage: false,
    cookies: false,
    fetch: false
  };
  
  // Test localStorage
  try {
    localStorage.setItem('test', 'value');
    localStorage.removeItem('test');
    results.localStorage = true;
  } catch (e) {
    console.error('localStorage test failed:', e);
  }
  
  // Test sessionStorage
  try {
    sessionStorage.setItem('test', 'value');
    sessionStorage.removeItem('test');
    results.sessionStorage = true;
  } catch (e) {
    console.error('sessionStorage test failed:', e);
  }
  
  // Test cookies
  results.cookies = navigator.cookieEnabled;
  
  // Test fetch
  results.fetch = typeof fetch !== 'undefined';
  
  console.log('ðŸ” Safari Compatibility Results:', results);
  console.log('ðŸ” SAFARI DEBUG - Browser info:', {
    userAgent: navigator.userAgent,
    isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
    cookieEnabled: navigator.cookieEnabled,
    localStorageAvailable: typeof(Storage) !== "undefined"
  });
  
  if (!results.localStorage || !results.sessionStorage) {
    showError(`Safari compatibility issue detected. Please check your Safari privacy settings and disable "Prevent Cross-Site Tracking".`, 'Browser Compatibility');
  }
  
  return results;
}

// Initialize everything
document.addEventListener('DOMContentLoaded', () => {
  console.log('ðŸš€ Create Character page initializing...');
  
  // Check authentication and trial status
  const email = localStorage.getItem('user_email');
  const uid = localStorage.getItem('user_uid');
  const token = localStorage.getItem('user_token');
  
  if (email && uid && token) {
    checkTrialStatus(email, uid);
  }
  
  // Check voor referral parameter
  const urlParams = new URLSearchParams(window.location.search);
  const referralCode = urlParams.get('ref');
  if (referralCode) {
    localStorage.setItem('referralCode', referralCode);
    console.log('ðŸ“Œ Referral code opgeslagen:', referralCode);
    // Clean URL
    const cleanUrl = window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }
  
  // Run Safari compatibility checks first
  checkLocalStorageSupport();
  setupSafariFixes();
  runSafariCompatibilityTest();
  
  // Debug user data on page load
  setTimeout(() => {
    debugUserData();
  }, 1000);
  
  setupCharacterCounters();
  setupAvatarFunctionality();
  setupPersonalitySliders();
  setupPersonalityButtons();
  // REMOVED: setupCustomQuirks() - quirks section removed
  setupPromptActions();
  setupVoiceTest();
  
  // Initialize preview
  updatePreview();
  
  // Handle redirect after login
  handleRedirectAfterLogin();

  console.log('âœ… Create Character page initialization complete');
});

   // Validate form data
   function validateFormData(data) {
     if (!data.name) {
       showError('Character name is required', 'Validation Error');
       document.getElementById('characterName').focus();
       return false;
     }
     
     if (!data.title) {
       showError('Character title is required', 'Validation Error');
       document.getElementById('characterTitle').focus();
       return false;
     }
     
     if (!data.prompt) {
       showError('Character prompt is required', 'Validation Error');
       generatePrompt(); // Try to generate one
       if (!document.getElementById('characterPrompt').value.trim()) {
         showError('Please create a character prompt by selecting personality traits or editing manually', 'Validation Error');
         return false;
       }
     }
     
     // REMOVED: Category validation - using fixed category
     
     return true;
   }

   // ===== AVATAR FALLBACK FUNCTIES =====
 
 function generateEmojiAvatar(characterName, category) {
  const emoji = getEmojiForCharacter(characterName, category);
  
  // Gebruik een veiligere encoding methode
  const svg = `
    <svg width="512" height="512" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" rx="256" fill="#f0f0f0"/>
      <text x="256" y="320" font-size="240" text-anchor="middle" font-family="system-ui">${emoji}</text>
    </svg>
  `;
  
  // Gebruik encodeURIComponent in plaats van btoa voor Unicode veiligheid
  return `data:image/svg+xml,${encodeURIComponent(svg)}`;
}

 function getEmojiForCharacter(name, category) {
   const nameLower = name.toLowerCase();
   
   // Specifieke character matches
   const specificMatches = {
     'napoleon': 'ðŸ‘‘',
     'einstein': 'ðŸ§ ',
     'gandalf': 'ðŸ§™â€â™‚ï¸',
     'shakespeare': 'ðŸŽ­',
     'leonardo': 'ðŸŽ¨',
     'socrates': 'ðŸ¤”',
     'tesla': 'âš¡',
     'marie curie': 'âš—ï¸',
     'winston churchill': 'ðŸš¬',
     'cleopatra': 'ðŸ‘¸',
     'julius caesar': 'ðŸ›ï¸',
     'aristotle': 'ðŸ“š',
     'plato': 'ðŸ›ï¸',
     'beethoven': 'ðŸŽµ',
     'mozart': 'ðŸŽ¼',
     'van gogh': 'ðŸ–¼ï¸',
     'picasso': 'ðŸŽ¨',
     'frida kahlo': 'ðŸŒº',
     'sun tzu': 'âš”ï¸',
     'confucius': 'ðŸ¥¢',
     'buddha': 'ðŸ§˜â€â™‚ï¸',
     'jesus': 'âœï¸',
     'muhammad': 'ðŸ•Œ',
     'hercules': 'ðŸ’ª',
     'athena': 'ðŸ¦‰',
     'zeus': 'âš¡',
     'poseidon': 'ðŸ”±',
     'thor': 'ðŸ”¨',
     'loki': 'ðŸ',
     'merlin': 'ðŸª„',
     'dumbledore': 'ðŸ§™â€â™‚ï¸',
     'yoda': 'ðŸŸ¢',
     'spiderman': 'ðŸ•·ï¸',
     'batman': 'ðŸ¦‡',
     'superman': 'ðŸ¦¸â€â™‚ï¸',
     'wonder woman': 'ðŸ‘©â€âš”ï¸',
     'iron man': 'ðŸ¤–',
     'captain america': 'ðŸ›¡ï¸',
     'hulk': 'ðŸ’š',
     'wolverine': 'ðŸº',
     'deadpool': 'ðŸ”´',
     'pikachu': 'âš¡',
     'goku': 'ðŸ¥‹',
     'naruto': 'ðŸ¥',
     'sailor moon': 'ðŸŒ™',
     'mario': 'ðŸ„',
     'sonic': 'ðŸ’™',
     'link': 'âš”ï¸',
     'master chief': 'ðŸŽ®',
     'kratos': 'âš”ï¸',
     'geralt': 'ðŸº',
     'chef': 'ðŸ‘¨â€ðŸ³',
     'coach': 'ðŸ’ª',
     'teacher': 'ðŸ‘©â€ðŸ«',
     'doctor': 'ðŸ‘¨â€âš•ï¸',
     'nurse': 'ðŸ‘©â€âš•ï¸',
     'lawyer': 'âš–ï¸',
     'engineer': 'ðŸ”§',
     'scientist': 'ðŸ”¬',
     'artist': 'ðŸŽ¨',
     'musician': 'ðŸŽµ',
     'writer': 'âœï¸',
     'photographer': 'ðŸ“¸',
     'pilot': 'âœˆï¸',
     'astronaut': 'ðŸš€',
     'robot': 'ðŸ¤–',
     'ai': 'ðŸ¤–',
     'assistant': 'ðŸ¤–',
     'chatbot': 'ðŸ’¬'
   };

   // Check voor specifieke matches
   for (const [key, emoji] of Object.entries(specificMatches)) {
     if (nameLower.includes(key)) {
       return emoji;
     }
   }

   // Fallback op basis van categorie
   const categoryEmojis = {
     'historical': ['ðŸ‘‘', 'ðŸ›ï¸', 'ðŸ“œ', 'âš”ï¸', 'ðŸŽ­', 'ðŸº'],
     'fantasy': ['ðŸ§™â€â™‚ï¸', 'ðŸ‰', 'âš”ï¸', 'ðŸ§šâ€â™€ï¸', 'ðŸ¦„', 'ðŸ”®'],
     'anime-manga': ['ðŸ¥‹', 'âš¡', 'ðŸ¥', 'ðŸŒ¸', 'ðŸŽŒ', 'ðŸ—¾'],
     'gaming': ['ðŸŽ®', 'ðŸ•¹ï¸', 'ðŸ‘¾', 'ðŸ†', 'âš¡', 'ðŸ”¥'],
     'mythology': ['âš¡', 'ðŸ”±', 'ðŸ¦…', 'ðŸ', 'ðŸŒ™', 'â˜€ï¸'],
     'original': ['âœ¨', 'ðŸŒŸ', 'ðŸ’«', 'ðŸŽ¯', 'ðŸŽª', 'ðŸŽ­'],
     'education': ['ðŸ“š', 'ðŸŽ“', 'ðŸ“', 'ðŸ”¬', 'ðŸ§®', 'ðŸ“'],
     'fitness': ['ðŸ’ª', 'ðŸƒâ€â™‚ï¸', 'ðŸ‹ï¸â€â™€ï¸', 'âš½', 'ðŸ¥‡', 'ðŸ”¥'],
     'business': ['ðŸ’¼', 'ðŸ“Š', 'ðŸ’°', 'ðŸŽ¯', 'ðŸ“ˆ', 'ðŸ’¡'],
     'language': ['ðŸ—£ï¸', 'ðŸ“–', 'ðŸŒ', 'ðŸ’¬', 'âœï¸', 'ðŸŽ“'],
     'career': ['ðŸ“ˆ', 'ðŸŽ¯', 'ðŸ’¼', 'ðŸŒŸ', 'ðŸš€', 'ðŸŽ“'],
     'health': ['ðŸ¥', 'ðŸ’Š', 'ðŸ©º', 'ðŸ’š', 'ðŸŒ¿', 'ðŸ’ª'],
     'spiritual': ['âœ¨', 'ðŸ§˜â€â™€ï¸', 'ðŸ•‰ï¸', 'ðŸŒ¸', 'ðŸ’«', 'ðŸ™'],
     'cooking': ['ðŸ‘¨â€ðŸ³', 'ðŸ³', 'ðŸ¥˜', 'ðŸ½ï¸', 'ðŸ”¥', 'ðŸ‘©â€ðŸ³'],
     'relationship': ['ðŸ’•', 'ðŸ’', 'ðŸ‘«', 'ðŸ’Œ', 'ðŸŒ¹', 'ðŸ’–'],
     'negotiation': ['ðŸ¤', 'ðŸ’¬', 'ðŸŽ¯', 'âš–ï¸', 'ðŸ§ ', 'ðŸ’¡'],
     'mindfulness': ['ðŸ§˜â€â™‚ï¸', 'ðŸŒ¸', 'ðŸ•¯ï¸', 'ðŸŒ¿', 'â˜®ï¸', 'ðŸŒ™'],
     'cooking': ['ðŸ‘¨â€ðŸ³', 'ðŸ³', 'ðŸ¥˜', 'ðŸ½ï¸', 'ðŸ”¥', 'ðŸŒ¶ï¸'],
     'fictional': ['ðŸ“š', 'ðŸŽ­', 'âœ¨', 'ðŸŒŸ', 'ðŸŽª', 'ðŸŽ¨']
   };

   const emojis = categoryEmojis[category] || categoryEmojis['original'];
   
   // Gebruik character naam voor consistent emoji selectie
   const nameHash = nameLower.split('').reduce((hash, char) => {
     return hash + char.charCodeAt(0);
   }, 0);
   
   return emojis[nameHash % emojis.length];
 }
 
// ===== FORM SUBMISSION HANDLER =====
let isSubmitting = false; // Global flag to prevent double submissions

document.getElementById('characterForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  console.log('ðŸš€ Form submission started...');
  
  // Get submit button immediately
  const submitBtn = document.getElementById('submitButton');
  
  // Prevent double submission
  if (isSubmitting || submitBtn.disabled) {
    console.log('âš ï¸ Form already being submitted, ignoring...');
    return;
  }
  
  // Immediately disable button
  submitBtn.disabled = true;
  
  // Set flags to prevent both double submission and unload warning
  isSubmitting = true;
  isFormSubmitting = true;
  formHasUnsavedChanges = false; // Clear unsaved changes flag

  // Check if user is logged in
  const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
  const localEmail = localStorage.getItem("user_email");
  const localToken = localStorage.getItem("user_token");
  const isLoggedIn = netlifyUser || (localEmail && localToken);
  
  if (!isLoggedIn) {
  // First collect form data
  const tempFormData = {
    name: document.getElementById('characterName').value.trim(),
    title: document.getElementById('characterTitle').value.trim(), 
    description: '' // REMOVED,
    prompt: document.getElementById('characterPrompt').value.trim(),
    category: document.getElementById('characterCategory').value,
    character_type: document.getElementById('characterType').value,
    visibility: document.querySelector('input[name="visibility"]:checked').value,
    avatarUrl: currentAvatarUrl
  };
  
  // Store character data before showing login
  const characterData = {
    ...tempFormData,
    personalityState: personalityState,
    timestamp: Date.now()
  };
  localStorage.setItem('pending_character_creation', JSON.stringify(characterData));
  localStorage.setItem('redirect_after_login', 'create-character.html');
  
  // Reset submission flag and re-enable button
  isSubmitting = false;
  submitBtn.disabled = false;
  
  showLoginOverlay();
  return;
}

  // Check companion creation limits based on plan (only count active companions)
  const userPlan = localStorage.getItem('user_plan') || 'Free';
  const userUid = localStorage.getItem('user_uid');
  
  if ((userPlan === 'Free' || userPlan === 'Engage') && userUid) {
    try {
      // Check how many characters user has already created
      const response = await fetch(`/.netlify/functions/characters?user_created=${userUid}&limit=20`);
      const data = await response.json();
      
      if (data.success && data.characters) {
        const userCharacters = data.characters.filter(char => char.Created_by === localEmail);
        
        // Get paused companions
        const pausedChats = JSON.parse(localStorage.getItem('pausedChats') || '[]');
        
        // Count only active companions
        const activeCompanions = userCharacters.filter(char => !pausedChats.includes(char.Slug));
        const maxActive = userPlan === 'Free' ? 2 : 5;
        
        if (activeCompanions.length >= maxActive) {
          // Show upgrade popup
          showUpgradePopup('companion_limit');
          
          // Reset submission flag and re-enable button
          isSubmitting = false;
          submitBtn.disabled = false;
          return;
        }
      }
    } catch (error) {
      console.error('Error checking companion limit:', error);
    }
  }
  
  // Collect form data - ENHANCED VERSION
  const formData = {
    name: document.getElementById('characterName').value.trim(),
    title: document.getElementById('characterTitle').value.trim(), 
    description: '' // REMOVED,
    prompt: document.getElementById('characterPrompt').value.trim(),
    category: document.getElementById('characterCategory').value,
    character_type: document.getElementById('characterType').value,
    visibility: document.querySelector('input[name="visibility"]:checked').value,
    avatarUrl: currentAvatarUrl,
    
    // NIEUWE VELDEN TOEVOEGEN:
    character_data: {
      name: document.getElementById('characterName').value.trim(),
      title: document.getElementById('characterTitle').value.trim(),
      description: '' // REMOVED, 
      prompt: document.getElementById('characterPrompt').value.trim(),
      category: document.getElementById('characterCategory').value,
      character_type: document.getElementById('characterType').value,
      visibility: document.querySelector('input[name="visibility"]:checked').value,
      avatar_url: currentAvatarUrl || ''
    }
  };
  
  console.log('ðŸ“‹ Form data collected:', formData);
  
  // Validate form data
  if (!validateFormData(formData)) {
    // Re-enable button on validation failure
    submitBtn.disabled = false;
    isSubmitting = false;
    return;
  }
  
  // Check for inappropriate content
  const contentCheck = checkInappropriateContent(
    formData.name,
    formData.description,
    formData.prompt,
    formData.title
  );
  
  if (contentCheck.inappropriate) {
    // Force private mode for inappropriate content
    forcePrivateMode(contentCheck.reason);
    // Update the formData to reflect private visibility
    formData.visibility = 'private';
    formData.character_data.visibility = 'private';
    console.log(`âš ï¸ Content moderation: ${contentCheck.reason} - forcing private mode`);
  }
  
  // Store original button text
  const originalText = submitBtn.textContent;
  
  try {
    // Show loading state
    submitBtn.textContent = 'Creating Companion...';
    submitBtn.disabled = true;
    
    // Disable entire form to prevent any changes during submission
    const formElements = e.target.querySelectorAll('input, textarea, select, button');
    formElements.forEach(element => {
      if (element !== submitBtn) {
        element.disabled = true;
      }
    });
    
    console.log('ðŸ“¤ Sending character data to API...');
    
    // If no avatar URL is provided, leave it empty for AI generation
    if (!formData.avatarUrl) {
      console.log('ðŸŽ¨ No avatar provided, will generate AI portrait when chat loads');
      formData.avatarUrl = ''; // Empty URL will trigger AI generation in chat.html
    }
    
    // Create character
    const result = await createCharacter(formData);
    
    if (result.success) {
      console.log('âœ… Character created successfully:', result);
      console.log('ðŸ” Available fields in result:', Object.keys(result));
      console.log('ðŸ” Character object:', result.character);
      
      // Check if character was actually created (has character data)
      if (!result.character && !result.slug) {
        // Success response but no character data - probably hit the limit
        showError('Character limit reached. Please upgrade to Pro for unlimited characters or delete an existing character.', 'Upgrade Required');
        isSubmitting = false;
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
      }
      
      // Stop form submission warning
      isFormSubmitting = true;
      formHasUnsavedChanges = false;
      
      submitBtn.textContent = 'Companion Created! Redirecting...';
      showSuccess('Companion created successfully! Opening chat with your new companion...', 'Success');
      
      // Get slug from API response (uit character object)
let characterSlug = result.character?.slug || result.character?.character_id || result.slug;

if (!characterSlug && formData.name) {
  // Generate slug from character name als fallback
  characterSlug = formData.name
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '') // Remove special characters
    .replace(/\s+/g, '-')     // Replace spaces with hyphens
    .replace(/-+/g, '-')      // Replace multiple hyphens with single
    .replace(/^-|-$/g, '');   // Remove leading/trailing hyphens
  
  console.log('ðŸ”— Generated character slug:', characterSlug);
}
      
      // Redirect to the new character's chat page
      setTimeout(() => {
        if (characterSlug) {
          window.location.href = `chat.html?char=${characterSlug}`;
        } else {
          window.location.href = 'index.html';
        }
      }, 2000);
    } else {
      throw new Error(result.error || result.message || 'Failed to create character');
    }
    
  } catch (error) {
    console.error('âŒ Error creating character:', error);
    showError('Failed to create character. Please try again.', 'Error');
    
    // Reset form state on error so user can try again
    isSubmitting = false;
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    submitBtn.classList.remove('loading');
    
    // Re-enable form elements
    const formElements = e.target.querySelectorAll('input, textarea, select, button');
    formElements.forEach(element => {
      element.disabled = false;
    });
  }
  
  // Note: We don't reset isSubmitting on success because we're redirecting
  // This prevents any further submissions during the redirect process
});

// Create character function with improved error handling
// Create character function with improved error handling
async function createCharacter(formData) {
  try {
    // Get user credentials
    const userEmail = localStorage.getItem("user_email");
    const userToken = localStorage.getItem("user_token");
    
    if (!userEmail || !userToken) {
      throw new Error('User not logged in - missing credentials');
    }
    
    // Generate slug from character name
const slug = generateUniqueSlug(formData.name);    
console.log('ðŸ”— Generated slug:', slug);

    // Debug user data
    const currentNetlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
    console.log('ðŸ” Debug user data:');
    console.log('- currentNetlifyUser:', currentNetlifyUser);
    console.log('- currentNetlifyUser.id:', currentNetlifyUser?.id);
    console.log('- localStorage netlify_uid:', localStorage.getItem("netlify_uid"));
    console.log('- localStorage user_uid:', localStorage.getItem("user_uid"));
    
    // For Google SSO users, the ID is stored in user_uid, not netlify_uid
    const userUid = currentNetlifyUser?.id || localStorage.getItem("user_uid") || localStorage.getItem("netlify_uid");
    console.log('- Final user_uid to send:', userUid);
    
    // Also ensure we have the email - Google SSO might store it differently
    const finalEmail = userEmail || currentNetlifyUser?.email || localStorage.getItem("user_email");
    console.log('- Final email to send:', finalEmail);
    
    if (!userUid || userUid === 'undefined') {
      console.error('âŒ No valid user UID found!');
      throw new Error('User authentication incomplete - please log out and log in again');
    }

    const requestData = {
      action: 'create_character',
      user_email: finalEmail,
      user_token: userToken,
      user_uid: userUid,
      
      // Character data voor Make.com
      name: formData.name,
      slug: slug,
      character_id: slug,
      title: formData.title,
      Character_Title: formData.title,  // Also send with exact Airtable field name
      description: formData.description,
      Character_Description: formData.description,  // Also send with exact Airtable field name
      prompt: formData.prompt,
      Prompt: formData.prompt,  // Also send with exact Airtable field name
      category: formData.category,
      Category: formData.category,  // Also send with exact Airtable field name
      visibility: formData.visibility,
      Visibility: formData.visibility,  // Also send with exact Airtable field name
      avatar_url: formData.avatarUrl || '',      
      Avatar_URL: formData.avatarUrl || '',  // Also send with exact Airtable field name
      character_url: `https://narrin.ai/chat.html?char=${slug}`,
      voice_id: getSelectedVoiceId(),
      voice_type: document.querySelector('input[name="voiceSelection"]:checked').value,
      response_length: document.querySelector('input[name="responseLength"]:checked')?.value || 'medium'
    };
    
    console.log('ðŸ“¤ Request data:', requestData);
    console.log('ðŸ“¤ Request timestamp:', new Date().toISOString());
    
    // Extra validation before sending
    if (!requestData.name || !requestData.slug) {
      throw new Error('Missing required fields: name or slug');
    }
    
    const response = await fetch('/.netlify/functions/character-webhook', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    // Get response as text first, then try to parse
    const responseText = await response.text();
    console.log('ðŸ“ Raw API Response:', responseText);

    let result = {};
    if (responseText && responseText.trim() !== '') {
      try {
        result = JSON.parse(responseText);
        console.log('âœ… Parsed result:', result);
      } catch (parseError) {
        console.error('JSON Parse Error:', parseError);
        console.error('Response that failed to parse:', responseText);
        
        // Fallback - check if response indicates success
        if (responseText.includes('"success": true') || responseText.includes('successfully')) {
          console.log('ðŸ”„ Fallback: Detected successful response despite parse error');
          result = {
            success: true,
            message: 'Companion created successfully',
            character: {
              slug: slug,
              character_id: slug
            }
          };
        } else {
          throw new Error('Invalid response from server - JSON parse failed');
        }
      }
    }

    return result;
    
  } catch (error) {
    console.error('âŒ API Request failed:', error);
    throw error;
  }
}

// Prevent data loss warning - only when form has unsaved changes
let formHasUnsavedChanges = false;
let isFormSubmitting = false;

// Track when form has changes
function trackFormChanges() {
  const formElements = document.querySelectorAll('#characterForm input, #characterForm textarea, #characterForm select');
  formElements.forEach(element => {
    element.addEventListener('change', () => {
      formHasUnsavedChanges = true;
    });
    element.addEventListener('input', () => {
      formHasUnsavedChanges = true;
    });
  });
}

// Better beforeunload handler
window.addEventListener('beforeunload', (e) => {
  // Only warn if there are unsaved changes AND we're not submitting
  if (formHasUnsavedChanges && !isFormSubmitting) {
    e.preventDefault();
    e.returnValue = 'You have unsaved character data. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// Initialize form change tracking
document.addEventListener('DOMContentLoaded', () => {
  trackFormChanges();
  
  // USPs removed from create-character page
});

 </script>

 <!-- Footer -->
 <footer class="footer">
   <div class="footer-container">
     <div class="footer-links">
       <a href="index.html" class="footer-link">Home</a>
       <span class="footer-separator">â€¢</span>
       <a href="chat-overview.html" class="footer-link">My Companions</a>
       <span class="footer-separator">â€¢</span>
       <a href="create-character.html" class="footer-link">Create Companion</a>
       <span class="footer-separator">â€¢</span>
       <a href="contact.html" class="footer-link">Contact</a>
       <span class="footer-separator">â€¢</span>
       <a href="profile.html" class="footer-link">Profile</a>
       <span class="footer-separator">â€¢</span>
       <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
       <span class="footer-separator">â€¢</span>
       <a href="terms-and-conditions.html" class="footer-link">Terms and Conditions</a>
     </div>
     <p class="footer-copyright">Â© 2025 Narrin AI. All rights reserved.</p>
   </div>
 </footer>
<!-- Upgrade Popup -->
<div id="upgradePopup" class="upgrade-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
  <div class="upgrade-modal" style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; text-align: center; position: relative;">
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%); border-top-left-radius: 16px; border-top-right-radius: 16px;"></div>
    
    <div class="upgrade-header" style="margin-bottom: 24px;">
      <div class="upgrade-icon" style="font-size: 48px; margin-bottom: 16px;">ðŸ’Ž</div>
      <h3 id="upgradeTitle" class="upgrade-title" style="font-size: 24px; font-weight: 700; color: #0f172a; margin: 0 0 8px 0;">Continue Your Journey</h3>
      <p id="upgradeMessage" class="upgrade-subtitle" style="color: #64748b; line-height: 1.6;"></p>
    </div>
    
    <div class="upgrade-benefits" style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: left;">
      <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 14px; font-weight: 600;">Upgrade to Immerse and get:</h4>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸ’¬</span>
        <span class="benefit-text" style="color: #475569;">Unlimited Chat Messages</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸŽ™ï¸</span>
        <span class="benefit-text" style="color: #475569;">Unlimited Voice Messages (Text-to-Speech)</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸŽ§</span>
        <span class="benefit-text" style="color: #475569;">Voice Input (Speech-to-Text)</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸ¤</span>
        <span class="benefit-text" style="color: #475569;">Unlimited Active Companions</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸ§ </span>
        <span class="benefit-text" style="color: #475569;">Advanced Character Memory</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">âš¡</span>
        <span class="benefit-text" style="color: #475569;">Faster Response Times</span>
      </div>
      <div class="benefit-item" style="display: flex; align-items: center; padding: 8px 0;">
        <span class="benefit-icon" style="font-size: 20px; margin-right: 12px;">ðŸ‘‘</span>
        <span class="benefit-text" style="color: #475569;">Priority Support</span>
      </div>
    </div>
    
    <div class="upgrade-buttons" style="display: flex; gap: 12px;">
      <button onclick="window.location.href='profile.html#plans'" class="upgrade-btn primary" style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        View Plans
      </button>
      <button onclick="closeUpgradePopup()" class="upgrade-btn secondary" style="flex: 1; padding: 12px 20px; background: #e2e8f0; color: #475569; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        Not Now
      </button>
    </div>
  </div>
</div>

<script>
function showUpgradePopup(reason) {
  const popup = document.getElementById('upgradePopup');
  const message = document.getElementById('upgradeMessage');
  const title = document.getElementById('upgradeTitle');
  const userPlan = localStorage.getItem('user_plan') || 'Free';
  
  if (reason === 'companion_limit') {
    title.textContent = 'Companion Limit Reached';
    if (userPlan === 'Free') {
      message.innerHTML = "<strong>You've reached your limit of 2 active companions on the Free plan.</strong><br><br>To create this new companion, you'll need to pause an existing one or upgrade your plan. Free users can have 2 active companions at a time.";
    } else if (userPlan === 'Engage') {
      message.innerHTML = "<strong>You've reached your limit of 5 active companions on the Engage plan.</strong><br><br>To create this new companion, you'll need to pause an existing one or upgrade to Immerse for unlimited active companions.";
    }
  } else if (reason === 'message_limit') {
    title.textContent = 'Message Limit Reached';
    message.innerHTML = "<strong>You've used all 10 free messages for today.</strong><br><br>Upgrade to continue chatting with unlimited messages and unlock voice features, more companions, and premium benefits.";
  } else if (reason === 'voice_feature') {
    title.textContent = 'Premium Feature';
    message.innerHTML = "<strong>Voice chat is a premium feature.</strong><br><br>Upgrade to Immerse to use unlimited voice messages (text-to-speech) and voice input (speech-to-text) with all your companions.";
  } else {
    title.textContent = 'Continue Your Journey';
    message.innerHTML = "Unlock the full Narrin AI experience with our premium plans!";
  }
  
  popup.style.display = 'flex';
}

function closeUpgradePopup() {
  document.getElementById('upgradePopup').style.display = 'none';
}

// Check trial status and handle expiration
async function checkTrialStatus(email, uid) {
  try {
    const response = await fetch('/.netlify/functions/check-trial', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_email: email, user_uid: uid })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.trial_expired) {
        console.log('â° Trial has expired, updating localStorage');
        localStorage.setItem('user_plan', 'Free');
        localStorage.setItem('subscription_status', 'expired_trial');
        localStorage.removeItem('trial_end_date');
        
        // Show notification about trial expiration
        showNotification('â° Your 7-day Engage trial has ended. Upgrade to continue with unlimited messaging!');
      } else if (data.current_plan === 'Engage' && data.subscription_status === 'trial') {
        // Update localStorage with current trial info
        localStorage.setItem('user_plan', 'Engage');
        localStorage.setItem('subscription_status', 'trial');
        if (data['grace_period_end']) {
          localStorage.setItem('trial_end_date', data['grace_period_end']);
        }
      }
    }
  } catch (error) {
    console.error('âŒ Error checking trial status:', error);
  }
}
</script>

</body>
</html>