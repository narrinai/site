<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex">
  <title>Chat with AI Companion | Organize Your Thoughts & Find Mental Clarity - Narrin AI</title>
  <meta name="description" content="Transform scattered thoughts into clear insights through personalized AI conversations. Chat with your companion to organize your mind and end each day feeling clearer.">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://narrin.ai/chat">
  <meta property="og:title" content="Chat with AI Companion | Transform Mental Chaos Into Clarity">
  <meta property="og:description" content="Transform scattered thoughts into organized insights through AI conversations. Find mental clarity and end each day feeling clearer.">
  <meta property="og:image" content="https://narrin.ai/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://narrin.ai/chat">
  <meta property="twitter:title" content="AI Chat for Mental Clarity | Organize Your Thoughts - Narrin AI">
  <meta property="twitter:description" content="Transform mental chaos into clear thinking through personalized AI conversations. Organize your thoughts and find clarity.">
  <meta property="twitter:image" content="https://narrin.ai/og-image.jpg">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D6T01M6XTJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D6T01M6XTJ');
  </script>

  <!-- Network Performance Optimizations -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://narrin.ai">
  <link rel="preconnect" href="https://hook.eu2.make.com">
  <link rel="dns-prefetch" href="https://api.airtable.com">

  <!-- Fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap"></noscript>

  <style>
    :root {
      /* Narrin Color Palette */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      
      /* Selira-inspired spacing */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 20px;
      --spacing-xl: 24px;
      --spacing-2xl: 32px;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-full: 50px;
      
      /* Transitions */
      --transition-base: 300ms ease-out;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-primary);
      background: var(--color-off-white);
      color: var(--color-navy);
      overflow: hidden;
      height: 100vh;
    }

    /* App Layout - Selira inspired */
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Main Chat Area - Full width on mobile */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--color-white);
    }

    /* Chat Header - Compact */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--color-light-gray);
      background: var(--color-white);
      flex-shrink: 0;
    }

    .character-info-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-left: 60px; /* Space for hamburger menu */
    }

    .character-avatar-header {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--color-teal);
      flex-shrink: 0;
    }

    .character-avatar-header img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .character-details {
      min-width: 0;
    }

    .character-name-header {
      font-family: var(--font-secondary);
      font-size: 18px;
      font-weight: 700;
      color: var(--color-navy);
      margin-bottom: 2px;
    }

    .character-status {
      color: var(--color-gray);
      font-size: 14px;
    }

    .chat-actions {
      display: flex;
      gap: var(--spacing-xs);
      flex-shrink: 0;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      background: var(--color-light-gray);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--color-gray);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      position: relative;
    }

    .action-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
    }

    /* Memory notification badge */
    .memory-btn.has-notification::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 8px;
      height: 8px;
      background: var(--color-coral);
      border-radius: 50%;
      border: 1px solid var(--color-white);
    }

    /* Chat Messages Area */
    .chat-messages {
      flex: 1;
      padding: var(--spacing-lg);
      overflow-y: auto;
      background: var(--color-off-white);
    }

    .welcome-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--color-gray);
    }

    .welcome-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
    }

    .welcome-message h3 {
      font-family: var(--font-secondary);
      font-size: 24px;
      font-weight: 600;
      color: var(--color-navy);
      margin-bottom: var(--spacing-xs);
    }

    .conversation-starters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
      max-width: 300px;
    }

    .starter-btn {
      background: var(--color-white);
      border: 1px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm);
      font-size: 13px;
      color: var(--color-navy);
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: center;
    }

    .starter-btn:hover {
      background: var(--color-teal-light);
      border-color: var(--color-teal);
      color: var(--color-navy);
    }

    .message {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      max-width: 85%;
    }

    .message.user {
      flex-direction: row-reverse;
      margin-left: auto;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-content {
      background: var(--color-white);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-lg);
      color: var(--color-navy);
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message.user .message-content {
      background: var(--gradient-primary);
      color: var(--color-white);
    }

    .message-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--spacing-xs);
      font-size: 11px;
      color: var(--color-gray);
    }

    .message-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .message-action {
      background: none;
      border: none;
      color: var(--color-gray);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all var(--transition-base);
    }

    .message-action:hover {
      background: var(--color-light-gray);
      color: var(--color-teal);
    }

    /* Chat Input - Selira inspired */
    .chat-input-container {
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--color-light-gray);
      background: var(--color-white);
      flex-shrink: 0;
    }

    .chat-input-wrapper {
      display: flex;
      gap: var(--spacing-sm);
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      background: var(--color-light-gray);
      border: none;
      border-radius: var(--radius-xl);
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--color-navy);
      font-family: inherit;
      font-size: 14px;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      outline: none;
    }

    #messageInput:focus {
      background: var(--color-white);
      box-shadow: 0 0 0 2px var(--color-teal-light);
    }

    .send-btn {
      width: 36px;
      height: 36px;
      background: var(--color-teal);
      border: none;
      border-radius: 50%;
      color: var(--color-white);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .send-btn:hover {
      background: var(--color-teal-dark);
      transform: scale(1.05);
    }

    .send-btn:disabled {
      background: var(--color-gray-light);
      cursor: not-allowed;
      transform: none;
    }

    /* Organize Thoughts Button */
    .organize-btn {
      width: 36px;
      height: 36px;
      background: var(--color-coral-light);
      border: none;
      border-radius: 50%;
      color: var(--color-white);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: var(--spacing-xs);
    }

    .organize-btn:hover {
      background: var(--color-coral);
      transform: scale(1.05);
    }

    /* Topics Panel */
    .topics-panel {
      position: fixed;
      bottom: 80px;
      left: var(--spacing-lg);
      right: var(--spacing-lg);
      background: var(--color-white);
      border: 1px solid var(--color-light-gray);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 100;
    }

    .topics-panel.open {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .topics-header {
      font-weight: 600;
      color: var(--color-navy);
      margin-bottom: var(--spacing-sm);
      text-align: center;
    }

    .topics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-xs);
    }

    .topic-btn {
      background: var(--color-off-white);
      border: 1px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm);
      font-size: 13px;
      color: var(--color-navy);
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: center;
    }

    .topic-btn:hover {
      background: var(--color-teal-light);
      border-color: var(--color-teal);
      color: var(--color-navy);
    }

    /* Memory and Customize buttons */
    .memory-btn, .customize-btn {
      background: var(--gradient-primary);
      color: var(--color-white);
    }

    .memory-btn:hover, .customize-btn:hover {
      transform: scale(1.05);
    }

    /* Mobile Menu Button - fixed top-left corner */
    .mobile-menu-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1000;
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--color-light-gray);
      border-radius: var(--radius-sm);
      color: var(--color-navy);
      font-size: 16px;
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .mobile-menu-btn:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: scale(1.05);
    }

    /* Typing indicator */
    .typing-dots {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: var(--spacing-xs) 0;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--color-gray);
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      30% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Mic Button Styles */
    .mic-button {
      width: 36px;
      height: 36px;
      background: var(--color-light-gray);
      border: none;
      border-radius: 50%;
      color: var(--color-gray);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .mic-button:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: scale(1.05);
    }

    .mic-button.recording {
      background: var(--color-coral);
      color: var(--color-white);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Modal Styles for Memory Hub and Customize */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--color-white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform var(--transition-base);
    }

    .modal-overlay.open .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .modal-title {
      font-family: var(--font-secondary);
      font-size: 24px;
      font-weight: 600;
      color: var(--color-navy);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--color-gray);
      cursor: pointer;
      transition: color var(--transition-base);
    }

    .modal-close:hover {
      color: var(--color-navy);
    }

    /* Disclaimer Styles */
    .disclaimer {
      font-size: 12px;
      color: var(--color-gray);
      text-align: center;
      line-height: 1.4;
      margin-top: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: transparent;
      border-radius: var(--radius-sm);
    }

    /* Mobile Responsive - Selira inspired */
    @media (max-width: 768px) {
      .chat-header {
        padding: var(--spacing-sm) var(--spacing-md);
        position: relative;
      }

      .character-avatar-header {
        width: 36px;
        height: 36px;
      }

      .character-name-header {
        font-size: 16px;
      }

      .chat-messages {
        padding: var(--spacing-md);
      }

      .chat-input-container {
        padding: var(--spacing-sm) var(--spacing-md);
      }

      .topics-panel {
        left: var(--spacing-md);
        right: var(--spacing-md);
        bottom: 70px;
      }

      .message {
        max-width: 90%;
      }

      .conversation-starters {
        grid-template-columns: 1fr;
      }
    }

    /* Very compact mobile (Selira-style) */
    @media (max-width: 480px) {
      .chat-header {
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .character-avatar-header {
        width: 32px;
        height: 32px;
      }

      .character-name-header {
        font-size: 15px;
      }

      .chat-messages {
        padding: var(--spacing-sm);
      }

      .chat-input-container {
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .topics-panel {
        left: var(--spacing-xs);
        right: var(--spacing-xs);
      }

      .action-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .send-btn, .organize-btn, .mic-button {
        width: 32px;
        height: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Main Chat Area -->
    <main class="chat-main">
      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Menu">
        ☰
      </button>

      <!-- Chat Header -->
      <header class="chat-header">
        <div class="character-info-header">
          <div class="character-avatar-header" id="characterAvatarHeader">
            <img src="/avatars/emily-1754251534076.webp" alt="AI Companion" onerror="this.style.display='none';" id="headerAvatarImg">
          </div>
          <div class="character-details">
            <h2 class="character-name-header" id="characterNameHeader">AI Companion</h2>
            <p class="character-status" id="characterStatusHeader">Your Thoughtful Guide</p>
          </div>
        </div>
        <div class="chat-actions">
          <button class="action-btn memory-btn" onclick="openMemoryHub()" title="Memory Hub" id="memoryBtn">
            🧠
          </button>
          <button class="action-btn customize-btn" onclick="openCustomize()" title="Customize" id="customizeBtn">
            ⚙️
          </button>
        </div>
      </header>

      <!-- Chat Messages Area -->
      <div class="chat-messages" id="chatMessages">
        <div class="welcome-message">
          <div class="welcome-icon">💭</div>
          <h3>Welcome to Narrin AI</h3>
          <p id="welcomeText">Transform your thoughts into clarity with your AI companion!</p>
          <div class="conversation-starters" id="conversationStarters">
            <button class="starter-btn" onclick="selectStarter('How are you feeling today?')">Daily Check-in</button>
            <button class="starter-btn" onclick="selectStarter('What\\'s been on your mind lately?')">Share Thoughts</button>
            <button class="starter-btn" onclick="selectStarter('Help me organize my goals.')">Set Goals</button>
            <button class="starter-btn" onclick="selectStarter('I need someone to talk to.')">Just Talk</button>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <button class="organize-btn" onclick="toggleTopics()" title="Organize Thoughts">
            +
          </button>
          <textarea 
            id="messageInput" 
            placeholder="Share what's on your mind..." 
            rows="1"
            maxlength="2000"
          ></textarea>
          <button class="mic-button" onclick="toggleSpeechToText()" id="micButton" title="Voice input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V4C15 2.34 13.66 1 12 1Z"/>
              <path d="M19 10V12C19 15.866 15.866 19 12 19C8.13401 19 5 15.866 5 12V10"/>
              <path d="M12 19V23"/>
              <path d="M8 23H16"/>
            </svg>
          </button>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            ➤
          </button>
        </div>
        
        <!-- AI Disclaimer -->
        <div class="disclaimer">
          <span>You are chatting with an AI companion. This is not a real person.</span>
        </div>
      </div>
    </main>

    <!-- Topics Panel -->
    <div class="topics-panel" id="topicsPanel">
      <div class="topics-header">Choose a topic to explore:</div>
      <div class="topics-grid" id="topicsGrid">
        <button class="topic-btn" onclick="selectTopic('daily-reflection')">Daily Reflection</button>
        <button class="topic-btn" onclick="selectTopic('goal-setting')">Goal Setting</button>
        <button class="topic-btn" onclick="selectTopic('mindfulness')">Mindfulness</button>
        <button class="topic-btn" onclick="selectTopic('relationships')">Relationships</button>
        <button class="topic-btn" onclick="selectTopic('productivity')">Productivity</button>
        <button class="topic-btn" onclick="selectTopic('creativity')">Creativity</button>
      </div>
    </div>

    <!-- Memory Hub Modal -->
    <div class="modal-overlay" id="memoryModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Memory Hub</h2>
          <button class="modal-close" onclick="closeMemoryHub()">&times;</button>
        </div>
        <div id="memoryContent">
          <p>Loading memories...</p>
        </div>
      </div>
    </div>

    <!-- Customize Modal -->
    <div class="modal-overlay" id="customizeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Customize Experience</h2>
          <button class="modal-close" onclick="closeCustomize()">&times;</button>
        </div>
        <div id="customizeContent">
          <p>Loading customization options...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentCharacter = null;
    let conversationHistory = [];
    let isTyping = false;
    let speechRecognition = null;
    let isRecording = false;
    let currentUser = null;
    let isAuthenticated = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Narrin AI Chat initialized');
      setupEventListeners();
      loadCharacterFromURL();
      initializeAuth();
    });

    function setupEventListeners() {
      const messageInput = document.getElementById('messageInput');
      
      if (messageInput) {
        messageInput.addEventListener('input', autoResizeTextarea);
        messageInput.addEventListener('keydown', handleKeyDown);
      }

      // Close topics when clicking outside
      document.addEventListener('click', function(e) {
        const topicsPanel = document.getElementById('topicsPanel');
        const organizeBtn = document.querySelector('.organize-btn');
        
        if (topicsPanel && !topicsPanel.contains(e.target) && !organizeBtn.contains(e.target)) {
          topicsPanel.classList.remove('open');
        }
      });

      // Close modals when clicking overlay
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
          e.target.classList.remove('open');
        }
      });
    }

    function autoResizeTextarea() {
      const textarea = document.getElementById('messageInput');
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // Character loading functions
    async function loadCharacterFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const characterSlug = urlParams.get('char') || urlParams.get('character');
      
      if (characterSlug) {
        await loadCharacterDirectly(characterSlug);
      } else {
        // Load default character
        setDefaultCharacter();
      }
    }

    async function loadCharacterDirectly(slug) {
      try {
        console.log('🔄 Loading character:', slug);
        
        const response = await fetch(`/.netlify/functions/characters?slug=${encodeURIComponent(slug)}`);
        const data = await response.json();
        
        if (data.success && data.character) {
          currentCharacter = data.character;
          updateCharacterUI(data.character);
          await loadConversationTopics(slug);
          showWelcomeMessage(data.character);
          
          // Check for memory hub notification after character is loaded
          setTimeout(() => {
            checkMemoryHubNotification();
          }, 1000);
        } else {
          console.error('Character not found:', slug);
          setDefaultCharacter();
        }
      } catch (error) {
        console.error('Error loading character:', error);
        setDefaultCharacter();
      }
    }

    function setDefaultCharacter() {
      currentCharacter = {
        slug: 'emily',
        name: 'Emily',
        title: 'Mindful Companion',
        description: 'Your thoughtful guide for mental clarity',
        avatar_url: '/avatars/emily-1754251534076.webp'
      };
      updateCharacterUI(currentCharacter);
    }

    function updateCharacterUI(character) {
      const nameHeader = document.getElementById('characterNameHeader');
      const statusHeader = document.getElementById('characterStatusHeader');
      const avatarImg = document.getElementById('headerAvatarImg');
      const welcomeText = document.getElementById('welcomeText');
      
      if (nameHeader) nameHeader.textContent = character.name || 'AI Companion';
      if (statusHeader) statusHeader.textContent = character.title || 'Your Thoughtful Guide';
      if (avatarImg && character.avatar_url) {
        avatarImg.src = character.avatar_url;
        avatarImg.alt = character.name;
      }
      if (welcomeText) {
        welcomeText.textContent = `Transform your thoughts into clarity with ${character.name}!`;
      }
      
      // Load chat history for this character
      loadChatHistory(character.slug);
    }

    function showWelcomeMessage(character) {
      // This could be enhanced with character-specific welcome messages
    }

    // Conversation topics
    async function loadConversationTopics(characterSlug) {
      try {
        // This could load character-specific topics from Airtable
        // For now, using default topics
        const defaultTopics = [
          { key: 'daily-reflection', label: 'Daily Reflection' },
          { key: 'goal-setting', label: 'Goal Setting' },
          { key: 'mindfulness', label: 'Mindfulness' },
          { key: 'relationships', label: 'Relationships' },
          { key: 'productivity', label: 'Productivity' },
          { key: 'creativity', label: 'Creativity' }
        ];
        
        updateTopicsUI(defaultTopics);
      } catch (error) {
        console.error('Error loading topics:', error);
      }
    }

    function updateTopicsUI(topics) {
      const topicsGrid = document.getElementById('topicsGrid');
      if (!topicsGrid) return;
      
      topicsGrid.innerHTML = topics.map(topic => 
        `<button class="topic-btn" onclick="selectTopic('${topic.key}')">${topic.label}</button>`
      ).join('');
    }

    function toggleTopics() {
      const topicsPanel = document.getElementById('topicsPanel');
      topicsPanel.classList.toggle('open');
    }

    function selectTopic(topic) {
      const topics = {
        'daily-reflection': 'How has your day been so far? What moments stood out to you?',
        'goal-setting': 'What\'s one goal you\'re working towards right now?',
        'mindfulness': 'How are you feeling in this moment?',
        'relationships': 'Tell me about a relationship that\'s important to you.',
        'productivity': 'What would help you feel more productive today?',
        'creativity': 'What creative projects or ideas are inspiring you lately?'
      };
      
      const messageInput = document.getElementById('messageInput');
      messageInput.value = topics[topic] || 'Let\'s talk about this topic.';
      autoResizeTextarea();
      messageInput.focus();
      
      document.getElementById('topicsPanel').classList.remove('open');
    }

    function selectStarter(message) {
      const messageInput = document.getElementById('messageInput');
      messageInput.value = message;
      autoResizeTextarea();
      messageInput.focus();
    }

    // Usage limit checking
    async function checkUsageLimit() {
      const token = localStorage.getItem("user_token");
      const uid = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      const isAnonymousUser = localStorage.getItem('is_anonymous_user') === 'true';
      
      if (!token || !uid || !email) {
        return false;
      }
      
      // For anonymous users on featured characters, skip server check and use browser-only limits
      const featuredCharacters = ['galina', 'blake-devoted-boyfriend', 'emerald', 'sol'];
      const currentCharSlug = new URLSearchParams(window.location.search).get('char') || new URLSearchParams(window.location.search).get('character');
      const isFeaturedCharacter = featuredCharacters.includes(currentCharSlug);
      
      if (isAnonymousUser && isFeaturedCharacter) {
        console.log('📊 Anonymous user on featured character - using browser-only limit check');
        const usageKey = `anonymous_usage_${currentCharSlug}`;
        const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
        
        console.log(`📊 Browser-only check: ${currentUsage}/5 for ${currentCharSlug}`);
        
        if (currentUsage >= 5) {
          console.log('🚫 Browser limit reached for anonymous user');
          showUpgradePrompt(5, 5, 'messages');
          return false;
        }
        
        console.log('✅ Anonymous user within browser limit');
        return true;
      }
      
      // For authenticated users, check with server
      try {
        const payload = {
          user_email: email,
          user_uid: uid,
          action: 'check_usage'
        };
        
        const response = await fetch('https://hook.eu2.make.com/36bygx4a2y4bkl97wkdjdmtn3o9ygjms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          console.warn('Usage check failed, allowing message');
          return true;
        }
        
        const data = await response.json();
        return data.canSend || true;
      } catch (error) {
        console.error('Usage limit check error:', error);
        return true; // Allow on error
      }
    }
    
    function showUpgradePrompt(current, limit, type) {
      alert(`You've reached your ${type} limit (${current}/${limit}). Please upgrade to continue!`);
    }

    // Message sending
    async function sendMessage(event) {
      event?.preventDefault();
      
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (!message || isTyping) return;
      
      // Check usage limit before sending message
      console.log('🔍 Checking usage limit before sending message...');
      const isAnonymousUser = localStorage.getItem('is_anonymous_user') === 'true';
      if (isAnonymousUser) {
        const featuredCharacters = ['galina', 'blake-devoted-boyfriend', 'emerald', 'sol'];
        const currentCharSlug = new URLSearchParams(window.location.search).get('char') || new URLSearchParams(window.location.search).get('character');
        const isFeaturedCharacter = featuredCharacters.includes(currentCharSlug);
        
        if (isFeaturedCharacter) {
          const usageKey = `anonymous_usage_${currentCharSlug}`;
          const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
          
          console.log(`📊 Anonymous usage check for ${currentCharSlug}: ${currentUsage}/5`);
          
          if (currentUsage >= 5) {
            console.log('🚫 Anonymous user trying to send 6th message - showing limit popup');
            showUpgradePrompt(5, 5, 'messages');
            return;
          }
        }
      }
      
      const canSend = await checkUsageLimit();
      console.log(`📊 Usage limit check result: canSend = ${canSend}`);
      if (!canSend) {
        console.log('🚫 Message blocked due to usage limit');
        return;
      }
      console.log('✅ Usage limit check passed, proceeding with message');
      
      // Add user message
      addMessage(message, 'user');
      messageInput.value = '';
      autoResizeTextarea();
      
      // Save message to localStorage
      saveMessageToHistory(message, 'user');
      
      // Show typing indicator
      const typingIndicator = addTypingIndicator();
      isTyping = true;
      
      try {
        // Send to Make.com webhook
        const response = await sendToMakeWebhook(message);
        
        if (response && response.reply) {
          typingIndicator.remove();
          isTyping = false;
          
          // Add AI response with typewriter effect
          await addMessageWithTypewriter(response.reply, 'ai');
          saveMessageToHistory(response.reply, 'ai');
          
          // Handle TTS if enabled
          if (response.tts_url) {
            handleTTSResponse(response.tts_url);
          }
        } else {
          throw new Error('Invalid response from AI');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        typingIndicator.remove();
        isTyping = false;
        addMessage('I apologize, but I\'m having trouble connecting right now. Please try again.', 'ai');
      }
    }

    async function sendToMakeWebhook(message) {
      const currentCharSlug = currentCharacter?.slug || 'emily';
      const user_email = localStorage.getItem("user_email") || 'anonymous@narrin.ai';
      const user_token = localStorage.getItem("user_token");
      const user_uid = localStorage.getItem("user_uid");
      const isAnonymousUser = localStorage.getItem('is_anonymous_user') === 'true';
      
      // Get recent conversation context
      const recentMessages = conversationHistory.slice(-10);
      
      // Update anonymous usage counter
      if (isAnonymousUser) {
        const featuredCharacters = ['galina', 'blake-devoted-boyfriend', 'emerald', 'sol'];
        const isFeaturedCharacter = featuredCharacters.includes(currentCharSlug);
        if (isFeaturedCharacter) {
          const usageKey = `anonymous_usage_${currentCharSlug}`;
          const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
          localStorage.setItem(usageKey, (currentUsage + 1).toString());
        }
      }
      
      const payload = {
        action: "send_message",
        text: message,
        user_message: message,
        memory_context: isAnonymousUser ? '' : '', // Could add memory context later
        conversation_history: isAnonymousUser ? [] : recentMessages,
        emotional_complexity: 0.5,
        relationship_phase: isAnonymousUser ? 'anonymous' : 'ongoing',
        total_messages: conversationHistory.length,
        slug: currentCharSlug,
        netlify_uid: user_uid || "",
        user_token: user_token || "",
        user_email: user_email,
        custom_prompt: currentCharacter?.customPrompt || null,
        is_customized: currentCharacter?.isCustomized || false,
        has_onboarding: false, // Could be enhanced later
        is_anonymous: isAnonymousUser,
        anonymous_session: isAnonymousUser ? localStorage.getItem('anonymous_character') : null
      };
      
      console.log('📤 Sending to Make webhook:', payload);
      
      // Add timeout handling
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      let response;
      try {
        response = await fetch('https://hook.eu2.make.com/36bygx4a2y4bkl97wkdjdmtn3o9ygjms', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('The AI is taking longer than expected. Please try again.');
        }
        throw error;
      }
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const rawText = await response.text();
      console.log('📄 Make webhook raw response:', rawText);
      
      try {
        return JSON.parse(rawText);
      } catch (parseError) {
        console.error('JSON parsing error:', parseError);
        // Try to extract just the reply if JSON is malformed
        const replyMatch = rawText.match(/"reply":\s*"([^"]*?)"/);
        if (replyMatch) {
          return { reply: replyMatch[1] };
        }
        throw new Error('Invalid response format from AI service');
      }
    }

    function addMessage(content, sender, autoScroll = true) {
      const messagesContainer = document.getElementById('chatMessages');
      const welcomeMessage = messagesContainer.querySelector('.welcome-message');
      
      if (welcomeMessage) {
        welcomeMessage.remove();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (sender === 'ai') {
        messageDiv.innerHTML = `
          <div class="message-avatar">
            <img src="${currentCharacter?.avatar_url || '/avatars/default-avatar.webp'}" alt="${currentCharacter?.name || 'AI'}" onerror="this.style.display='none'">
          </div>
          <div class="message-wrapper">
            <div class="message-content">${content}</div>
            <div class="message-meta">
              <span>${timestamp}</span>
              <div class="message-actions">
                <button class="message-action" onclick="copyMessage(this)" title="Copy">📋</button>
                <button class="message-action" onclick="speakMessage(this)" title="Speak">🔊</button>
              </div>
            </div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="message-wrapper">
            <div class="message-content">${content}</div>
            <div class="message-meta">
              <span>${timestamp}</span>
            </div>
          </div>
        `;
      }
      
      messagesContainer.appendChild(messageDiv);
      
      if (autoScroll) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    async function addMessageWithTypewriter(content, sender) {
      const messagesContainer = document.getElementById('chatMessages');
      const welcomeMessage = messagesContainer.querySelector('.welcome-message');
      
      if (welcomeMessage) {
        welcomeMessage.remove();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">
          <img src="${currentCharacter?.avatar_url || '/avatars/default-avatar.webp'}" alt="${currentCharacter?.name || 'AI'}" onerror="this.style.display='none'">
        </div>
        <div class="message-wrapper">
          <div class="message-content" id="typing-content"></div>
          <div class="message-meta">
            <span>${timestamp}</span>
            <div class="message-actions">
              <button class="message-action" onclick="copyMessage(this)" title="Copy">📋</button>
              <button class="message-action" onclick="speakMessage(this)" title="Speak">🔊</button>
            </div>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Typewriter effect
      const contentDiv = messageDiv.querySelector('#typing-content');
      let i = 0;
      
      return new Promise((resolve) => {
        const typeInterval = setInterval(() => {
          if (i < content.length) {
            contentDiv.textContent += content.charAt(i);
            i++;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          } else {
            clearInterval(typeInterval);
            resolve();
          }
        }, 30);
      });
    }

    function addTypingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai typing-indicator';
      typingDiv.innerHTML = `
        <div class="message-avatar">
          <img src="${currentCharacter?.avatar_url || '/avatars/default-avatar.webp'}" alt="${currentCharacter?.name || 'AI'}" onerror="this.style.display='none'">
        </div>
        <div class="message-content">
          <div class="typing-dots">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return typingDiv;
    }

    // Message actions
    function copyMessage(button) {
      const messageContent = button.closest('.message-wrapper').querySelector('.message-content').textContent;
      navigator.clipboard.writeText(messageContent).then(() => {
        button.textContent = '✓';
        setTimeout(() => button.textContent = '📋', 2000);
      });
    }

    function speakMessage(button) {
      const messageContent = button.closest('.message-wrapper').querySelector('.message-content').textContent;
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(messageContent);
        window.speechSynthesis.speak(utterance);
      }
    }

    // Chat history functions
    function saveMessageToHistory(message, sender) {
      const messageObj = {
        content: message,
        sender: sender,
        timestamp: new Date().toISOString()
      };
      
      conversationHistory.push(messageObj);
      
      // Save to localStorage
      const historyKey = `chat_history_${currentCharacter?.slug || 'default'}`;
      localStorage.setItem(historyKey, JSON.stringify(conversationHistory));
      
      // Also save to Airtable via Netlify function
      saveChatMessageToAirtable(messageObj);
    }

    async function saveChatMessageToAirtable(messageObj) {
      try {
        const user_email = localStorage.getItem("user_email") || 'anonymous@narrin.ai';
        
        await fetch('/.netlify/functions/save-chat-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_email: user_email,
            character_slug: currentCharacter?.slug || 'default',
            message: messageObj.content,
            sender: messageObj.sender,
            timestamp: messageObj.timestamp
          })
        });
      } catch (error) {
        console.error('Error saving message to Airtable:', error);
      }
    }

    // Load chat history from localStorage
    function loadChatHistory(characterSlug) {
      const historyKey = `chat_history_${characterSlug || 'default'}`;
      const storedHistory = localStorage.getItem(historyKey);
      
      if (storedHistory) {
        try {
          const history = JSON.parse(storedHistory);
          conversationHistory = history;
          
          // Display the messages
          const messagesContainer = document.getElementById('chatMessages');
          const welcomeMessage = messagesContainer.querySelector('.welcome-message');
          
          if (history.length > 0 && welcomeMessage) {
            welcomeMessage.remove();
          }
          
          history.forEach((messageObj) => {
            addMessage(messageObj.content, messageObj.sender, false); // Don't auto-scroll during loading
          });
          
          // Scroll to bottom after all messages are loaded
          if (history.length > 0) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
          
          console.log(`📜 Loaded ${history.length} messages from chat history for ${characterSlug}`);
        } catch (error) {
          console.error('Error loading chat history:', error);
          conversationHistory = [];
        }
      }
    }

    // Speech-to-text
    function toggleSpeechToText() {
      const micButton = document.getElementById('micButton');
      
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Speech recognition is not supported in your browser');
        return;
      }
      
      if (!isRecording) {
        startSpeechRecognition();
      } else {
        stopSpeechRecognition();
      }
    }

    function startSpeechRecognition() {
      const micButton = document.getElementById('micButton');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      speechRecognition = new SpeechRecognition();
      speechRecognition.continuous = false;
      speechRecognition.interimResults = false;
      speechRecognition.lang = 'en-US';
      
      speechRecognition.onstart = () => {
        isRecording = true;
        micButton.classList.add('recording');
        micButton.title = 'Stop recording';
      };
      
      speechRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const messageInput = document.getElementById('messageInput');
        messageInput.value = transcript;
        autoResizeTextarea();
      };
      
      speechRecognition.onend = () => {
        isRecording = false;
        micButton.classList.remove('recording');
        micButton.title = 'Voice input';
      };
      
      speechRecognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isRecording = false;
        micButton.classList.remove('recording');
        micButton.title = 'Voice input';
      };
      
      speechRecognition.start();
    }

    function stopSpeechRecognition() {
      if (speechRecognition) {
        speechRecognition.stop();
      }
    }

    // Text-to-speech
    function handleTTSResponse(ttsUrl) {
      if (ttsUrl) {
        const audio = new Audio(ttsUrl);
        audio.play().catch(error => {
          console.error('Error playing TTS audio:', error);
        });
      }
    }

    // Memory Hub
    async function openMemoryHub() {
      const modal = document.getElementById('memoryModal');
      const content = document.getElementById('memoryContent');
      
      // Hide notification badge when opened
      hideMemoryHubBadge();
      
      modal.classList.add('open');
      
      try {
        await lazyLoadMemoryHub();
      } catch (error) {
        console.error('Error loading memory hub:', error);
        content.innerHTML = '<p>Error loading memories. Please try again.</p>';
      }
    }

    async function lazyLoadMemoryHub() {
      const content = document.getElementById('memoryContent');
      content.innerHTML = '<p>Loading memories...</p>';
      
      try {
        const user_email = localStorage.getItem("user_email");
        const character_slug = currentCharacter?.slug;
        
        if (!user_email || !character_slug) {
          content.innerHTML = '<p>Please log in to access your memories.</p>';
          return;
        }
        
        const response = await fetch(`/.netlify/functions/memory?user_email=${encodeURIComponent(user_email)}&character_slug=${encodeURIComponent(character_slug)}`);
        const data = await response.json();
        
        if (data.success && data.memories) {
          displayMemories(data.memories);
        } else {
          content.innerHTML = '<p>No memories found yet. Start chatting to build memories!</p>';
        }
      } catch (error) {
        throw error;
      }
    }

    function displayMemories(memories) {
      const content = document.getElementById('memoryContent');
      
      if (!memories || memories.length === 0) {
        content.innerHTML = '<p>No memories found yet. Start chatting to build memories!</p>';
        return;
      }
      
      const memoriesHTML = memories.map(memory => `
        <div style="background: var(--color-off-white); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
          <h4 style="color: var(--color-navy); margin-bottom: var(--spacing-xs);">${memory.title || 'Memory'}</h4>
          <p style="color: var(--color-gray-dark); line-height: 1.4;">${memory.description || memory.content}</p>
          <small style="color: var(--color-gray); margin-top: var(--spacing-xs); display: block;">
            Importance: ${memory.importance || 'N/A'} | 
            ${memory.created_at ? new Date(memory.created_at).toLocaleDateString() : 'Unknown date'}
          </small>
        </div>
      `).join('');
      
      content.innerHTML = memoriesHTML;
    }

    function closeMemoryHub() {
      document.getElementById('memoryModal').classList.remove('open');
    }

    // Memory notification badge system
    function showMemoryHubBadge() {
      const memoryBtn = document.getElementById('memoryBtn');
      if (memoryBtn) {
        memoryBtn.classList.add('has-notification');
        console.log('🔴 Memory Hub notification badge shown');
      }
    }
    
    function hideMemoryHubBadge() {
      const memoryBtn = document.getElementById('memoryBtn');
      if (memoryBtn) {
        memoryBtn.classList.remove('has-notification');
        // Mark as viewed in localStorage
        localStorage.setItem('memory_hub_viewed', 'true');
        console.log('✅ Memory Hub notification badge hidden');
      }
    }
    
    function checkMemoryHubNotification() {
      const hasViewed = localStorage.getItem('memory_hub_viewed');
      const hasImported = localStorage.getItem('chatgpt_import_timestamp');
      const characterSlug = currentCharacter?.slug || 'default';
      const isNewCompanion = !localStorage.getItem(`visited_${characterSlug}`);
      
      // Show badge if:
      // 1. User hasn't viewed Memory Hub before AND (new companion OR has imported memories)
      // 2. User has imported memories but hasn't viewed Memory Hub since
      if (!hasViewed && (isNewCompanion || hasImported)) {
        showMemoryHubBadge();
      }
      
      // Mark this companion as visited
      if (isNewCompanion && characterSlug) {
        localStorage.setItem(`visited_${characterSlug}`, 'true');
      }
    }

    // Customize
    async function openCustomize() {
      const modal = document.getElementById('customizeModal');
      modal.classList.add('open');
      
      try {
        await lazyLoadCustomize();
      } catch (error) {
        console.error('Error loading customize options:', error);
        document.getElementById('customizeContent').innerHTML = '<p>Error loading customization options.</p>';
      }
    }

    async function lazyLoadCustomize() {
      const content = document.getElementById('customizeContent');
      
      content.innerHTML = `
        <div style="display: grid; gap: var(--spacing-lg);">
          <div>
            <h3 style="color: var(--color-navy); margin-bottom: var(--spacing-sm);">Avatar Options</h3>
            <p style="color: var(--color-gray); margin-bottom: var(--spacing-md);">Customize how your AI companion appears.</p>
            <button onclick="generateNewAvatar()" style="background: var(--gradient-primary); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); cursor: pointer;">
              Generate New Avatar
            </button>
          </div>
          
          <div>
            <h3 style="color: var(--color-navy); margin-bottom: var(--spacing-sm);">Voice Settings</h3>
            <p style="color: var(--color-gray); margin-bottom: var(--spacing-md);">Adjust text-to-speech preferences.</p>
            <label style="display: block; margin-bottom: var(--spacing-xs);">
              <input type="checkbox" id="ttsEnabled" style="margin-right: var(--spacing-xs);"> 
              Enable text-to-speech
            </label>
          </div>
          
          <div>
            <h3 style="color: var(--color-navy); margin-bottom: var(--spacing-sm);">Chat Settings</h3>
            <p style="color: var(--color-gray); margin-bottom: var(--spacing-md);">Personalize your chat experience.</p>
            <button onclick="clearChatHistory()" style="background: var(--color-coral); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); cursor: pointer;">
              Clear Chat History
            </button>
          </div>
        </div>
      `;
    }

    function closeCustomize() {
      document.getElementById('customizeModal').classList.remove('open');
    }

    function generateNewAvatar() {
      alert('Avatar generation feature coming soon!');
    }

    function clearChatHistory() {
      if (confirm('Are you sure you want to clear your chat history? This cannot be undone.')) {
        conversationHistory = [];
        const historyKey = `chat_history_${currentCharacter?.slug || 'default'}`;
        localStorage.removeItem(historyKey);
        
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
          <div class="welcome-message">
            <div class="welcome-icon">💭</div>
            <h3>Chat Cleared</h3>
            <p>Start a new conversation with ${currentCharacter?.name || 'your AI companion'}!</p>
          </div>
        `;
        
        closeCustomize();
      }
    }

    // Authentication placeholder
    function initializeAuth() {
      // This would integrate with Netlify Identity
      // For now, using localStorage for demo
      const user_email = localStorage.getItem("user_email");
      if (user_email && user_email !== 'anonymous@narrin.ai') {
        isAuthenticated = true;
        currentUser = { email: user_email };
      }
    }

    // Utility functions
    function toggleMobileMenu() {
      // This would open a mobile navigation menu
      alert('Mobile Menu - This would open the navigation menu');
    }

    console.log('✅ Narrin AI Chat with Selira-inspired design ready');
  </script>
</body>
</html>