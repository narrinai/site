<!-- chat.html (dynamisch template voor meerdere karakters, met Make-logica) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Chat</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #ffffff;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-overflow-scrolling: touch;
    }

    input,
    button,
    textarea {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      position: relative;
    }

    /* Header Navigation */
    .header {
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Fix for Netlify Identity modal z-index on all devices */
    .netlify-identity-widget,
    [data-netlify-identity-widget],
    .netlify-identity-widget iframe,
    .netlify-identity-widget > div,
    .netlify-identity-widget .netlify-identity-modal {
      z-index: 2147483647 !important;
    }

    /* Additional mobile-specific fixes */
    @media (max-width: 768px) {
      .netlify-identity-widget {
        position: fixed !important;
        z-index: 2147483647 !important;
      }
      
      .netlify-identity-widget > div {
        position: fixed !important;
        z-index: 2147483647 !important;
      }
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .logo {
      font-size: 24px;
      font-weight: 600;
      color: #000;
      text-decoration: none;
    }

    .nav-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background-color: #000;
      color: #fff;
    }

    .btn-primary:hover {
      background-color: #333;
    }

    .btn-secondary {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
    }

    .btn-secondary:hover {
      background-color: #e0e0e0;
    }

    @media (max-width: 768px) {
      .nav-buttons {
        gap: 8px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin: 0 0 10px 0;
      color: #333;
    }

    .header p {
      color: #666;
      font-size: 16px;
      margin: 0;
    }

    .character-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .character-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .character-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      flex-shrink: 0;
    }

    .character-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .character-info {
      flex: 1;
    }

    .character-info h2 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 24px;
      font-weight: 600;
    }

    .character-info p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }

    .chat-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .loading-state h3 {
      font-size: 20px;
      margin: 0 0 12px 0;
      color: #333;
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: #c53030;
      background: #fed7d7;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .error-state h3 {
      margin: 0 0 8px 0;
      color: #c53030;
      font-size: 20px;
    }

    .error-state p {
      margin: 0 0 16px 0;
      font-size: 16px;
    }

    .error-state a {
      color: #2c5282;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .error-state a:hover {
      color: #2a4e7c;
      text-decoration: underline;
    }

    #chatlog {
      height: 400px;
      overflow-y: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 16px;
      border: 1px solid #e0e0e0;
    }

    #chatlog p {
      margin: 0 0 16px 0;
      line-height: 1.5;
    }

    #chatlog p:last-child {
      margin-bottom: 0;
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    #userInput {
      flex: 1;
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    #userInput:focus {
      outline: none;
      border-color: #333;
    }

    button {
      padding: 14px 28px;
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
    }

    button:hover {
      background-color: #333;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .disclaimer {
      font-size: 12px;
      color: #666;
      text-align: center;
      line-height: 1.4;
      margin-top: 0;
    }

    .disclaimer-icon {
      display: inline-block;
      margin-right: 4px;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 8px;
      object-fit: cover;
    }

    .message-avatar {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 12px;
      vertical-align: middle;
      margin-right: 8px;
      background: #e0e0e0;
    }

    @media (max-width: 600px) {
      .container {
        padding: 16px;
      }

      .header h1 {
        font-size: 28px;
      }

      .character-section,
      .chat-section {
        padding: 20px;
      }

      .character-avatar {
        width: 64px;
        height: 64px;
        font-size: 32px;
      }

      .character-info h2 {
        font-size: 20px;
      }

      #chatlog {
        height: 300px;
        padding: 16px;
        font-size: 15px;
      }

      .input-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }

      .disclaimer {
        font-size: 11px;
        padding: 0 8px;
      }
    }
  </style>

  <!-- ─────────────────────────────────────────────────────────────
       1) Laad allereerst de Netlify Identity‐widget in de <head>
       ───────────────────────────────────────────────────────────── -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- ─────────────────────────────────────────────────────────────
       2) Wacht tot de DOM volledig is geladen voordat je `init()`
          van Netlify Identity aanroept. Dit voorkomt `appendChild`
          Fouten omdat de pagina al opgebouwd is.
       ───────────────────────────────────────────────────────────── -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const netlifyIdentity = window.netlifyIdentity;
      netlifyIdentity.init();

      // Bij init: als er al een ingelogde user is, roep handleLogin aan.
      // We verwijderen hier de automatische `netlifyIdentity.open("login")`
      // zodat de login‐modal alleen opent wanneer de gebruiker wél op "Send" klikt.
      netlifyIdentity.on("init", (user) => {
        if (user) {
          handleLogin(user);
        }
      });

      netlifyIdentity.on("login", (user) => {
        handleLogin(user);
        netlifyIdentity.close();
      });

      netlifyIdentity.on("logout", () => {
        clearLocalAuth();
        window.location.href = "/";
      });
    });

    async function handleLogin(user) {
      const email = user.email;
      const uid   = user.id;                // Netlify UID
      const token = user.token.access_token; // Netlify JWT

      localStorage.setItem("user_email", email);
      localStorage.setItem("user_token", token);
      localStorage.setItem("user_uid", uid);
      window.isRegistered = true;

      console.log("DEBUG: handleLogin → verstuur Webhook1:", {
        user_email: email,
        user_uid:   uid,
        user_token: token
      });

      try {
        const res = await fetch(
          "https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_email: email,
              user_uid:   uid,
              user_token: token
            })
          }
        );

        const rawText = await res.text();
        console.log("Webhook1 raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
          console.log("Webhook1 parsed JSON:", data);
        } catch (e) {
          console.warn("Webhook1: response is not JSON, skipping:", e);
        }
      } catch (err) {
        console.error("Error in registration-webhook call:", err);
      }

      // Zodra de pagina geladen is, laad de chat-geschiedenis
      if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
      ) {
        fetchHistory();
      }
    }

    function clearLocalAuth() {
      localStorage.removeItem("user_email");
      localStorage.removeItem("user_token");
      localStorage.removeItem("user_uid");
      window.isRegistered = false;
    }
  </script>
  <!-- EINDE AANGEPASTE SCRIPT -->

</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="logo">Narrin AI</a>
      <nav class="nav-buttons">
        <a href="category.html" class="btn btn-secondary">🎭 Characters</a>
        <a href="#" onclick="openNetlifyLogin(); return false;" class="btn btn-secondary" id="loginBtn">👤 Login</a>
        <a href="create-character.html" class="btn btn-primary">✨ Create Character</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div id="loadingState" class="loading-state">
      <h3>Loading character...</h3>
      <p>Please wait while we fetch your character's information.</p>
    </div>

    <div id="errorState" class="error-state" style="display: none;">
      <h3>Character not found</h3>
      <p>The character you're looking for doesn't exist or isn't accessible.</p>
      <a href="create-character.html">Create a new character</a> or <a href="/">go back to home</a>
    </div>

    <div id="chatInterface" style="display: none;">
      <div class="header">
        <h1>Character Chat</h1>
        <p>Have a conversation with your AI character</p>
      </div>

      <div class="character-section">
        <div class="character-header" id="characterHeader">
          <div class="character-avatar" id="characterAvatar">👤</div>
          <div class="character-info">
            <h2 id="characterName">Loading...</h2>
            <p id="characterTitle"></p>
          </div>
        </div>
      </div>

      <div class="chat-section">
        <div id="chatlog"></div>
        <div class="input-group">
          <input id="userInput" type="text" placeholder="Type your message here..." />
          <button onclick="handleSendClick(event)" id="sendButton">Send</button>
        </div>
        <div class="disclaimer">
          <span class="disclaimer-icon">ℹ️</span>
          This is an AI chatbot and not a real person. All responses are generated by artificial intelligence and should be treated as fiction. 
          Do not rely on any information provided as factual or as professional advice. 
          The platform owner assumes no responsibility for the content generated by AI characters.
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation and Netlify Identity functions -->
  <script>

    // Netlify Identity functions (matching index.html)
    function openNetlifyLogin() {
      if (window.netlifyIdentity) {
        if (isMobileDevice()) {
          // On mobile, show alert and redirect to profile page
          alert('For the best login experience on mobile, please use the profile page.');
          window.location.href = 'profile.html';
        } else {
          // On desktop, use modal with z-index fix
          const header = document.querySelector('.header');
          if (header) {
            header.style.zIndex = '1';
          }
          
          window.netlifyIdentity.open('login');
          
          setTimeout(() => {
            if (header) {
              header.style.zIndex = '100';
            }
          }, 500);
        }
      } else {
        console.error('Netlify Identity not loaded');
        alert('Login system not available. Please try again later.');
      }
    }

    function updateLoginButton() {
      const loginBtn = document.getElementById('loginBtn');
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      if (user) {
        loginBtn.innerHTML = '👤 ' + (user.user_metadata.full_name || user.email);
        loginBtn.onclick = function() {
          window.location.href = 'profile.html';
          return false;
        };
      } else {
        loginBtn.innerHTML = '👤 Login';
        loginBtn.onclick = function() {
          openNetlifyLogin();
          return false;
        };
      }
    }

    // Initialize login button on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          updateLoginButton();
        });

        window.netlifyIdentity.on('login', user => {
          updateLoginButton();
          window.netlifyIdentity.close();
        });

        window.netlifyIdentity.on('logout', () => {
          updateLoginButton();
        });
      }
    });
  </script>

  <!-- ─────────────────────────────────────────────────────────────
       A) CHARACTER LOADING & SETUP
       ───────────────────────────────────────────────────────────── -->
  <script>
    // Global variables
    let currentCharacter = null;
    let characterSlug = null;
    
    // Endpoints
    const endpoint = "https://hook.eu2.make.com/c753wxuxgpcu37fol9seri6rdtpz2lju";

    const params = new URLSearchParams(window.location.search);
    characterSlug = params.get("char");

    if (!characterSlug) {
      showError("No character specified in URL");
    } else {
      loadCharacter(characterSlug);
    }

    async function loadCharacter(slug) {
      try {
        console.log("Loading character:", slug);
        
        // Get user info if available
        const token = localStorage.getItem("user_token");
        const uid = localStorage.getItem("user_uid");
        const email = localStorage.getItem("user_email");
        
        // Send request with user info if available
        const requestData = {
          action: "get_character",
          slug: slug
        };
        
        // Add user info if logged in
        if (token && uid && email) {
          requestData.user_token = token;
          requestData.user_uid = uid;
          requestData.user_email = email;
        }
        
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const rawText = await response.text();
        console.log("Character API response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("Invalid JSON response:", e);
          throw new Error("Invalid response format");
        }

        if (!data.character && !data.name) {
          throw new Error("Character not found");
        }

        // Handle both possible response formats
        currentCharacter = data.character || {
          name: data.name,
          character_title: data.character_title,
          avatar_url: data.avatar_url,
          character_description: data.character_description
        };
        
        setupCharacterInterface();
        
      } catch (error) {
        console.error("Error loading character:", error);
        showError("Failed to load character: " + error.message);
      }
    }

    function setupCharacterInterface() {
      if (!currentCharacter) return;

      // Update page title
      document.title = `Chat with ${currentCharacter.name}`;

      // Update character header
      document.getElementById('characterName').textContent = currentCharacter.name;
      document.getElementById('characterTitle').textContent = currentCharacter.character_title || '';

      // Update avatar
      const avatarElement = document.getElementById('characterAvatar');
      if (currentCharacter.avatar_url) {
        avatarElement.innerHTML = `<img src="${currentCharacter.avatar_url}" alt="${currentCharacter.name}">`;
      } else {
        avatarElement.innerHTML = '👤';
      }

      // Show chat interface, hide loading
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('chatInterface').style.display = 'block';

      // Setup input listener
      const userInput = document.getElementById("userInput");
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSendClick(e);
      });

      // Load history if user is logged in
      if (window.isRegistered) {
        fetchHistory();
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('chatInterface').style.display = 'none';
      
      // Optionally customize error message
      const errorState = document.getElementById('errorState');
      errorState.querySelector('p').textContent = message;
    }
  </script>

  <!-- ─────────────────────────────────────────────────────────────
       B) handleSendClick() (FINAL VERSION - zonder content debug)
       ───────────────────────────────────────────────────────────── -->
  <script>
    function handleSendClick(event) {
      if (!currentCharacter) {
        alert("Character not loaded yet, please wait...");
        return;
      }
      
      // Better login detection - check multiple sources
      const token = localStorage.getItem("user_token");
      const uid = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      // If we have all required data OR netlify user, user is logged in
      if ((token && uid && email) || netlifyUser) {
        sendMessage(event);
        return;
      }
      
      // Not logged in - redirect to profile for login
      localStorage.setItem('login_redirect_url', window.location.href);
      window.location.href = 'profile.html';
    }
  </script>

  <!-- ─────────────────────────────────────────────────────────────
       C) fetchHistory() (Netlify-variant)
       ───────────────────────────────────────────────────────────── -->
  <script>
    async function fetchHistory() {
      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !characterSlug || !email) {
        console.warn("fetchHistory: missing token, uid, email or character");
        return;
      }

      try {
        const resp = await fetch("https://hook.eu2.make.com/fjpapor4lkj9mpypaqx8no68d64bxe19", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_email: email,
            user_uid:   uid,
            user_token: token,
            char:        characterSlug
          })
        });

        if (!resp.ok) {
          console.error("fetchHistory → resp.ok false:", resp.status, resp.statusText);
          return;
        }

        const rawText = await resp.text();
        console.log("fetchHistory raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("fetchHistory → JSON.parse failed:", e, "Raw data:", rawText);
          return;
        }

        if (!Array.isArray(data.history)) {
          console.warn("fetchHistory → expected data.history[] but got:", data);
          return;
        }

        const chatlog = document.getElementById("chatlog");
        data.history.forEach((record) => {
          const role    = record.fields.Role;
          const message = record.fields.Message;
          const p       = document.createElement("p");
          if (role === "user") {
            p.innerHTML = `<strong>You:</strong> ${message}`;
          } else {
            const avatarHtml = getAvatarHtml();
            p.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${message}`;
          }
          chatlog.appendChild(p);
        });

        chatlog.scrollTop = chatlog.scrollHeight;
      } catch (err) {
        console.error("fetchHistory → Exception in fetchHistory:", err);
      }
    }

    function getAvatarHtml() {
      if (currentCharacter?.avatar_url) {
        return `<img class="avatar" src="${currentCharacter.avatar_url}" alt="avatar">`;
      }
      return '<span class="message-avatar">👤</span>';
    }

    // Als de pagina al geladen is en user is ingelogd, laad historie
    window.addEventListener("DOMContentLoaded", () => {
      if (window.isRegistered) {
        setTimeout(() => {
          if (currentCharacter) fetchHistory();
        }, 500);
      }
    });
  </script>

  <!-- ─────────────────────────────────────────────────────────────
       D) sendMessage() (Netlify-variant)
       ───────────────────────────────────────────────────────────── -->
  <script>
    async function sendMessage(event) {
      event?.preventDefault();
      const userInput = document.getElementById("userInput");
      const input = userInput.value.trim();
      if (!input) return;

      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !email) {
        console.error("sendMessage: missing token, uid or email");
        alert("You are not logged in properly.");
        return;
      }

      // Disable send button during request
      const sendButton = document.getElementById("sendButton");
      sendButton.disabled = true;
      sendButton.textContent = "Sending...";

      // Show user message directly
      const chatlog = document.getElementById("chatlog");
      const divUser = document.createElement("p");
      divUser.innerHTML = `<strong>You:</strong> ${input}`;
      chatlog.appendChild(divUser);
      chatlog.scrollTop = chatlog.scrollHeight;
      userInput.value = "";

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "chat",
            text: input,
            slug: characterSlug,
            char: characterSlug,  // For backward compatibility
            name: currentCharacter?.name,
            character_title: currentCharacter?.character_title,
            character_description: currentCharacter?.character_description,
            avatar_url: currentCharacter?.avatar_url,
            user_email: email,
            user_uid: uid,
            user_token: token
          })
        });

        if (!response.ok) {
          console.error("sendMessage → response.ok false:", response.status, response.statusText);
          throw new Error(`Server returned status ${response.status}`);
        }

        const text = await response.text();
        console.log("Raw response from Make:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error("sendMessage → JSON.parse failed:", e);
          throw new Error("Invalid JSON received from server");
        }

        const reply = data.reply || "⚠️ No reply.";

        // Show bot response
        const divBot = document.createElement("p");
        const avatarHtml = getAvatarHtml();
        divBot.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${reply}`;
        chatlog.appendChild(divBot);
        chatlog.scrollTop = chatlog.scrollHeight;
        
      } catch (err) {
        console.error("sendMessage → Error in fetch or parsing:", err);
        alert("❌ Error sending message: " + err.message);
        const divErr = document.createElement("p");
        divErr.innerHTML = `<strong>${currentCharacter?.name || 'Character'}:</strong> ⚠️ Something went wrong while sending.`;
        chatlog.appendChild(divErr);
        chatlog.scrollTop = chatlog.scrollHeight;
      } finally {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.textContent = "Send";
      }
    }
  </script>
</body>
</html>