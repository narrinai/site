<!-- chat.html (dynamisch template voor meerdere karakters, met Make-logica) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Chat - Narrin AI</title>
  
  <!-- Import Modern Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Creative & Bold Color Palette with White Primary */
    :root {
      /* Primary Colors - White Based */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      
      /* Bold Accent Colors - Teal & Coral */
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-coral-dark: #ea580c;
      
      /* Supporting Colors */
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      --gradient-subtle: linear-gradient(135deg, var(--color-teal-light) 0%, var(--color-coral-light) 100%);
      --gradient-background: linear-gradient(135deg, var(--color-white) 0%, var(--color-off-white) 100%);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-colored: 0 10px 25px -5px rgba(20, 184, 166, 0.2);
      
      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      --font-size-5xl: 3rem;
      --font-size-6xl: 3.75rem;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 0.15s ease-out;
      --transition-base: 0.2s ease-out;
      --transition-slow: 0.3s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-primary);
      margin: 0;
      padding: 0;
      background: var(--color-off-white);
      color: var(--color-navy);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      scroll-behavior: smooth;
      width: 100%;
      min-height: 100vh;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-overflow-scrolling: touch;
    }

    input,
    button,
    textarea {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      position: relative;
    }

    /* Header - Ultra Compact */
    .header {
      background:
        linear-gradient(135deg, rgba(20, 184, 166, 0.08) 0%, rgba(249, 115, 22, 0.08) 100%),
        linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%),
        rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: calc(var(--spacing-sm) * 1.2) var(--spacing-lg);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: all var(--transition-base);
      position: relative;
      overflow: hidden;
    }

    /* Playful geometric accent for header */
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 15% 50%, rgba(20, 184, 166, 0.03) 0%, transparent 30%),
        radial-gradient(circle at 85% 50%, rgba(249, 115, 22, 0.03) 0%, transparent 30%);
      pointer-events: none;
    }

    /* Subtle animated dots pattern */
    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(20, 184, 166, 0.1) 1px, transparent 1px),
        radial-gradient(circle at 80% 80%, rgba(249, 115, 22, 0.1) 1px, transparent 1px);
      background-size: 40px 40px, 60px 60px;
      opacity: 0.3;
      pointer-events: none;
    }

    /* Fix for Netlify Identity modal z-index on desktop only */
    @media (min-width: 769px) {
      .netlify-identity-widget,
      [data-netlify-identity-widget],
      .netlify-identity-widget iframe,
      .netlify-identity-widget > div,
      .netlify-identity-widget .netlify-identity-modal {
        z-index: 2147483647 !important;
      }
    }

    .header-content {
      width: 100%;
      margin: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: calc(var(--spacing-xs) * 0.8);
      padding: 0 var(--spacing-lg);
    }

    .logo {
      font-family: var(--font-secondary);
      font-size: calc(var(--font-size-lg) * 0.9);
      font-weight: 800;
      color: var(--color-navy);
      text-decoration: none;
      letter-spacing: -0.02em;
      transition: all var(--transition-base);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 10;
    }

    .logo:hover {
      opacity: 0.8;
      transform: scale(1.02);
    }

    .nav-buttons {
      display: flex;
      gap: calc(var(--spacing-md) * 1.2);
      align-items: center;
      flex-wrap: wrap;
    }

    .nav-link {
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: calc(var(--font-size-sm) * 0.95);
      transition: all var(--transition-base);
      position: relative;
      padding: calc(var(--spacing-xs) * 0.8) 0;
    }

    .nav-link:hover {
      color: var(--color-teal);
      opacity: 0.8;
    }

    .btn {
      padding: calc(var(--spacing-xs) * 0.7) calc(var(--spacing-sm) * 0.9);
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: calc(var(--font-size-xs) * 0.9);
      transition: all var(--transition-base);
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      letter-spacing: -0.01em;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
      border: 1px solid transparent;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--color-white);
      color: var(--color-navy);
      border: 2px solid var(--color-teal);
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: var(--color-teal);
      color: var(--color-white);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .header {
        padding: calc(var(--spacing-sm) * 1.0) var(--spacing-sm);
      }

      .header-content {
        flex-direction: column;
        gap: calc(var(--spacing-sm) * 0.8);
        align-items: stretch;
      }

      .logo {
        font-size: calc(var(--font-size-base) * 0.9);
        text-align: center;
      }

      .nav-buttons {
        gap: calc(var(--spacing-xs) * 0.8);
        justify-content: center;
      }

      .nav-link {
        font-size: calc(var(--font-size-xs) * 0.95);
      }
      
      .btn {
        padding: calc(var(--spacing-xs) * 0.6) calc(var(--spacing-sm) * 0.8);
        font-size: calc(var(--font-size-xs) * 0.85);
      }
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: var(--spacing-md) var(--spacing-xl);
    }

    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .page-header h1 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .page-header p {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      margin: 0;
      font-weight: 400;
    }

    .character-section {
      background: var(--color-white);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .character-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }

    .character-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .character-avatar {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-full);
      object-fit: cover;
      background: var(--color-light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-2xl);
      flex-shrink: 0;
      border: 3px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .character-avatar img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-full);
      object-fit: cover;
    }

    .character-info {
      flex: 1;
    }

    .character-info h2 {
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--color-navy);
      font-size: var(--font-size-lg);
      font-weight: 700;
      font-family: var(--font-secondary);
      letter-spacing: -0.01em;
    }

    .character-info p {
      margin: 0;
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .chat-section {
      background: var(--color-white);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .chat-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }

    .loading-state {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-xl);
      color: var(--color-gray);
    }

    .loading-state h3 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      margin: 0 0 var(--spacing-md) 0;
      color: var(--color-navy);
      font-weight: 700;
    }

    .error-state {
      text-align: center;
      padding: var(--spacing-2xl) var(--spacing-xl);
      color: #c53030;
      background: #fed7d7;
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
    }

    .error-state h3 {
      margin: 0 0 var(--spacing-xs) 0;
      color: #c53030;
      font-size: var(--font-size-2xl);
      font-family: var(--font-secondary);
      font-weight: 700;
    }

    .error-state p {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: var(--font-size-base);
    }

    .error-state a {
      color: var(--color-teal);
      text-decoration: none;
      font-weight: 600;
      transition: all var(--transition-base);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
    }

    .error-state a:hover {
      color: var(--color-white);
      background: var(--color-teal);
      transform: translateY(-1px);
    }

    #chatlog {
      height: 350px;
      overflow-y: auto;
      background: var(--color-off-white);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-sm);
      border: 2px solid var(--color-light-gray);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-base);
    }

    #chatlog:hover {
      border-color: var(--color-teal);
    }

    #chatlog p {
      margin: 0 0 var(--spacing-md) 0;
      line-height: 1.5;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      background: var(--color-white);
      box-shadow: var(--shadow-sm);
    }

    #chatlog p:last-child {
      margin-bottom: 0;
    }

    .input-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }

    #userInput {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      font-family: var(--font-primary);
      transition: all var(--transition-base);
      background: var(--color-white);
      color: var(--color-navy);
      box-shadow: var(--shadow-sm);
    }

    #userInput:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    #userInput::placeholder {
      color: var(--color-gray-light);
      font-weight: 400;
    }

    button {
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      min-width: 100px;
      box-shadow: var(--shadow-colored);
      font-family: var(--font-primary);
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    button:disabled {
      background: var(--color-gray-light);
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      text-align: center;
      line-height: 1.4;
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--color-off-white);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-light-gray);
    }

    .disclaimer-icon {
      display: inline-block;
      margin-right: var(--spacing-xs);
      color: var(--color-teal);
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      vertical-align: middle;
      margin-right: var(--spacing-xs);
      object-fit: cover;
      border: 2px solid var(--color-light-gray);
    }

    .message-avatar {
      display: inline-block;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      text-align: center;
      line-height: 24px;
      font-size: var(--font-size-xs);
      vertical-align: middle;
      margin-right: var(--spacing-xs);
      background: var(--color-light-gray);
      border: 2px solid var(--color-gray-light);
    }

    @media (max-width: 600px) {
      .container {
        padding: var(--spacing-sm) var(--spacing-lg);
      }

      .page-header h1 {
        font-size: var(--font-size-xl);
      }

      .page-header p {
        font-size: var(--font-size-xs);
      }

      .character-section,
      .chat-section {
        padding: var(--spacing-lg) var(--spacing-lg);
      }

      .character-avatar {
        width: 50px;
        height: 50px;
        font-size: var(--font-size-xl);
      }

      .character-info h2 {
        font-size: var(--font-size-base);
      }

      .character-info p {
        font-size: var(--font-size-xs);
      }

      #chatlog {
        height: 300px;
        padding: var(--spacing-md);
        font-size: var(--font-size-xs);
      }

      .input-group {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      button {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-lg);
      }

      .disclaimer {
        font-size: calc(var(--font-size-xs) * 0.9);
        padding: var(--spacing-xs) var(--spacing-sm);
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus styles for keyboard navigation */
    .btn:focus,
    button:focus,
    #userInput:focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }
  </style>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       1) Laad allereerst de Netlify Identity‚Äêwidget in de <head>
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       2) Wacht tot de DOM volledig is geladen voordat je `init()`
          van Netlify Identity aanroept. Dit voorkomt `appendChild`
          Fouten omdat de pagina al opgebouwd is.
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const netlifyIdentity = window.netlifyIdentity;
      netlifyIdentity.init();

      // Bij init: als er al een ingelogde user is, roep handleLogin aan.
      // We verwijderen hier de automatische `netlifyIdentity.open("login")`
      // zodat de login‚Äêmodal alleen opent wanneer de gebruiker w√©l op "Send" klikt.
      netlifyIdentity.on("init", (user) => {
        if (user) {
          handleLogin(user);
        }
      });

      netlifyIdentity.on("login", (user) => {
        handleLogin(user);
        netlifyIdentity.close();
      });

      netlifyIdentity.on("logout", () => {
        clearLocalAuth();
        window.location.href = "/";
      });
    });

    async function handleLogin(user) {
      const email = user.email;
      const uid   = user.id;                // Netlify UID
      const token = user.token.access_token; // Netlify JWT

      localStorage.setItem("user_email", email);
      localStorage.setItem("user_token", token);
      localStorage.setItem("user_uid", uid);
      window.isRegistered = true;

      console.log("DEBUG: handleLogin ‚Üí verstuur Webhook1:", {
        user_email: email,
        user_uid:   uid,
        user_token: token
      });

      try {
        const res = await fetch(
          "https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_email: email,
              user_uid:   uid,
              user_token: token
            })
          }
        );

        const rawText = await res.text();
        console.log("Webhook1 raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
          console.log("Webhook1 parsed JSON:", data);
        } catch (e) {
          console.warn("Webhook1: response is not JSON, skipping:", e);
        }
      } catch (err) {
        console.error("Error in registration-webhook call:", err);
      }

      // Zodra de pagina geladen is, laad de chat-geschiedenis
      if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
      ) {
        fetchHistory();
      }
    }

    function clearLocalAuth() {
      localStorage.removeItem("user_email");
      localStorage.removeItem("user_token");
      localStorage.removeItem("user_uid");
      window.isRegistered = false;
    }

    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
  </script>
  <!-- EINDE AANGEPASTE SCRIPT -->

</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="logo">Narrin AI</a>
      <nav class="nav-buttons">
        <a href="index.html" class="nav-link">Characters</a>
        <a href="chat-overview.html" class="nav-link">Chats</a>
        <a href="#" onclick="openNetlifyLogin(); return false;" class="nav-link" id="loginBtn">üë§ Login</a>
        <a href="create-character.html" class="btn btn-primary">‚ú® Create Character</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div id="loadingState" class="loading-state">
      <h3>Loading character...</h3>
      <p>Please wait while we fetch your character's information.</p>
    </div>

    <div id="errorState" class="error-state" style="display: none;">
      <h3>Character not found</h3>
      <p>The character you're looking for doesn't exist or isn't accessible.</p>
      <a href="create-character.html">Create a new character</a> or <a href="/">go back to home</a>
    </div>

    <div id="chatInterface" style="display: none;">
      <div class="page-header">
        <h1>Character Chat</h1>
        <p>Have a conversation with your AI character</p>
      </div>

      <div class="character-section">
        <div class="character-header" id="characterHeader">
          <div class="character-avatar" id="characterAvatar">üë§</div>
          <div class="character-info">
            <h2 id="characterName">Loading...</h2>
            <p id="characterTitle"></p>
          </div>
        </div>
      </div>

      <div class="chat-section">
        <div id="chatlog"></div>
        <div class="input-group">
          <input id="userInput" type="text" placeholder="Type your message here..." />
          <button onclick="handleSendClick(event)" id="sendButton">Send</button>
        </div>
        <div class="disclaimer">
          <span class="disclaimer-icon">‚ÑπÔ∏è</span>
          This is an AI chatbot and not a real person. All responses are generated by artificial intelligence and should be treated as fiction. 
          Do not rely on any information provided as factual or as professional advice. 
          The platform owner assumes no responsibility for the content generated by AI characters.
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation and Netlify Identity functions -->
  <script>

    // Netlify Identity functions (matching index.html)
    function openNetlifyLogin() {
      if (window.netlifyIdentity) {
        if (isMobileDevice()) {
          // On mobile, redirect to profile page for better UX
          window.location.href = 'profile.html';
        } else {
          // On desktop, use modal
          window.netlifyIdentity.open('login');
        }
      } else {
        console.error('Netlify Identity not loaded');
        alert('Login system not available. Please try again later.');
      }
    }

    function updateLoginButton() {
      const loginBtn = document.getElementById('loginBtn');
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      if (user) {
        loginBtn.innerHTML = 'üë§ ' + (user.user_metadata.full_name || user.email);
        loginBtn.onclick = function() {
          window.location.href = 'profile.html';
          return false;
        };
      } else {
        loginBtn.innerHTML = 'üë§ Login';
        loginBtn.onclick = function() {
          openNetlifyLogin();
          return false;
        };
      }
    }

    // Initialize login button on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          updateLoginButton();
        });

        window.netlifyIdentity.on('login', user => {
          updateLoginButton();
          window.netlifyIdentity.close();
        });

        window.netlifyIdentity.on('logout', () => {
          updateLoginButton();
        });
      }
    });
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       A) CHARACTER LOADING & SETUP
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    // Global variables
    let currentCharacter = null;
    let characterSlug = null;
    
    // FIXED: Separate endpoints for different actions
    const getCharacterEndpoint = "https://hook.eu2.make.com/c753wxuxgpcu37fol9seri6rdtpz2lju";
    const chatEndpoint = "https://hook.eu2.make.com/c753wxuxgpcu37fol9seri6rdtpz2lju";

    const params = new URLSearchParams(window.location.search);
    characterSlug = params.get("char");

    if (!characterSlug) {
      showError("No character specified in URL");
    } else {
      loadCharacter(characterSlug);
    }

    async function loadCharacter(slug) {
      try {
        console.log("Loading character:", slug);
        
        // Get user info if available
        const token = localStorage.getItem("user_token");
        const uid = localStorage.getItem("user_uid");
        const email = localStorage.getItem("user_email");
        
        // Send request with user info if available
        const requestData = {
          action: "get_character",
          slug: slug
        };
        
        // Add user info if logged in
        if (token && uid && email) {
          requestData.user_token = token;
          requestData.user_uid = uid;
          requestData.user_email = email;
        }
        
        const response = await fetch(getCharacterEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const rawText = await response.text();
        console.log("Character API response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("Invalid JSON response:", e);
          throw new Error("Invalid response format");
        }

        if (!data.character && !data.name) {
          throw new Error("Character not found");
        }

        // Handle both possible response formats
        currentCharacter = data.character || {
          name: data.name,
          character_title: data.character_title,
          avatar_url: data.avatar_url,
          character_description: data.character_description
        };
        
        setupCharacterInterface();
        
      } catch (error) {
        console.error("Error loading character:", error);
        showError("Failed to load character: " + error.message);
      }
    }

    function setupCharacterInterface() {
      if (!currentCharacter) return;

      // Update page title
      document.title = `Chat with ${currentCharacter.name}`;

      // Update character header
      document.getElementById('characterName').textContent = currentCharacter.name;
      document.getElementById('characterTitle').textContent = currentCharacter.character_title || '';

      // Update avatar
      const avatarElement = document.getElementById('characterAvatar');
      if (currentCharacter.avatar_url) {
        avatarElement.innerHTML = `<img src="${currentCharacter.avatar_url}" alt="${currentCharacter.name}">`;
      } else {
        avatarElement.innerHTML = 'üë§';
      }

      // Show chat interface, hide loading
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('chatInterface').style.display = 'block';

      // Setup input listener
      const userInput = document.getElementById("userInput");
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSendClick(e);
      });

      // Load history if user is logged in
      if (window.isRegistered) {
        fetchHistory();
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('chatInterface').style.display = 'none';
      
      // Optionally customize error message
      const errorState = document.getElementById('errorState');
      errorState.querySelector('p').textContent = message;
    }
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       B) handleSendClick() (FINAL VERSION - zonder content debug)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    function handleSendClick(event) {
      if (!currentCharacter) {
        alert("Character not loaded yet, please wait...");
        return;
      }
      
      // Better login detection - check multiple sources
      const token = localStorage.getItem("user_token");
      const uid = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      // If we have all required data OR netlify user, user is logged in
      if ((token && uid && email) || netlifyUser) {
        sendMessage(event);
        return;
      }
      
      // Not logged in - redirect to profile for login
      localStorage.setItem('login_redirect_url', window.location.href);
      window.location.href = 'profile.html';
    }
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       C) fetchHistory() (Netlify-variant)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    async function fetchHistory() {
      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !characterSlug || !email) {
        console.warn("fetchHistory: missing token, uid, email or character");
        return;
      }

      try {
        const resp = await fetch("https://hook.eu2.make.com/fjpapor4lkj9mpypaqx8no68d64bxe19", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_email: email,
            user_uid:   uid,
            user_token: token,
            char:        characterSlug
          })
        });

        if (!resp.ok) {
          console.error("fetchHistory ‚Üí resp.ok false:", resp.status, resp.statusText);
          return;
        }

        const rawText = await resp.text();
        console.log("fetchHistory raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("fetchHistory ‚Üí JSON.parse failed:", e, "Raw data:", rawText);
          return;
        }

        if (!Array.isArray(data.history)) {
          console.warn("fetchHistory ‚Üí expected data.history[] but got:", data);
          return;
        }

        const chatlog = document.getElementById("chatlog");
        data.history.forEach((record) => {
          const role    = record.fields.Role;
          const message = record.fields.Message;
          const p       = document.createElement("p");
          if (role === "user") {
            p.innerHTML = `<strong>You:</strong> ${message}`;
          } else {
            const avatarHtml = getAvatarHtml();
            p.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${message}`;
          }
          chatlog.appendChild(p);
        });

        chatlog.scrollTop = chatlog.scrollHeight;
      } catch (err) {
        console.error("fetchHistory ‚Üí Exception in fetchHistory:", err);
      }
    }

    function getAvatarHtml() {
      if (currentCharacter?.avatar_url) {
        return `<img class="avatar" src="${currentCharacter.avatar_url}" alt="avatar">`;
      }
      return '<span class="message-avatar">üë§</span>';
    }

    // Als de pagina al geladen is en user is ingelogd, laad historie
    window.addEventListener("DOMContentLoaded", () => {
      if (window.isRegistered) {
        setTimeout(() => {
          if (currentCharacter) fetchHistory();
        }, 500);
      }
    });
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       D) sendMessage() (FIXED VERSION - uses correct endpoint)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    async function sendMessage(event) {
      event?.preventDefault();
      const userInput = document.getElementById("userInput");
      const input = userInput.value.trim();
      if (!input) return;

      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !email) {
        console.error("sendMessage: missing token, uid or email");
        // Direct redirect to profile without alert
        localStorage.setItem('login_redirect_url', window.location.href);
        window.location.href = 'profile.html';
        return;
      }

      // Disable send button during request
      const sendButton = document.getElementById("sendButton");
      sendButton.disabled = true;
      sendButton.textContent = "Sending...";

      // Show user message directly
      const chatlog = document.getElementById("chatlog");
      const divUser = document.createElement("p");
      divUser.innerHTML = `<strong>You:</strong> ${input}`;
      chatlog.appendChild(divUser);
      chatlog.scrollTop = chatlog.scrollHeight;
      userInput.value = "";

      try {
        // FIXED: Use chatEndpoint instead of wrong endpoint
        const response = await fetch(chatEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "chat",
            text: input,
            slug: characterSlug,
            character_id: characterSlug,
            name: currentCharacter?.name,
            character_title: currentCharacter?.character_title,
            character_description: currentCharacter?.character_description,
            avatar_url: currentCharacter?.avatar_url,
            user_email: email,
            user_uid: uid,
            user_token: token,
            role: "user"
          })
        });

        if (!response.ok) {
          console.error("sendMessage ‚Üí response.ok false:", response.status, response.statusText);
          throw new Error(`Server returned status ${response.status}`);
        }

        const text = await response.text();
        console.log("Raw response from Make:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error("sendMessage ‚Üí JSON.parse failed:", e);
          throw new Error("Invalid JSON received from server");
        }

        const reply = data.reply || "‚ö†Ô∏è No reply.";

        // Show bot response
        const divBot = document.createElement("p");
        const avatarHtml = getAvatarHtml();
        divBot.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${reply}`;
        chatlog.appendChild(divBot);
        chatlog.scrollTop = chatlog.scrollHeight;
        
      } catch (err) {
        console.error("sendMessage ‚Üí Error in fetch or parsing:", err);
        alert("‚ùå Error sending message: " + err.message);
        const divErr = document.createElement("p");
        divErr.innerHTML = `<strong>${currentCharacter?.name || 'Character'}:</strong> ‚ö†Ô∏è Something went wrong while sending.`;
        chatlog.appendChild(divErr);
        chatlog.scrollTop = chatlog.scrollHeight;
      } finally {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.textContent = "Send";
      }
    }
  </script>
</body>
</html>