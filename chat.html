<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Chat</title>
  <!-- styles ... (laat deze ongewijzigd zoals in je originele bestand) -->
</head>
<body>
  <div class="chat-container">
    <h2 id="characterName">Loading...</h2>
    <div id="chatlog"></div>
    <div class="input-group">
      <input id="userInput" type="text" placeholder="Say something..." />
      <button onclick="sendMessage(event)">Send</button>
    </div>
  </div>

  <!-- Registratie-popup -->
  <div id="registerPopup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ccc; border-radius:8px; padding:20px; z-index:1000; max-width:90%; width:300px; box-shadow:0 0 10px rgba(0,0,0,0.2);">
    <p>Voer je e-mailadres in om een account aan te maken. Door te registreren ga je automatisch akkoord met onze voorwaarden.</p>
    <input type="email" id="emailInput" placeholder="jij@example.com" style="width:100%; padding:8px; margin-top:10px;" required>
    <button onclick="registerUser()" style="margin-top:12px;">Registreren</button>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const character = params.get("char") || "napoleon";

  const avatars = {
    napoleon: "napoleon.png",
    gandalf: "gandalf.png",
    goku: "goku.png",
    buffy: "buffy.png"
  };
  const names = {
    napoleon: "Napoleon Bonaparte",
    gandalf: "Gandalf the Grey",
    goku: "Son Goku",
    buffy: "Buffy Summers"
  };

  const endpoint = "https://hook.eu2.make.com/c753wxuxgpcu37fol9seri6rdtpz2lju";
  const avatarUrl = avatars[character];
  const displayName = names[character];

  if (!avatars[character]) {
    alert("⚠️ Unknown character, defaulting to Napoleon.");
    window.location.href = "?char=napoleon";
  }

  document.getElementById("characterName").innerText = displayName;

  const chatlog = document.getElementById("chatlog");
  const userInput = document.getElementById("userInput");
  userInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function getUserToken() {
    let token = localStorage.getItem("user_token");
    if (!token) {
      token = crypto.randomUUID();
      localStorage.setItem("user_token", token);
    }
    return token;
  }

  const userToken = localStorage.getItem("user_token");
  const userEmail = localStorage.getItem("user_email");

  if (!userToken || !userEmail) {
    showRegistrationPopup();
  }

  async function sendMessage(event) {
    event?.preventDefault();
    const input = userInput.value.trim();
    if (!input) return;

    const userMessageElement = document.createElement('p');
    userMessageElement.innerHTML = `<strong>You:</strong> ${input.replace(/\n/g, "<br>")}`;
    chatlog.appendChild(userMessageElement);
    userInput.value = "";
    chatlog.scrollTop = chatlog.scrollHeight;

    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: input,
          char: character,
          user_token: getUserToken()
        })
      });

      const text = await response.text();
      const data = JSON.parse(text);
      const reply = data.reply || "⚠️ No reply.";

      const botMessageElement = document.createElement('p');
      botMessageElement.innerHTML = `<strong><img class="avatar" src="${avatarUrl}" alt="${displayName} avatar"> ${displayName}:</strong> ${reply.replace(/\n/g, "<br>")}`;
      chatlog.appendChild(botMessageElement);

    } catch (err) {
      console.error("Error in fetch:", err);
      const errorElement = document.createElement('p');
      errorElement.innerHTML = `<strong>${displayName}:</strong> ⚠️ Something went wrong while sending.`;
      chatlog.appendChild(errorElement);
    }

    chatlog.scrollTop = chatlog.scrollHeight;
  }

  function showRegistrationPopup() {
    document.getElementById("registerPopup").style.display = "block";
  }

  async function registerUser() {
    const email = document.getElementById("emailInput").value;
    if (!email) return alert("Vul een geldig e-mailadres in");

    const token = crypto.randomUUID();
    localStorage.setItem("user_token", token);
    localStorage.setItem("user_email", email);

    await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, token })
    });

    document.getElementById("registerPopup").style.display = "none";
  }
</script>
</body>
</html>