<!-- chat.html (dynamisch template voor meerdere karakters, met Make-logica) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Chat</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #ffffff;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-overflow-scrolling: touch;
    }

    input,
    button,
    textarea {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      position: relative;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin: 0 0 10px 0;
      color: #333;
    }

    .header p {
      color: #666;
      font-size: 16px;
      margin: 0;
    }

    .character-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .character-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .character-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      flex-shrink: 0;
    }

    .character-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .character-info {
      flex: 1;
    }

    .character-info h2 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 24px;
      font-weight: 600;
    }

    .character-info p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }

    .chat-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .loading-state h3 {
      font-size: 20px;
      margin: 0 0 12px 0;
      color: #333;
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: #c53030;
      background: #fed7d7;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .error-state h3 {
      margin: 0 0 8px 0;
      color: #c53030;
      font-size: 20px;
    }

    .error-state p {
      margin: 0 0 16px 0;
      font-size: 16px;
    }

    .error-state a {
      color: #2c5282;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .error-state a:hover {
      color: #2a4e7c;
      text-decoration: underline;
    }

    #chatlog {
      height: 400px;
      overflow-y: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 16px;
      border: 1px solid #e0e0e0;
    }

    #chatlog p {
      margin: 0 0 16px 0;
      line-height: 1.5;
    }

    #chatlog p:last-child {
      margin-bottom: 0;
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    #userInput {
      flex: 1;
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    #userInput:focus {
      outline: none;
      border-color: #333;
    }

    button {
      padding: 14px 28px;
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
    }

    button:hover {
      background-color: #333;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .disclaimer {
      font-size: 12px;
      color: #666;
      text-align: center;
      line-height: 1.4;
      margin-top: 0;
    }

    .disclaimer-icon {
      display: inline-block;
      margin-right: 4px;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 8px;
      object-fit: cover;
    }

    .message-avatar {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 12px;
      vertical-align: middle;
      margin-right: 8px;
      background: #e0e0e0;
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      .header h1 {
        font-size: 28px;
      }

      .character-section,
      .chat-section {
        padding: 20px;
      }

      .character-avatar {
        width: 64px;
        height: 64px;
        font-size: 32px;
      }

      .character-info h2 {
        font-size: 20px;
      }

      #chatlog {
        height: 300px;
        padding: 16px;
        font-size: 15px;
      }

      .input-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }

      .disclaimer {
        font-size: 11px;
        padding: 0 8px;
      }
    }
  </style>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       1) Laad allereerst de Netlify Identity‚Äêwidget in de <head>
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       2) Wacht tot de DOM volledig is geladen voordat je `init()`
          van Netlify Identity aanroept. Dit voorkomt `appendChild`
          Fouten omdat de pagina al opgebouwd is.
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const netlifyIdentity = window.netlifyIdentity;
      netlifyIdentity.init();

      // Bij init: als er al een ingelogde user is, roep handleLogin aan.
      // We verwijderen hier de automatische `netlifyIdentity.open("login")`
      // zodat de login‚Äêmodal alleen opent wanneer de gebruiker w√©l op "Send" klikt.
      netlifyIdentity.on("init", (user) => {
        if (user) {
          handleLogin(user);
        }
      });

      netlifyIdentity.on("login", (user) => {
        handleLogin(user);
        netlifyIdentity.close();
      });

      netlifyIdentity.on("logout", () => {
        clearLocalAuth();
        window.location.href = "/";
      });
    });

    async function handleLogin(user) {
      const email = user.email;
      const uid   = user.id;                // Netlify UID
      const token = user.token.access_token; // Netlify JWT

      localStorage.setItem("user_email", email);
      localStorage.setItem("user_token", token);
      localStorage.setItem("user_uid", uid);
      window.isRegistered = true;

      console.log("DEBUG: handleLogin ‚Üí verstuur Webhook1:", {
        user_email: email,
        user_uid:   uid,
        user_token: token
      });

      try {
        const res = await fetch(
          "https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_email: email,
              user_uid:   uid,
              user_token: token
            })
          }
        );

        const rawText = await res.text();
        console.log("Webhook1 raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
          console.log("Webhook1 parsed JSON:", data);
        } catch (e) {
          console.warn("Webhook1: antwoord is geen JSON, sla over:", e);
        }
      } catch (err) {
        console.error("Fout in registration-webhook call:", err);
      }

      // Zodra de pagina geladen is, laad de chat-geschiedenis
      if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
      ) {
        fetchHistory();
      }
    }

    function clearLocalAuth() {
      localStorage.removeItem("user_email");
      localStorage.removeItem("user_token");
      localStorage.removeItem("user_uid");
      window.isRegistered = false;
    }
  </script>
  <!-- EINDE AANGEPASTE SCRIPT -->

</head>

<body>
  <div class="container">
    <div id="loadingState" class="loading-state">
      <h3>Loading character...</h3>
      <p>Please wait while we fetch your character's information.</p>
    </div>

    <div id="errorState" class="error-state" style="display: none;">
      <h3>Character not found</h3>
      <p>The character you're looking for doesn't exist or isn't accessible.</p>
      <a href="create-character.html">Create a new character</a> or <a href="/">go back to home</a>
    </div>

    <div id="chatInterface" style="display: none;">
      <div class="header">
        <h1>Character Chat</h1>
        <p>Have a conversation with your AI character</p>
      </div>

      <div class="character-section">
        <div class="character-header" id="characterHeader">
          <div class="character-avatar" id="characterAvatar">üë§</div>
          <div class="character-info">
            <h2 id="characterName">Loading...</h2>
            <p id="characterTitle"></p>
          </div>
        </div>
      </div>

      <div class="chat-section">
        <div id="chatlog"></div>
        <div class="input-group">
          <input id="userInput" type="text" placeholder="Type your message here..." />
          <button onclick="handleSendClick(event)" id="sendButton">Send</button>
        </div>
        <div class="disclaimer">
          <span class="disclaimer-icon">‚ÑπÔ∏è</span>
          This is an AI chatbot and not a real person. All responses are generated by artificial intelligence and should be treated as fiction. 
          Do not rely on any information provided as factual or as professional advice. 
          The platform owner assumes no responsibility for the content generated by AI characters.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       A) CHARACTER LOADING & SETUP
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    // Global variables
    let currentCharacter = null;
    let characterSlug = null;
    
    // Endpoints
    const endpoint = "https://hook.eu2.make.com/c753wxuxgpcu37fol9seri6rdtpz2lju";

    const params = new URLSearchParams(window.location.search);
    characterSlug = params.get("char");

    if (!characterSlug) {
      showError("No character specified in URL");
    } else {
      loadCharacter(characterSlug);
    }

    async function loadCharacter(slug) {
      try {
        console.log("Loading character:", slug);
        
        // Get user info if available
        const token = localStorage.getItem("user_token");
        const uid = localStorage.getItem("user_uid");
        const email = localStorage.getItem("user_email");
        
        // Send request with user info if available
        const requestData = {
          action: "get_character",
          slug: slug
        };
        
        // Add user info if logged in
        if (token && uid && email) {
          requestData.user_token = token;
          requestData.user_uid = uid;
          requestData.user_email = email;
        }
        
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const rawText = await response.text();
        console.log("Character API response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("Invalid JSON response:", e);
          throw new Error("Invalid response format");
        }

        if (!data.character && !data.name) {
          throw new Error("Character not found");
        }

        // Handle both possible response formats
        currentCharacter = data.character || {
          name: data.name,
          character_title: data.character_title,
          avatar_url: data.avatar_url,
          character_description: data.character_description
        };
        
        setupCharacterInterface();
        
      } catch (error) {
        console.error("Error loading character:", error);
        showError("Failed to load character: " + error.message);
      }
    }

    function setupCharacterInterface() {
      if (!currentCharacter) return;

      // Update page title
      document.title = `Chat with ${currentCharacter.name}`;

      // Update character header
      document.getElementById('characterName').textContent = currentCharacter.name;
      document.getElementById('characterTitle').textContent = currentCharacter.character_title || '';

      // Update avatar
      const avatarElement = document.getElementById('characterAvatar');
      if (currentCharacter.avatar_url) {
        avatarElement.innerHTML = `<img src="${currentCharacter.avatar_url}" alt="${currentCharacter.name}">`;
      } else {
        avatarElement.innerHTML = 'üë§';
      }

      // Show chat interface, hide loading
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('chatInterface').style.display = 'block';

      // Setup input listener
      const userInput = document.getElementById("userInput");
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSendClick(e);
      });

      // Load history if user is logged in
      if (window.isRegistered) {
        fetchHistory();
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('chatInterface').style.display = 'none';
      
      // Optionally customize error message
      const errorState = document.getElementById('errorState');
      errorState.querySelector('p').textContent = message;
    }
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       B) handleSendClick() (FIXED VERSION - zorgt dat login‚Äêmodal alleen opent als niet ingelogd)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    function handleSendClick(event) {
      if (!currentCharacter) {
        alert("Character not loaded yet, please wait...");
        return;
      }
      
      // Check if user is logged in by checking the current Netlify Identity user
      const currentUser = netlifyIdentity.currentUser();
      
      if (!currentUser || !window.isRegistered) {
        // Only open login modal if user is not logged in
        netlifyIdentity.open("login");
        return;
      }
      
      // User is logged in, proceed with sending the message
      sendMessage(event);
    }
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       C) fetchHistory() (Netlify-variant)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    async function fetchHistory() {
      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !characterSlug || !email) {
        console.warn("fetchHistory: mist token, uid, email of character");
        return;
      }

      try {
        const resp = await fetch("https://hook.eu2.make.com/fjpapor4lkj9mpypaqx8no68d64bxe19", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_email: email,
            user_uid:   uid,
            user_token: token,
            char:        characterSlug
          })
        });

        if (!resp.ok) {
          console.error("fetchHistory ‚Üí resp.ok false:", resp.status, resp.statusText);
          return;
        }

        const rawText = await resp.text();
        console.log("fetchHistory raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("fetchHistory ‚Üí JSON.parse mislukte:", e, "Raw data:", rawText);
          return;
        }

        if (!Array.isArray(data.history)) {
          console.warn("fetchHistory ‚Üí verwacht data.history[] maar kreeg:", data);
          return;
        }

        const chatlog = document.getElementById("chatlog");
        data.history.forEach((record) => {
          const role    = record.fields.Role;
          const message = record.fields.Message;
          const p       = document.createElement("p");
          if (role === "user") {
            p.innerHTML = `<strong>You:</strong> ${message}`;
          } else {
            const avatarHtml = getAvatarHtml();
            p.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${message}`;
          }
          chatlog.appendChild(p);
        });

        chatlog.scrollTop = chatlog.scrollHeight;
      } catch (err) {
        console.error("fetchHistory ‚Üí Uitzondering bij fetchHistory:", err);
      }
    }

    function getAvatarHtml() {
      if (currentCharacter?.avatar_url) {
        return `<img class="avatar" src="${currentCharacter.avatar_url}" alt="avatar">`;
      }
      return '<span class="message-avatar">üë§</span>';
    }

    // Als de pagina al geladen is en user is ingelogd, laad historie
    window.addEventListener("DOMContentLoaded", () => {
      if (window.isRegistered) {
        setTimeout(() => {
          if (currentCharacter) fetchHistory();
        }, 500);
      }
    });
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       D) sendMessage() (Netlify-variant)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    async function sendMessage(event) {
      event?.preventDefault();
      const userInput = document.getElementById("userInput");
      const input = userInput.value.trim();
      if (!input) return;

      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !email) {
        console.error("sendMessage: mist token, uid of email");
        alert("Je bent niet (goed) ingelogd.");
        return;
      }

      // Disable send button during request
      const sendButton = document.getElementById("sendButton");
      sendButton.disabled = true;
      sendButton.textContent = "Sending...";

      // Toon direct het user-bericht
      const chatlog = document.getElementById("chatlog");
      const divUser = document.createElement("p");
      divUser.innerHTML = `<strong>You:</strong> ${input}`;
      chatlog.appendChild(divUser);
      chatlog.scrollTop = chatlog.scrollHeight;
      userInput.value = "";

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text:       input,
            char:       characterSlug,
            user_email: email,
            user_uid:   uid,
            user_token: token
          })
        });

        if (!response.ok) {
          console.error("sendMessage ‚Üí response.ok false:", response.status, response.statusText);
          throw new Error(`Server gaf status ${response.status} terug`);
        }

        const text = await response.text();
        console.log("Ruwe response van Make:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error("sendMessage ‚Üí JSON.parse mislukte:", e);
          throw new Error("Ongeldige JSON ontvangen van server");
        }

        const reply = data.reply || "‚ö†Ô∏è No reply.";

        // Toon bot-antwoord
        const divBot = document.createElement("p");
        const avatarHtml = getAvatarHtml();
        divBot.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${reply}`;
        chatlog.appendChild(divBot);
        chatlog.scrollTop = chatlog.scrollHeight;
        
      } catch (err) {
        console.error("sendMessage ‚Üí Fout in fetch of parsing:", err);
        alert("‚ùå Fout bij verzenden: " + err.message);
        const divErr = document.createElement("p");
        divErr.innerHTML = `<strong>${currentCharacter?.name || 'Character'}:</strong> ‚ö†Ô∏è Er ging iets mis bij het versturen.`;
        chatlog.appendChild(divErr);
        chatlog.scrollTop = chatlog.scrollHeight;
      } finally {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.textContent = "Send";
      }
    }
  </script>
</body>
</html>