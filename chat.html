<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Chat - Narrin AI</title>
  
  <!-- Import Modern Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS CUSTOM PROPERTIES ===== */
    :root {
      /* Primary Colors */
      --color-white: #ffffff;
      --color-off-white: #fafafa;
      --color-light-gray: #f5f5f5;
      
      /* Accent Colors */
      --color-teal: #14b8a6;
      --color-teal-light: #5eead4;
      --color-teal-dark: #0f766e;
      --color-teal-alt: #10a394;
      --color-coral: #f97316;
      --color-coral-light: #fb923c;
      --color-coral-dark: #ea580c;
      
      /* Supporting Colors */
      --color-navy: #1e293b;
      --color-navy-light: #334155;
      --color-gray: #64748b;
      --color-gray-light: #94a3b8;
      --color-gray-dark: #475569;
      
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, var(--color-teal) 0%, var(--color-coral) 100%);
      --gradient-subtle: linear-gradient(135deg, var(--color-teal-light) 0%, var(--color-coral-light) 100%);
      --gradient-tags: linear-gradient(135deg, var(--color-teal-alt) 0%, var(--color-coral) 100%);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-colored: 0 10px 25px -5px rgba(20, 184, 166, 0.2);
      
      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;
      
      /* Typography */
      --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-secondary: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Font Sizes */
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms ease-out;
      --transition-base: 300ms ease-out;
      --transition-slow: 500ms ease-out;
      
      /* Touch Target Size */
      --touch-target: 44px;
      
      /* Z-index Scale */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-overlay: 300;
      --z-modal: 400;
      --z-menu-overlay: 500;
    }

    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      overflow-x: hidden;
    }

    body {
      font-family: var(--font-primary);
      background: var(--color-off-white);
      color: var(--color-navy);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      width: 100%;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-overflow-scrolling: touch;
    }

    input,
    button,
    textarea {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      position: relative;
    }

    /* ===== ACCESSIBILITY ===== */
    :focus {
      outline: 2px solid var(--color-teal);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    /* ===== HEADER NAVIGATION ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: all var(--transition-base);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--spacing-lg);
      width: 100%;
      overflow: hidden;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 72px;
      gap: var(--spacing-lg);
      width: 100%;
    }

    /* Logo */
    .logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-xl);
      font-weight: 800;
      text-decoration: none;
      letter-spacing: -0.02em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: transform var(--transition-base);
      flex-shrink: 0;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    /* Desktop Navigation Center */
    .nav-center {
      display: none;
      align-items: center;
      gap: var(--spacing-2xl);
      flex: 1;
      justify-content: center;
    }

    /* USPs Container - Desktop */
    .nav-usps {
      display: flex;
      align-items: center;
      gap: var(--spacing-xl);
    }

    .usp-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-gray-dark);
      font-size: var(--font-size-xs);
      font-weight: 500;
      white-space: nowrap;
    }

    .usp-icon {
      font-size: var(--font-size-lg);
      color: var(--color-teal);
    }

    /* Search Bar - Desktop */
    .nav-search {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .nav-search-input {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-lg);
      padding-right: calc(var(--spacing-lg) * 2.5);
      font-size: var(--font-size-sm);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .nav-search-input:hover {
      border-color: var(--color-gray-light);
    }

    .nav-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .nav-search-input::placeholder {
      color: var(--color-gray-light);
    }

    .search-submit {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .search-submit:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .search-submit svg {
      width: 18px;
      height: 18px;
      color: var(--color-white);
    }

    /* Navigation Links - Desktop */
    .nav-links {
      display: none;
      align-items: center;
      gap: var(--spacing-xl);
    }

    .nav-link {
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-sm);
      transition: color var(--transition-base);
      position: relative;
      padding: var(--spacing-xs) 0;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--gradient-primary);
      transition: width var(--transition-base);
    }

    .nav-link:hover {
      color: var(--color-teal);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-sm);
      font-weight: 600;
      text-decoration: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      min-height: var(--touch-target);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      box-shadow: var(--shadow-colored);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Mobile Navigation Container */
    .mobile-nav-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-shrink: 0;
    }

    /* Mobile USP Carousel */
    .mobile-usp-carousel {
      display: none;
      align-items: center;
      justify-content: center;
      height: 24px;
      overflow: hidden;
      position: relative;
      flex: 1;
      min-width: 0;
    }

    .mobile-usp-track {
      display: flex;
      flex-direction: column;
      transition: transform var(--transition-slow);
      height: 300%;
    }

    .mobile-usp-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-gray-dark);
      font-size: var(--font-size-xs);
      font-weight: 500;
      white-space: nowrap;
      min-height: 100%;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Mobile Search Button */
    .mobile-search-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .mobile-search-btn:hover {
      background: var(--color-light-gray);
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Hamburger Menu */
    .mobile-menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--color-navy);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      position: relative;
      flex-shrink: 0;
      z-index: var(--z-menu-overlay);
    }

    .mobile-menu-btn:hover {
      background: var(--color-light-gray);
    }

    .hamburger {
      width: 24px;
      height: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: var(--color-navy);
      border-radius: 1px;
      transition: all var(--transition-base);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }

    .mobile-menu-btn.active .hamburger span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* Mobile Menu Overlay - Full Screen */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: var(--z-overlay);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mobile-menu-content {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: var(--spacing-3xl) var(--spacing-xl);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all var(--transition-base);
    }

    .mobile-menu-overlay.active .mobile-menu-content {
      transform: scale(1) translateY(0);
    }

    .mobile-menu-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .mobile-menu-logo {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .mobile-menu-subtitle {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
    }

    .mobile-menu-nav {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .mobile-menu-link {
      display: flex;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      color: var(--color-navy);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-base);
      transition: all var(--transition-base);
      border-radius: var(--radius-md);
      background: var(--color-off-white);
    }

    .mobile-menu-link:hover {
      background: var(--color-light-gray);
      color: var(--color-teal);
      transform: translateX(4px);
    }

    .mobile-menu-link.btn-primary {
      background: var(--gradient-primary);
      color: var(--color-white);
      justify-content: center;
      font-weight: 700;
      margin-top: var(--spacing-lg);
    }

    .mobile-menu-link.btn-primary:hover {
      background: var(--gradient-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .mobile-menu-link-icon {
      margin-right: var(--spacing-sm);
      font-size: var(--font-size-lg);
    }

    /* Mobile Search Overlay */
    .mobile-search-overlay {
      position: fixed;
      top: 72px;
      left: 0;
      right: 0;
      background: var(--color-white);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: var(--z-dropdown);
    }

    .mobile-search-overlay.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .mobile-search-form {
      display: flex;
      gap: var(--spacing-sm);
    }

    .mobile-search-input {
      flex: 1;
      padding: var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-md);
      background: var(--color-white);
      color: var(--color-navy);
      transition: all var(--transition-base);
    }

    .mobile-search-input:focus {
      border-color: var(--color-teal);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* Desktop Styles */
    @media (min-width: 769px) {
      .nav-center {
        display: flex;
      }

      .nav-links {
        display: flex;
      }

      .mobile-nav-container {
        display: none;
      }

      .mobile-usp-carousel {
        display: none !important;
      }

      .mobile-search-btn {
        display: none !important;
      }

      .mobile-menu-btn {
        display: none !important;
      }

      .mobile-menu-overlay {
        display: none !important;
      }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .header-container {
        padding: 0 var(--spacing-md);
      }

      .header-content {
        min-height: 60px;
        gap: var(--spacing-sm);
        padding: 0;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        align-items: center;
      }

      .logo {
        font-size: var(--font-size-lg);
        flex-shrink: 0;
        min-width: fit-content;
        grid-column: 1;
      }

      .mobile-usp-carousel {
        display: flex;
        height: 24px;
        overflow: hidden;
        position: relative;
        grid-column: 2;
        justify-self: center;
        align-items: center;
        justify-content: center;
      }

      .mobile-nav-container {
        flex-shrink: 0;
        min-width: fit-content;
        display: flex !important;
        gap: var(--spacing-xs);
        grid-column: 3 / 5;
        justify-self: end;
      }

      .nav-center {
        display: none !important;
      }

      .nav-links {
        display: none !important;
      }

      .mobile-search-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-menu-btn {
        display: flex;
        flex-shrink: 0;
      }

      .mobile-search-overlay {
        top: 60px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .header-content {
        gap: var(--spacing-xs);
        grid-template-columns: auto 1fr auto auto;
      }
      
      .logo {
        font-size: var(--font-size-base);
      }
    }

    /* Netlify Identity Modal Positioning */
    .netlify-identity-widget,
    [data-netlify-identity-widget] {
      z-index: 2147483647 !important;
    }

    .netlify-identity-widget iframe,
    .netlify-identity-widget > div,
    .netlify-identity-widget .netlify-identity-modal {
      z-index: 2147483647 !important;
    }

    /* CHAT SPECIFIC STYLES */
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: var(--spacing-md) var(--spacing-xl);
    }

    .page-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .page-header h1 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--color-navy);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .page-header p {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      margin: 0;
      font-weight: 400;
    }

    .character-section {
      background: var(--color-white);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .character-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }

    .character-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .character-avatar {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-full);
      object-fit: cover;
      background: var(--color-light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-2xl);
      flex-shrink: 0;
      border: 3px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .character-avatar img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-full);
      object-fit: cover;
    }

    .character-info {
      flex: 1;
    }

    .character-info h2 {
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--color-navy);
      font-size: var(--font-size-lg);
      font-weight: 700;
      font-family: var(--font-secondary);
      letter-spacing: -0.01em;
    }

    .character-info p {
      margin: 0;
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .chat-section {
      background: var(--color-white);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 2px solid var(--color-light-gray);
      transition: all var(--transition-base);
    }

    .chat-section:hover {
      border-color: var(--color-teal);
      box-shadow: var(--shadow-lg);
    }

    .loading-state {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-xl);
      color: var(--color-gray);
    }

    .loading-state h3 {
      font-family: var(--font-secondary);
      font-size: var(--font-size-2xl);
      margin: 0 0 var(--spacing-md) 0;
      color: var(--color-navy);
      font-weight: 700;
    }

    .error-state {
      text-align: center;
      padding: var(--spacing-2xl) var(--spacing-xl);
      color: #c53030;
      background: #fed7d7;
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
    }

    .error-state h3 {
      margin: 0 0 var(--spacing-xs) 0;
      color: #c53030;
      font-size: var(--font-size-2xl);
      font-family: var(--font-secondary);
      font-weight: 700;
    }

    .error-state p {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: var(--font-size-base);
    }

    .error-state a {
      color: var(--color-teal);
      text-decoration: none;
      font-weight: 600;
      transition: all var(--transition-base);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
    }

    .error-state a:hover {
      color: var(--color-white);
      background: var(--color-teal);
      transform: translateY(-1px);
    }

    #chatlog {
      height: 350px;
      overflow-y: auto;
      background: var(--color-off-white);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-sm);
      border: 2px solid var(--color-light-gray);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-base);
    }

    #chatlog:hover {
      border-color: var(--color-teal);
    }

    #chatlog p {
      margin: 0 0 var(--spacing-md) 0;
      line-height: 1.5;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      background: var(--color-white);
      box-shadow: var(--shadow-sm);
    }

    #chatlog p:last-child {
      margin-bottom: 0;
    }

    .input-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }

    #userInput {
      flex: 1;
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-full);
      font-family: var(--font-primary);
      transition: all var(--transition-base);
      background: var(--color-white);
      color: var(--color-navy);
      box-shadow: var(--shadow-sm);
    }

    #userInput:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    #userInput::placeholder {
      color: var(--color-gray-light);
      font-weight: 400;
    }

    #sendButton {
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--gradient-primary);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      min-width: 100px;
      box-shadow: var(--shadow-colored);
      font-family: var(--font-primary);
    }

    #sendButton:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    #sendButton:disabled {
      background: var(--color-gray-light);
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-gray);
      text-align: center;
      line-height: 1.4;
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--color-off-white);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-light-gray);
    }

    .disclaimer-icon {
      display: inline-block;
      margin-right: var(--spacing-xs);
      color: var(--color-teal);
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      vertical-align: middle;
      margin-right: var(--spacing-xs);
      object-fit: cover;
      border: 2px solid var(--color-light-gray);
    }

    .message-avatar {
      display: inline-block;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      text-align: center;
      line-height: 24px;
      font-size: var(--font-size-xs);
      vertical-align: middle;
      margin-right: var(--spacing-xs);
      background: var(--color-light-gray);
      border: 2px solid var(--color-gray-light);
    }

    @media (max-width: 600px) {
      .container {
        padding: var(--spacing-sm) var(--spacing-lg);
      }

      .page-header h1 {
        font-size: var(--font-size-xl);
      }

      .page-header p {
        font-size: var(--font-size-xs);
      }

      .character-section,
      .chat-section {
        padding: var(--spacing-lg) var(--spacing-lg);
      }

      .character-avatar {
        width: 50px;
        height: 50px;
        font-size: var(--font-size-xl);
      }

      .character-info h2 {
        font-size: var(--font-size-base);
      }

      .character-info p {
        font-size: var(--font-size-xs);
      }

      #chatlog {
        height: 300px;
        padding: var(--spacing-md);
        font-size: var(--font-size-xs);
      }

      .input-group {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      #sendButton {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-lg);
      }

      .disclaimer {
        font-size: calc(var(--font-size-xs) * 0.9);
        padding: var(--spacing-xs) var(--spacing-sm);
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const netlifyIdentity = window.netlifyIdentity;
      netlifyIdentity.init();

      netlifyIdentity.on("init", (user) => {
        if (user) {
          handleLogin(user);
        }
      });

      netlifyIdentity.on("login", (user) => {
        handleLogin(user);
        netlifyIdentity.close();
      });

      netlifyIdentity.on("logout", () => {
        clearLocalAuth();
        window.location.href = "/";
      });
    });

    async function handleLogin(user) {
      const email = user.email;
      const uid   = user.id;
      const token = user.token.access_token;

      localStorage.setItem("user_email", email);
      localStorage.setItem("user_token", token);
      localStorage.setItem("user_uid", uid);
      window.isRegistered = true;

      console.log("DEBUG: handleLogin → verstuur Webhook1:", {
        user_email: email,
        user_uid:   uid,
        user_token: token
      });

      try {
        const res = await fetch(
          "https://hook.eu2.make.com/03ug6qzucda4ksrkcc06nu3bu3vetj15",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_email: email,
              user_uid:   uid,
              user_token: token
            })
          }
        );

        const rawText = await res.text();
        console.log("Webhook1 raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
          console.log("Webhook1 parsed JSON:", data);
        } catch (e) {
          console.warn("Webhook1: response is not JSON, skipping:", e);
        }
      } catch (err) {
        console.error("Error in registration-webhook call:", err);
      }

      if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
      ) {
        fetchHistory();
      }
    }

    function clearLocalAuth() {
      localStorage.removeItem("user_email");
      localStorage.removeItem("user_token");
      localStorage.removeItem("user_uid");
      window.isRegistered = false;
    }

    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
  </script>
</head>

<body>
  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-container">
      <div class="header-content">
        <!-- Logo -->
        <a href="index.html" class="logo" aria-label="Narrin AI Home">Narrin AI</a>

        <!-- Desktop Navigation Center -->
        <nav class="nav-center" role="navigation" aria-label="Main navigation">
          <!-- USPs - All visible on desktop -->
          <div class="nav-usps" aria-label="Key features">
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🔒</span>
              <span>100% Safe</span>
            </div>
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🧠</span>
              <span>Character Memory</span>
            </div>
            <div class="usp-item">
              <span class="usp-icon" aria-hidden="true">🔐</span>
              <span>Private Data</span>
            </div>
          </div>

          <!-- Search Bar - Always visible on desktop -->
          <form class="nav-search" role="search">
            <input 
              type="search" 
              class="nav-search-input" 
              placeholder="Search characters..." 
              aria-label="Search characters"
            />
            <button type="submit" class="search-submit" aria-label="Submit search">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </button>
          </form>
        </nav>

        <!-- Desktop Navigation Links -->
        <nav class="nav-links" role="navigation" aria-label="Secondary navigation">
          <a href="index.html" class="nav-link">Characters</a>
          <a href="chat-overview.html" class="nav-link">Chats</a>
          <a href="profile.html" class="nav-link" id="loginBtn">Login/Register</a>
          <a href="create-character.html" class="btn btn-primary">✨ Create Character</a>
        </nav>

        <!-- Mobile Navigation Container -->
        <div class="mobile-nav-container">
          <!-- Mobile USP Carousel -->
          <div class="mobile-usp-carousel" aria-label="Key features carousel">
            <div class="mobile-usp-track" id="uspTrack">
              <div class="mobile-usp-item">
                <span class="usp-icon" aria-hidden="true">🔒</span>
                <span>100% Safe</span>
              </div>
              <div class="mobile-usp-item">
                <span class="usp-icon" aria-hidden="true">🧠</span>
                <span>Character Memory</span>
              </div>
              <div class="mobile-usp-item">
                <span class="usp-icon" aria-hidden="true">🔐</span>
                <span>Private Data</span>
              </div>
            </div>
          </div>

          <!-- Mobile Search Button -->
          <button 
            class="mobile-search-btn" 
            id="mobileSearchBtn"
            aria-label="Open search"
            aria-expanded="false"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>

          <!-- Mobile Hamburger Menu -->
          <button
            class="mobile-menu-btn"
            id="mobileMenuBtn"
            aria-label="Open navigation menu"
            aria-expanded="false"
          >
            <div class="hamburger">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Search Overlay -->
    <div class="mobile-search-overlay" id="mobileSearchOverlay">
      <form class="mobile-search-form" role="search">
        <input 
          type="search" 
          class="mobile-search-input" 
          placeholder="Search characters..." 
          aria-label="Search characters"
          id="mobileSearchInput"
        />
        <button type="submit" class="btn btn-primary" aria-label="Submit search">
          Search
        </button>
      </form>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-menu-logo">Narrin AI</div>
        <div class="mobile-menu-subtitle">AI Character Chat</div>
      </div>
      <nav class="mobile-menu-nav" role="navigation" aria-label="Mobile navigation">
        <a href="index.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">🏠</span>
          Characters
        </a>
        <a href="chat-overview.html" class="mobile-menu-link">
          <span class="mobile-menu-link-icon">💬</span>
          Chats
        </a>
        <a href="profile.html" class="mobile-menu-link" id="mobileLoginBtn">
          <span class="mobile-menu-link-icon">👤</span>
          Login/Register
        </a>
        <a href="create-character.html" class="mobile-menu-link btn-primary">
          <span class="mobile-menu-link-icon">✨</span>
          Create Character
        </a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div id="loadingState" class="loading-state">
      <h3>Loading character...</h3>
      <p>Please wait while we fetch your character's information.</p>
    </div>

    <div id="errorState" class="error-state" style="display: none;">
      <h3>Character not found</h3>
      <p>The character you're looking for doesn't exist or isn't accessible.</p>
      <a href="create-character.html">Create a new character</a> or <a href="/">go back to home</a>
    </div>

    <div id="chatInterface" style="display: none;">
      <div class="page-header">
        <h1>Character Chat</h1>
        <p>Have a conversation with your AI character</p>
      </div>

      <div class="character-section">
        <div class="character-header" id="characterHeader">
          <div class="character-avatar" id="characterAvatar">👤</div>
          <div class="character-info">
            <h2 id="characterName">Loading...</h2>
            <p id="characterTitle"></p>
          </div>
        </div>
      </div>

      <div class="chat-section">
        <div id="chatlog"></div>
        <div class="input-group">
          <input id="userInput" type="text" placeholder="Type your message here..." />
          <button onclick="handleSendClick(event)" id="sendButton">Send</button>
        </div>
        <div class="disclaimer">
          <span class="disclaimer-icon">ℹ️</span>
          This is an AI chatbot and not a real person. All responses are generated by artificial intelligence and should be treated as fiction. 
          Do not rely on any information provided as factual or as professional advice. 
          The platform owner assumes no responsibility for the content generated by AI characters.
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation and Chat Scripts -->
  <script>
    // ===== NAVIGATION FUNCTIONALITY =====
    
    // Mobile Search Elements
    const mobileSearchBtn = document.getElementById('mobileSearchBtn');
    const mobileSearchOverlay = document.getElementById('mobileSearchOverlay');
    const mobileSearchInput = document.getElementById('mobileSearchInput');
    
    // Mobile Menu Elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    // USP Carousel Elements
    const uspTrack = document.getElementById('uspTrack');
    let currentUspIndex = 0;
    let uspInterval;

    // ===== MOBILE SEARCH FUNCTIONALITY =====
    function toggleMobileSearch() {
      const isActive = mobileSearchOverlay.classList.contains('active');
      
      if (isActive) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      } else {
        // Close mobile menu if open
        closeMobileMenu();
        
        mobileSearchOverlay.classList.add('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'true');
        mobileSearchInput.focus();
      }
    }

    mobileSearchBtn?.addEventListener('click', toggleMobileSearch);

    // ===== MOBILE MENU FUNCTIONALITY =====
    function toggleMobileMenu() {
      const isActive = mobileMenuOverlay.classList.contains('active');
      
      if (isActive) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    }

    function openMobileMenu() {
      // Close search overlay if open
      if (mobileSearchOverlay.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
      
      mobileMenuOverlay.classList.add('active');
      mobileMenuBtn.classList.add('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      mobileMenuOverlay.classList.remove('active');
      mobileMenuBtn.classList.remove('active');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }

    mobileMenuBtn?.addEventListener('click', toggleMobileMenu);

    // Close menu when clicking on overlay background
    mobileMenuOverlay?.addEventListener('click', (e) => {
      if (e.target === mobileMenuOverlay) {
        closeMobileMenu();
      }
    });

    // Close menu when clicking on a menu item
    document.querySelectorAll('.mobile-menu-link').forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });

    // Close search and menu on outside click
    document.addEventListener('click', (e) => {
      // Close search overlay
      if (!mobileSearchOverlay?.contains(e.target) &&
          !mobileSearchBtn?.contains(e.target) &&
          mobileSearchOverlay?.classList.contains('active')) {
        mobileSearchOverlay.classList.remove('active');
        mobileSearchBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (mobileMenuOverlay.classList.contains('active')) {
          closeMobileMenu();
        }
        if (mobileSearchOverlay.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // ===== USP CAROUSEL FUNCTIONALITY =====
    function startUspCarousel() {
      if (window.innerWidth <= 768 && uspTrack) {
        uspInterval = setInterval(() => {
          currentUspIndex = (currentUspIndex + 1) % 3;
          uspTrack.style.transform = `translateY(-${currentUspIndex * 33.333}%)`;
        }, 3000);
      }
    }

    function stopUspCarousel() {
      if (uspInterval) {
        clearInterval(uspInterval);
        uspInterval = null;
      }
    }

    // Handle responsive behavior
    function handleResize() {
      if (window.innerWidth > 768) {
        stopUspCarousel();
        if (uspTrack) {
          uspTrack.style.transform = '';
        }
        if (mobileSearchOverlay?.classList.contains('active')) {
          mobileSearchOverlay.classList.remove('active');
          mobileSearchBtn?.setAttribute('aria-expanded', 'false');
        }
        if (mobileMenuOverlay?.classList.contains('active')) {
          closeMobileMenu();
        }
      } else {
        startUspCarousel();
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      handleResize();
    });

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(handleResize, 250);
    });

    // ===== SEARCH FUNCTIONALITY =====
    function handleSearch(searchTerm) {
      console.log('Search term:', searchTerm);
      // Implement search functionality here
    }

    // Desktop search
    document.querySelector('.nav-search')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.nav-search-input');
      handleSearch(searchInput.value);
    });

    // Mobile search
    document.querySelector('.mobile-search-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchInput = e.target.querySelector('.mobile-search-input');
      handleSearch(searchInput.value);
      toggleMobileSearch();
    });

    // ===== NETLIFY IDENTITY BUTTON UPDATES =====
    function updateLoginButton() {
      const loginBtn = document.getElementById('loginBtn');
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      if (user) {
        const displayName = user.user_metadata.full_name || user.email;
        if (loginBtn) {
          loginBtn.textContent = displayName;
          loginBtn.href = 'profile.html';
        }
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">👤</span>'}${displayName}`;
        }
      } else {
        if (loginBtn) {
          loginBtn.textContent = 'Login/Register';
          loginBtn.href = 'profile.html';
        }
        if (mobileLoginBtn) {
          const icon = mobileLoginBtn.querySelector('.mobile-menu-link-icon');
          mobileLoginBtn.innerHTML = `${icon ? icon.outerHTML : '<span class="mobile-menu-link-icon">👤</span>'}Login/Register`;
        }
      }
    }

    // Initialize login button on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          updateLoginButton();
        });

        window.netlifyIdentity.on('login', user => {
          updateLoginButton();
          window.netlifyIdentity.close();
        });

        window.netlifyIdentity.on('logout', () => {
          updateLoginButton();
        });
      }
    });

    // ===== CHARACTER LOADING & SETUP =====
    let currentCharacter = null;
    let characterSlug = null;
    
    // NIEUWE WEBHOOK URL
    const newWebhookUrl = "https://hook.eu2.make.com/36bygx4a2y4bkl97wkdjdmtn3o9ygjms";

    const params = new URLSearchParams(window.location.search);
    characterSlug = params.get("char");

    if (!characterSlug) {
      showError("No character specified in URL");
    } else {
      loadCharacter(characterSlug);
    }

    async function loadCharacter(slug) {
      try {
        console.log("Loading character:", slug);
        
        const token = localStorage.getItem("user_token");
        const uid = localStorage.getItem("user_uid");
        const email = localStorage.getItem("user_email");
        
        const requestData = {
          action: "get_character",
          Slug: slug,
          user_uid: uid || "",
          user_token: token || "",
          user_email: email || ""
        };
        
        const response = await fetch(newWebhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log("Character API response:", data);

        if (!data.success || !data.character) {
          throw new Error("Character not found");
        }

        currentCharacter = data.character;
        setupCharacterInterface();
        
      } catch (error) {
        console.error("Error loading character:", error);
        showError("Failed to load character: " + error.message);
      }
    }

    function setupCharacterInterface() {
      if (!currentCharacter) return;

      document.title = `Chat with ${currentCharacter.name}`;
      document.getElementById('characterName').textContent = currentCharacter.name;
      document.getElementById('characterTitle').textContent = currentCharacter.character_title || '';

      const avatarElement = document.getElementById('characterAvatar');
      if (currentCharacter.avatar_url) {
        avatarElement.innerHTML = `<img src="${currentCharacter.avatar_url}" alt="${currentCharacter.name}">`;
      } else {
        avatarElement.innerHTML = '👤';
      }

      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('chatInterface').style.display = 'block';

      const userInput = document.getElementById("userInput");
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSendClick(e);
      });

      if (window.isRegistered) {
        fetchHistory();
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('chatInterface').style.display = 'none';
      
      const errorState = document.getElementById('errorState');
      errorState.querySelector('p').textContent = message;
    }

    // ===== CHAT FUNCTIONALITY =====
    function handleSendClick(event) {
      if (!currentCharacter) {
        alert("Character not loaded yet, please wait...");
        return;
      }
      
      const token = localStorage.getItem("user_token");
      const uid = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      const netlifyUser = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      
      if ((token && uid && email) || netlifyUser) {
        sendMessage(event);
        return;
      }
      
      localStorage.setItem('login_redirect_url', window.location.href);
      window.location.href = 'profile.html';
    }

    async function fetchHistory() {
      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !characterSlug || !email) {
        console.warn("fetchHistory: missing token, uid, email or character");
        return;
      }

      try {
        const resp = await fetch("https://hook.eu2.make.com/fjpapor4lkj9mpypaqx8no68d64bxe19", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_email: email,
            user_uid:   uid,
            user_token: token,
            char:        characterSlug
          })
        });

        if (!resp.ok) {
          console.error("fetchHistory → resp.ok false:", resp.status, resp.statusText);
          return;
        }

        const rawText = await resp.text();
        console.log("fetchHistory raw response:", rawText);

        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          console.error("fetchHistory → JSON.parse failed:", e, "Raw data:", rawText);
          return;
        }

        if (!Array.isArray(data.history)) {
          console.warn("fetchHistory → expected data.history[] but got:", data);
          return;
        }

        const chatlog = document.getElementById("chatlog");
        data.history.forEach((record) => {
          const role    = record.fields.Role;
          const message = record.fields.Message;
          const p       = document.createElement("p");
          if (role === "user") {
            p.innerHTML = `<strong>You:</strong> ${message}`;
          } else {
            const avatarHtml = getAvatarHtml();
            p.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${message}`;
          }
          chatlog.appendChild(p);
        });

        chatlog.scrollTop = chatlog.scrollHeight;
      } catch (err) {
        console.error("fetchHistory → Exception in fetchHistory:", err);
      }
    }

    function getAvatarHtml() {
      if (currentCharacter?.avatar_url) {
        return `<img class="avatar" src="${currentCharacter.avatar_url}" alt="avatar">`;
      }
      return '<span class="message-avatar">👤</span>';
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (window.isRegistered) {
        setTimeout(() => {
          if (currentCharacter) fetchHistory();
        }, 500);
      }
    });

    async function sendMessage(event) {
      event?.preventDefault();
      const userInput = document.getElementById("userInput");
      const input = userInput.value.trim();
      if (!input) return;

      const token = localStorage.getItem("user_token");
      const uid   = localStorage.getItem("user_uid");
      const email = localStorage.getItem("user_email");
      if (!token || !uid || !email) {
        console.error("sendMessage: missing token, uid or email");
        localStorage.setItem('login_redirect_url', window.location.href);
        window.location.href = 'profile.html';
        return;
      }

      const sendButton = document.getElementById("sendButton");
      sendButton.disabled = true;
      sendButton.textContent = "Sending...";

      const chatlog = document.getElementById("chatlog");
      const divUser = document.createElement("p");
      divUser.innerHTML = `<strong>You:</strong> ${input}`;
      chatlog.appendChild(divUser);
      chatlog.scrollTop = chatlog.scrollHeight;
      userInput.value = "";

      try {
        const response = await fetch(newWebhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "send_message",
            text: input,
            Character_id: characterSlug,
            Slug: characterSlug,
            user_uid: uid,
            user_token: token,
            user_email: email
          })
        });

        if (!response.ok) {
          console.error("sendMessage → response.ok false:", response.status, response.statusText);
          throw new Error(`Server returned status ${response.status}`);
        }

        const rawText = await response.text();
console.log("Chat response raw:", rawText);

let data;
try {
  data = JSON.parse(rawText);
} catch (e) {
  console.warn("JSON parse error, using fallback:", e);
  data = { 
    success: true, 
    reply: "Whoopsie! 🙈 I just had a bit of a brain fart (do AIs have brains?). Let's pretend that never happened and try again!" 
  };
}
        console.log("Chat response:", data);

        if (!data.success) {
          throw new Error("Chat request failed");
        }

        const reply = data.reply || "⚠️ No reply received.";

        const divBot = document.createElement("p");
        const avatarHtml = getAvatarHtml();
        divBot.innerHTML = `<strong>${avatarHtml}${currentCharacter?.name || 'Character'}:</strong> ${reply}`;
        chatlog.appendChild(divBot);
        chatlog.scrollTop = chatlog.scrollHeight;
        
      } catch (err) {
        console.error("sendMessage → Error:", err);
        alert("❌ Error sending message: " + err.message);
        
        const divErr = document.createElement("p");
        divErr.innerHTML = `<strong>${currentCharacter?.name || 'Character'}:</strong> ⚠️ Something went wrong while sending.`;
        chatlog.appendChild(divErr);
        chatlog.scrollTop = chatlog.scrollHeight;
      } finally {
        sendButton.disabled = false;
        sendButton.textContent = "Send";
      }
    }
  </script>
</body>
</html>